//@version=6
indicator("UTCC Metals v2.5.1 - Institutional", 
     shorttitle="Metals", 
     overlay=true, 
     max_labels_count=100,
     max_lines_count=100)

// ============================================================================
// UTCC METALS v2.5.1 - INSTITUTIONAL
// ============================================================================
// Version: 2.5.1 - Governance Hardening (Phase 4)
//
// v2.5.1 CHANGES (Phase 4 - Governance Hardening):
// - Regime veto invariant: regimeAllowsArming gate prevents isArmed
//   during R-COMPRESSION/R-CHAOS/R-OFFSESSION (item 15)
// - Granular execution constraints: computed maxRiskR/maxTrades/addsEnabled
//   from regime + risk combo, most restrictive wins (item 16)
//   R-EXPANSION TREND=1.0R/3, EXPLODE=0.5R/2, R-TRANSITION=0.5R/1
//   K-REDUCED=0.5R/1, K-LOCKED=NONE/0
// - Disarm reason codes: U-DISARM-EMA, U-DISARM-MTF, U-DISARM-EFFICIENCY
//   appended to contributingStr on BLOCKED alerts (item 17)
//
// v2.5.0: Institutional Alert Refactoring (Phase 1 + Phase 2)
// v2.3.0: Discord-optimised alert format
// v2.1.1: DST/Fix Window/Futures Detection Fixes
// v2.1.0: Auto-calibration, session awareness, playbook system
//
// WATCHLIST:
// XAUUSD (Gold), XAGUSD (Silver)
// Also supports: XAUEUR, XAGEUR, GC, SI, etc.
// ============================================================================

// ============================================================================
// INSTRUMENT DETECTION
// ============================================================================
tkr = str.upper(syminfo.ticker)
base = str.upper(syminfo.basecurrency)

// Gold detection - includes spot and futures (GC prefix for all CME gold futures)
isGold = str.contains(tkr, "XAU") or str.contains(tkr, "GOLD") or (base == "XAU") or str.startswith(tkr, "GC")

// Silver detection - includes spot and futures (SI prefix for all CME silver futures)
isSilver = str.contains(tkr, "XAG") or str.contains(tkr, "SILVER") or (base == "XAG") or str.startswith(tkr, "SI")

isKnownMetal = isGold or isSilver

// Metal name for display
var string metalName = "METAL"
if isGold
    metalName := "GOLD"
else if isSilver
    metalName := "SILVER"
else
    metalName := syminfo.basecurrency

metalShort = isGold ? "XAU" : isSilver ? "XAG" : base

// ============================================================================
// INPUTS - DISPLAY SETTINGS
// ============================================================================
GRP_DISPLAY = "ðŸŽ¨ Display Settings"
displayMode = input.string("Compact", "Display Mode", 
     options=["Minimal", "Compact", "Standard", "Full"], 
     group=GRP_DISPLAY,
     tooltip="Minimal=Status only | Compact=Status+Checklist | Standard=+Key details | Full=Everything")
panelPosition = input.string("Top Right", "Panel Position", 
     options=["Top Left", "Top Right", "Bottom Left", "Bottom Right"], 
     group=GRP_DISPLAY)
panelSize = input.string("Medium", "Panel Size", 
     options=["Small", "Medium", "Large"], 
     group=GRP_DISPLAY)

// ============================================================================
// INPUTS - VISUAL CUSTOMISATION
// ============================================================================
GRP_VISUAL = "ðŸŽ¨ Visual Customisation"

headerFontSize = input.string("Normal", "Header Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
statusFontSize = input.string("Large", "Status Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
dataFontSize = input.string("Small", "Data Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
scoreFontSize = input.string("Normal", "Score Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)

borderWidth = input.int(1, "Border Width", minval=0, maxval=10, group=GRP_VISUAL)
frameWidth = input.int(2, "Frame Width", minval=0, maxval=10, group=GRP_VISUAL)
panelTransparency = input.int(0, "Background Transparency", minval=0, maxval=100, group=GRP_VISUAL)
borderTransparency = input.int(0, "Border Transparency", minval=0, maxval=100, group=GRP_VISUAL)

debugMode = input.bool(false, "ðŸ”§ Force Test Alerts", group=GRP_VISUAL)
showAlertDiagnostics = input.bool(false, "ðŸ” Alert Diagnostics Panel", group=GRP_VISUAL)

// ============================================================================
// INPUTS - CRITERIA THRESHOLDS (4 CRITERIA)
// ============================================================================
GRP_CRITERIA = "âœ… 4-Criteria Thresholds"

minTrendScore = input.int(80, "1ï¸âƒ£ Min Trend Score", minval=60, maxval=100, 
     group=GRP_CRITERIA,
     tooltip="Indices require 80 minimum for quality setups")

acceptTrend = input.bool(true, "3ï¸âƒ£ Accept: TREND", group=GRP_CRITERIA, inline="vol1")
acceptExplode = input.bool(true, "EXPLODE (with rules)", group=GRP_CRITERIA, inline="vol1")
explodeMinPercentile = input.int(20, "EXPLODE Min %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol2")
explodeMaxPercentile = input.int(80, "EXPLODE Max %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol2")
acceptQuiet = input.bool(false, "Accept: QUIET (with rules)", group=GRP_CRITERIA, inline="vol3",
     tooltip="QUIET disabled by default - metal consolidations break violently")
quietMinPercentile = input.int(30, "QUIET Min %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol4")
quietMaxPercentile = input.int(70, "QUIET Max %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol4")

useAutoATR = input.bool(true, "Use Auto-Calibrated ATR Filter", group=GRP_CRITERIA)
manualATRFilter = input.int(50, "Manual ATR Filter %", minval=0, maxval=150, step=5, group=GRP_CRITERIA)
var float atrFilterPercent = na  // assigned after calibration block

// ============================================================================
// INPUTS - METALS RISK SETTINGS
// ============================================================================
GRP_RISK = "âš ï¸ Metals Risk Settings"

enableFixCaution = input.bool(true, "Enable London Fix Caution", 
     group=GRP_RISK,
     tooltip="Flags +/-15 mins around 10:30 and 15:00 London time fix windows")

enableLondonOpenCaution = input.bool(true, "Enable London Open Caution",
     group=GRP_RISK,
     tooltip="First 30 minutes after London open = spike risk")

enableNYOpenCaution = input.bool(true, "Enable NY Open Caution", 
     group=GRP_RISK,
     tooltip="First 30 minutes after NY open = spike risk")

isHighImpactDay = input.bool(false, "âš ï¸ High Impact Day (NFP/Fed)", 
     group=GRP_RISK,
     tooltip="Enable on NFP/Fed days - blocks trading")

// ============================================================================
// INPUTS - EXECUTION CONTEXT
// ============================================================================
GRP_CONTEXT = "â° Execution Context"

showSessionInfo = input.bool(true, "Show Session Indicator", group=GRP_CONTEXT)
useDstShift = input.bool(false, "Apply DST Shift", group=GRP_CONTEXT,
     tooltip="Enable when market clocks shift for daylight saving. Adjusts session windows.")
dstShiftMins = input.int(60, "DST Shift (mins)", minval=-120, maxval=120, step=30, group=GRP_CONTEXT,
     tooltip="Minutes to shift session windows. Use +60 for US summer (shifts windows later), -60 for US winter.")
showBarTimer = input.bool(true, "Show Time to Bar Close", group=GRP_CONTEXT)
barTimerCritical = input.int(5, "ðŸ”´ Critical Warning (min)", minval=1, maxval=30, group=GRP_CONTEXT)
barTimerWarning = input.int(15, "ðŸŸ¡ Warning (min)", minval=1, maxval=60, group=GRP_CONTEXT)
barTimerCaution = input.int(30, "ðŸŸ  Caution (min)", minval=1, maxval=120, group=GRP_CONTEXT)
showSpreadMonitor = input.bool(true, "Show Spread Monitor", group=GRP_CONTEXT)
spreadWarningMultiplier = input.float(1.5, "Spread Warning Multiplier", minval=1.0, maxval=3.0, step=0.1, group=GRP_CONTEXT)

// ============================================================================
// INPUTS - SCORING SYSTEM
// ============================================================================
GRP_SCORE = "ðŸ“Š Scoring System"
minTradeScore = input.int(80, "Min Score for TRADE", minval=60, maxval=95, group=GRP_SCORE)
minCautionScore = input.int(70, "Min Score for CAUTION", minval=50, maxval=80, group=GRP_SCORE)

// ============================================================================
// INPUTS - EMA TREND SETTINGS
// ============================================================================
GRP_TREND = "ðŸ“ˆ Trend Settings"
fastLength = input.int(9, "Fast EMA", minval=1, group=GRP_TREND)
midLength = input.int(21, "Mid EMA", minval=1, group=GRP_TREND)
slowLength = input.int(50, "Slow EMA", minval=1, group=GRP_TREND)
trendLength = input.int(200, "HTF Trend EMA", minval=1, group=GRP_TREND)
adxLength = input.int(14, "ADX Length", minval=1, group=GRP_TREND)
adxThreshold = input.int(16, "ADX Threshold", minval=10, maxval=50, group=GRP_TREND,
     tooltip="Manual fallback ADX threshold (used only when Auto ADX is OFF).")
useAutoADX = input.bool(true, "Use Auto-Calibrated ADX", group=GRP_TREND,
     tooltip="Auto mode uses bucket-calibrated ADX; Legacy mode uses per-metal rules.")

mtf1 = input.timeframe("60", "MTF 1", group=GRP_TREND)
mtf2 = input.timeframe("240", "MTF 2", group=GRP_TREND)
mtf3 = input.timeframe("D", "MTF 3", group=GRP_TREND)

// ============================================================================
// INPUTS - ATR VOLATILITY SETTINGS
// ============================================================================
GRP_ATR = "âš¡ Volatility Settings"
atrLength = input.int(14, "ATR Length", minval=1, group=GRP_ATR)
atrPercentileLookback = input.int(252, "ATR Percentile Lookback", minval=50, maxval=1000, group=GRP_ATR)
atrBaseline = input.int(50, "ATR Baseline Length", minval=10, maxval=200, group=GRP_ATR)
sepTolerance = input.float(0.20, "Separation Tolerance", minval=0.01, maxval=0.50, step=0.01, group=GRP_ATR)
eqTolerance = input.float(0.40, "Equality Tolerance", minval=0.05, maxval=0.50, step=0.01, group=GRP_ATR)

// ============================================================================
// ðŸ§© METALS CALIBRATION PROFILE (AUTO via Daily ATR%)
// ============================================================================
GRP_CAL = "ðŸ§© Metals Calibration"

calibMode = input.string("Auto (ATR% of Price)", "Calibration Mode",
     options=["Auto (ATR% of Price)", "Legacy (Gold/Silver rules)"],
     group=GRP_CAL,
     tooltip="Auto scales thresholds using Daily ATR as % of price. Legacy keeps Gold/Silver specific rules.")

// --- Daily ATR% (symbol-agnostic) using PREVIOUS completed daily values ---
dATR = request.security(syminfo.tickerid, "D", ta.atr(atrLength)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dClose = request.security(syminfo.tickerid, "D", close[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrPctD = dClose > 0 ? (dATR / dClose) * 100.0 : na

// --- Auto-calibrated outputs ---
var float autoATRFilter = na
var float autoEntryHot = na
var float autoEntryOptimal = na
var float autoEntryAcceptable = na
var float autoSRDanger = na
var float autoADXThreshold = na

// Defaults (NORMAL bucket)
autoATRFilter := 45.0
autoEntryHot := 0.5
autoEntryOptimal := 0.9
autoEntryAcceptable := 1.4
autoSRDanger := 0.4
autoADXThreshold := 16.0

if calibMode == "Legacy (Gold/Silver rules)"
    // Legacy behaviour - Gold vs Silver calibration
    // Silver is more volatile than Gold
    if isSilver
        autoATRFilter := 40.0
        autoEntryHot := 0.7
        autoEntryOptimal := 1.2
        autoEntryAcceptable := 1.8
        autoSRDanger := 0.5
        autoADXThreshold := 14.0
    else
        // Gold - lower volatility
        autoATRFilter := 50.0
        autoEntryHot := 0.5
        autoEntryOptimal := 0.9
        autoEntryAcceptable := 1.4
        autoSRDanger := 0.4
        autoADXThreshold := 16.0
else
    // Auto mode: map Daily ATR% buckets to thresholds
    // Gold typically 0.8-1.5%, Silver 1.5-3%
    if not na(atrPctD)
        if atrPctD < 0.8
            // Low vol / quiet market
            autoATRFilter := 40.0
            autoEntryHot := 0.3
            autoEntryOptimal := 0.6
            autoEntryAcceptable := 1.0
            autoSRDanger := 0.3
            autoADXThreshold := 18.0
        else if atrPctD < 1.5
            // Normal vol (typical Gold)
            autoATRFilter := 45.0
            autoEntryHot := 0.5
            autoEntryOptimal := 0.9
            autoEntryAcceptable := 1.4
            autoSRDanger := 0.4
            autoADXThreshold := 16.0
        else if atrPctD < 2.5
            // High vol (typical Silver / active Gold)
            autoATRFilter := 50.0
            autoEntryHot := 0.7
            autoEntryOptimal := 1.1
            autoEntryAcceptable := 1.7
            autoSRDanger := 0.5
            autoADXThreshold := 14.0
        else
            // Extreme vol (crisis / flash moves)
            autoATRFilter := 55.0
            autoEntryHot := 0.9
            autoEntryOptimal := 1.4
            autoEntryAcceptable := 2.0
            autoSRDanger := 0.6
            autoADXThreshold := 13.0

// --- Diagnostics: active calibration bucket ---
var string calibBucket = "DEFAULT"

if not na(atrPctD)
    if atrPctD < 0.8
        calibBucket := "LOW"
    else if atrPctD < 1.5
        calibBucket := "NORMAL"
    else if atrPctD < 2.5
        calibBucket := "HIGH"
    else
        calibBucket := "EXTREME"
else
    calibBucket := "DEFAULT"

// Build display string
var string calibDisplay = ""

if calibMode == "Legacy (Gold/Silver rules)"
    calibDisplay := "Legacy: " + metalShort
else
    if na(atrPctD)
        calibDisplay := "Auto: DEFAULT (no D data)"
    else
        calibDisplay := "Auto: " + calibBucket + " (" + str.tostring(atrPctD, "#.##") + "%)"

// Final ATR filter threshold
atrFilterPercent := useAutoATR ? autoATRFilter : manualATRFilter

// Effective ADX threshold
effectiveADXThreshold = useAutoADX ? autoADXThreshold : adxThreshold

// ============================================================================
// INPUTS - ALERT SETTINGS (v2.0 CONTEXT ALERTS)
// ============================================================================
GRP_ALERTS = "ðŸ”” Context Alerts (v2.0)"

alertMode = input.string("alertcondition", "Alert Mode",
     options=["alertcondition", "alert() per bar", "alert() bar close"],
     group=GRP_ALERTS)

enableContextCandidate = input.bool(true, "CONTEXT CANDIDATE Alert", group=GRP_ALERTS)
enableContextArmed = input.bool(true, "CONTEXT ARMED Alert", group=GRP_ALERTS)
enableContextDisarmed = input.bool(true, "CONTEXT DISARMED Alert", group=GRP_ALERTS)
enableSessionReset = input.bool(true, "SESSION RESET Alert", group=GRP_ALERTS)

alertStrongThreshold = input.int(76, "ARMED Threshold", minval=70, maxval=90, group=GRP_ALERTS)
candidateThreshold = input.int(82, "CANDIDATE Threshold", minval=70, maxval=95, group=GRP_ALERTS)

alertPerfectThreshold = 85

// ============================================================================
// INPUTS - SESSION LOCK (v2.0)
// ============================================================================
GRP_LOCK = "ðŸ”’ Session Lock (v2.0)"

enableSessionLock = input.bool(true, "Enable Session Lock", group=GRP_LOCK)
disarmScoreThreshold = input.int(10, "Disarm Score Drop", minval=5, maxval=20, step=1, group=GRP_LOCK)
efficiencyThreshold = input.float(0.4, "Min Directional Efficiency", minval=0.1, maxval=0.8, step=0.05, group=GRP_LOCK)
upgradePersistence = input.int(2, "Upgrade Persistence (bars)", minval=1, maxval=5, group=GRP_LOCK)

mtfDegradationScoreThreshold = input.int(75, "4H Score Warning Level", minval=60, maxval=85, group=GRP_ALERTS)

strongEntryRequirement = input.string("HOT/OPTIMAL", "Entry Zone for ARMED Alerts", 
     options=["HOT/OPTIMAL", "Include ACCEPTABLE", "Any Zone"],
     group=GRP_ALERTS)

riskSpreadMultiplier = input.float(2.0, "Spread Spike Threshold", minval=1.5, maxval=5.0, step=0.5, group=GRP_ALERTS)

// ============================================================================
// ALERT MESSAGE CONTENT (Deprecated - retained for input compatibility)
// ============================================================================
// These inputs were used by the legacy buildDetailMsg() function.
// The new institutional alert system uses f_buildAlert() with fixed format.
GRP_MSG = "Alert Message Content (Legacy)"
msgShowPair = input.bool(true, "Show Pair", group=GRP_MSG, inline="msg1")
msgShowScore = input.bool(true, "Show Score", group=GRP_MSG, inline="msg1")
msgShowTrend = input.bool(true, "Show Trend Score", group=GRP_MSG, inline="msg1")
msgShowEntry = input.bool(true, "Show Entry Zone", group=GRP_MSG, inline="msg2")
msgShowMTF = input.bool(true, "Show MTF Count", group=GRP_MSG, inline="msg2")
msgShowRSI = input.bool(true, "Show RSI Count", group=GRP_MSG, inline="msg2")
msgShowATR = input.bool(false, "Show ATR State", group=GRP_MSG, inline="msg3")
msgShowSession = input.bool(false, "Show Session", group=GRP_MSG, inline="msg3")
msgShowTimeframe = input.bool(false, "Show Timeframe", group=GRP_MSG, inline="msg3")

// ============================================================================
// INPUTS - ALERT QUALITY FILTERS
// ============================================================================
GRP_FILTERS = "Alert Quality Filters"

srProximityFilter = input.float(0.0, "Min S/R Distance (ATR)", minval=0.0, maxval=3.0, step=0.1, group=GRP_FILTERS)
scoreGapRequired = input.int(0, "Score Gap Above Threshold", minval=0, maxval=20, step=1, group=GRP_FILTERS)
atrPercentileFloor = input.int(0, "Min ATR Percentile", minval=0, maxval=50, step=5, group=GRP_FILTERS)

// ============================================================================
// INPUTS - RISK GOVERNOR (Institutional)
// ============================================================================
GRP_RISK_GOV = "Risk Governor"
riskGovernorState = input.string("NORMAL", "Risk State",
     options=["NORMAL", "REDUCED", "LOCKED"],
     group=GRP_RISK_GOV,
     tooltip="Set from Command Centre risk status.\nNORMAL: Full trading\nREDUCED: -3% drawdown or 2+ consecutive losses (0.5R max, 1 trade)\nLOCKED: -5% drawdown or circuit breaker (no new trades)")

// ============================================================================
// INPUTS - RSI MOMENTUM SETTINGS
// ============================================================================
GRP_RSI = "ðŸ’¨ Momentum Settings"
rsiLength = input.int(14, "RSI Length", minval=1, group=GRP_RSI)
rsiOverbought = input.int(70, "RSI Overbought", minval=50, maxval=90, group=GRP_RSI)
rsiOversold = input.int(30, "RSI Oversold", minval=10, maxval=50, group=GRP_RSI)

// ============================================================================
// INPUTS - STYLE CUSTOMISATION
// ============================================================================
GRP_STYLE = "ðŸŽ¨ Colours & Style"

colorTradeGreen = input.color(color.rgb(0, 200, 0), "Trade Ready", group=GRP_STYLE)
colorCautionOrange = input.color(color.rgb(255, 165, 0), "Caution", group=GRP_STYLE)
colorNoTradeRed = input.color(color.rgb(220, 20, 20), "No Trade", group=GRP_STYLE)
colorPass = input.color(color.rgb(34, 171, 148), "Pass", group=GRP_STYLE)
colorFail = input.color(color.rgb(239, 83, 80), "Fail", group=GRP_STYLE)
colorHeader = input.color(color.rgb(64, 115, 122), "Header BG", group=GRP_STYLE)
colorBody = input.color(color.rgb(45, 52, 58), "Body BG", group=GRP_STYLE)
colorText = input.color(color.white, "Text", group=GRP_STYLE)

// ============================================================================
// INSTITUTIONAL ALERT BUILDER FUNCTIONS
// ============================================================================
// 4-Emoji Standard: ARMED/CANDIDATE/BLOCKED/INFO
// Scan-first, detail-on-demand. One emoji per alert type. No variations.
// ============================================================================

// --- Enum-Style Constants (Alert Types) ---
ALERT_INFO      = "INFO"
ALERT_CANDIDATE = "CANDIDATE"
ALERT_ARMED     = "ARMED"
ALERT_BLOCKED   = "BLOCKED"

// --- Execution Constraint: STAND_DOWN constant ---
EXECUTION_NONE = "NONE"

// --- Computed Execution Builder (Granular from Regime + Risk) ---
f_executionStr(float maxR, int maxTrades, bool addsOn) =>
    if maxR <= 0.0
        "NONE"
    else
        "- MAX_RISK: " + str.tostring(maxR, "#.##") + "R\n" +
         "- MAX_TRADES: " + str.tostring(maxTrades) + "\n" +
         "- ADDS: " + (addsOn ? "ENABLED" : "DISABLED")

// --- Emoji Resolver (strict, fixed â€” 4 emojis only) ---
f_alertEmoji(string alertType) =>
    string emoji = "âšª"
    if alertType == ALERT_ARMED
        emoji := "ðŸŸ¢"
    else if alertType == ALERT_CANDIDATE
        emoji := "ðŸŸ¡"
    else if alertType == ALERT_BLOCKED
        emoji := "ðŸ”´"
    else
        emoji := "âšª"
    emoji

// --- Severity Prefix Resolver ---
f_alertPrefix(string alertType) =>
    string prefix = "[I]"
    if alertType == ALERT_ARMED
        prefix := "[A]"
    else if alertType == ALERT_CANDIDATE
        prefix := "[C]"
    else if alertType == ALERT_BLOCKED
        prefix := "[B]"
    else
        prefix := "[I]"
    prefix

// --- Header Builder (Scan Line) ---
f_alertHeader(string alertType, string sym, string primaryReason, string riskState, string scoreStr) =>
    emoji = f_alertEmoji(alertType)
    prefix = f_alertPrefix(alertType)
    emoji + " " +
     prefix + " " +
     alertType + " | " +
     sym + " | " +
     primaryReason + " | " +
     riskState + " | " +
     scoreStr

// --- Body Builder (Audit Detail) ---
f_alertBody(string primaryReason, string contributingReasons, string permission, string execution) =>
    "Primary: " + primaryReason + "\n" +
     "Contributing: [" + contributingReasons + "]\n\n" +
     "PERMISSION: " + permission + "\n" +
     "EXECUTION:\n" + execution

// --- Full Alert Builder (Header + Em-Dash + Body) ---
f_buildAlert(
     string alertType,
     string sym,
     string primaryReason,
     string contributingReasons,
     string permission,
     string execution,
     string riskState,
     int scoreValue
 ) =>
    scoreStr = "U-SCORE-" + str.tostring(scoreValue)
    header = f_alertHeader(alertType, sym, primaryReason, riskState, scoreStr)
    body   = f_alertBody(primaryReason, contributingReasons, permission, execution)
    header + "\n" + "\u2014\n" + body

// ============================================================================
// CALCULATIONS: EMA TREND SYSTEM
// ============================================================================

fastEMA = ta.ema(close, fastLength)
midEMA = ta.ema(close, midLength)
slowEMA = ta.ema(close, slowLength)
trendEMA = ta.ema(close, trendLength)

trendSlope = trendEMA - trendEMA[5]
trendSlopeUp = trendSlope > 0
trendSlopeDown = trendSlope < 0

dirmov(len) =>
    up = ta.change(high)
    down = -ta.change(low)
    plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
    minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
    truerange = ta.rma(ta.tr, len)
    plus = fixnan(100 * ta.rma(plusDM, len) / truerange)
    minus = fixnan(100 * ta.rma(minusDM, len) / truerange)
    [plus, minus]

[diPlus, diMinus] = dirmov(adxLength)
adxValue = 100 * ta.rma(math.abs(diPlus - diMinus) / (diPlus + diMinus == 0 ? 1 : diPlus + diMinus), adxLength)

mtf1Bullish = request.security(syminfo.tickerid, mtf1, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
mtf2Bullish = request.security(syminfo.tickerid, mtf2, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
mtf3Bullish = request.security(syminfo.tickerid, mtf3, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

mtfBullCount = (mtf1Bullish ? 1 : 0) + (mtf2Bullish ? 1 : 0) + (mtf3Bullish ? 1 : 0)
mtfBearCount = (not mtf1Bullish ? 1 : 0) + (not mtf2Bullish ? 1 : 0) + (not mtf3Bullish ? 1 : 0)
mtfFullAlignment = mtfBullCount == 3 or mtfBearCount == 3
mtfAlignmentBullish = mtfBullCount == 3

mtfAlignCount = mtfAlignmentBullish ? 3 : mtfBearCount == 3 ? 3 : math.max(mtfBullCount, mtfBearCount)

bullishEMAStack = fastEMA > midEMA and midEMA > slowEMA
bearishEMAStack = fastEMA < midEMA and midEMA < slowEMA
priceAboveTrend = close > trendEMA
priceBelowTrend = close < trendEMA

// Trend Score (0-100)
trendScore = 0.0

if bullishEMAStack
    trendScore += 20
    if priceAboveTrend
        trendScore += 10
    if trendSlopeUp
        trendScore += 10
else if bearishEMAStack
    trendScore += 20
    if priceBelowTrend
        trendScore += 10
    if trendSlopeDown
        trendScore += 10

// ADX component
if adxValue >= 25
    trendScore += 20
else if adxValue >= effectiveADXThreshold
    trendScore += 15
else if adxValue >= 12
    trendScore += 8

// MTF alignment
if mtfFullAlignment
    trendScore += 20
else if mtfBullCount >= 2 or mtfBearCount >= 2
    trendScore += 10

// Slope + HTF confirmation
if (mtfAlignmentBullish and trendSlopeUp and priceAboveTrend) or (mtfBearCount == 3 and trendSlopeDown and priceBelowTrend)
    trendScore += 20
else if trendSlopeUp or trendSlopeDown
    trendScore += 10

trendScore := math.min(100, trendScore)

// ============================================================================
// âš¡ CALCULATIONS: ATR VOLATILITY SYSTEM
// ============================================================================

atrCurrent = ta.atr(atrLength)
atrH1 = request.security(syminfo.tickerid, "60", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrH4 = request.security(syminfo.tickerid, "240", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrD1 = request.security(syminfo.tickerid, "D", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

atrBaseMa = ta.ema(atrCurrent, atrBaseline)
atrFilterCurrentPercent = atrBaseMa > 0 ? (atrCurrent / atrBaseMa) * 100 : 100
atrFilterActive = atrFilterPercent == 0 ? true : atrFilterCurrentPercent >= atrFilterPercent

atrPercentile = ta.percentrank(atrD1, atrPercentileLookback)

baseCurr = ta.ema(atrCurrent, atrBaseline)
baseH1 = request.security(syminfo.tickerid, "60", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
baseH4 = request.security(syminfo.tickerid, "240", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
baseD1 = request.security(syminfo.tickerid, "D", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

rCur = baseCurr != 0 ? atrCurrent / baseCurr : atrCurrent
rH1 = baseH1 != 0 ? atrH1 / baseH1 : atrH1
rH4 = baseH4 != 0 ? atrH4 / baseH4 : atrH4
rD1 = baseD1 != 0 ? atrD1 / baseD1 : atrD1

sep = 1.0 + sepTolerance
q1s = rH1 > rCur * sep ? 1 : 0
q2s = rH4 > rH1 * sep ? 1 : 0
q3s = rD1 > rH4 * sep ? 1 : 0
e1s = rCur > rH1 * sep ? 1 : 0
e2s = rH1 > rH4 * sep ? 1 : 0
e3s = rH4 > rD1 * sep ? 1 : 0

quietStrong = q1s + q2s + q3s
explodeStrong = e1s + e2s + e3s

m1 = math.max(math.abs(rCur), math.abs(rH4))
m2 = math.max(math.abs(rH4), math.abs(rD1))
approx1 = m1 == 0 ? true : math.abs(rCur - rH4) / m1 <= eqTolerance
approx2 = m2 == 0 ? true : math.abs(rH4 - rD1) / m2 <= eqTolerance
isTrend = approx1 and approx2 and not (quietStrong >= 2 or explodeStrong >= 2)

var string atrState = "MIXED"
if quietStrong == 3
    atrState := "QUIET"
else if explodeStrong == 3
    atrState := "EXPLODE"
else if isTrend
    atrState := "TREND"
else
    atrState := "MIXED"

// ============================================================================
// ðŸ’¨ CALCULATIONS: RSI MOMENTUM SYSTEM
// ============================================================================

rsiCurrent = ta.rsi(close, rsiLength)
rsiH1 = request.security(syminfo.tickerid, "60", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiH4 = request.security(syminfo.tickerid, "240", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiD1 = request.security(syminfo.tickerid, "D", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

rsiBullCount = (rsiCurrent > 50 ? 1 : 0) + (rsiH1 > 50 ? 1 : 0) + (rsiH4 > 50 ? 1 : 0) + (rsiD1 > 50 ? 1 : 0)
rsiBearCount = (rsiCurrent < 50 ? 1 : 0) + (rsiH1 < 50 ? 1 : 0) + (rsiH4 < 50 ? 1 : 0) + (rsiD1 < 50 ? 1 : 0)
rsiAllBull = rsiBullCount == 4
rsiAllBear = rsiBearCount == 4

// ============================================================================
// ðŸ“° CALCULATIONS: METALS RISK DETECTION
// ============================================================================

// Use bar time for historical correctness
srcTime = barstate.isrealtime ? timenow : time
utcHour = hour(srcTime, "UTC")
utcMinute = minute(srcTime, "UTC")
currentMonth = month(srcTime, "UTC")

// London Fix Windows (+/-15 mins around fix) - LONDON TIME, needs DST adjustment
// AM Fix: 10:30 London = 630 mins -> window 615-645
// PM Fix: 15:00 London = 900 mins -> window 885-915
utcMinOfDayRaw = utcHour * 60 + utcMinute
utcMinOfDayAdj = utcMinOfDayRaw + (useDstShift ? dstShiftMins : 0)  // + sign: positive shifts windows later

// Fix windows use DST-adjusted time (London time, not true UTC)
inAMFixWindow = utcMinOfDayAdj >= 615 and utcMinOfDayAdj <= 645
inPMFixWindow = utcMinOfDayAdj >= 885 and utcMinOfDayAdj <= 915
inFixWindow = enableFixCaution and (inAMFixWindow or inPMFixWindow)

// High Impact Day Risk (manual toggle)
highImpactRiskActive = isHighImpactDay

// ============================================================================
// â° CALCULATIONS: SESSION DETECTION (METALS)
// ============================================================================

var string currentSession = "Off-Hours"
var string sessionQuality = "Low"
var bool inCashSession = false
var bool inOpenCaution = false

// Use minutes since midnight for precise boundaries (with DST adjustment)
utcMinOfDay = utcHour * 60 + utcMinute
// Note: utcMinOfDayAdj already calculated above with + sign

// Metals Sessions (UTC times - 23h trading)
// Asian: 22:00-07:00 = 1320-1440 + 0-420 (quieter)
// London Pre: 07:00-08:00 = 420-480
// London Open CAUTION: 08:00-08:30 = 480-510
// London Prime: 08:30-13:30 = 510-810
// NY Open CAUTION: 13:30-14:00 = 810-840
// NY Prime: 14:00-21:00 = 840-1260
// Transition: 21:00-22:00 = 1260-1320 (low liquidity)

// Handle wraparound for Asian session
isAsianSession = utcMinOfDayAdj >= 1320 or utcMinOfDayAdj < 420

if isAsianSession
    currentSession := "Asian"
    sessionQuality := "Low"
    inCashSession := true
    inOpenCaution := false
else if utcMinOfDayAdj >= 420 and utcMinOfDayAdj < 480
    currentSession := "London Pre"
    sessionQuality := "Medium"
    inCashSession := true
    inOpenCaution := false
else if utcMinOfDayAdj >= 480 and utcMinOfDayAdj < 510
    currentSession := "London Open"
    sessionQuality := "Caution"
    inCashSession := true
    inOpenCaution := enableLondonOpenCaution
else if utcMinOfDayAdj >= 510 and utcMinOfDayAdj < 810
    currentSession := "London"
    sessionQuality := "High"
    inCashSession := true
    inOpenCaution := false
else if utcMinOfDayAdj >= 810 and utcMinOfDayAdj < 840
    currentSession := "NY Open"
    sessionQuality := "Caution"
    inCashSession := true
    inOpenCaution := enableNYOpenCaution
else if utcMinOfDayAdj >= 840 and utcMinOfDayAdj < 1260
    currentSession := "NY"
    sessionQuality := "High"
    inCashSession := true
    inOpenCaution := false
else if utcMinOfDayAdj >= 1260 and utcMinOfDayAdj < 1320
    currentSession := "Transition"
    sessionQuality := "Low"
    inCashSession := false
    inOpenCaution := false
else
    currentSession := "Off-Hours"
    sessionQuality := "Low"
    inCashSession := false
    inOpenCaution := false

// Combined risk
var bool metalRiskHigh = false
var string metalRiskReason = ""

metalRiskHigh := highImpactRiskActive or (inOpenCaution and (enableNYOpenCaution or enableLondonOpenCaution)) or inFixWindow

if highImpactRiskActive
    metalRiskReason := "NFP/FED DAY"
else if inFixWindow
    metalRiskReason := inAMFixWindow ? "AM FIX" : "PM FIX"
else if inOpenCaution and currentSession == "London Open"
    metalRiskReason := "LON OPEN"
else if inOpenCaution and currentSession == "NY Open"
    metalRiskReason := "NY OPEN"
else
    metalRiskReason := "Clear"

// ============================================================================
// ðŸ“ CALCULATIONS: S/R PROXIMITY
// ============================================================================

srLookback = 100

swingHigh = ta.highest(high, srLookback)
swingLow = ta.lowest(low, srLookback)

atrValue = ta.atr(14)
distToResistance = atrValue > 0 ? (swingHigh - close) / atrValue : 10.0
distToSupport = atrValue > 0 ? (close - swingLow) / atrValue : 10.0

distToNearestSR = math.min(distToResistance, distToSupport)

tooCloseToSR = distToNearestSR < autoSRDanger
moderateProximity = distToNearestSR >= autoSRDanger and distToNearestSR < 1.5

var string srStatus = ""
var color srStatusColor = color.green

if tooCloseToSR
    srStatus := "TOO CLOSE"
    srStatusColor := color.red
else if moderateProximity
    srStatus := "MODERATE"
    srStatusColor := color.orange
else
    srStatus := "CLEAR"
    srStatusColor := color.green

var float srProximityScore = 0.0
if distToNearestSR >= 2.0
    srProximityScore := 5.0
else if distToNearestSR >= 1.5
    srProximityScore := 4.0
else if distToNearestSR >= 1.0
    srProximityScore := 3.0
else if distToNearestSR >= autoSRDanger
    srProximityScore := 2.0
else
    srProximityScore := 0.0

// ============================================================================
// ðŸŽ¯ CALCULATIONS: ENTRY ZONE ANALYSIS
// ============================================================================

distFromFastEMA = atrValue > 0 ? math.abs(close - fastEMA) / atrValue : 10.0
distFromMidEMA = atrValue > 0 ? math.abs(close - midEMA) / atrValue : 10.0

var string entryZoneQuality = ""
var float entryZoneScore = 0.0
var color entryZoneColor = color.gray

if distFromFastEMA < autoEntryHot
    entryZoneQuality := "HOT ZONE"
    entryZoneScore := 5.0
    entryZoneColor := color.lime
else if distFromFastEMA < autoEntryOptimal
    entryZoneQuality := "OPTIMAL"
    entryZoneScore := 4.0
    entryZoneColor := color.green
else if distFromFastEMA < autoEntryAcceptable
    entryZoneQuality := "ACCEPTABLE"
    entryZoneScore := 3.0
    entryZoneColor := color.yellow
else if distFromMidEMA < autoEntryOptimal
    entryZoneQuality := "DEEP PULLBACK"
    entryZoneScore := 2.0
    entryZoneColor := color.orange
else
    entryZoneQuality := "EXTENDED"
    entryZoneScore := 0.0
    entryZoneColor := color.red

// RSI Momentum Bonus
var float rsiMomentumBonus = 0.0
var string rsiMomentumStatus = ""

rsiCrossedUp = ta.crossover(rsiCurrent, 50)
rsiCrossedDown = ta.crossunder(rsiCurrent, 50)

rsiBullishMomentum = (mtfAlignmentBullish and rsiCrossedUp) or (mtfAlignmentBullish and rsiCurrent > 55)
rsiBearishMomentum = (mtfBearCount == 3 and rsiCrossedDown) or (mtfBearCount == 3 and rsiCurrent < 45)

if rsiBullishMomentum or rsiBearishMomentum
    if rsiCrossedUp or rsiCrossedDown
        rsiMomentumBonus := 2.0
        rsiMomentumStatus := "CROSSED 50"
    else
        rsiMomentumBonus := 1.0
        rsiMomentumStatus := "STRONG"
else if (mtfAlignmentBullish and rsiCurrent > 50) or (mtfBearCount == 3 and rsiCurrent < 50)
    rsiMomentumBonus := 0.5
    rsiMomentumStatus := "ALIGNED"
else
    rsiMomentumBonus := 0.0
    rsiMomentumStatus := "NEUTRAL"

entryTotalScore = entryZoneScore + rsiMomentumBonus

var string entryRating = ""
if entryTotalScore >= 6.5
    entryRating := "EXCELLENT"
else if entryTotalScore >= 5.0
    entryRating := "GOOD"
else if entryTotalScore >= 3.5
    entryRating := "FAIR"
else if entryTotalScore >= 2.0
    entryRating := "POOR"
else
    entryRating := "AVOID"

// ============================================================================
// âœ… 4-CRITERIA EVALUATION
// ============================================================================

// CRITERION 1: Trend Score >= Threshold
criterion1Pass = trendScore >= minTrendScore
criterion1Value = str.tostring(math.round(trendScore)) + "/100"
criterion1Status = criterion1Pass ? "âœ…" : "âŒ"

// CRITERION 2: MTF Alignment (3/3 required)
criterion2Pass = mtfFullAlignment
criterion2Value = mtfAlignmentBullish ? "BULL 3/3" : mtfBearCount == 3 ? "BEAR 3/3" : str.tostring(mtfBullCount) + "/3"
criterion2Status = criterion2Pass ? "âœ…" : "âŒ"

// CRITERION 3: Volatility Ready
var bool criterion3Pass = false
var string criterion3Detail = ""

if atrState == "TREND" and acceptTrend
    criterion3Pass := true
    criterion3Detail := "TREND"
else if atrState == "EXPLODE" and acceptExplode
    if atrPercentile >= explodeMinPercentile and atrPercentile <= explodeMaxPercentile
        criterion3Pass := true
        criterion3Detail := "EXPLODE (" + str.tostring(math.round(atrPercentile)) + "%ile)"
    else
        criterion3Pass := false
        criterion3Detail := "EXPLODE (Extreme)"
else if atrState == "QUIET" and acceptQuiet
    if atrPercentile >= quietMinPercentile and atrPercentile <= quietMaxPercentile
        criterion3Pass := true
        criterion3Detail := "QUIET (" + str.tostring(math.round(atrPercentile)) + "%ile)"
    else
        criterion3Pass := false
        criterion3Detail := "QUIET (Edge)"
else if atrState == "MIXED"
    criterion3Pass := false
    criterion3Detail := "MIXED"
else
    criterion3Pass := false
    criterion3Detail := atrState

criterion3Value = criterion3Detail
criterion3Status = criterion3Pass ? "âœ…" : "âŒ"

// CRITERION 4: Metal Risk Status
criterion4Pass = not metalRiskHigh
criterion4Value = metalRiskHigh ? metalRiskReason : "CLEAR"
criterion4Status = criterion4Pass ? "âœ…" : "âŒ"

// ATR PERCENTILE - DISPLAY ONLY
atrPercentileValue = math.round(atrPercentile)
atrGuidance = atrPercentileValue < 30 ? "IDEAL" : atrPercentileValue < 60 ? "NORMAL" : atrPercentileValue < 80 ? "ELEVATED" : "EXHAUSTED"
atrGuidanceColor = atrPercentileValue < 30 ? color.lime : atrPercentileValue < 60 ? color.green : atrPercentileValue < 80 ? color.yellow : color.red

criteriaMet = (criterion1Pass ? 1 : 0) + (criterion2Pass ? 1 : 0) + (criterion3Pass ? 1 : 0) + (criterion4Pass ? 1 : 0)

// ============================================================================
// ðŸ“Š SCORING SYSTEM (0-100 points)
// ============================================================================

var float overallScore = 0.0
overallScore := 0.0

// 1. TREND QUALITY SCORE (0-40 points)
trendQualityScore = (trendScore / 100) * 40
overallScore += trendQualityScore

// 2. VOLATILITY REGIME SCORE (0-30 points)
var float volatilityScore = 0.0
if atrState == "TREND"
    volatilityScore := 25.0
else if atrState == "EXPLODE"
    if atrPercentile >= 20 and atrPercentile <= 80
        volatilityScore := 20.0
    else if atrPercentile >= 15 and atrPercentile <= 90
        volatilityScore := 15.0
    else
        volatilityScore := 0.0
else if atrState == "QUIET"
    if atrPercentile >= 30 and atrPercentile <= 70
        volatilityScore := 15.0
    else if atrPercentile >= 15 and atrPercentile <= 85
        volatilityScore := 10.0
    else
        volatilityScore := 0.0
else
    volatilityScore := 0.0

if atrFilterActive
    volatilityScore += 5.0

overallScore += volatilityScore

// 3. MOMENTUM ALIGNMENT SCORE (0-20 points)
var float momentumScore = 0.0
if rsiAllBull or rsiAllBear
    momentumScore := 20.0
else if rsiBullCount >= 3 or rsiBearCount >= 3
    momentumScore := 15.0
else if rsiBullCount >= 2 or rsiBearCount >= 2
    momentumScore := 8.0
else
    momentumScore := 0.0

overallScore += momentumScore

// 4. RISK CONTEXT SCORE (0-5 points)
dailyHigh = request.security(syminfo.tickerid, "D", high, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dailyLow = request.security(syminfo.tickerid, "D", low, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dailyRange = dailyHigh - dailyLow
dailyPosition = dailyRange > 0 ? ((close - dailyLow) / dailyRange * 100) : 50

var float riskScore = 0.0

if dailyPosition >= 40 and dailyPosition <= 60
    riskScore := 1.5
else if dailyPosition >= 30 and dailyPosition <= 70
    riskScore := 1.0
else
    riskScore := 0.5

// Session quality bonus
if sessionQuality == "High"
    riskScore += 2.0
else if sessionQuality == "Medium"
    riskScore += 1.5
else if sessionQuality == "Caution"
    riskScore += 0.5
else
    riskScore += 0.0

// Risk penalties
if metalRiskHigh
    riskScore -= 2.0
if false
    riskScore -= 0.5

riskScore := math.max(0, math.min(5, riskScore))

overallScore += riskScore

// 5. PRICE ACTION SCORE (0-5 points)
priceActionScore = 0.0
priceActionScore += (srProximityScore / 5.0) * 3.0
priceActionScore += (math.min(5.0, entryZoneScore) / 5.0) * 2.0

overallScore += priceActionScore

overallScore := math.min(100, overallScore)

// ============================================================================
// INVALIDATION-BASED RISK MANAGEMENT (Institutional - Dollars for Metals)
// ============================================================================
// Invalidation = The price level where the trade idea is WRONG
// Stop placement is derived from invalidation, not arbitrary ATR multiples

invalidationBuffer = atrCurrent * 0.5

var float invalidationLevel = na
var float stopLevel = na
var float targetLevel = na
var float riskReward = 2.0
var string invalidationReason = ""

if mtfAlignmentBullish
    invalidationLevel := fastEMA - invalidationBuffer
    stopLevel := invalidationLevel - (atrCurrent * 0.1)
    targetLevel := close + (math.abs(close - stopLevel) * 2.0)
    invalidationReason := "Below EMA"
else if mtfBearCount == 3
    invalidationLevel := fastEMA + invalidationBuffer
    stopLevel := invalidationLevel + (atrCurrent * 0.1)
    targetLevel := close - (math.abs(stopLevel - close) * 2.0)
    invalidationReason := "Above EMA"
else
    invalidationLevel := close - atrCurrent
    stopLevel := close - (atrCurrent * 1.1)
    targetLevel := close + atrCurrent
    invalidationReason := "No Direction"

riskDistance = math.abs(close - stopLevel)
rewardDistance = math.abs(targetLevel - close)
riskReward := riskDistance > 0 ? rewardDistance / riskDistance : 0.0

// Convert to dollars (metals use price units, not pips)
stopDollars = math.round(riskDistance * 100) / 100
targetDollars = math.round(rewardDistance * 100) / 100

// ============================================================================
// VOLATILITY EXPLANATION
// ============================================================================

var string volExplanation = ""
if atrState == "TREND"
    volExplanation := "Steady consistent movement across timeframes. Ideal trending conditions."
else if atrState == "EXPLODE"
    volExplanation := "Sharp spike in activity. Breakout or news-driven. High risk/reward."
else if atrState == "QUIET"
    volExplanation := "Compressed range, consolidation. Potential breakout setup forming."
else
    volExplanation := "Conflicting volatility signals. Mixed market structure, avoid."

// Trend explanation
var string trendExplanation = ""
if fastEMA > midEMA and midEMA > slowEMA
    trendExplanation := "Fast > Mid > Slow - Clean bullish alignment"
else if fastEMA < midEMA and midEMA < slowEMA
    trendExplanation := "Fast < Mid < Slow - Clean bearish alignment"
else
    trendExplanation := "Mixed EMA structure - No clear trend"

// ADX interpretation
var string adxInterpretation = ""
if adxValue > 25
    adxInterpretation := "Strong"
else if adxValue > effectiveADXThreshold
    adxInterpretation := "Moderate"
else
    adxInterpretation := "Weak"

// ============================================================================
// ðŸŽ¯ STATUS DETERMINATION
// ============================================================================

var string tradeStatus = "âŒ NO TRADE"
var color tradeStatusColor = colorNoTradeRed
var string tradeStatusType = ""
var string positionSizeRec = ""

allCriteriaMet = criterion1Pass and criterion2Pass and criterion3Pass and criterion4Pass
trendDirection = bullishEMAStack ? 1 : bearishEMAStack ? -1 : 0

if criteriaMet == 4
    tradeStatus := "âœ… TRADE"
    tradeStatusColor := colorTradeGreen
    positionSizeRec := "Full"
    entryIsGood = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
    if overallScore >= 90 and entryIsGood
        tradeStatusType := "Textbook"
    else if overallScore >= 85
        tradeStatusType := "Strong"
    else
        tradeStatusType := "Good"

else if criteriaMet == 3
    bool criticalPass = criterion1Pass and criterion2Pass
    
    if criticalPass
        if overallScore >= 85
            tradeStatus := "âœ… TRADE"
            tradeStatusColor := colorTradeGreen
            positionSizeRec := "Full"
            tradeStatusType := "Strong"
        else if overallScore >= minCautionScore
            tradeStatus := "âš ï¸ CAUTION"
            tradeStatusColor := colorCautionOrange
            positionSizeRec := "50%"
            tradeStatusType := "Decent"
        else
            tradeStatus := "âŒ NO TRADE"
            tradeStatusColor := colorNoTradeRed
            positionSizeRec := "Avoid"
            tradeStatusType := "Score Too Low"
    else
        tradeStatus := "âŒ NO TRADE"
        tradeStatusColor := colorNoTradeRed
        positionSizeRec := "Avoid"
        if not criterion1Pass
            tradeStatusType := "Weak Trend"
        else
            tradeStatusType := "MTF Divergence"

else if criteriaMet == 2
    if overallScore >= minCautionScore
        tradeStatus := "âš ï¸ CAUTION"
        tradeStatusColor := colorCautionOrange
        positionSizeRec := "25-50%"
        tradeStatusType := "Marginal"
    else
        tradeStatus := "âŒ NO TRADE"
        tradeStatusColor := colorNoTradeRed
        positionSizeRec := "Avoid"
        tradeStatusType := "Too Weak"

else
    tradeStatus := "âŒ NO TRADE"
    tradeStatusColor := colorNoTradeRed
    positionSizeRec := "Avoid"
    if criterion3Pass == false
        tradeStatusType := "Vol Issue"
    else if criterion4Pass == false
        tradeStatusType := "Risk Event"
    else if criterion1Pass == false
        tradeStatusType := "Weak Trend"
    else if criterion2Pass == false
        tradeStatusType := "MTF Mixed"
    else
        tradeStatusType := "Multiple Issues"

// ============================================================================
// ðŸ”’ SESSION LOCK SYSTEM (v2.0)
// ============================================================================

candleRange = high - low
candleBody = math.abs(close - open)
rawEfficiency = candleRange > 0 ? candleBody / candleRange : 0

candleBullish = close > open
candleBearish = close < open

var bool isArmed = false
var int armedDirection = 0
var float armedScore = 0.0
var string armedSession = ""
var int barsAboveThreshold = 0
var string disarmReason = ""
var string currentPlaybook = "NO TRADE"

var bool wasArmed = false
var int wasArmedDirection = 0
var string lastSession = ""

var bool wasCandidate_rt = false
var bool wasCandidate_close = false
var int wasCandidateDir_rt = 0
var int wasCandidateDir_close = 0

sessionJustChanged = currentSession != lastSession
sessionResetEvent = sessionJustChanged and barstate.isnew

var bool structuralDamage = false
var bool efficiencyCollapse = false
var bool mtfBroken = false
var bool emaCompressed = false

// Time to bar close
tfSeconds = timeframe.in_seconds()
barStartTime = time
currentTime = timenow
barTimeElapsed = (currentTime - barStartTime) / 1000
barTimeRemaining = math.max(0, tfSeconds - barTimeElapsed)
minutesRemaining = math.floor(barTimeRemaining / 60)
secondsRemaining = math.floor(barTimeRemaining % 60)

var string barCloseText = ""
var bool barCloseWarning = false
var color barTimerColor = color.white

if barstate.isrealtime
    if minutesRemaining <= barTimerCritical
        barCloseWarning := true
        barTimerColor := color.rgb(255, 50, 50)
        barCloseText := str.tostring(minutesRemaining) + "m " + str.tostring(secondsRemaining) + "s"
    else if minutesRemaining <= barTimerWarning
        barCloseWarning := true
        barTimerColor := color.rgb(255, 200, 0)
        barCloseText := str.tostring(minutesRemaining) + "m " + str.tostring(secondsRemaining) + "s"
    else if minutesRemaining <= barTimerCaution
        barCloseWarning := false
        barTimerColor := color.rgb(255, 165, 0)
        barCloseText := str.tostring(minutesRemaining) + "m"
    else
        barCloseWarning := false
        barTimerColor := color.rgb(100, 200, 100)
        barCloseText := str.tostring(minutesRemaining) + "m"
else
    barCloseText := "---"
    barCloseWarning := false
    barTimerColor := color.gray

// Spread monitoring
recentVolatility = ta.atr(14)
currentBarRange = high - low
expectedRange = recentVolatility * 0.5
rangeRatio = expectedRange > 0 ? currentBarRange / expectedRange : 1.0

var string spreadStatus = "NORMAL"
var bool spreadWarning = false
if rangeRatio > spreadWarningMultiplier
    spreadStatus := "WIDE"
    spreadWarning := true
else if rangeRatio > (spreadWarningMultiplier * 0.7)
    spreadStatus := "ELEVATED"
    spreadWarning := false
else
    spreadStatus := "NORMAL"
    spreadWarning := false

if not barstate.isrealtime
    spreadStatus := "---"
    spreadWarning := false

// Session Lock Logic
bullishEfficiency = candleBullish ? rawEfficiency : 0.0
bearishEfficiency = candleBearish ? rawEfficiency : 0.0

emaCompressed := trendDirection == 0
mtfBroken := mtfAlignCount < 3
efficiencyCollapse := (trendDirection == 1 and bullishEfficiency < efficiencyThreshold and candleBullish) or (trendDirection == -1 and bearishEfficiency < efficiencyThreshold and candleBearish)
structuralDamage := emaCompressed or mtfBroken or efficiencyCollapse

if emaCompressed
    disarmReason := "EMA Compressed"
else if mtfBroken
    disarmReason := "MTF Break"
else if efficiencyCollapse
    disarmReason := "Efficiency Collapse"
else
    disarmReason := ""

// --- Regime Veto Invariant (v2.5.1) ---
// No ARMED during STAND_DOWN regimes. Uses raw atrState/atrPercentile/currentSession.
regimeAllowsArming = true
if atrState == "MIXED"
    regimeAllowsArming := false
else if atrState == "QUIET" and atrPercentile < 15
    regimeAllowsArming := false
else if currentSession == "Off-Hours"
    regimeAllowsArming := false

meetsArmCriteria = allCriteriaMet and overallScore >= alertStrongThreshold and mtfAlignCount == 3 and trendDirection != 0 and regimeAllowsArming
if meetsArmCriteria
    barsAboveThreshold := barsAboveThreshold + 1
else
    barsAboveThreshold := 0

if enableSessionLock
    if sessionJustChanged
        isArmed := false
        armedDirection := 0
        armedScore := 0.0
        armedSession := ""
        barsAboveThreshold := 0
    
    if not isArmed and barsAboveThreshold >= upgradePersistence
        isArmed := true
        armedDirection := trendDirection
        armedScore := overallScore
        armedSession := currentSession
    
    if isArmed
        scoreBelowDisarm = overallScore < (armedScore - disarmScoreThreshold)
        if scoreBelowDisarm and structuralDamage
            isArmed := false
            armedDirection := 0
        // v2.5.1: Regime veto forces disarm regardless of score
        if not regimeAllowsArming
            isArmed := false
            armedDirection := 0
            disarmReason := "Regime Veto"
else
    isArmed := meetsArmCriteria
    armedDirection := trendDirection
    armedScore := overallScore

if not isArmed
    currentPlaybook := "NO TRADE"
else
    if atrState == "TREND"
        currentPlaybook := armedDirection == 1 ? "CONTINUATION LONG" : "CONTINUATION SHORT"
    else if atrState == "EXPLODE"
        currentPlaybook := armedDirection == 1 ? "DEEP PULLBACK LONG" : "DEEP PULLBACK SHORT"
    else if atrState == "QUIET"
        currentPlaybook := "OBSERVATION ONLY"
    else
        currentPlaybook := "STAND DOWN"

armedStatusText = isArmed ? (armedDirection == 1 ? "\u2191 ARMED" : "\u2193 ARMED") : "DISARMED"
armedStatusColor = isArmed ? (armedDirection == 1 ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80)) : color.gray

// ============================================================================
// INSTITUTIONAL PRIORITY RESOLVER (Regime > Risk > UTCC)
// ============================================================================
// Reads existing UTCC variables. Adds governance layer on top.
// Higher layers veto lower layers. No exceptions.
// ============================================================================

// --- Derived risk code from Risk Governor input ---
riskCode = riskGovernorState == "LOCKED" ? "K-LOCKED" : riskGovernorState == "REDUCED" ? "K-REDUCED" : "K-NORMAL"

// ============================================================================
// LAYER 1: REGIME CHECK (Highest Authority)
// ============================================================================
var string regimeCode = "R-EXPANSION"
var string regimePermission = "FULL"

if atrState == "MIXED"
    regimeCode := "R-CHAOS"
    regimePermission := "STAND_DOWN"
else if atrState == "QUIET" and atrPercentile < 15
    regimeCode := "R-COMPRESSION"
    regimePermission := "STAND_DOWN"
else if currentSession == "Off-Hours"
    regimeCode := "R-OFFSESSION"
    regimePermission := "STAND_DOWN"
else if atrState == "QUIET"
    regimeCode := "R-COMPRESSION"
    regimePermission := "CONDITIONAL"
else if atrState == "EXPLODE"
    regimeCode := "R-TRANSITION"
    regimePermission := "CONDITIONAL"
else if atrState == "TREND"
    regimeCode := "R-EXPANSION"
    regimePermission := "FULL"

// ============================================================================
// LAYER 2: RISK GOVERNOR CHECK (Overrides UTCC)
// ============================================================================
var string riskPermission = "FULL"
if riskGovernorState == "LOCKED"
    riskPermission := "STAND_DOWN"
else if riskGovernorState == "REDUCED"
    riskPermission := "CONDITIONAL"
else
    riskPermission := "FULL"

// ============================================================================
// LAYER 3: RESOLVE FINAL PERMISSION (Most Restrictive Wins)
// ============================================================================
var string finalPermission = "FULL"
if regimePermission == "STAND_DOWN" or riskPermission == "STAND_DOWN"
    finalPermission := "STAND_DOWN"
else if regimePermission == "CONDITIONAL" or riskPermission == "CONDITIONAL"
    finalPermission := "CONDITIONAL"
else
    finalPermission := "FULL"

// ============================================================================
// LAYER 4: DETERMINE PRIMARY REASON (Highest Authority That Restricted)
// ============================================================================
var string primaryReason = "R-EXPANSION"
if regimePermission == "STAND_DOWN"
    primaryReason := regimeCode
else if riskPermission == "STAND_DOWN"
    primaryReason := riskCode
else if regimePermission == "CONDITIONAL"
    primaryReason := regimeCode
else if riskPermission == "CONDITIONAL"
    primaryReason := riskCode
else
    // Both regime and risk allow full - regime is ALWAYS primary
    // UTCC codes are NEVER primary. Ever.
    primaryReason := regimeCode

// ============================================================================
// LAYER 5: AUTO-SELECT ALERT TYPE
// ============================================================================
var string resolvedAlertType = ALERT_INFO
if finalPermission == "STAND_DOWN"
    resolvedAlertType := ALERT_BLOCKED
else if finalPermission == "FULL" and isArmed and allCriteriaMet
    resolvedAlertType := ALERT_ARMED
else if finalPermission == "CONDITIONAL" or (allCriteriaMet and not isArmed)
    resolvedAlertType := ALERT_CANDIDATE
else
    resolvedAlertType := ALERT_INFO

// ============================================================================
// LAYER 6: COMPUTE EXECUTION CONSTRAINTS (Granular, v2.5.1)
// ============================================================================
// Regime sets baseline. Risk governor overrides downward. Most restrictive wins.
// Per spec: R-EXPANSION TREND=1.0R/3, EXPLODE=0.5R/2, R-TRANSITION=0.5R/1

// --- Regime baseline ---
var float regimeMaxR = 0.0
var int regimeMaxTrades = 0
var bool regimeAdds = false

if regimePermission == "STAND_DOWN"
    regimeMaxR := 0.0
    regimeMaxTrades := 0
    regimeAdds := false
else if regimeCode == "R-EXPANSION" and atrState == "TREND"
    regimeMaxR := 1.0
    regimeMaxTrades := 3
    regimeAdds := true
else if regimeCode == "R-EXPANSION" and atrState == "EXPLODE"
    regimeMaxR := 0.5
    regimeMaxTrades := 2
    regimeAdds := false
else if regimeCode == "R-TRANSITION"
    regimeMaxR := 0.5
    regimeMaxTrades := 1
    regimeAdds := false
else if regimeCode == "R-COMPRESSION"
    regimeMaxR := 0.5
    regimeMaxTrades := 1
    regimeAdds := false
else
    regimeMaxR := 1.0
    regimeMaxTrades := 3
    regimeAdds := true

// --- Risk governor override (downward only) ---
var float riskMaxR = 0.0
var int riskMaxTrades = 0
var bool riskAdds = false

if riskGovernorState == "LOCKED"
    riskMaxR := 0.0
    riskMaxTrades := 0
    riskAdds := false
else if riskGovernorState == "REDUCED"
    riskMaxR := 0.5
    riskMaxTrades := 1
    riskAdds := false
else
    riskMaxR := 99.0
    riskMaxTrades := 99
    riskAdds := true

// --- Final: most restrictive wins ---
var float finalMaxR = 0.0
var int finalMaxTrades = 0
var bool finalAdds = false
finalMaxR := math.min(regimeMaxR, riskMaxR)
finalMaxTrades := math.min(regimeMaxTrades, riskMaxTrades)
finalAdds := regimeAdds and riskAdds

// --- Build execution string ---
var string resolvedExecution = EXECUTION_NONE
if finalPermission == "STAND_DOWN"
    resolvedExecution := EXECUTION_NONE
else
    resolvedExecution := f_executionStr(finalMaxR, finalMaxTrades, finalAdds)

// ============================================================================
// BUILD CONTRIBUTING REASONS (Supporting Evidence)
// ============================================================================
contributingStr = "U-MTF-" + str.tostring(mtfAlignCount) + "OF3"
contributingStr := contributingStr + ", U-SCORE-" + str.tostring(math.round(overallScore))
contributingStr := contributingStr + ", U-ATR-" + atrState
if not criterion1Pass
    contributingStr := contributingStr + ", U-TREND-WEAK"
if atrPercentile < 20
    contributingStr := contributingStr + ", U-ATR-BELOW-P" + str.tostring(math.round(atrPercentile))
if str.contains(entryZoneQuality, "EXTENDED")
    contributingStr := contributingStr + ", U-ENTRY-EXTENDED"
if tooCloseToSR
    contributingStr := contributingStr + ", U-SR-CLOSE"
if metalRiskHigh
    contributingStr := contributingStr + ", U-NEWS-RISK"
// v2.5.1: Disarm reason codes for BLOCKED alerts
if not isArmed and disarmReason != ""
    if disarmReason == "EMA Compressed"
        contributingStr := contributingStr + ", U-DISARM-EMA"
    else if disarmReason == "MTF Break"
        contributingStr := contributingStr + ", U-DISARM-MTF"
    else if disarmReason == "Efficiency Collapse"
        contributingStr := contributingStr + ", U-DISARM-EFFICIENCY"
    else if disarmReason == "Regime Veto"
        contributingStr := contributingStr + ", U-DISARM-REGIME"

// ============================================================================
// TABLE DISPLAY - INSTITUTIONAL 4-TIER (v2.5.0)
// ============================================================================
// Hierarchy: Alert Type > Regime > Execution > UTCC Criteria
// Colour mapping: 4-Emoji Standard (ARMED/CANDIDATE/BLOCKED/INFO)
// ============================================================================

var table dashTable = na

tablePos = panelPosition == "Top Left" ? position.top_left : 
           panelPosition == "Top Right" ? position.top_right : 
           panelPosition == "Bottom Left" ? position.bottom_left : 
           position.bottom_right

getSize(string s) =>
    s == "Tiny" ? size.tiny : s == "Small" ? size.small : s == "Normal" ? size.normal : s == "Large" ? size.large : size.huge

headerSize = getSize(headerFontSize)
statusSize = getSize(statusFontSize)
dataSize = getSize(dataFontSize)
scoreSize = getSize(scoreFontSize)

if barstate.isfirst
    maxRows = displayMode == "Minimal" ? 7 : displayMode == "Compact" ? 19 : displayMode == "Standard" ? 42 : 52
    dashTable := table.new(tablePos, 2, maxRows, 
         bgcolor=color.new(colorBody, panelTransparency),
         frame_color=color.new(colorHeader, borderTransparency),
         frame_width=frameWidth,
         border_width=borderWidth,
         border_color=color.new(colorHeader, borderTransparency))

if barstate.islast
    maxClearRows = displayMode == "Minimal" ? 6 : displayMode == "Compact" ? 18 : displayMode == "Standard" ? 41 : 51
    table.clear(dashTable, 0, 0, 1, maxClearRows)
    
    row = 0
    
    // ========================================
    // TIER 1: INSTITUTIONAL STATUS (Always show)
    // ========================================
    
    // --- Colour mapping from 4-Emoji Standard ---
    var color statusBgColor = color.rgb(30, 30, 50)
    var color statusTextColor = color.rgb(100, 149, 237)
    if resolvedAlertType == ALERT_ARMED
        statusBgColor := color.rgb(0, 60, 0)
        statusTextColor := color.rgb(34, 197, 94)
    else if resolvedAlertType == ALERT_CANDIDATE
        statusBgColor := color.rgb(60, 50, 0)
        statusTextColor := color.rgb(234, 179, 8)
    else if resolvedAlertType == ALERT_BLOCKED
        statusBgColor := color.rgb(60, 0, 0)
        statusTextColor := color.rgb(239, 68, 68)
    else
        statusBgColor := color.rgb(30, 30, 50)
        statusTextColor := color.rgb(100, 149, 237)
    
    // Row 0: Pair + Timeframe | Metal Name
    table.cell(dashTable, 0, row, syminfo.ticker + " " + timeframe.period, 
         text_color=colorText, text_size=headerSize, 
         bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, metalName + " | " + metalShort, 
         text_color=color.rgb(255, 215, 0), text_size=headerSize,
         bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 1: ALERT TYPE | PRIMARY REASON | PERMISSION
    table.cell(dashTable, 0, row, resolvedAlertType, 
         text_color=statusTextColor, text_size=statusSize, 
         bgcolor=color.new(statusBgColor, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, primaryReason + " | " + finalPermission, 
         text_color=statusTextColor, text_size=scoreSize, 
         bgcolor=color.new(statusBgColor, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 2: REGIME | RISK STATE
    table.cell(dashTable, 0, row, "REGIME", 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, regimeCode + " | RISK: " + riskCode, 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 3: EXECUTION CONSTRAINT (computed from regime + risk)
    string execDisplay = "NONE"
    if finalMaxR > 0.0
        execDisplay := "MAX_RISK: " + str.tostring(finalMaxR, "#.##") + "R | TRADES: " + str.tostring(finalMaxTrades)
        if finalAdds
            execDisplay := execDisplay + " | ADDS: ON"
    
    table.cell(dashTable, 0, row, "EXECUTION", 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, execDisplay, 
         text_color=finalPermission == "STAND_DOWN" ? color.rgb(239, 68, 68) : finalPermission == "CONDITIONAL" ? color.rgb(234, 179, 8) : color.rgb(34, 197, 94), 
         text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 4: Score (contributing evidence, not decision-maker)
    entryShort = str.contains(entryZoneQuality, "HOT") ? "HOT" : str.contains(entryZoneQuality, "OPTIMAL") ? "OPT" : str.contains(entryZoneQuality, "ACCEPTABLE") ? "ACC" : str.contains(entryZoneQuality, "DEEP") ? "DEEP" : "EXT"
    scoreText = "U-SCORE-" + str.tostring(math.round(overallScore)) + " | " + entryShort + " | " + str.tostring(criteriaMet) + "/4"
    
    table.cell(dashTable, 0, row, "UTCC", 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, scoreText, 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // ========================================
    // TIER 2: CRITERIA CHECKLIST (Compact+)
    // ========================================
    
    if displayMode != "Minimal"
        table.cell(dashTable, 0, row, "CRITERIA CHECKLIST", 
             text_color=colorText, text_size=headerSize, 
             bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
        table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
        row += 1
        
        // Criterion 1: Trend Score
        table.cell(dashTable, 0, row, criterion1Status + " 1. Trend Score", 
             text_color=criterion1Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion1Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 2: MTF Alignment
        table.cell(dashTable, 0, row, criterion2Status + " 2. MTF Alignment", 
             text_color=criterion2Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion2Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 3: Volatility
        table.cell(dashTable, 0, row, criterion3Status + " 3. Volatility", 
             text_color=criterion3Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion3Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 4: Risk Status
        table.cell(dashTable, 0, row, criterion4Status + " 4. Risk Status", 
             text_color=criterion4Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion4Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // ATR Percentile
        table.cell(dashTable, 0, row, "ATR: " + str.tostring(atrPercentileValue) + "%", 
             text_color=atrGuidanceColor, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, atrGuidance, 
             text_color=atrGuidanceColor, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Calibration
        table.cell(dashTable, 0, row, "Calibration", 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, calibDisplay, 
             text_color=color.rgb(100, 200, 255), text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Playbook (after criteria per institutional spec)
        if enableSessionLock
            var color playbookColor = color.gray
            if currentPlaybook == "NO TRADE"
                playbookColor := color.gray
            else if str.contains(currentPlaybook, "OBSERVATION")
                playbookColor := color.rgb(255, 200, 0)
            else if str.contains(currentPlaybook, "STAND DOWN")
                playbookColor := color.rgb(255, 165, 0)
            else if armedDirection == 1
                playbookColor := color.rgb(34, 171, 148)
            else
                playbookColor := color.rgb(239, 83, 80)
            table.cell(dashTable, 0, row, "PLAYBOOK", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, currentPlaybook, 
                 text_color=playbookColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
        
        // Session info
        sessionDisplayText = currentSession + " | " + sessionQuality
        table.cell(dashTable, 0, row, "Session", 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, sessionDisplayText, 
             text_color=sessionQuality == "High" ? colorPass : sessionQuality == "Caution" ? colorCautionOrange : colorText, 
             text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Summary verdict
        verdictText = str.tostring(criteriaMet) + "/4 -> " + positionSizeRec
        table.cell(dashTable, 0, row, verdictText, 
             text_color=statusTextColor, text_size=dataSize, 
             bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
        table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
        row += 1
        
        // ========================================
        // EXECUTION CONTEXT ROW
        // ========================================
        
        // Critical timer warning banner
        if showBarTimer and (minutesRemaining <= barTimerCritical)
            table.cell(dashTable, 0, row, barCloseText, 
                 text_color=barTimerColor, text_size=statusSize,
                 bgcolor=color.new(color.rgb(50, 0, 0), panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "CLOSE SOON!", 
                 text_color=barTimerColor, text_size=statusSize, 
                 bgcolor=color.new(color.rgb(50, 0, 0), panelTransparency), text_halign=text.align_center)
            row += 1
        
        // Build context string
        string sessionCtxText = showSessionInfo ? currentSession : ""
        string timerText = showBarTimer and minutesRemaining > barTimerCritical ? barCloseText : ""
        string spreadText = showSpreadMonitor ? spreadStatus + (spreadWarning ? " !!" : "") : ""
        
        contextParts = array.new<string>()
        if sessionCtxText != ""
            contextParts.push(sessionCtxText)
        if timerText != ""
            contextParts.push(timerText)
        if spreadText != ""
            contextParts.push(spreadText)
        
        string contextText = ""
        color contextColor = colorText
        if contextParts.size() > 0
            contextText := contextParts.get(0)
            for i = 1 to contextParts.size() - 1
                contextText += " | " + contextParts.get(i)
            if showBarTimer and minutesRemaining <= barTimerWarning and minutesRemaining > barTimerCritical
                contextColor := barTimerColor
        
        if contextText != ""
            table.cell(dashTable, 0, row, contextText, 
                 text_color=contextColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", 
                 bgcolor=color.new(colorBody, panelTransparency))
            row += 1
        
        // ========================================
        // TIER 3: STANDARD MODE
        // ========================================
        
        if displayMode == "Standard" or displayMode == "Full"
            // Score Breakdown
            table.cell(dashTable, 0, row, "SCORE BREAKDOWN", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Trend Quality", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(trendQualityScore)) + "/40", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Volatility Regime", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(volatilityScore)) + "/30", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Momentum Alignment", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(momentumScore)) + "/20", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Risk Context", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(riskScore * 10) / 10) + "/5", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Price Action", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(priceActionScore * 10) / 10) + "/5", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Volatility Analysis
            table.cell(dashTable, 0, row, "VOLATILITY ANALYSIS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "State: " + atrState, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(atrPercentile)) + "%ile", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, volExplanation, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorBody, panelTransparency))
            row += 1
            
            // Risk Management (Metals: dollars not pips)
            table.cell(dashTable, 0, row, "RISK MANAGEMENT", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Stop", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(stopLevel, "#.##") + " ($" + str.tostring(stopDollars, "#.##") + ")", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Target", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(targetLevel, "#.##") + " ($" + str.tostring(targetDollars, "#.##") + ")", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "R:R Ratio", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(riskReward, "#.#") + ":1", 
                 text_color=riskReward >= 2.0 ? colorPass : riskReward >= 1.5 ? colorText : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Trend Details
            table.cell(dashTable, 0, row, "TREND DETAILS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, trendExplanation, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorBody, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "ADX", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(adxValue)) + " (" + adxInterpretation + ")", 
                 text_color=adxValue > 25 ? colorPass : adxValue > effectiveADXThreshold ? colorText : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            htfText = mtfAlignmentBullish ? "BULLISH" : mtfBearCount == 3 ? "BEARISH" : "MIXED"
            table.cell(dashTable, 0, row, "HTF Bias", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, htfText, 
                 text_color=mtfFullAlignment ? colorPass : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // S/R Proximity
            table.cell(dashTable, 0, row, "S/R PROXIMITY", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "To Resistance", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distToResistance, "#.##") + " ATR", 
                 text_color=distToResistance < 0.5 ? colorFail : distToResistance < 1.5 ? colorText : colorPass, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "To Support", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distToSupport, "#.##") + " ATR", 
                 text_color=distToSupport < 0.5 ? colorFail : distToSupport < 1.5 ? colorText : colorPass, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "S/R Status", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, srStatus, 
                 text_color=srStatusColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Entry Zone Analysis
            table.cell(dashTable, 0, row, "ENTRY ZONE ANALYSIS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "EMA Distance", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distFromFastEMA, "#.##") + " ATR", 
                 text_color=entryZoneColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Entry Zone", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, entryZoneQuality, 
                 text_color=entryZoneColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "RSI Momentum", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rsiMomentumStatus, 
                 text_color=rsiMomentumBonus >= 2.0 ? colorPass : rsiMomentumBonus >= 1.0 ? colorText : color.gray, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Entry Score", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(entryTotalScore, "#.#") + "/7 (" + entryRating + ")", 
                 text_color=entryTotalScore >= 6 ? colorPass : entryTotalScore >= 4 ? colorText : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
        
        // ========================================
        // TIER 4: FULL MODE
        // ========================================
        
        if displayMode == "Full"
            // Momentum RSI
            table.cell(dashTable, 0, row, "MOMENTUM (RSI)", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Current TF", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiCurrent)), 
                 text_color=rsiCurrent > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "1H", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiH1)), 
                 text_color=rsiH1 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "4H", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiH4)), 
                 text_color=rsiH4 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Daily", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiD1)), 
                 text_color=rsiD1 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            rsiSummary = rsiAllBull ? "All BULL" : rsiAllBear ? "All BEAR" : str.tostring(rsiBullCount) + "/4 Bull"
            table.cell(dashTable, 0, row, "Alignment", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rsiSummary, 
                 text_color=(rsiAllBull or rsiAllBear) ? colorPass : colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Price Action
            table.cell(dashTable, 0, row, "PRICE ACTION", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            rangeText = str.tostring(math.round(dailyPosition)) + "%"
            rangeColor = dailyPosition >= 40 and dailyPosition <= 60 ? colorPass : colorText
            table.cell(dashTable, 0, row, "Daily Range", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rangeText, 
                 text_color=rangeColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Spread Status", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, spreadStatus + (spreadWarning ? " !!" : ""), 
                 text_color=spreadWarning ? colorFail : colorPass, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1


// ============================================================================
// ALERT QUALITY FILTER CHECKS
// ============================================================================

entryIsHotOrOptimal = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
entryIncludesAcceptable = entryIsHotOrOptimal or str.contains(entryZoneQuality, "ACCEPTABLE")
entryPassesForStrong = strongEntryRequirement == "Any Zone" ? true : strongEntryRequirement == "Include ACCEPTABLE" ? entryIncludesAcceptable : entryIsHotOrOptimal

srProximityPasses = distToNearestSR >= srProximityFilter

scoreGapPassesStrong = overallScore >= (alertStrongThreshold + scoreGapRequired)
scoreGapPassesPerfect = overallScore >= (alertPerfectThreshold + scoreGapRequired)

qualityFiltersPassed = entryPassesForStrong and srProximityPasses

// ============================================================================
// CANDIDATE CONDITION (v2.0)
// ============================================================================
candidateMeetsLong = allCriteriaMet and mtfAlignCount == 3 and trendDirection == 1 and entryIsHotOrOptimal and srProximityPasses and overallScore >= candidateThreshold
candidateMeetsShort = allCriteriaMet and mtfAlignCount == 3 and trendDirection == -1 and entryIsHotOrOptimal and srProximityPasses and overallScore >= candidateThreshold
candidateMeets = candidateMeetsLong or candidateMeetsShort
candidateDirection = candidateMeetsLong ? 1 : candidateMeetsShort ? -1 : 0

contextJustCandidateLong = candidateMeetsLong and (not wasCandidate_rt or wasCandidateDir_rt != 1)
contextJustCandidateShort = candidateMeetsShort and (not wasCandidate_rt or wasCandidateDir_rt != -1)
contextJustCandidate = contextJustCandidateLong or contextJustCandidateShort

// Update realtime memory immediately
wasCandidate_rt := candidateMeets
wasCandidateDir_rt := candidateDirection

// Update confirmed memory on bar close
if barstate.isconfirmed
    wasCandidate_close := candidateMeets
    wasCandidateDir_close := candidateDirection

// ============================================================================
// STATE CHANGE DETECTION
// ============================================================================
contextJustArmedLong = isArmed and armedDirection == 1 and (not wasArmed or wasArmedDirection != 1)
contextJustArmedShort = isArmed and armedDirection == -1 and (not wasArmed or wasArmedDirection != -1)
contextJustDisarmed = wasArmed and not isArmed

if barstate.isconfirmed
    wasArmed := isArmed
    wasArmedDirection := armedDirection
    lastSession := currentSession

// ============================================================================
// ALERT CONDITIONS
// ============================================================================

lockPassesLong = enableSessionLock ? (isArmed and armedDirection == 1) : true
lockPassesShort = enableSessionLock ? (isArmed and armedDirection == -1) : true

strongBullishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesStrong and qualityFiltersPassed and mtfAlignCount == 3 and trendDirection == 1 and lockPassesLong)
strongBearishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesStrong and qualityFiltersPassed and mtfAlignCount == 3 and trendDirection == -1 and lockPassesShort)

perfectBullishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesPerfect and entryIsHotOrOptimal and srProximityPasses and mtfAlignCount == 3 and trendDirection == 1 and rsiAllBull and lockPassesLong)
perfectBearishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesPerfect and entryIsHotOrOptimal and srProximityPasses and mtfAlignCount == 3 and trendDirection == -1 and rsiAllBear and lockPassesShort)

// ============================================================================
// MTF DEGRADATION
// ============================================================================
var int prev1HDirection = 0
var int prev4HDirection = 0
var int prevMTFAlignCount = 0
var float prevTrendScore = 0.0

h1Direction = mtf1Bullish ? 1 : -1
h4Direction = mtf2Bullish ? 1 : -1

h1DirectionFlip = prev1HDirection != 0 and h1Direction != prev1HDirection and barstate.isconfirmed
h4DirectionFlip = prev4HDirection != 0 and h4Direction != prev4HDirection and barstate.isconfirmed
h4ScoreDrop = prevTrendScore >= mtfDegradationScoreThreshold and trendScore < mtfDegradationScoreThreshold and barstate.isconfirmed
mtfAlignmentBreak = prevMTFAlignCount == 3 and mtfAlignCount < 3 and barstate.isconfirmed

mtfDegradationCondition = h1DirectionFlip or h4DirectionFlip or h4ScoreDrop or mtfAlignmentBreak

degradationType = h4DirectionFlip ? "4H FLIP" : h4ScoreDrop ? "4H SCORE" : mtfAlignmentBreak ? "MTF BREAK" : h1DirectionFlip ? "1H FLIP" : ""

if barstate.isconfirmed
    prev1HDirection := h1Direction
    prev4HDirection := h4Direction
    prevMTFAlignCount := mtfAlignCount
    prevTrendScore := trendScore

// ============================================================================
// RISK WARNING
// ============================================================================
currentSpread = currentBarRange
avgSpread = expectedRange

fomcRiskDetected = highImpactRiskActive and barstate.isconfirmed
spreadSpikeDetected = spreadWarning and (currentSpread >= avgSpread * riskSpreadMultiplier) and barstate.isconfirmed

riskWarningCondition = fomcRiskDetected or spreadSpikeDetected

riskType = fomcRiskDetected ? "FOMC RISK" : spreadSpikeDetected ? "SPREAD SPIKE" : ""

riskContext = fomcRiskDetected ? "Fed day - stand down" : spreadSpikeDetected ? str.tostring(math.round(currentSpread / avgSpread * 10) / 10) + "x avg" : ""

// ============================================================================
// ðŸ” ALERT DIAGNOSTICS PANEL (v2.4.0)
// ============================================================================

var table diagTable = na

diagCriteriaMetCount = (criterion1Pass ? 1 : 0) + (criterion2Pass ? 1 : 0) + 
     (criterion3Pass ? 1 : 0) + (criterion4Pass ? 1 : 0)
diagEntryHotOpt = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
diagEntryAcceptable = diagEntryHotOpt or str.contains(entryZoneQuality, "ACCEPTABLE")
diagEntryOK = strongEntryRequirement == "Any Zone" ? true : strongEntryRequirement == "Include ACCEPTABLE" ? diagEntryAcceptable : diagEntryHotOpt
diagMTFOK = mtfAlignCount == 3
diagIsBull = trendDirection == 1
diagIsBear = trendDirection == -1
diagTimerOK = minutesRemaining > barTimerCritical

if barstate.isfirst and showAlertDiagnostics
    diagTable := table.new(position.bottom_left, 2, 19,
         bgcolor=color.new(color.rgb(30, 30, 40), 10),
         frame_color=color.rgb(100, 100, 120),
         frame_width=1,
         border_width=1,
         border_color=color.rgb(60, 60, 80))

if barstate.islast and showAlertDiagnostics
    table.clear(diagTable, 0, 0, 1, 18)
    
    dRow = 0
    diagSize = size.small
    
    // Header
    table.cell(diagTable, 0, dRow, "DIAGNOSTICS " + metalShort, 
         text_color=color.white, text_size=size.normal,
         bgcolor=color.rgb(80, 80, 100), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, currentSession, 
         text_color=color.yellow, text_size=size.normal,
         bgcolor=color.rgb(80, 80, 100), text_halign=text.align_right)
    dRow += 1
    
    // CURRENT STATE
    table.cell(diagTable, 0, dRow, "--- CURRENT STATE ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    armedDisplayText = isArmed ? (armedDirection == 1 ? "^ ARMED" : "v ARMED") : "DISARMED"
    armedDisplayColor = isArmed ? color.rgb(34, 197, 94) : color.rgb(239, 68, 68)
    table.cell(diagTable, 0, dRow, "Context State", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, armedDisplayText, 
         text_color=armedDisplayColor, text_size=size.normal,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "Playbook", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, currentPlaybook, 
         text_color=color.rgb(100, 181, 246), text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    lockStatusText = enableSessionLock ? (isArmed ? "LOCKED" : "SEEKING") : "DISABLED"
    lockStatusColor = enableSessionLock ? (isArmed ? color.rgb(34, 197, 94) : color.rgb(234, 179, 8)) : color.gray
    table.cell(diagTable, 0, dRow, "Session Lock", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, lockStatusText, 
         text_color=lockStatusColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // ARM CONDITIONS
    table.cell(diagTable, 0, dRow, "--- ARM CONDITIONS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    scoreOK = overallScore >= alertStrongThreshold
    table.cell(diagTable, 0, dRow, "Score >=" + str.tostring(alertStrongThreshold), 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(math.round(overallScore)) + " " + (scoreOK ? "PASS" : "FAIL"), 
         text_color=scoreOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "MTF 3/3", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(mtfAlignCount) + "/3 " + (diagMTFOK ? "PASS" : "FAIL"), 
         text_color=diagMTFOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    dirText = diagIsBull ? "^ BULL" : diagIsBear ? "v BEAR" : "MIXED"
    dirOK = diagIsBull or diagIsBear
    table.cell(diagTable, 0, dRow, "Direction", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, dirText + " " + (dirOK ? "PASS" : "FAIL"), 
         text_color=dirOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    entryShortDiag = str.contains(entryZoneQuality, "HOT") ? "HOT" : str.contains(entryZoneQuality, "OPTIMAL") ? "OPT" : str.contains(entryZoneQuality, "ACCEPTABLE") ? "ACC" : str.contains(entryZoneQuality, "DEEP") ? "DEEP" : "EXT"
    table.cell(diagTable, 0, dRow, "Entry Zone", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, entryShortDiag + " " + (diagEntryOK ? "PASS" : "FAIL"), 
         text_color=diagEntryOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    effOK = rawEfficiency >= efficiencyThreshold
    table.cell(diagTable, 0, dRow, "Efficiency >=" + str.tostring(math.round(efficiencyThreshold * 100)) + "%", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(math.round(rawEfficiency * 100)) + "% " + (effOK ? "PASS" : "FAIL"), 
         text_color=effOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    persistOK = barsAboveThreshold >= upgradePersistence
    table.cell(diagTable, 0, dRow, "Persistence", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(barsAboveThreshold) + "/" + str.tostring(upgradePersistence) + " " + (persistOK ? "PASS" : "WAIT"), 
         text_color=persistOK ? color.rgb(34, 171, 148) : color.rgb(234, 179, 8),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // DISARM TRIGGERS
    table.cell(diagTable, 0, dRow, "--- DISARM TRIGGERS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    scoreDropped = isArmed and (overallScore < (armedScore - disarmScoreThreshold))
    table.cell(diagTable, 0, dRow, "Score Drop >" + str.tostring(disarmScoreThreshold), 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, scoreDropped ? "YES !!" : "NO OK", 
         text_color=scoreDropped ? color.rgb(239, 83, 80) : color.rgb(100, 100, 120),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "Structural Damage", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, structuralDamage ? "YES !!" : "NO OK", 
         text_color=structuralDamage ? color.rgb(239, 83, 80) : color.rgb(100, 100, 120),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // ALERT STATUS
    table.cell(diagTable, 0, dRow, "--- ALERT STATUS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    wouldArmLong = not wasArmed and isArmed and armedDirection == 1
    wouldArmShort = not wasArmed and isArmed and armedDirection == -1
    wouldDisarm = wasArmed and not isArmed
    alertWouldFire = wouldArmLong or wouldArmShort or wouldDisarm
    
    diagConfirmed = barstate.isconfirmed
    table.cell(diagTable, 0, dRow, "Bar Confirmed", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, diagConfirmed ? "YES" : "PENDING", 
         text_color=diagConfirmed ? color.rgb(34, 197, 94) : color.rgb(234, 179, 8), text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    string alertTypeText = na
    if alertWouldFire and not diagConfirmed
        alertTypeText := wouldArmLong ? "ARMED ^ (at close)" : wouldArmShort ? "ARMED v (at close)" : "DISARMED (at close)"
    else if alertWouldFire and diagConfirmed
        alertTypeText := wouldArmLong ? "ARMED ^ FIRED" : wouldArmShort ? "ARMED v FIRED" : "DISARMED FIRED"
    else
        alertTypeText := "NO CHANGE"
    alertTypeColor = wouldArmLong or wouldArmShort ? color.rgb(34, 197, 94) : wouldDisarm ? color.rgb(239, 83, 80) : color.gray
    
    table.cell(diagTable, 0, dRow, "ARMED Would Fire", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, alertTypeText, 
         text_color=alertTypeColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    candidateText = contextJustCandidateLong ? "CANDIDATE ^" : contextJustCandidateShort ? "CANDIDATE v" : candidateMeets ? "ACTIVE" : "NO"
    candidateColor = contextJustCandidate ? color.rgb(234, 179, 8) : candidateMeets ? color.rgb(100, 149, 237) : color.gray
    table.cell(diagTable, 0, dRow, "CANDIDATE Would Fire", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, candidateText, 
         text_color=candidateColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)

// v2.5.0: Institutional alert system using f_buildAlert()

// ============================================================================
// REGISTER ALERT CONDITIONS (4-Emoji Standard)
// ============================================================================
// Note: alertcondition() messages are static templates.
// Dynamic reason codes require alert() function (below).

// ALERT 0: Candidate (Long) - Quality detected, intra-bar
alertcondition(enableContextCandidate and contextJustCandidateLong, 
     title="CANDIDATE Long",
     message='ðŸŸ¡ [C] CANDIDATE | {{ticker}} | R-TRANSITION | K-NORMAL | CONDITIONAL')

// ALERT 0: Candidate (Short) - Quality detected, intra-bar
alertcondition(enableContextCandidate and contextJustCandidateShort, 
     title="CANDIDATE Short",
     message='ðŸŸ¡ [C] CANDIDATE | {{ticker}} | R-TRANSITION | K-NORMAL | CONDITIONAL')

// ALERT 1: Armed (Long) - Full permission, bar close confirmed
alertcondition(enableContextArmed and contextJustArmedLong and barstate.isconfirmed, 
     title="ARMED Long",
     message='ðŸŸ¢ [A] ARMED | {{ticker}} | R-EXPANSION | K-NORMAL | FULL')

// ALERT 2: Armed (Short) - Full permission, bar close confirmed
alertcondition(enableContextArmed and contextJustArmedShort and barstate.isconfirmed, 
     title="ARMED Short",
     message='ðŸŸ¢ [A] ARMED | {{ticker}} | R-EXPANSION | K-NORMAL | FULL')

// ALERT 3: Blocked - Explicit veto, bar close confirmed
alertcondition(enableContextDisarmed and contextJustDisarmed and barstate.isconfirmed, 
     title="BLOCKED",
     message='ðŸ”´ [B] BLOCKED | {{ticker}} | R-COMPRESSION | STAND_DOWN')

// ALERT 4: Info - Session reset, context only
alertcondition(enableSessionReset and sessionResetEvent, 
     title="INFO Session Reset",
     message='âšª [I] INFO | {{ticker}} | SESSION_RESET')

// ============================================================================
// DETAILED ALERTS (alert() function - Institutional Format)
// ============================================================================
// Uses Priority Resolver variables: resolvedAlertType, primaryReason,
// finalPermission, resolvedExecution, riskCode, contributingStr
// Format: Scan line + em-dash + audit body

useAlertPerBar = alertMode == "alert() per bar"
useAlertBarClose = alertMode == "alert() bar close"
alertFreq = useAlertBarClose ? alert.freq_once_per_bar_close : alert.freq_once_per_bar

// State change detection for alert firing
stateChanged = contextJustCandidateLong or contextJustCandidateShort or contextJustArmedLong or contextJustArmedShort or contextJustDisarmed or sessionResetEvent

if useAlertPerBar or useAlertBarClose
    if enableContextCandidate and contextJustCandidateLong
        alert(
             f_buildAlert(
                 resolvedAlertType == ALERT_BLOCKED ? ALERT_BLOCKED : ALERT_CANDIDATE,
                 syminfo.ticker,
                 primaryReason,
                 contributingStr,
                 finalPermission,
                 resolvedAlertType == ALERT_BLOCKED ? EXECUTION_NONE : resolvedExecution,
                 riskCode,
                 math.round(overallScore)
             ),
             alert.freq_once_per_bar
         )
    
    if enableContextCandidate and contextJustCandidateShort
        alert(
             f_buildAlert(
                 resolvedAlertType == ALERT_BLOCKED ? ALERT_BLOCKED : ALERT_CANDIDATE,
                 syminfo.ticker,
                 primaryReason,
                 contributingStr,
                 finalPermission,
                 resolvedAlertType == ALERT_BLOCKED ? EXECUTION_NONE : resolvedExecution,
                 riskCode,
                 math.round(overallScore)
             ),
             alert.freq_once_per_bar
         )
    
    if enableContextArmed and contextJustArmedLong and barstate.isconfirmed
        alert(
             f_buildAlert(
                 resolvedAlertType,
                 syminfo.ticker,
                 primaryReason,
                 contributingStr,
                 finalPermission,
                 resolvedExecution,
                 riskCode,
                 math.round(overallScore)
             ),
             alertFreq
         )
    
    if enableContextArmed and contextJustArmedShort and barstate.isconfirmed
        alert(
             f_buildAlert(
                 resolvedAlertType,
                 syminfo.ticker,
                 primaryReason,
                 contributingStr,
                 finalPermission,
                 resolvedExecution,
                 riskCode,
                 math.round(overallScore)
             ),
             alertFreq
         )
    
    if enableContextDisarmed and contextJustDisarmed and barstate.isconfirmed
        alert(
             f_buildAlert(
                 ALERT_BLOCKED,
                 syminfo.ticker,
                 primaryReason,
                 contributingStr,
                 finalPermission,
                 EXECUTION_NONE,
                 riskCode,
                 math.round(overallScore)
             ),
             alertFreq
         )
    
    if enableSessionReset and sessionResetEvent
        alert(
             f_buildAlert(
                 ALERT_INFO,
                 syminfo.ticker,
                 "SESSION_RESET",
                 "U-SESSION-" + currentSession,
                 "STAND_DOWN",
                 EXECUTION_NONE,
                 riskCode,
                 math.round(overallScore)
             ),
             alert.freq_once_per_bar
         )

// ============================================================================
// END OF UTCC METALS v2.5.1
// ============================================================================
