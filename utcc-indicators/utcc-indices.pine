//@version=6
indicator("UTCC Indices v2.5.1 - Institutional", 
     shorttitle="Indices", 
     overlay=true, 
     max_labels_count=100,
     max_lines_count=100)

// ============================================================================
// UTCC INDICES v2.5.1 - INSTITUTIONAL
// ============================================================================
// Version: 2.5.1 - Governance Hardening (Phase 4)
// 
// v2.5.1 CHANGES (Phase 4 - Governance Hardening):
// - NEW: Defensive invariant after resolver â€” fail-closed if regime is
//        STAND_DOWN, forces BLOCKED + EXECUTION_NONE regardless of resolver
// - FIX: disarmReason now wired into BLOCKED alert contributing reasons
//        (U-DISARM-EMA, U-DISARM-MTF, U-DISARM-EFFICIENCY)
// - KEEP: All Phase 1 + Phase 2 changes from v2.5.0
//
// v2.5.0 CHANGES (Phase 1 - Alert System Refactoring):
// - NEW: Institutional Priority Resolver (Regime > Risk > UTCC authority stack)
// - NEW: Risk Governor input (NORMAL/REDUCED/LOCKED) from Command Centre
// - NEW: Alert builder functions (f_alertHeader, f_alertBody, f_buildAlert)
// - NEW: 4-emoji standard (ARMED/CANDIDATE/BLOCKED/INFO)
// - NEW: Reason-code system (R-series regime, K-series risk, U-series UTCC)
// - NEW: Severity prefix [A]/[C]/[B]/[I] on all scan lines
// - NEW: Em-dash separated header/body format for Discord mobile
// - NEW: asset_class = "INDICES" in JSON payload
// - FIX: ARMED threshold default 75 (was 80) per audit spec
// - FIX: CANDIDATE threshold default 80 (was 85) per audit spec
// - FIX: DISARMED renamed to BLOCKED per institutional taxonomy
// - FIX: RESET reclassified as INFO alert type
// - REMOVE: buildJsonPayload() replaced by f_buildAlert()
// - REMOVE: buildDetailMsg() replaced by f_buildAlert()
// - KEEP: All 4-criteria evaluation logic untouched
// - KEEP: All scoring system weights/calculations untouched
// - KEEP: Session lock arm/disarm mechanics untouched
// - KEEP: ATR hierarchy detection untouched
// - KEEP: All multi-timeframe calculations untouched
//
// v2.4.0 CHANGES:
// - Full 4-tier table display ported from Forex Rolls-Royce
// - Standard mode: Score Breakdown, Volatility Analysis, Risk Management,
//        Trend Details, S/R Proximity, Entry Zone Analysis sections
// - Full mode: RSI multi-timeframe detail, Price Action section
// - Alert Diagnostics panel (toggle via settings)
// - Context row with session + timer + spread combined
// - Invalidation-based stop/target/R:R calculations (points display)
// - volExplanation, trendExplanation, adxInterpretation helpers
// - All computed data now reaches the screen (was skeletal)
// - All calibrations, instrument detection, risk settings untouched
//
// v2.1.0 FEATURES:
// - Auto-calibration using Daily ATR% (symbol-agnostic)
// - 4 volatility buckets: LOW/NORMAL/HIGH/EXTREME
// - Region-aware sessions (US/EU/UK/ASIA/AU)
// - Market open caution (first 30 mins spike protection)
// - Earnings season warning (Jan/Apr/Jul/Oct)
// - FOMC day manual toggle
// - ARMED/DISARMED/CANDIDATE/SESSION RESET alerts
// - Session Lock with playbook system
// - Legacy mode available for original per-index rules
//
// WATCHLIST:
// US: US30USD, US2000USD, SPX500USD, NAS100USD, CN50USD
// EU: DE30EUR, EU50EUR, FR40EUR
// UK: UK100GBP
// ASIA: JP225JPY, JP225USD, HK33HKD
// AU: AU200AUD
// ============================================================================

// ============================================================================
// INSTRUMENT DETECTION & REGION ASSIGNMENT
// ============================================================================
tkr = str.upper(syminfo.ticker)
base = str.upper(syminfo.basecurrency)

// US Indices
isUS500 = str.contains(tkr, "SPX500") or str.contains(tkr, "US500") or str.contains(tkr, "SP500")
isNAS100 = str.contains(tkr, "NAS100") or str.contains(tkr, "US100") or str.contains(tkr, "USTEC") or str.contains(tkr, "NDX")
isUS30 = str.contains(tkr, "US30") or str.contains(tkr, "DJ30") or str.contains(tkr, "DOW")
isUS2000 = str.contains(tkr, "US2000") or str.contains(tkr, "RUS2000") or str.contains(tkr, "RUSSELL") or str.contains(tkr, "RTY")

// EU Indices
isDE30 = str.contains(tkr, "DE30") or str.contains(tkr, "DE40") or str.contains(tkr, "GER30") or str.contains(tkr, "GER40") or str.contains(tkr, "DAX")
isEU50 = str.contains(tkr, "EU50") or str.contains(tkr, "EUSTX50") or str.contains(tkr, "STOXX")
isFR40 = str.contains(tkr, "FR40") or str.contains(tkr, "FRA40") or str.contains(tkr, "CAC")

// UK Indices
isUK100 = str.contains(tkr, "UK100") or str.contains(tkr, "FTSE")

// Asia Indices
isJP225 = str.contains(tkr, "JP225") or str.contains(tkr, "JPN225") or str.contains(tkr, "NK225") or str.contains(tkr, "NIKKEI")
isHK33 = str.contains(tkr, "HK33") or str.contains(tkr, "HKG33") or str.contains(tkr, "HSI")
isCN50 = str.contains(tkr, "CN50") or str.contains(tkr, "CHN50") or str.contains(tkr, "CHINA50") or str.contains(tkr, "A50")

// AU Indices
isAU200 = str.contains(tkr, "AU200") or str.contains(tkr, "AUS200") or str.contains(tkr, "ASX")

// Region detection
isUSIndex = isUS500 or isNAS100 or isUS30 or isUS2000
isEUIndex = isDE30 or isEU50 or isFR40
isUKIndex = isUK100
isAsiaIndex = isJP225 or isHK33 or isCN50
isAUIndex = isAU200
isKnownIndex = isUSIndex or isEUIndex or isUKIndex or isAsiaIndex or isAUIndex

// Region assignment
var string region = "UNKNOWN"
if isUSIndex
    region := "US"
else if isEUIndex
    region := "EU"
else if isUKIndex
    region := "UK"
else if isAsiaIndex
    region := "ASIA"
else if isAUIndex
    region := "AU"
else
    region := "OTHER"

// Index name for display
var string indexName = "INDEX"
if isUS500
    indexName := "S&P 500"
else if isNAS100
    indexName := "NASDAQ 100"
else if isUS30
    indexName := "DOW 30"
else if isUS2000
    indexName := "RUSSELL 2000"
else if isDE30
    indexName := "DAX 40"
else if isEU50
    indexName := "EURO STOXX 50"
else if isFR40
    indexName := "CAC 40"
else if isUK100
    indexName := "FTSE 100"
else if isJP225
    indexName := "NIKKEI 225"
else if isHK33
    indexName := "HANG SENG"
else if isCN50
    indexName := "CHINA A50"
else if isAU200
    indexName := "ASX 200"
else
    indexName := syminfo.ticker

// Short name for display
indexShort = isUS500 ? "SPX" : isNAS100 ? "NAS" : isUS30 ? "US30" : isUS2000 ? "RUT" : isDE30 ? "DAX" : isEU50 ? "EU50" : isFR40 ? "CAC" : isUK100 ? "FTSE" : isJP225 ? "NKY" : isHK33 ? "HSI" : isCN50 ? "A50" : isAU200 ? "ASX" : base

// ============================================================================
// INPUTS - DISPLAY SETTINGS
// ============================================================================
GRP_DISPLAY = "ðŸŽ¨ Display Settings"
displayMode = input.string("Compact", "Display Mode", 
     options=["Minimal", "Compact", "Standard", "Full"], 
     group=GRP_DISPLAY,
     tooltip="Minimal=Status only | Compact=Status+Checklist | Standard=+Key details | Full=Everything")
panelPosition = input.string("Top Right", "Panel Position", 
     options=["Top Left", "Top Right", "Bottom Left", "Bottom Right"], 
     group=GRP_DISPLAY)
panelSize = input.string("Medium", "Panel Size", 
     options=["Small", "Medium", "Large"], 
     group=GRP_DISPLAY)

// ============================================================================
// INPUTS - VISUAL CUSTOMISATION
// ============================================================================
GRP_VISUAL = "ðŸŽ¨ Visual Customisation"

headerFontSize = input.string("Normal", "Header Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
statusFontSize = input.string("Large", "Status Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
dataFontSize = input.string("Small", "Data Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)
scoreFontSize = input.string("Normal", "Score Font Size", 
     options=["Tiny", "Small", "Normal", "Large", "Huge"], 
     group=GRP_VISUAL)

borderWidth = input.int(1, "Border Width", minval=0, maxval=10, group=GRP_VISUAL)
frameWidth = input.int(2, "Frame Width", minval=0, maxval=10, group=GRP_VISUAL)
panelTransparency = input.int(0, "Background Transparency", minval=0, maxval=100, group=GRP_VISUAL)
borderTransparency = input.int(0, "Border Transparency", minval=0, maxval=100, group=GRP_VISUAL)

debugMode = input.bool(false, "ðŸ”§ Force Test Alerts", group=GRP_VISUAL)
showAlertDiagnostics = input.bool(false, "ðŸ” Alert Diagnostics Panel", group=GRP_VISUAL)

// ============================================================================
// INPUTS - CRITERIA THRESHOLDS (4 CRITERIA)
// ============================================================================
GRP_CRITERIA = "âœ… 4-Criteria Thresholds"

minTrendScore = input.int(80, "1ï¸âƒ£ Min Trend Score", minval=60, maxval=100, 
     group=GRP_CRITERIA,
     tooltip="Indices require 80 minimum for quality setups")

acceptTrend = input.bool(true, "3ï¸âƒ£ Accept: TREND", group=GRP_CRITERIA, inline="vol1")
acceptExplode = input.bool(true, "EXPLODE (with rules)", group=GRP_CRITERIA, inline="vol1")
explodeMinPercentile = input.int(20, "EXPLODE Min %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol2")
explodeMaxPercentile = input.int(80, "EXPLODE Max %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol2")
acceptQuiet = input.bool(false, "Accept: QUIET (with rules)", group=GRP_CRITERIA, inline="vol3",
     tooltip="QUIET disabled by default - index consolidations break violently")
quietMinPercentile = input.int(30, "QUIET Min %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol4")
quietMaxPercentile = input.int(70, "QUIET Max %ile", minval=0, maxval=100, group=GRP_CRITERIA, inline="vol4")

useAutoATR = input.bool(true, "Use Auto-Calibrated ATR Filter", group=GRP_CRITERIA)
manualATRFilter = input.int(50, "Manual ATR Filter %", minval=0, maxval=150, step=5, group=GRP_CRITERIA)
var float atrFilterPercent = na  // assigned after calibration block

// ============================================================================
// INPUTS - INDEX RISK SETTINGS
// ============================================================================
GRP_RISK = "âš ï¸ Index Risk Settings"

enableEarningsWarning = input.bool(true, "Enable Earnings Season Warning", 
     group=GRP_RISK,
     tooltip="Flags Jan/Apr/Jul/Oct as elevated risk periods")

enableOpenCaution = input.bool(true, "Enable Market Open Caution", 
     group=GRP_RISK,
     tooltip="First 30 minutes after cash open = spike risk")

isFomcDay = input.bool(false, "FOMC Day (Manual Toggle)", 
     group=GRP_RISK,
     tooltip="Enable on Fed announcement days - blocks trading")

// ============================================================================
// INPUTS - RISK GOVERNOR (v2.5.0 Institutional)
// ============================================================================
GRP_RISK_GOV = "Risk Governor"
riskGovernorState = input.string("NORMAL", "Risk State",
     options=["NORMAL", "REDUCED", "LOCKED"],
     group=GRP_RISK_GOV,
     tooltip="Set from Command Centre.\nNORMAL: Full trading\nREDUCED: -3% drawdown or 2+ consecutive losses\nLOCKED: -5% drawdown or circuit breaker")

// ============================================================================
// INPUTS - EXECUTION CONTEXT
// ============================================================================
GRP_CONTEXT = "â° Execution Context"

showSessionInfo = input.bool(true, "Show Session Indicator", group=GRP_CONTEXT)
showBarTimer = input.bool(true, "Show Time to Bar Close", group=GRP_CONTEXT)
barTimerCritical = input.int(5, "ðŸ”´ Critical Warning (min)", minval=1, maxval=30, group=GRP_CONTEXT)
barTimerWarning = input.int(15, "ðŸŸ¡ Warning (min)", minval=1, maxval=60, group=GRP_CONTEXT)
barTimerCaution = input.int(30, "ðŸŸ  Caution (min)", minval=1, maxval=120, group=GRP_CONTEXT)
showSpreadMonitor = input.bool(true, "Show Spread Monitor", group=GRP_CONTEXT)
spreadWarningMultiplier = input.float(1.5, "Spread Warning Multiplier", minval=1.0, maxval=3.0, step=0.1, group=GRP_CONTEXT)

// ============================================================================
// INPUTS - SCORING SYSTEM
// ============================================================================
GRP_SCORE = "ðŸ“Š Scoring System"
minTradeScore = input.int(80, "Min Score for TRADE", minval=60, maxval=95, group=GRP_SCORE)
minCautionScore = input.int(70, "Min Score for CAUTION", minval=50, maxval=80, group=GRP_SCORE)

// ============================================================================
// INPUTS - EMA TREND SETTINGS
// ============================================================================
GRP_TREND = "ðŸ“ˆ Trend Settings"
fastLength = input.int(9, "Fast EMA", minval=1, group=GRP_TREND)
midLength = input.int(21, "Mid EMA", minval=1, group=GRP_TREND)
slowLength = input.int(50, "Slow EMA", minval=1, group=GRP_TREND)
trendLength = input.int(200, "HTF Trend EMA", minval=1, group=GRP_TREND)
adxLength = input.int(14, "ADX Length", minval=1, group=GRP_TREND)
adxThreshold = input.int(16, "ADX Threshold", minval=10, maxval=50, group=GRP_TREND,
     tooltip="Manual fallback ADX threshold (used only when Auto ADX is OFF).")
useAutoADX = input.bool(true, "Use Auto-Calibrated ADX", group=GRP_TREND,
     tooltip="Auto mode uses bucket-calibrated ADX; Legacy mode uses per-index rules.")

mtf1 = input.timeframe("60", "MTF 1", group=GRP_TREND)
mtf2 = input.timeframe("240", "MTF 2", group=GRP_TREND)
mtf3 = input.timeframe("D", "MTF 3", group=GRP_TREND)

// ============================================================================
// INPUTS - ATR VOLATILITY SETTINGS
// ============================================================================
GRP_ATR = "âš¡ Volatility Settings"
atrLength = input.int(14, "ATR Length", minval=1, group=GRP_ATR)
atrPercentileLookback = input.int(252, "ATR Percentile Lookback", minval=50, maxval=1000, group=GRP_ATR)
atrBaseline = input.int(50, "ATR Baseline Length", minval=10, maxval=200, group=GRP_ATR)
sepTolerance = input.float(0.20, "Separation Tolerance", minval=0.01, maxval=0.50, step=0.01, group=GRP_ATR)
eqTolerance = input.float(0.40, "Equality Tolerance", minval=0.05, maxval=0.50, step=0.01, group=GRP_ATR)

// ============================================================================
// ðŸ§© INDEX CALIBRATION PROFILE (AUTO via Daily ATR%)
// ============================================================================
GRP_CAL = "ðŸ§© Index Calibration"

calibMode = input.string("Auto (ATR% of Price)", "Calibration Mode",
     options=["Auto (ATR% of Price)", "Legacy (per-index rules)"],
     group=GRP_CAL,
     tooltip="Auto scales thresholds for ANY index using Daily ATR as % of price. Legacy keeps per-index style rules.")

// --- Daily ATR% (symbol-agnostic) using PREVIOUS completed daily values ---
dATR = request.security(syminfo.tickerid, "D", ta.atr(atrLength)[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dClose = request.security(syminfo.tickerid, "D", close[1], gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrPctD = dClose > 0 ? (dATR / dClose) * 100.0 : na

// --- Auto-calibrated outputs ---
var float autoATRFilter = na
var float autoEntryHot = na
var float autoEntryOptimal = na
var float autoEntryAcceptable = na
var float autoSRDanger = na
var float autoADXThreshold = na

// Defaults (NORMAL bucket)
autoATRFilter := 50.0
autoEntryHot := 0.5
autoEntryOptimal := 0.9
autoEntryAcceptable := 1.3
autoSRDanger := 0.35
autoADXThreshold := 16.0

if calibMode == "Legacy (per-index rules)"
    // Legacy behaviour - per-index calibration
    // NAS100/US2000/HK33/CN50 = high vol; SPX/UK100/AU200/EU50 = lower vol
    if isNAS100 or isUS2000 or isHK33 or isCN50
        autoATRFilter := 45.0
        autoEntryHot := 0.7
        autoEntryOptimal := 1.2
        autoEntryAcceptable := 1.8
        autoSRDanger := 0.5
        autoADXThreshold := 15.0
    else if isUS30 or isDE30 or isJP225
        autoATRFilter := 50.0
        autoEntryHot := 0.6
        autoEntryOptimal := 1.0
        autoEntryAcceptable := 1.5
        autoSRDanger := 0.4
        autoADXThreshold := 16.0
    else
        // SPX, UK100, AU200, EU50, FR40 - lower vol
        autoATRFilter := 55.0
        autoEntryHot := 0.5
        autoEntryOptimal := 0.9
        autoEntryAcceptable := 1.3
        autoSRDanger := 0.35
        autoADXThreshold := 17.0
else
    // Auto mode: map Daily ATR% buckets to thresholds
    // Index buckets are MUCH tighter than crypto (indices typically 0.5-1.5% daily)
    if not na(atrPctD)
        if atrPctD < 0.5
            // Low vol / dead market / holiday
            autoATRFilter := 40.0
            autoEntryHot := 0.3
            autoEntryOptimal := 0.6
            autoEntryAcceptable := 1.0
            autoSRDanger := 0.25
            autoADXThreshold := 18.0
        else if atrPctD < 1.0
            // Normal vol (typical index day)
            autoATRFilter := 50.0
            autoEntryHot := 0.5
            autoEntryOptimal := 0.9
            autoEntryAcceptable := 1.3
            autoSRDanger := 0.35
            autoADXThreshold := 16.0
        else if atrPctD < 1.5
            // High vol (news / earnings / Fed)
            autoATRFilter := 55.0
            autoEntryHot := 0.6
            autoEntryOptimal := 1.0
            autoEntryAcceptable := 1.5
            autoSRDanger := 0.40
            autoADXThreshold := 15.0
        else
            // Extreme vol (crisis / flash crash)
            autoATRFilter := 60.0
            autoEntryHot := 0.7
            autoEntryOptimal := 1.2
            autoEntryAcceptable := 1.8
            autoSRDanger := 0.50
            autoADXThreshold := 14.0

// --- Diagnostics: active calibration bucket ---
var string calibBucket = "DEFAULT"

if not na(atrPctD)
    if atrPctD < 0.5
        calibBucket := "LOW"
    else if atrPctD < 1.0
        calibBucket := "NORMAL"
    else if atrPctD < 1.5
        calibBucket := "HIGH"
    else
        calibBucket := "EXTREME"
else
    calibBucket := "DEFAULT"

// Build display string
var string calibDisplay = ""

if calibMode == "Legacy (per-index rules)"
    calibDisplay := "Legacy: " + indexShort
else
    if na(atrPctD)
        calibDisplay := "Auto: DEFAULT (no D data)"
    else
        calibDisplay := "Auto: " + calibBucket + " (" + str.tostring(atrPctD, "#.##") + "%)"

// Final ATR filter threshold
atrFilterPercent := useAutoATR ? autoATRFilter : manualATRFilter

// Effective ADX threshold
effectiveADXThreshold = useAutoADX ? autoADXThreshold : adxThreshold

// ============================================================================
// INPUTS - ALERT SETTINGS (v2.0 CONTEXT ALERTS)
// ============================================================================
GRP_ALERTS = "ðŸ”” Context Alerts (v2.0)"

alertMode = input.string("alertcondition", "Alert Mode",
     options=["alertcondition", "alert() per bar", "alert() bar close"],
     group=GRP_ALERTS)

enableContextCandidate = input.bool(true, "CONTEXT CANDIDATE Alert", group=GRP_ALERTS)
enableContextArmed = input.bool(true, "CONTEXT ARMED Alert", group=GRP_ALERTS)
enableContextDisarmed = input.bool(true, "CONTEXT DISARMED Alert", group=GRP_ALERTS)
enableSessionReset = input.bool(true, "SESSION RESET Alert", group=GRP_ALERTS)

alertStrongThreshold = input.int(75, "ARMED Threshold", minval=70, maxval=90, group=GRP_ALERTS)
candidateThreshold = input.int(80, "CANDIDATE Threshold", minval=70, maxval=95, group=GRP_ALERTS)

alertPerfectThreshold = 85

// ============================================================================
// INPUTS - SESSION LOCK (v2.0)
// ============================================================================
GRP_LOCK = "ðŸ”’ Session Lock (v2.0)"

enableSessionLock = input.bool(true, "Enable Session Lock", group=GRP_LOCK)
disarmScoreThreshold = input.int(10, "Disarm Score Drop", minval=5, maxval=20, step=1, group=GRP_LOCK)
efficiencyThreshold = input.float(0.4, "Min Directional Efficiency", minval=0.1, maxval=0.8, step=0.05, group=GRP_LOCK)
upgradePersistence = input.int(2, "Upgrade Persistence (bars)", minval=1, maxval=5, group=GRP_LOCK)

mtfDegradationScoreThreshold = input.int(75, "4H Score Warning Level", minval=60, maxval=85, group=GRP_ALERTS)

strongEntryRequirement = input.string("HOT/OPTIMAL", "Entry Zone for ARMED Alerts", 
     options=["HOT/OPTIMAL", "Include ACCEPTABLE", "Any Zone"],
     group=GRP_ALERTS)

riskSpreadMultiplier = input.float(2.0, "Spread Spike Threshold", minval=1.5, maxval=5.0, step=0.5, group=GRP_ALERTS)

// ============================================================================
// ALERT MESSAGE CONTENT
// ============================================================================
GRP_MSG = "ðŸ“ Alert Message Content"
msgShowPair = input.bool(true, "Show Pair", group=GRP_MSG, inline="msg1")
msgShowScore = input.bool(true, "Show Score", group=GRP_MSG, inline="msg1")
msgShowTrend = input.bool(true, "Show Trend Score", group=GRP_MSG, inline="msg1")
msgShowEntry = input.bool(true, "Show Entry Zone", group=GRP_MSG, inline="msg2")
msgShowMTF = input.bool(true, "Show MTF Count", group=GRP_MSG, inline="msg2")
msgShowRSI = input.bool(true, "Show RSI Count", group=GRP_MSG, inline="msg2")
msgShowATR = input.bool(false, "Show ATR State", group=GRP_MSG, inline="msg3")
msgShowSession = input.bool(false, "Show Session", group=GRP_MSG, inline="msg3")
msgShowTimeframe = input.bool(false, "Show Timeframe", group=GRP_MSG, inline="msg3")

// ============================================================================
// INPUTS - ALERT QUALITY FILTERS
// ============================================================================
GRP_FILTERS = "ðŸŽšï¸ Alert Quality Filters"

srProximityFilter = input.float(0.0, "Min S/R Distance (ATR)", minval=0.0, maxval=3.0, step=0.1, group=GRP_FILTERS)
scoreGapRequired = input.int(0, "Score Gap Above Threshold", minval=0, maxval=20, step=1, group=GRP_FILTERS)
atrPercentileFloor = input.int(0, "Min ATR Percentile", minval=0, maxval=50, step=5, group=GRP_FILTERS)

// ============================================================================
// INPUTS - RSI MOMENTUM SETTINGS
// ============================================================================
GRP_RSI = "ðŸ’¨ Momentum Settings"
rsiLength = input.int(14, "RSI Length", minval=1, group=GRP_RSI)
rsiOverbought = input.int(70, "RSI Overbought", minval=50, maxval=90, group=GRP_RSI)
rsiOversold = input.int(30, "RSI Oversold", minval=10, maxval=50, group=GRP_RSI)

// ============================================================================
// INPUTS - STYLE CUSTOMISATION
// ============================================================================
GRP_STYLE = "ðŸŽ¨ Colours & Style"

colorTradeGreen = input.color(color.rgb(0, 200, 0), "Trade Ready", group=GRP_STYLE)
colorCautionOrange = input.color(color.rgb(255, 165, 0), "Caution", group=GRP_STYLE)
colorNoTradeRed = input.color(color.rgb(220, 20, 20), "No Trade", group=GRP_STYLE)
colorPass = input.color(color.rgb(34, 171, 148), "Pass", group=GRP_STYLE)
colorFail = input.color(color.rgb(239, 83, 80), "Fail", group=GRP_STYLE)
colorHeader = input.color(color.rgb(64, 115, 122), "Header BG", group=GRP_STYLE)
colorBody = input.color(color.rgb(45, 52, 58), "Body BG", group=GRP_STYLE)
colorText = input.color(color.white, "Text", group=GRP_STYLE)

// ============================================================================
// ðŸ“Š CALCULATIONS: EMA TREND SYSTEM
// ============================================================================

fastEMA = ta.ema(close, fastLength)
midEMA = ta.ema(close, midLength)
slowEMA = ta.ema(close, slowLength)
trendEMA = ta.ema(close, trendLength)

trendSlope = trendEMA - trendEMA[5]
trendSlopeUp = trendSlope > 0
trendSlopeDown = trendSlope < 0

dirmov(len) =>
    up = ta.change(high)
    down = -ta.change(low)
    plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
    minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
    truerange = ta.rma(ta.tr, len)
    plus = fixnan(100 * ta.rma(plusDM, len) / truerange)
    minus = fixnan(100 * ta.rma(minusDM, len) / truerange)
    [plus, minus]

[diPlus, diMinus] = dirmov(adxLength)
adxValue = 100 * ta.rma(math.abs(diPlus - diMinus) / (diPlus + diMinus == 0 ? 1 : diPlus + diMinus), adxLength)

mtf1Bullish = request.security(syminfo.tickerid, mtf1, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
mtf2Bullish = request.security(syminfo.tickerid, mtf2, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
mtf3Bullish = request.security(syminfo.tickerid, mtf3, ta.ema(close, fastLength) > ta.ema(close, slowLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

mtfBullCount = (mtf1Bullish ? 1 : 0) + (mtf2Bullish ? 1 : 0) + (mtf3Bullish ? 1 : 0)
mtfBearCount = (not mtf1Bullish ? 1 : 0) + (not mtf2Bullish ? 1 : 0) + (not mtf3Bullish ? 1 : 0)
mtfFullAlignment = mtfBullCount == 3 or mtfBearCount == 3
mtfAlignmentBullish = mtfBullCount == 3

mtfAlignCount = mtfAlignmentBullish ? 3 : mtfBearCount == 3 ? 3 : math.max(mtfBullCount, mtfBearCount)

bullishEMAStack = fastEMA > midEMA and midEMA > slowEMA
bearishEMAStack = fastEMA < midEMA and midEMA < slowEMA
priceAboveTrend = close > trendEMA
priceBelowTrend = close < trendEMA

// Trend Score (0-100)
trendScore = 0.0

if bullishEMAStack
    trendScore += 20
    if priceAboveTrend
        trendScore += 10
    if trendSlopeUp
        trendScore += 10
else if bearishEMAStack
    trendScore += 20
    if priceBelowTrend
        trendScore += 10
    if trendSlopeDown
        trendScore += 10

// ADX component
if adxValue >= 25
    trendScore += 20
else if adxValue >= effectiveADXThreshold
    trendScore += 15
else if adxValue >= 12
    trendScore += 8

// MTF alignment
if mtfFullAlignment
    trendScore += 20
else if mtfBullCount >= 2 or mtfBearCount >= 2
    trendScore += 10

// Slope + HTF confirmation
if (mtfAlignmentBullish and trendSlopeUp and priceAboveTrend) or (mtfBearCount == 3 and trendSlopeDown and priceBelowTrend)
    trendScore += 20
else if trendSlopeUp or trendSlopeDown
    trendScore += 10

trendScore := math.min(100, trendScore)

// ============================================================================
// âš¡ CALCULATIONS: ATR VOLATILITY SYSTEM
// ============================================================================

atrCurrent = ta.atr(atrLength)
atrH1 = request.security(syminfo.tickerid, "60", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrH4 = request.security(syminfo.tickerid, "240", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
atrD1 = request.security(syminfo.tickerid, "D", ta.atr(atrLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

atrBaseMa = ta.ema(atrCurrent, atrBaseline)
atrFilterCurrentPercent = atrBaseMa > 0 ? (atrCurrent / atrBaseMa) * 100 : 100
atrFilterActive = atrFilterPercent == 0 ? true : atrFilterCurrentPercent >= atrFilterPercent

atrPercentile = ta.percentrank(atrD1, atrPercentileLookback)

baseCurr = ta.ema(atrCurrent, atrBaseline)
baseH1 = request.security(syminfo.tickerid, "60", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
baseH4 = request.security(syminfo.tickerid, "240", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
baseD1 = request.security(syminfo.tickerid, "D", ta.ema(ta.atr(atrLength), atrBaseline), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

rCur = baseCurr != 0 ? atrCurrent / baseCurr : atrCurrent
rH1 = baseH1 != 0 ? atrH1 / baseH1 : atrH1
rH4 = baseH4 != 0 ? atrH4 / baseH4 : atrH4
rD1 = baseD1 != 0 ? atrD1 / baseD1 : atrD1

sep = 1.0 + sepTolerance
q1s = rH1 > rCur * sep ? 1 : 0
q2s = rH4 > rH1 * sep ? 1 : 0
q3s = rD1 > rH4 * sep ? 1 : 0
e1s = rCur > rH1 * sep ? 1 : 0
e2s = rH1 > rH4 * sep ? 1 : 0
e3s = rH4 > rD1 * sep ? 1 : 0

quietStrong = q1s + q2s + q3s
explodeStrong = e1s + e2s + e3s

m1 = math.max(math.abs(rCur), math.abs(rH4))
m2 = math.max(math.abs(rH4), math.abs(rD1))
approx1 = m1 == 0 ? true : math.abs(rCur - rH4) / m1 <= eqTolerance
approx2 = m2 == 0 ? true : math.abs(rH4 - rD1) / m2 <= eqTolerance
isTrend = approx1 and approx2 and not (quietStrong >= 2 or explodeStrong >= 2)

var string atrState = "MIXED"
if quietStrong == 3
    atrState := "QUIET"
else if explodeStrong == 3
    atrState := "EXPLODE"
else if isTrend
    atrState := "TREND"
else
    atrState := "MIXED"

// ============================================================================
// ðŸ’¨ CALCULATIONS: RSI MOMENTUM SYSTEM
// ============================================================================

rsiCurrent = ta.rsi(close, rsiLength)
rsiH1 = request.security(syminfo.tickerid, "60", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiH4 = request.security(syminfo.tickerid, "240", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
rsiD1 = request.security(syminfo.tickerid, "D", ta.rsi(close, rsiLength), gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)

rsiBullCount = (rsiCurrent > 50 ? 1 : 0) + (rsiH1 > 50 ? 1 : 0) + (rsiH4 > 50 ? 1 : 0) + (rsiD1 > 50 ? 1 : 0)
rsiBearCount = (rsiCurrent < 50 ? 1 : 0) + (rsiH1 < 50 ? 1 : 0) + (rsiH4 < 50 ? 1 : 0) + (rsiD1 < 50 ? 1 : 0)
rsiAllBull = rsiBullCount == 4
rsiAllBear = rsiBearCount == 4

// ============================================================================
// ðŸ“° CALCULATIONS: INDEX RISK DETECTION
// ============================================================================

// Use bar time for historical correctness
srcTime = barstate.isrealtime ? timenow : time
utcHour = hour(srcTime, "UTC")
utcMinute = minute(srcTime, "UTC")
currentMonth = month(srcTime, "UTC")

// Earnings Season (Jan, Apr, Jul, Oct)
isEarningsSeason = (currentMonth == 1) or (currentMonth == 4) or (currentMonth == 7) or (currentMonth == 10)
earningsRiskActive = enableEarningsWarning and isEarningsSeason

// FOMC Risk (manual toggle)
fomcRiskActive = isFomcDay

// ============================================================================
// â° CALCULATIONS: SESSION DETECTION (REGION-AWARE)
// ============================================================================

var string currentSession = "Off-Hours"
var string sessionQuality = "Low"
var bool inCashSession = false
var bool inOpenCaution = false

// Use minutes since midnight for precise boundaries
utcMinOfDay = utcHour * 60 + utcMinute

// US Sessions (UTC times)
// Pre-Market: 12:00-13:29 = 720-809
// Cash Open CAUTION: 13:30-13:59 = 810-839 (exactly 30 mins)
// Cash Session: 14:00-19:59 = 840-1199
// After Hours: 20:00-21:59 = 1200-1319

// EU/UK Sessions (UTC times)
// Pre-Market: 06:00-07:59 = 360-479
// Cash Open CAUTION: 08:00-08:29 = 480-509 (exactly 30 mins)
// Cash Session: 08:30-16:29 = 510-989
// US Overlap: 13:30-16:29 = 810-989

// JP Sessions (UTC times)
// Cash Open CAUTION: 00:00-00:29 = 0-29 (exactly 30 mins)
// Cash Session: 00:30-05:59 = 30-359

// HK/CN Sessions (UTC times)
// Cash Open CAUTION: 01:30-01:59 = 90-119 (exactly 30 mins)
// Cash Session: 02:00-07:59 = 120-479

// AU Sessions (UTC times)
// Cash Open CAUTION: 00:00-00:29 = 0-29 (exactly 30 mins)
// Cash Session: 00:30-05:59 = 30-359

if region == "US"
    if utcMinOfDay >= 720 and utcMinOfDay < 810
        currentSession := "Pre-Market"
        sessionQuality := "Medium"
        inCashSession := false
        inOpenCaution := false
    else if utcMinOfDay >= 810 and utcMinOfDay < 840
        currentSession := "Cash Open"
        sessionQuality := "Caution"
        inCashSession := true
        inOpenCaution := enableOpenCaution
    else if utcMinOfDay >= 840 and utcMinOfDay < 1200
        currentSession := "Cash Session"
        sessionQuality := "High"
        inCashSession := true
        inOpenCaution := false
    else if utcMinOfDay >= 1200 and utcMinOfDay < 1320
        currentSession := "After Hours"
        sessionQuality := "Medium"
        inCashSession := false
        inOpenCaution := false
    else
        currentSession := "Off-Hours"
        sessionQuality := "Low"
        inCashSession := false
        inOpenCaution := false

else if region == "EU" or region == "UK"
    if utcMinOfDay >= 360 and utcMinOfDay < 480
        currentSession := "Pre-Market"
        sessionQuality := "Medium"
        inCashSession := false
        inOpenCaution := false
    else if utcMinOfDay >= 480 and utcMinOfDay < 510
        currentSession := "Cash Open"
        sessionQuality := "Caution"
        inCashSession := true
        inOpenCaution := enableOpenCaution
    else if utcMinOfDay >= 510 and utcMinOfDay < 810
        currentSession := "Cash Session"
        sessionQuality := "High"
        inCashSession := true
        inOpenCaution := false
    else if utcMinOfDay >= 810 and utcMinOfDay < 990
        currentSession := "US Overlap"
        sessionQuality := "High"
        inCashSession := true
        inOpenCaution := false
    else
        currentSession := "Off-Hours"
        sessionQuality := "Low"
        inCashSession := false
        inOpenCaution := false

else if region == "ASIA"
    if isJP225
        if utcMinOfDay >= 0 and utcMinOfDay < 30
            currentSession := "Cash Open"
            sessionQuality := "Caution"
            inCashSession := true
            inOpenCaution := enableOpenCaution
        else if utcMinOfDay >= 30 and utcMinOfDay < 360
            currentSession := "Cash Session"
            sessionQuality := "High"
            inCashSession := true
            inOpenCaution := false
        else
            currentSession := "Off-Hours"
            sessionQuality := "Low"
            inCashSession := false
            inOpenCaution := false
    else if isHK33 or isCN50
        if utcMinOfDay >= 90 and utcMinOfDay < 120
            currentSession := "Cash Open"
            sessionQuality := "Caution"
            inCashSession := true
            inOpenCaution := enableOpenCaution
        else if utcMinOfDay >= 120 and utcMinOfDay < 480
            currentSession := "Cash Session"
            sessionQuality := "High"
            inCashSession := true
            inOpenCaution := false
        else
            currentSession := "Off-Hours"
            sessionQuality := "Low"
            inCashSession := false
            inOpenCaution := false
    else
        currentSession := "Off-Hours"
        sessionQuality := "Low"
        inCashSession := false
        inOpenCaution := false

else if region == "AU"
    if utcMinOfDay >= 0 and utcMinOfDay < 30
        currentSession := "Cash Open"
        sessionQuality := "Caution"
        inCashSession := true
        inOpenCaution := enableOpenCaution
    else if utcMinOfDay >= 30 and utcMinOfDay < 360
        currentSession := "Cash Session"
        sessionQuality := "High"
        inCashSession := true
        inOpenCaution := false
    else
        currentSession := "Off-Hours"
        sessionQuality := "Low"
        inCashSession := false
        inOpenCaution := false

else
    currentSession := "Unknown"
    sessionQuality := "Low"
    inCashSession := false
    inOpenCaution := false

// Combined risk
var bool indexRiskHigh = false
var string indexRiskReason = ""

indexRiskHigh := fomcRiskActive or inOpenCaution

if fomcRiskActive
    indexRiskReason := "FOMC DAY"
else if inOpenCaution
    indexRiskReason := "OPEN CAUTION"
else if earningsRiskActive
    indexRiskReason := "EARNINGS SZN"
else
    indexRiskReason := "Clear"

// ============================================================================
// ðŸ“ CALCULATIONS: S/R PROXIMITY
// ============================================================================

srLookback = 100

swingHigh = ta.highest(high, srLookback)
swingLow = ta.lowest(low, srLookback)

atrValue = ta.atr(14)
distToResistance = atrValue > 0 ? (swingHigh - close) / atrValue : 10.0
distToSupport = atrValue > 0 ? (close - swingLow) / atrValue : 10.0

distToNearestSR = math.min(distToResistance, distToSupport)

tooCloseToSR = distToNearestSR < autoSRDanger
moderateProximity = distToNearestSR >= autoSRDanger and distToNearestSR < 1.5

var string srStatus = ""
var color srStatusColor = color.green

if tooCloseToSR
    srStatus := "TOO CLOSE"
    srStatusColor := color.red
else if moderateProximity
    srStatus := "MODERATE"
    srStatusColor := color.orange
else
    srStatus := "CLEAR"
    srStatusColor := color.green

var float srProximityScore = 0.0
if distToNearestSR >= 2.0
    srProximityScore := 5.0
else if distToNearestSR >= 1.5
    srProximityScore := 4.0
else if distToNearestSR >= 1.0
    srProximityScore := 3.0
else if distToNearestSR >= autoSRDanger
    srProximityScore := 2.0
else
    srProximityScore := 0.0

// ============================================================================
// ðŸŽ¯ CALCULATIONS: ENTRY ZONE ANALYSIS
// ============================================================================

distFromFastEMA = atrValue > 0 ? math.abs(close - fastEMA) / atrValue : 10.0
distFromMidEMA = atrValue > 0 ? math.abs(close - midEMA) / atrValue : 10.0

var string entryZoneQuality = ""
var float entryZoneScore = 0.0
var color entryZoneColor = color.gray

if distFromFastEMA < autoEntryHot
    entryZoneQuality := "HOT ZONE"
    entryZoneScore := 5.0
    entryZoneColor := color.lime
else if distFromFastEMA < autoEntryOptimal
    entryZoneQuality := "OPTIMAL"
    entryZoneScore := 4.0
    entryZoneColor := color.green
else if distFromFastEMA < autoEntryAcceptable
    entryZoneQuality := "ACCEPTABLE"
    entryZoneScore := 3.0
    entryZoneColor := color.yellow
else if distFromMidEMA < autoEntryOptimal
    entryZoneQuality := "DEEP PULLBACK"
    entryZoneScore := 2.0
    entryZoneColor := color.orange
else
    entryZoneQuality := "EXTENDED"
    entryZoneScore := 0.0
    entryZoneColor := color.red

// RSI Momentum Bonus
var float rsiMomentumBonus = 0.0
var string rsiMomentumStatus = ""

rsiCrossedUp = ta.crossover(rsiCurrent, 50)
rsiCrossedDown = ta.crossunder(rsiCurrent, 50)

rsiBullishMomentum = (mtfAlignmentBullish and rsiCrossedUp) or (mtfAlignmentBullish and rsiCurrent > 55)
rsiBearishMomentum = (mtfBearCount == 3 and rsiCrossedDown) or (mtfBearCount == 3 and rsiCurrent < 45)

if rsiBullishMomentum or rsiBearishMomentum
    if rsiCrossedUp or rsiCrossedDown
        rsiMomentumBonus := 2.0
        rsiMomentumStatus := "CROSSED 50"
    else
        rsiMomentumBonus := 1.0
        rsiMomentumStatus := "STRONG"
else if (mtfAlignmentBullish and rsiCurrent > 50) or (mtfBearCount == 3 and rsiCurrent < 50)
    rsiMomentumBonus := 0.5
    rsiMomentumStatus := "ALIGNED"
else
    rsiMomentumBonus := 0.0
    rsiMomentumStatus := "NEUTRAL"

entryTotalScore = entryZoneScore + rsiMomentumBonus

var string entryRating = ""
if entryTotalScore >= 6.5
    entryRating := "EXCELLENT"
else if entryTotalScore >= 5.0
    entryRating := "GOOD"
else if entryTotalScore >= 3.5
    entryRating := "FAIR"
else if entryTotalScore >= 2.0
    entryRating := "POOR"
else
    entryRating := "AVOID"

// ============================================================================
// âœ… 4-CRITERIA EVALUATION
// ============================================================================

// CRITERION 1: Trend Score >= Threshold
criterion1Pass = trendScore >= minTrendScore
criterion1Value = str.tostring(math.round(trendScore)) + "/100"
criterion1Status = criterion1Pass ? "âœ…" : "âŒ"

// CRITERION 2: MTF Alignment (3/3 required)
criterion2Pass = mtfFullAlignment
criterion2Value = mtfAlignmentBullish ? "BULL 3/3" : mtfBearCount == 3 ? "BEAR 3/3" : str.tostring(mtfBullCount) + "/3"
criterion2Status = criterion2Pass ? "âœ…" : "âŒ"

// CRITERION 3: Volatility Ready
var bool criterion3Pass = false
var string criterion3Detail = ""

if atrState == "TREND" and acceptTrend
    criterion3Pass := true
    criterion3Detail := "TREND"
else if atrState == "EXPLODE" and acceptExplode
    if atrPercentile >= explodeMinPercentile and atrPercentile <= explodeMaxPercentile
        criterion3Pass := true
        criterion3Detail := "EXPLODE (" + str.tostring(math.round(atrPercentile)) + "%ile)"
    else
        criterion3Pass := false
        criterion3Detail := "EXPLODE (Extreme)"
else if atrState == "QUIET" and acceptQuiet
    if atrPercentile >= quietMinPercentile and atrPercentile <= quietMaxPercentile
        criterion3Pass := true
        criterion3Detail := "QUIET (" + str.tostring(math.round(atrPercentile)) + "%ile)"
    else
        criterion3Pass := false
        criterion3Detail := "QUIET (Edge)"
else if atrState == "MIXED"
    criterion3Pass := false
    criterion3Detail := "MIXED"
else
    criterion3Pass := false
    criterion3Detail := atrState

criterion3Value = criterion3Detail
criterion3Status = criterion3Pass ? "âœ…" : "âŒ"

// CRITERION 4: Index Risk Status
criterion4Pass = not indexRiskHigh
criterion4Value = indexRiskHigh ? indexRiskReason : "CLEAR"
criterion4Status = criterion4Pass ? "âœ…" : "âŒ"

// ATR PERCENTILE - DISPLAY ONLY
atrPercentileValue = math.round(atrPercentile)
atrGuidance = atrPercentileValue < 30 ? "IDEAL" : atrPercentileValue < 60 ? "NORMAL" : atrPercentileValue < 80 ? "ELEVATED" : "EXHAUSTED"
atrGuidanceColor = atrPercentileValue < 30 ? color.lime : atrPercentileValue < 60 ? color.green : atrPercentileValue < 80 ? color.yellow : color.red

criteriaMet = (criterion1Pass ? 1 : 0) + (criterion2Pass ? 1 : 0) + (criterion3Pass ? 1 : 0) + (criterion4Pass ? 1 : 0)

// ============================================================================
// ðŸ“Š SCORING SYSTEM (0-100 points)
// ============================================================================

var float overallScore = 0.0
overallScore := 0.0

// 1. TREND QUALITY SCORE (0-40 points)
trendQualityScore = (trendScore / 100) * 40
overallScore += trendQualityScore

// 2. VOLATILITY REGIME SCORE (0-30 points)
var float volatilityScore = 0.0
if atrState == "TREND"
    volatilityScore := 25.0
else if atrState == "EXPLODE"
    if atrPercentile >= 20 and atrPercentile <= 80
        volatilityScore := 20.0
    else if atrPercentile >= 15 and atrPercentile <= 90
        volatilityScore := 15.0
    else
        volatilityScore := 0.0
else if atrState == "QUIET"
    if atrPercentile >= 30 and atrPercentile <= 70
        volatilityScore := 15.0
    else if atrPercentile >= 15 and atrPercentile <= 85
        volatilityScore := 10.0
    else
        volatilityScore := 0.0
else
    volatilityScore := 0.0

if atrFilterActive
    volatilityScore += 5.0

overallScore += volatilityScore

// 3. MOMENTUM ALIGNMENT SCORE (0-20 points)
var float momentumScore = 0.0
if rsiAllBull or rsiAllBear
    momentumScore := 20.0
else if rsiBullCount >= 3 or rsiBearCount >= 3
    momentumScore := 15.0
else if rsiBullCount >= 2 or rsiBearCount >= 2
    momentumScore := 8.0
else
    momentumScore := 0.0

overallScore += momentumScore

// 4. RISK CONTEXT SCORE (0-5 points)
dailyHigh = request.security(syminfo.tickerid, "D", high, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dailyLow = request.security(syminfo.tickerid, "D", low, gaps=barmerge.gaps_off, lookahead=barmerge.lookahead_off)
dailyRange = dailyHigh - dailyLow
dailyPosition = dailyRange > 0 ? ((close - dailyLow) / dailyRange * 100) : 50

var float riskScore = 0.0

if dailyPosition >= 40 and dailyPosition <= 60
    riskScore := 1.5
else if dailyPosition >= 30 and dailyPosition <= 70
    riskScore := 1.0
else
    riskScore := 0.5

// Session quality bonus
if sessionQuality == "High"
    riskScore += 2.0
else if sessionQuality == "Medium"
    riskScore += 1.5
else if sessionQuality == "Caution"
    riskScore += 0.5
else
    riskScore += 0.0

// Risk penalties
if indexRiskHigh
    riskScore -= 2.0
if earningsRiskActive
    riskScore -= 0.5

riskScore := math.max(0, math.min(5, riskScore))

overallScore += riskScore

// 5. PRICE ACTION SCORE (0-5 points)
priceActionScore = 0.0
priceActionScore += (srProximityScore / 5.0) * 3.0
priceActionScore += (math.min(5.0, entryZoneScore) / 5.0) * 2.0

overallScore += priceActionScore

overallScore := math.min(100, overallScore)

// ============================================================================
// ðŸŽ¯ STATUS DETERMINATION
// ============================================================================

var string tradeStatus = "âŒ NO TRADE"
var color tradeStatusColor = colorNoTradeRed
var string tradeStatusType = ""
var string positionSizeRec = ""

allCriteriaMet = criterion1Pass and criterion2Pass and criterion3Pass and criterion4Pass
trendDirection = bullishEMAStack ? 1 : bearishEMAStack ? -1 : 0

if criteriaMet == 4
    tradeStatus := "âœ… TRADE"
    tradeStatusColor := colorTradeGreen
    positionSizeRec := "Full"
    entryIsGood = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
    if overallScore >= 90 and entryIsGood
        tradeStatusType := "Textbook"
    else if overallScore >= 85
        tradeStatusType := "Strong"
    else
        tradeStatusType := "Good"

else if criteriaMet == 3
    bool criticalPass = criterion1Pass and criterion2Pass
    
    if criticalPass
        if overallScore >= 85
            tradeStatus := "âœ… TRADE"
            tradeStatusColor := colorTradeGreen
            positionSizeRec := "Full"
            tradeStatusType := "Strong"
        else if overallScore >= minCautionScore
            tradeStatus := "âš ï¸ CAUTION"
            tradeStatusColor := colorCautionOrange
            positionSizeRec := "50%"
            tradeStatusType := "Decent"
        else
            tradeStatus := "âŒ NO TRADE"
            tradeStatusColor := colorNoTradeRed
            positionSizeRec := "Avoid"
            tradeStatusType := "Score Too Low"
    else
        tradeStatus := "âŒ NO TRADE"
        tradeStatusColor := colorNoTradeRed
        positionSizeRec := "Avoid"
        if not criterion1Pass
            tradeStatusType := "Weak Trend"
        else
            tradeStatusType := "MTF Divergence"

else if criteriaMet == 2
    if overallScore >= minCautionScore
        tradeStatus := "âš ï¸ CAUTION"
        tradeStatusColor := colorCautionOrange
        positionSizeRec := "25-50%"
        tradeStatusType := "Marginal"
    else
        tradeStatus := "âŒ NO TRADE"
        tradeStatusColor := colorNoTradeRed
        positionSizeRec := "Avoid"
        tradeStatusType := "Too Weak"

else
    tradeStatus := "âŒ NO TRADE"
    tradeStatusColor := colorNoTradeRed
    positionSizeRec := "Avoid"
    if criterion3Pass == false
        tradeStatusType := "Vol Issue"
    else if criterion4Pass == false
        tradeStatusType := "Risk Event"
    else if criterion1Pass == false
        tradeStatusType := "Weak Trend"
    else if criterion2Pass == false
        tradeStatusType := "MTF Mixed"
    else
        tradeStatusType := "Multiple Issues"

// ============================================================================
// ðŸ”’ SESSION LOCK SYSTEM (v2.0)
// ============================================================================

candleRange = high - low
candleBody = math.abs(close - open)
rawEfficiency = candleRange > 0 ? candleBody / candleRange : 0

candleBullish = close > open
candleBearish = close < open

var bool isArmed = false
var int armedDirection = 0
var float armedScore = 0.0
var string armedSession = ""
var int barsAboveThreshold = 0
var string disarmReason = ""
var string currentPlaybook = "NO TRADE"

var bool wasArmed = false
var int wasArmedDirection = 0
var string lastSession = ""

var bool wasCandidate_rt = false
var bool wasCandidate_close = false
var int wasCandidateDir_rt = 0
var int wasCandidateDir_close = 0

sessionJustChanged = currentSession != lastSession
sessionResetEvent = sessionJustChanged and barstate.isnew

var bool structuralDamage = false
var bool efficiencyCollapse = false
var bool mtfBroken = false
var bool emaCompressed = false

// Time to bar close
tfSeconds = timeframe.in_seconds()
barStartTime = time
currentTime = timenow
barTimeElapsed = (currentTime - barStartTime) / 1000
barTimeRemaining = math.max(0, tfSeconds - barTimeElapsed)
minutesRemaining = math.floor(barTimeRemaining / 60)
secondsRemaining = math.floor(barTimeRemaining % 60)

var string barCloseText = ""
var bool barCloseWarning = false
var color barTimerColor = color.white

if barstate.isrealtime
    if minutesRemaining <= barTimerCritical
        barCloseWarning := true
        barTimerColor := color.rgb(255, 50, 50)
        barCloseText := str.tostring(minutesRemaining) + "m " + str.tostring(secondsRemaining) + "s"
    else if minutesRemaining <= barTimerWarning
        barCloseWarning := true
        barTimerColor := color.rgb(255, 200, 0)
        barCloseText := str.tostring(minutesRemaining) + "m " + str.tostring(secondsRemaining) + "s"
    else if minutesRemaining <= barTimerCaution
        barCloseWarning := false
        barTimerColor := color.rgb(255, 165, 0)
        barCloseText := str.tostring(minutesRemaining) + "m"
    else
        barCloseWarning := false
        barTimerColor := color.rgb(100, 200, 100)
        barCloseText := str.tostring(minutesRemaining) + "m"
else
    barCloseText := "---"
    barCloseWarning := false
    barTimerColor := color.gray

// Spread monitoring
recentVolatility = ta.atr(14)
currentBarRange = high - low
expectedRange = recentVolatility * 0.5
rangeRatio = expectedRange > 0 ? currentBarRange / expectedRange : 1.0

var string spreadStatus = "NORMAL"
var bool spreadWarning = false
if rangeRatio > spreadWarningMultiplier
    spreadStatus := "WIDE"
    spreadWarning := true
else if rangeRatio > (spreadWarningMultiplier * 0.7)
    spreadStatus := "ELEVATED"
    spreadWarning := false
else
    spreadStatus := "NORMAL"
    spreadWarning := false

if not barstate.isrealtime
    spreadStatus := "---"
    spreadWarning := false

// Session Lock Logic
bullishEfficiency = candleBullish ? rawEfficiency : 0.0
bearishEfficiency = candleBearish ? rawEfficiency : 0.0

emaCompressed := trendDirection == 0
mtfBroken := mtfAlignCount < 3
efficiencyCollapse := (trendDirection == 1 and bullishEfficiency < efficiencyThreshold and candleBullish) or (trendDirection == -1 and bearishEfficiency < efficiencyThreshold and candleBearish)
structuralDamage := emaCompressed or mtfBroken or efficiencyCollapse

if emaCompressed
    disarmReason := "EMA Compressed"
else if mtfBroken
    disarmReason := "MTF Break"
else if efficiencyCollapse
    disarmReason := "Efficiency Collapse"
else
    disarmReason := ""

meetsArmCriteria = allCriteriaMet and overallScore >= alertStrongThreshold and mtfAlignCount == 3 and trendDirection != 0
if meetsArmCriteria
    barsAboveThreshold := barsAboveThreshold + 1
else
    barsAboveThreshold := 0

if enableSessionLock
    if sessionJustChanged
        isArmed := false
        armedDirection := 0
        armedScore := 0.0
        armedSession := ""
        barsAboveThreshold := 0
    
    if not isArmed and barsAboveThreshold >= upgradePersistence
        isArmed := true
        armedDirection := trendDirection
        armedScore := overallScore
        armedSession := currentSession
    
    if isArmed
        scoreBelowDisarm = overallScore < (armedScore - disarmScoreThreshold)
        if scoreBelowDisarm and structuralDamage
            isArmed := false
            armedDirection := 0
else
    isArmed := meetsArmCriteria
    armedDirection := trendDirection
    armedScore := overallScore

if not isArmed
    currentPlaybook := "NO TRADE"
else
    if atrState == "TREND"
        currentPlaybook := armedDirection == 1 ? "CONTINUATION LONG" : "CONTINUATION SHORT"
    else if atrState == "EXPLODE"
        currentPlaybook := armedDirection == 1 ? "DEEP PULLBACK LONG" : "DEEP PULLBACK SHORT"
    else if atrState == "QUIET"
        currentPlaybook := "OBSERVATION ONLY"
    else
        currentPlaybook := "STAND DOWN"

armedStatusText = isArmed ? (armedDirection == 1 ? "ARMED UP" : "ARMED DN") : "DISARMED"
armedStatusColor = isArmed ? (armedDirection == 1 ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80)) : color.gray

// v2.5.1: Moved here from alert section â€” needed by f_buildJson() below
playbookShort = str.contains(currentPlaybook, "CONTINUATION") ? "CONTINUATION" : str.contains(currentPlaybook, "DEEP PULLBACK") ? "DEEP PULLBACK" : str.contains(currentPlaybook, "OBSERVATION") ? "OBSERVATION" : str.contains(currentPlaybook, "STAND DOWN") ? "STAND DOWN" : "NO TRADE"

// ============================================================================
// INSTITUTIONAL ALERT BUILDER FUNCTIONS (v2.5.0)
// ============================================================================
// Constants, emoji resolver, header/body builders, execution strings
// These produce the 4-emoji standard scan line + audit body format.

// --- Alert Type Constants ---
ALERT_ARMED = "ARMED"
ALERT_CANDIDATE = "CANDIDATE"
ALERT_BLOCKED = "BLOCKED"
ALERT_INFO = "INFO"

// --- Execution Constraint Strings ---
EXECUTION_NONE = "NONE"
EXECUTION_FULL = "- MAX_RISK: 1.0R\n- MAX_TRADES: 3\n- ADDS: ENABLED"
EXECUTION_CONDITIONAL = "- MAX_RISK: 0.25R\n- MAX_TRADES: 1\n- ADDS: DISABLED"

// --- Emoji Resolver (strict, fixed â€” 4 emojis only) ---
f_alertEmoji(string alertType) =>
    string emoji = "âšª"
    if alertType == ALERT_ARMED
        emoji := "ðŸŸ¢"
    else if alertType == ALERT_CANDIDATE
        emoji := "ðŸŸ¡"
    else if alertType == ALERT_BLOCKED
        emoji := "ðŸ”´"
    else
        emoji := "âšª"
    emoji

// --- Severity Prefix (for email rule filtering) ---
f_severityPrefix(string alertType) =>
    string result = ""
    if alertType == ALERT_ARMED
        result := "[A]"
    else if alertType == ALERT_CANDIDATE
        result := "[C]"
    else if alertType == ALERT_BLOCKED
        result := "[B]"
    else
        result := "[I]"
    result

// --- Header Builder (scan line â€” triage in <1 second) ---
f_alertHeader(string alertType, string symbol, string pReason, string rState, string sStr) =>
    f_alertEmoji(alertType) + " " + f_severityPrefix(alertType) + " " + alertType + " | " + symbol + " | " + pReason + " | " + rState + " | " + sStr

// --- Body Builder (audit detail â€” opened when needed) ---
f_alertBody(string pReason, string contribReasons, string perm, string exec) =>
    "Primary: " + pReason + "\nContributing: [" + contribReasons + "]\n\nPERMISSION: " + perm + "\nEXECUTION:\n" + exec

// --- Full Alert Builder (header + em-dash + body) ---
f_buildAlert(string alertType, string symbol, string pReason, string contribReasons, string perm, string exec, string rState, int scoreVal) =>
    string sStr = "U-SCORE-" + str.tostring(scoreVal)
    string hdr = f_alertHeader(alertType, symbol, pReason, rState, sStr)
    string bdy = f_alertBody(pReason, contribReasons, perm, exec)
    hdr + "\n\u2014\n" + bdy

// --- JSON Context Builder (machine-parsable payload for webhook) ---
f_buildJson(string alertType, string pReason, string contribReasons, string perm, string rState, string exec, int scoreVal) =>
    string dStr = trendDirection == 1 ? "long" : trendDirection == -1 ? "short" : "none"
    string eClean = str.contains(entryZoneQuality, "HOT") ? "HOT" : str.contains(entryZoneQuality, "OPTIMAL") ? "OPTIMAL" : str.contains(entryZoneQuality, "ACCEPTABLE") ? "ACCEPTABLE" : str.contains(entryZoneQuality, "DEEP") ? "DEEP" : "EXTENDED"
    string rCount = trendDirection == 1 ? str.tostring(rsiBullCount) : str.tostring(rsiBearCount)
    string maxRisk = exec == EXECUTION_FULL ? "1.0R" : exec == EXECUTION_CONDITIONAL ? "0.25R" : "NONE"
    string maxTrades = exec == EXECUTION_FULL ? "3" : exec == EXECUTION_CONDITIONAL ? "1" : "0"
    string p = '{"type":"' + alertType + '","pair":"' + syminfo.ticker + '","asset_class":"INDICES"'
    p := p + ',"primary":"' + pReason + '","contributing":"' + contribReasons + '"'
    p := p + ',"permission":"' + perm + '","execution":{"max_risk":"' + maxRisk + '","max_trades":' + maxTrades + '}'
    p := p + ',"context":{"direction":"' + dStr + '","score":' + str.tostring(scoreVal)
    p := p + ',"criteria":' + str.tostring(criteriaMet) + ',"entry":"' + eClean + '"'
    p := p + ',"vol_state":"' + atrState + '","mtf":' + str.tostring(mtfAlignCount) + ',"rsi":' + rCount
    p := p + ',"session":"' + currentSession + '","playbook":"' + playbookShort + '"'
    p := p + ',"regime":"' + atrState + '","risk_state":"' + rState + '"}}'
    p

// ============================================================================
// INSTITUTIONAL PRIORITY RESOLVER (v2.5.0)
// ============================================================================
// Regime > Risk > UTCC authority stack.
// Reads existing variables only â€” adds governance layer, replaces nothing.
// Higher layers veto lower layers. No exceptions.

// --- Derived Risk Code ---
riskCode = riskGovernorState == "LOCKED" ? "K-LOCKED" : riskGovernorState == "REDUCED" ? "K-REDUCED" : "K-NORMAL"

// ============================================================================
// LAYER 1: REGIME CHECK (Highest Authority)
// ============================================================================
// Regime can force BLOCKED regardless of anything below it.

var string regimeCode = "R-EXPANSION"
var string regimePermission = "FULL"

if atrState == "MIXED"
    regimeCode := "R-CHAOS"
    regimePermission := "STAND_DOWN"
else if atrState == "QUIET" and atrPercentile < 15
    regimeCode := "R-COMPRESSION"
    regimePermission := "STAND_DOWN"
else if currentSession == "Off-Hours" or currentSession == "Unknown"
    regimeCode := "R-OFFSESSION"
    regimePermission := "STAND_DOWN"
else if atrState == "QUIET"
    regimeCode := "R-COMPRESSION"
    regimePermission := "CONDITIONAL"
else if atrState == "EXPLODE"
    regimeCode := "R-TRANSITION"
    regimePermission := "CONDITIONAL"
else if atrState == "TREND"
    regimeCode := "R-EXPANSION"
    regimePermission := "FULL"

// ============================================================================
// LAYER 2: RISK GOVERNOR CHECK (Overrides UTCC)
// ============================================================================
// Risk state can downgrade permission but never upgrade it.

var string riskPermission = "FULL"
if riskGovernorState == "LOCKED"
    riskPermission := "STAND_DOWN"
else if riskGovernorState == "REDUCED"
    riskPermission := "CONDITIONAL"
else
    riskPermission := "FULL"

// ============================================================================
// LAYER 3: RESOLVE FINAL PERMISSION (Most Restrictive Wins)
// ============================================================================

var string finalPermission = "FULL"
if regimePermission == "STAND_DOWN" or riskPermission == "STAND_DOWN"
    finalPermission := "STAND_DOWN"
else if regimePermission == "CONDITIONAL" or riskPermission == "CONDITIONAL"
    finalPermission := "CONDITIONAL"
else
    finalPermission := "FULL"

// ============================================================================
// LAYER 4: DETERMINE PRIMARY REASON (Highest Authority That Restricted)
// ============================================================================
// Primary reason = the MOST AUTHORITATIVE factor that set the current state.
// INSTITUTIONAL RULE: UTCC codes (U-series) are NEVER primary. Ever.
// When criteria fail but regime/risk both allow, regime remains primary.
// Failed criteria surface in contributing reasons only.

var string primaryReason = "R-EXPANSION"
if regimePermission == "STAND_DOWN"
    primaryReason := regimeCode
else if riskPermission == "STAND_DOWN"
    primaryReason := riskCode
else if regimePermission == "CONDITIONAL"
    primaryReason := regimeCode
else if riskPermission == "CONDITIONAL"
    primaryReason := riskCode
else
    // Both regime and risk allow full â€” regime is ALWAYS primary
    primaryReason := regimeCode

// ============================================================================
// LAYER 5: AUTO-SELECT ALERT TYPE
// ============================================================================

var string resolvedAlertType = ALERT_INFO
if finalPermission == "STAND_DOWN"
    resolvedAlertType := ALERT_BLOCKED
else if finalPermission == "FULL" and isArmed and allCriteriaMet
    resolvedAlertType := ALERT_ARMED
else if finalPermission == "CONDITIONAL" or (allCriteriaMet and not isArmed)
    resolvedAlertType := ALERT_CANDIDATE
else
    resolvedAlertType := ALERT_INFO

// ============================================================================
// LAYER 6: RESOLVE EXECUTION CONSTRAINT
// ============================================================================

var string resolvedExecution = EXECUTION_NONE
if finalPermission == "STAND_DOWN"
    resolvedExecution := EXECUTION_NONE
else if finalPermission == "CONDITIONAL"
    resolvedExecution := EXECUTION_CONDITIONAL
else
    resolvedExecution := EXECUTION_FULL

// ============================================================================
// INVARIANT CHECK (Fail-Closed â€” v2.5.1)
// ============================================================================
// Defensive guard: if regime forced STAND_DOWN, override everything.
// This catches any upstream bug that might leak ARMED/CANDIDATE through.
// No ARMED during R-COMPRESSION or R-CHAOS. No exceptions.

if regimePermission == "STAND_DOWN"
    if resolvedAlertType == ALERT_ARMED or resolvedAlertType == ALERT_CANDIDATE
        resolvedAlertType := ALERT_BLOCKED
    if resolvedExecution != EXECUTION_NONE
        resolvedExecution := EXECUTION_NONE
    if finalPermission != "STAND_DOWN"
        finalPermission := "STAND_DOWN"

if riskPermission == "STAND_DOWN"
    if resolvedAlertType == ALERT_ARMED
        resolvedAlertType := ALERT_BLOCKED
    if resolvedExecution == EXECUTION_FULL
        resolvedExecution := EXECUTION_NONE

// ============================================================================
// BUILD CONTRIBUTING REASONS (Supporting Evidence)
// ============================================================================

var string contributingStr = ""
contributingStr := "U-MTF-" + str.tostring(mtfAlignCount) + "OF3"
contributingStr := contributingStr + ", U-SCORE-" + str.tostring(math.round(overallScore))
contributingStr := contributingStr + ", U-ATR-" + atrState
if not criterion1Pass
    contributingStr := contributingStr + ", U-TREND-WEAK"
if not criterion2Pass
    contributingStr := contributingStr + ", U-MTF-MISALIGN"
if not criterion3Pass
    contributingStr := contributingStr + ", U-VOL-MIXED"
if atrPercentile < 20
    contributingStr := contributingStr + ", U-ATR-BELOW-P" + str.tostring(math.round(atrPercentile))
if str.contains(entryZoneQuality, "EXTENDED")
    contributingStr := contributingStr + ", U-ENTRY-EXTENDED"
if tooCloseToSR
    contributingStr := contributingStr + ", U-SR-CLOSE"
if indexRiskHigh
    contributingStr := contributingStr + ", U-RISK-EVENT"
if inOpenCaution
    contributingStr := contributingStr + ", U-OPEN-CAUTION"
if earningsRiskActive
    contributingStr := contributingStr + ", U-EARNINGS-SZN"

// v2.5.1: Wire disarm reason into BLOCKED contributing reasons
if not isArmed and disarmReason != ""
    string disarmCode = "U-DISARM"
    if disarmReason == "EMA Compressed"
        disarmCode := "U-DISARM-EMA"
    else if disarmReason == "MTF Break"
        disarmCode := "U-DISARM-MTF"
    else if disarmReason == "Efficiency Collapse"
        disarmCode := "U-DISARM-EFFICIENCY"
    contributingStr := contributingStr + ", " + disarmCode

// ============================================================================
// ðŸ“ DISPLAY HELPER VARIABLES (v2.4.0)
// ============================================================================
// Volatility, trend, and ADX explanation text for Standard/Full modes

var string volExplanation = ""
if atrState == "TREND"
    volExplanation := "Steady consistent movement across timeframes. Ideal trending conditions."
else if atrState == "EXPLODE"
    volExplanation := "Sharp spike in activity. Breakout or news-driven. High risk/reward."
else if atrState == "QUIET"
    volExplanation := "Compressed range, consolidation. Potential breakout setup forming."
else
    volExplanation := "Conflicting volatility signals. Mixed market structure, avoid."

var string trendExplanation = ""
if fastEMA > midEMA and midEMA > slowEMA
    trendExplanation := "Fast > Mid > Slow - Clean bullish alignment"
else if fastEMA < midEMA and midEMA < slowEMA
    trendExplanation := "Fast < Mid < Slow - Clean bearish alignment"
else
    trendExplanation := "Mixed EMA structure - No clear trend"

var string adxInterpretation = ""
if adxValue > 25
    adxInterpretation := "Strong"
else if adxValue > 20
    adxInterpretation := "Moderate"
else
    adxInterpretation := "Weak"

// ============================================================================
// ðŸ“ RISK MANAGEMENT CALCULATIONS (v2.4.0)
// ============================================================================
// Invalidation-based: stop = where the trade idea is WRONG

invalidationBuffer = atrCurrent * 0.5

var float invalidationLevel = na
var float stopLevel = na
var float targetLevel = na
var float riskReward = 2.0
var string invalidationReason = ""

if mtfAlignmentBullish
    invalidationLevel := fastEMA - invalidationBuffer
    stopLevel := invalidationLevel - (atrCurrent * 0.1)
    targetLevel := close + (math.abs(close - stopLevel) * 2.0)
    invalidationReason := "Below EMA"
else if mtfBearCount == 3
    invalidationLevel := fastEMA + invalidationBuffer
    stopLevel := invalidationLevel + (atrCurrent * 0.1)
    targetLevel := close - (math.abs(stopLevel - close) * 2.0)
    invalidationReason := "Above EMA"
else
    invalidationLevel := close - atrCurrent
    stopLevel := close - (atrCurrent * 1.1)
    targetLevel := close + atrCurrent
    invalidationReason := "No Direction"

riskDistance = math.abs(close - stopLevel)
rewardDistance = math.abs(targetLevel - close)
riskReward := riskDistance > 0 ? rewardDistance / riskDistance : 0.0

// Index-appropriate display: show price levels + distance in points
stopPoints = math.round(riskDistance / syminfo.mintick)
targetPoints = math.round(rewardDistance / syminfo.mintick)


// ============================================================================
// ðŸ“º TABLE DISPLAY - FULL 4-TIER (v2.4.0)
// ============================================================================

var table dashTable = na

tablePos = panelPosition == "Top Left" ? position.top_left : 
           panelPosition == "Top Right" ? position.top_right : 
           panelPosition == "Bottom Left" ? position.bottom_left : 
           position.bottom_right

getSize(string s) =>
    s == "Tiny" ? size.tiny : s == "Small" ? size.small : s == "Normal" ? size.normal : s == "Large" ? size.large : size.huge

headerSize = getSize(headerFontSize)
statusSize = getSize(statusFontSize)
dataSize = getSize(dataFontSize)
scoreSize = getSize(scoreFontSize)

if barstate.isfirst
    maxRows = displayMode == "Minimal" ? 7 : 
              displayMode == "Compact" ? 19 : 
              displayMode == "Standard" ? 42 : 
              52
    dashTable := table.new(tablePos, 2, maxRows, 
         bgcolor=color.new(colorBody, panelTransparency),
         frame_color=color.new(colorHeader, borderTransparency),
         frame_width=frameWidth,
         border_width=borderWidth,
         border_color=color.new(colorHeader, borderTransparency))

if barstate.islast
    maxClearRows = displayMode == "Minimal" ? 6 : 
                   displayMode == "Compact" ? 18 : 
                   displayMode == "Standard" ? 41 : 
                   51
    table.clear(dashTable, 0, 0, 1, maxClearRows)
    
    row = 0
    
    // ========================================
    // TIER 1: INSTITUTIONAL STATUS (Always show)
    // ========================================
    // v2.5.0: Institutional display hierarchy
    // Row 0: Pair + TF header
    // Row 1: Alert Type | Primary Reason | Permission
    // Row 2: Regime | R-code | Risk State
    // Row 3: Execution | Max Risk | Trades
    
    // --- Institutional colour mapping (matches 4-emoji standard) ---
    color instStatusBg = color.rgb(30, 30, 50)
    color instStatusText = color.rgb(100, 149, 237)
    color instRowBg = color.rgb(30, 30, 50)
    if resolvedAlertType == ALERT_ARMED
        instStatusBg := color.rgb(0, 60, 0)
        instStatusText := color.rgb(34, 197, 94)
        instRowBg := color.rgb(0, 40, 0)
    else if resolvedAlertType == ALERT_CANDIDATE
        instStatusBg := color.rgb(60, 50, 0)
        instStatusText := color.rgb(234, 179, 8)
        instRowBg := color.rgb(40, 35, 0)
    else if resolvedAlertType == ALERT_BLOCKED
        instStatusBg := color.rgb(60, 0, 0)
        instStatusText := color.rgb(239, 68, 68)
        instRowBg := color.rgb(40, 0, 0)
    else
        instStatusBg := color.rgb(30, 30, 50)
        instStatusText := color.rgb(100, 149, 237)
        instRowBg := color.rgb(25, 25, 40)
    
    // Row 0: Header â€” Pair + Timeframe | Region + Index Short
    table.cell(dashTable, 0, row, syminfo.ticker + " " + timeframe.period, 
         text_color=colorText, text_size=headerSize, 
         bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, region + " | " + indexShort, 
         text_color=color.rgb(100, 200, 255), text_size=headerSize,
         bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 1: Alert Type | Primary Reason + Permission
    table.cell(dashTable, 0, row, resolvedAlertType, 
         text_color=instStatusText, text_size=statusSize, 
         bgcolor=color.new(instStatusBg, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, primaryReason + " | " + finalPermission, 
         text_color=instStatusText, text_size=scoreSize, 
         bgcolor=color.new(instStatusBg, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 2: Regime | R-code + Risk State
    table.cell(dashTable, 0, row, "REGIME", 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(instRowBg, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, regimeCode + " | " + riskCode, 
         text_color=instStatusText, text_size=dataSize, 
         bgcolor=color.new(instRowBg, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // Row 3: Execution constraint
    string execDisplay = "NONE"
    if resolvedExecution == EXECUTION_FULL
        execDisplay := "MAX_RISK: 1.0R | TRADES: 3"
    else if resolvedExecution == EXECUTION_CONDITIONAL
        execDisplay := "MAX_RISK: 0.25R | TRADES: 1"
    table.cell(dashTable, 0, row, "EXECUTION", 
         text_color=colorText, text_size=dataSize, 
         bgcolor=color.new(instRowBg, panelTransparency), text_halign=text.align_left)
    table.cell(dashTable, 1, row, execDisplay, 
         text_color=instStatusText, text_size=dataSize, 
         bgcolor=color.new(instRowBg, panelTransparency), text_halign=text.align_right)
    row += 1
    
    // ========================================
    // TIER 2: CRITERIA CHECKLIST (Compact+)
    // ========================================
    
    if displayMode != "Minimal"
        table.cell(dashTable, 0, row, "CRITERIA CHECKLIST", 
             text_color=colorText, text_size=headerSize, 
             bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
        table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
        row += 1
        
        // Criterion 1: Trend Score
        table.cell(dashTable, 0, row, criterion1Status + " 1. Trend Score", 
             text_color=criterion1Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion1Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 2: MTF Alignment
        table.cell(dashTable, 0, row, criterion2Status + " 2. MTF Alignment", 
             text_color=criterion2Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion2Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 3: Volatility
        table.cell(dashTable, 0, row, criterion3Status + " 3. Volatility", 
             text_color=criterion3Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion3Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Criterion 4: Risk Status
        table.cell(dashTable, 0, row, criterion4Status + " 4. Risk Status", 
             text_color=criterion4Pass ? colorPass : colorFail, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, criterion4Value, 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Playbook (moved here per institutional spec â€” after criteria, before verdict)
        if enableSessionLock
            var color playbookColor = color.gray
            if currentPlaybook == "NO TRADE"
                playbookColor := color.gray
            else if str.contains(currentPlaybook, "OBSERVATION")
                playbookColor := color.rgb(255, 200, 0)
            else if str.contains(currentPlaybook, "STAND DOWN")
                playbookColor := color.rgb(255, 165, 0)
            else if armedDirection == 1
                playbookColor := color.rgb(34, 171, 148)
            else
                playbookColor := color.rgb(239, 83, 80)
            table.cell(dashTable, 0, row, "PLAYBOOK", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, currentPlaybook, 
                 text_color=playbookColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
        
        // ATR Percentile
        table.cell(dashTable, 0, row, "ATR: " + str.tostring(atrPercentileValue) + "%", 
             text_color=atrGuidanceColor, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, atrGuidance, 
             text_color=atrGuidanceColor, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Calibration (Index-specific)
        table.cell(dashTable, 0, row, "Calibration", 
             text_color=colorText, text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
        table.cell(dashTable, 1, row, calibDisplay, 
             text_color=color.rgb(100, 200, 255), text_size=dataSize, 
             bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
        row += 1
        
        // Summary verdict
        verdictText = str.tostring(criteriaMet) + "/4 | " + resolvedAlertType
        table.cell(dashTable, 0, row, verdictText, 
             text_color=instStatusText, text_size=dataSize, 
             bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
        table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
        row += 1
        
        // ========================================
        // EXECUTION CONTEXT (Timer + Session + Spread)
        // ========================================
        
        // Critical timer banner
        if showBarTimer and (minutesRemaining <= barTimerCritical)
            table.cell(dashTable, 0, row, barCloseText, 
                 text_color=barTimerColor, text_size=statusSize,
                 bgcolor=color.new(color.rgb(50, 0, 0), panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "CLOSE SOON!", 
                 text_color=barTimerColor, text_size=statusSize, 
                 bgcolor=color.new(color.rgb(50, 0, 0), panelTransparency), text_halign=text.align_center)
            row += 1
        
        // Context row (session + timer + spread combined)
        string sessionText = showSessionInfo ? currentSession : ""
        string timerText = showBarTimer and minutesRemaining > barTimerCritical ? barCloseText : ""
        string spreadText = showSpreadMonitor ? spreadStatus + (spreadWarning ? " !!" : "") : ""
        
        contextParts = array.new<string>()
        if sessionText != ""
            contextParts.push(sessionText)
        if earningsRiskActive
            contextParts.push("EARNINGS")
        if timerText != ""
            contextParts.push(timerText)
        if spreadText != ""
            contextParts.push(spreadText)
        
        string contextText = ""
        color contextColor = colorText
        if contextParts.size() > 0
            contextText := contextParts.get(0)
            for i = 1 to contextParts.size() - 1
                contextText += " | " + contextParts.get(i)
            if showBarTimer and minutesRemaining <= barTimerWarning and minutesRemaining > barTimerCritical
                contextColor := barTimerColor
        
        if contextText != ""
            table.cell(dashTable, 0, row, contextText, 
                 text_color=contextColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", 
                 bgcolor=color.new(colorBody, panelTransparency))
            row += 1
        
        // ========================================
        // TIER 3: STANDARD MODE
        // ========================================
        
        if displayMode == "Standard" or displayMode == "Full"
            // Score Breakdown
            table.cell(dashTable, 0, row, "SCORE BREAKDOWN", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Trend Quality", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(trendQualityScore)) + "/40", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Volatility Regime", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(volatilityScore)) + "/30", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Momentum Alignment", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(momentumScore)) + "/20", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Risk Context", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(riskScore)) + "/5", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Price Action", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(priceActionScore)) + "/5", 
                 text_color=colorText, text_size=scoreSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Volatility Analysis
            table.cell(dashTable, 0, row, "VOLATILITY ANALYSIS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "State: " + atrState, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(atrPercentile)) + "%ile", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, volExplanation, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, "", 
                 bgcolor=color.new(colorBody, panelTransparency))
            row += 1
            
            // Risk Management
            table.cell(dashTable, 0, row, "RISK MANAGEMENT", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Stop", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(stopLevel, format.mintick) + " (" + str.tostring(stopPoints) + " pts)", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Target", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(targetLevel, format.mintick) + " (" + str.tostring(targetPoints) + " pts)", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "R:R Ratio", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            rrColor = riskReward >= 2.0 ? colorPass : riskReward >= 1.5 ? colorText : colorFail
            table.cell(dashTable, 1, row, str.tostring(riskReward, "#.#") + ":1", 
                 text_color=rrColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Trend Details
            table.cell(dashTable, 0, row, "TREND DETAILS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, trendExplanation, 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, "", 
                 bgcolor=color.new(colorBody, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "ADX", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(adxValue)) + " (" + adxInterpretation + ")", 
                 text_color=adxValue > effectiveADXThreshold ? colorPass : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            htfText = mtfAlignmentBullish ? "BULLISH" : mtfBearCount == 3 ? "BEARISH" : "MIXED"
            table.cell(dashTable, 0, row, "HTF Bias", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, htfText, 
                 text_color=mtfFullAlignment ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // S/R Proximity
            table.cell(dashTable, 0, row, "S/R PROXIMITY", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "To Resistance", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distToResistance, "#.##") + " ATR", 
                 text_color=distToResistance < 0.5 ? colorFail : distToResistance < 1.5 ? colorText : colorPass, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "To Support", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distToSupport, "#.##") + " ATR", 
                 text_color=distToSupport < 0.5 ? colorFail : distToSupport < 1.5 ? colorText : colorPass, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "S/R Status", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, srStatus, 
                 text_color=srStatusColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Entry Zone Analysis
            table.cell(dashTable, 0, row, "ENTRY ZONE ANALYSIS", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "EMA Distance", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(distFromFastEMA, "#.##") + " ATR", 
                 text_color=entryZoneColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Entry Zone", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, entryZoneQuality, 
                 text_color=entryZoneColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "RSI Momentum", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rsiMomentumStatus, 
                 text_color=rsiMomentumBonus >= 2.0 ? colorPass : rsiMomentumBonus >= 1.0 ? colorText : color.gray, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Entry Score", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(entryTotalScore, "#.#") + "/7 (" + entryRating + ")", 
                 text_color=entryTotalScore >= 6 ? colorPass : entryTotalScore >= 4 ? colorText : colorFail, 
                 text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
        
        // ========================================
        // TIER 4: FULL MODE
        // ========================================
        
        if displayMode == "Full"
            // Momentum RSI Detail
            table.cell(dashTable, 0, row, "MOMENTUM (RSI)", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            table.cell(dashTable, 0, row, "Current TF", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiCurrent)), 
                 text_color=rsiCurrent > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "1H", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiH1)), 
                 text_color=rsiH1 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "4H", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiH4)), 
                 text_color=rsiH4 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Daily", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, str.tostring(math.round(rsiD1)), 
                 text_color=rsiD1 > 50 ? colorPass : colorFail, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            rsiSummary = rsiAllBull ? "All BULL" : rsiAllBear ? "All BEAR" : str.tostring(rsiBullCount) + "/4 Bull"
            table.cell(dashTable, 0, row, "Alignment", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rsiSummary, 
                 text_color=(rsiAllBull or rsiAllBear) ? colorPass : colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            // Price Action
            table.cell(dashTable, 0, row, "PRICE ACTION", 
                 text_color=colorText, text_size=headerSize, 
                 bgcolor=color.new(colorHeader, panelTransparency), text_halign=text.align_center)
            table.cell(dashTable, 1, row, "", bgcolor=color.new(colorHeader, panelTransparency))
            row += 1
            
            rangeText = str.tostring(math.round(dailyPosition)) + "%"
            rangeColor = dailyPosition >= 40 and dailyPosition <= 60 ? colorPass : colorText
            table.cell(dashTable, 0, row, "Daily Range", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, rangeText, 
                 text_color=rangeColor, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1
            
            table.cell(dashTable, 0, row, "Spread Status", 
                 text_color=colorText, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_left)
            table.cell(dashTable, 1, row, spreadStatus + (spreadWarning ? " !!" : ""), 
                 text_color=spreadWarning ? colorFail : colorPass, text_size=dataSize, 
                 bgcolor=color.new(colorBody, panelTransparency), text_halign=text.align_right)
            row += 1

// ============================================================================
// ALERT QUALITY FILTER CHECKS
// ============================================================================

entryIsHotOrOptimal = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
entryIncludesAcceptable = entryIsHotOrOptimal or str.contains(entryZoneQuality, "ACCEPTABLE")
entryPassesForStrong = strongEntryRequirement == "Any Zone" ? true : strongEntryRequirement == "Include ACCEPTABLE" ? entryIncludesAcceptable : entryIsHotOrOptimal

srProximityPasses = distToNearestSR >= srProximityFilter

scoreGapPassesStrong = overallScore >= (alertStrongThreshold + scoreGapRequired)
scoreGapPassesPerfect = overallScore >= (alertPerfectThreshold + scoreGapRequired)

qualityFiltersPassed = entryPassesForStrong and srProximityPasses

// ============================================================================
// CANDIDATE CONDITION (v2.0)
// ============================================================================
candidateMeetsLong = allCriteriaMet and mtfAlignCount == 3 and trendDirection == 1 and entryIsHotOrOptimal and srProximityPasses and overallScore >= candidateThreshold
candidateMeetsShort = allCriteriaMet and mtfAlignCount == 3 and trendDirection == -1 and entryIsHotOrOptimal and srProximityPasses and overallScore >= candidateThreshold
candidateMeets = candidateMeetsLong or candidateMeetsShort
candidateDirection = candidateMeetsLong ? 1 : candidateMeetsShort ? -1 : 0

contextJustCandidateLong = candidateMeetsLong and (not wasCandidate_rt or wasCandidateDir_rt != 1)
contextJustCandidateShort = candidateMeetsShort and (not wasCandidate_rt or wasCandidateDir_rt != -1)
contextJustCandidate = contextJustCandidateLong or contextJustCandidateShort

// Update realtime memory immediately
wasCandidate_rt := candidateMeets
wasCandidateDir_rt := candidateDirection

// Update confirmed memory on bar close
if barstate.isconfirmed
    wasCandidate_close := candidateMeets
    wasCandidateDir_close := candidateDirection

// ============================================================================
// STATE CHANGE DETECTION
// ============================================================================
contextJustArmedLong = isArmed and armedDirection == 1 and (not wasArmed or wasArmedDirection != 1)
contextJustArmedShort = isArmed and armedDirection == -1 and (not wasArmed or wasArmedDirection != -1)
contextJustDisarmed = wasArmed and not isArmed

if barstate.isconfirmed
    wasArmed := isArmed
    wasArmedDirection := armedDirection
    lastSession := currentSession


// ============================================================================
// ðŸ” ALERT DIAGNOSTICS PANEL (v2.4.0 - Ported from Forex)
// ============================================================================

var table diagTable = na

diagCriteriaMetCount = (criterion1Pass ? 1 : 0) + (criterion2Pass ? 1 : 0) + 
     (criterion3Pass ? 1 : 0) + (criterion4Pass ? 1 : 0)
diagEntryHotOpt = str.contains(entryZoneQuality, "HOT") or str.contains(entryZoneQuality, "OPTIMAL")
diagEntryAcceptable = diagEntryHotOpt or str.contains(entryZoneQuality, "ACCEPTABLE")
diagEntryOK = strongEntryRequirement == "Any Zone" ? true : strongEntryRequirement == "Include ACCEPTABLE" ? diagEntryAcceptable : diagEntryHotOpt
diagMTFOK = mtfAlignCount == 3
diagIsBull = trendDirection == 1
diagIsBear = trendDirection == -1
diagTimerOK = minutesRemaining > barTimerCritical

if barstate.isfirst and showAlertDiagnostics
    diagTable := table.new(position.bottom_left, 2, 19,
         bgcolor=color.new(color.rgb(30, 30, 40), 10),
         frame_color=color.rgb(100, 100, 120),
         frame_width=1,
         border_width=1,
         border_color=color.rgb(60, 60, 80))

if barstate.islast and showAlertDiagnostics
    table.clear(diagTable, 0, 0, 1, 18)
    
    dRow = 0
    diagSize = size.small
    
    // Header
    table.cell(diagTable, 0, dRow, "DIAGNOSTICS " + indexShort, 
         text_color=color.white, text_size=size.normal,
         bgcolor=color.rgb(80, 80, 100), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, currentSession, 
         text_color=color.yellow, text_size=size.normal,
         bgcolor=color.rgb(80, 80, 100), text_halign=text.align_right)
    dRow += 1
    
    // === CURRENT STATE ===
    table.cell(diagTable, 0, dRow, "--- CURRENT STATE ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    armedDisplayText = isArmed ? (armedDirection == 1 ? "ARMED UP" : "ARMED DN") : "DISARMED"
    armedDisplayColor = isArmed ? color.rgb(34, 197, 94) : color.rgb(239, 68, 68)
    table.cell(diagTable, 0, dRow, "Context State", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, armedDisplayText, 
         text_color=armedDisplayColor, text_size=size.normal,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "Playbook", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, currentPlaybook, 
         text_color=color.rgb(100, 181, 246), text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    lockStatusText = enableSessionLock ? (isArmed ? "LOCKED" : "SEEKING") : "DISABLED"
    lockStatusColor = enableSessionLock ? (isArmed ? color.rgb(34, 197, 94) : color.rgb(234, 179, 8)) : color.gray
    table.cell(diagTable, 0, dRow, "Session Lock", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, lockStatusText, 
         text_color=lockStatusColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // === ARM CONDITIONS ===
    table.cell(diagTable, 0, dRow, "--- ARM CONDITIONS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    scoreOK = overallScore >= alertStrongThreshold
    table.cell(diagTable, 0, dRow, "Score >=" + str.tostring(alertStrongThreshold), 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    scoreIcon = scoreOK ? " PASS" : " FAIL"
    table.cell(diagTable, 1, dRow, str.tostring(math.round(overallScore)) + scoreIcon, 
         text_color=scoreOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "MTF 3/3", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    mtfIcon = diagMTFOK ? " PASS" : " FAIL"
    table.cell(diagTable, 1, dRow, str.tostring(mtfAlignCount) + "/3" + mtfIcon, 
         text_color=diagMTFOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    dirText = diagIsBull ? "BULL" : diagIsBear ? "BEAR" : "MIXED"
    dirOK = diagIsBull or diagIsBear
    dirIcon = dirOK ? " PASS" : " FAIL"
    table.cell(diagTable, 0, dRow, "Direction", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, dirText + dirIcon, 
         text_color=dirOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    entryShortDiag = str.contains(entryZoneQuality, "HOT") ? "HOT" : str.contains(entryZoneQuality, "OPTIMAL") ? "OPT" : str.contains(entryZoneQuality, "ACCEPTABLE") ? "ACC" : str.contains(entryZoneQuality, "DEEP") ? "DEEP" : "EXT"
    entryIcon = diagEntryOK ? " PASS" : " FAIL"
    table.cell(diagTable, 0, dRow, "Entry Zone", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, entryShortDiag + entryIcon, 
         text_color=diagEntryOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    effOK = rawEfficiency >= efficiencyThreshold
    effIcon = effOK ? " PASS" : " FAIL"
    table.cell(diagTable, 0, dRow, "Efficiency >=" + str.tostring(math.round(efficiencyThreshold * 100)) + "%", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(math.round(rawEfficiency * 100)) + "%" + effIcon, 
         text_color=effOK ? color.rgb(34, 171, 148) : color.rgb(239, 83, 80),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    persistOK = barsAboveThreshold >= upgradePersistence
    persistIcon = persistOK ? " PASS" : " WAIT"
    table.cell(diagTable, 0, dRow, "Persistence", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, str.tostring(barsAboveThreshold) + "/" + str.tostring(upgradePersistence) + persistIcon, 
         text_color=persistOK ? color.rgb(34, 171, 148) : color.rgb(234, 179, 8),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // === DISARM TRIGGERS ===
    table.cell(diagTable, 0, dRow, "--- DISARM TRIGGERS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    scoreDropped = isArmed and (overallScore < (armedScore - disarmScoreThreshold))
    table.cell(diagTable, 0, dRow, "Score Drop >" + str.tostring(disarmScoreThreshold), 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, scoreDropped ? "YES WARN" : "NO OK", 
         text_color=scoreDropped ? color.rgb(239, 83, 80) : color.rgb(100, 100, 120),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    table.cell(diagTable, 0, dRow, "Structural Damage", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, structuralDamage ? "YES WARN" : "NO OK", 
         text_color=structuralDamage ? color.rgb(239, 83, 80) : color.rgb(100, 100, 120),
         text_size=diagSize, bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    // === ALERT STATUS ===
    table.cell(diagTable, 0, dRow, "--- ALERT STATUS ---", 
         text_color=color.gray, text_size=diagSize,
         bgcolor=color.rgb(40, 40, 50), text_halign=text.align_center)
    table.cell(diagTable, 1, dRow, "", bgcolor=color.rgb(40, 40, 50))
    dRow += 1
    
    wouldArmLong = not wasArmed and isArmed and armedDirection == 1
    wouldArmShort = not wasArmed and isArmed and armedDirection == -1
    wouldDisarm = wasArmed and not isArmed
    alertWouldFire = wouldArmLong or wouldArmShort or wouldDisarm
    
    diagConfirmed = barstate.isconfirmed
    table.cell(diagTable, 0, dRow, "Bar Confirmed", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, diagConfirmed ? "YES" : "PENDING", 
         text_color=diagConfirmed ? color.rgb(34, 197, 94) : color.rgb(234, 179, 8), text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    string alertTypeText = na
    if alertWouldFire and not diagConfirmed
        alertTypeText := wouldArmLong ? "ARMED UP (at close)" : wouldArmShort ? "ARMED DN (at close)" : "DISARMED (at close)"
    else if alertWouldFire and diagConfirmed
        alertTypeText := wouldArmLong ? "ARMED UP FIRED" : wouldArmShort ? "ARMED DN FIRED" : "DISARMED FIRED"
    else
        alertTypeText := "NO CHANGE"
    alertTypeColor = wouldArmLong or wouldArmShort ? color.rgb(34, 197, 94) : wouldDisarm ? color.rgb(239, 83, 80) : color.gray
    
    table.cell(diagTable, 0, dRow, "ARMED Would Fire", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, alertTypeText, 
         text_color=alertTypeColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)
    dRow += 1
    
    candidateText = contextJustCandidateLong ? "CANDIDATE UP" : contextJustCandidateShort ? "CANDIDATE DN" : candidateMeets ? "ACTIVE" : "NO"
    candidateColor = contextJustCandidate ? color.rgb(234, 179, 8) : candidateMeets ? color.rgb(100, 149, 237) : color.gray
    table.cell(diagTable, 0, dRow, "CANDIDATE Would Fire", 
         text_color=color.white, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_left)
    table.cell(diagTable, 1, dRow, candidateText, 
         text_color=candidateColor, text_size=diagSize,
         bgcolor=color.rgb(30, 30, 40), text_halign=text.align_right)

// ============================================================================
// ALERT CONDITIONS
// ============================================================================

lockPassesLong = enableSessionLock ? (isArmed and armedDirection == 1) : true
lockPassesShort = enableSessionLock ? (isArmed and armedDirection == -1) : true

strongBullishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesStrong and qualityFiltersPassed and mtfAlignCount == 3 and trendDirection == 1 and lockPassesLong)
strongBearishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesStrong and qualityFiltersPassed and mtfAlignCount == 3 and trendDirection == -1 and lockPassesShort)

perfectBullishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesPerfect and entryIsHotOrOptimal and srProximityPasses and mtfAlignCount == 3 and trendDirection == 1 and rsiAllBull and lockPassesLong)
perfectBearishCondition = debugMode ? true : (allCriteriaMet and scoreGapPassesPerfect and entryIsHotOrOptimal and srProximityPasses and mtfAlignCount == 3 and trendDirection == -1 and rsiAllBear and lockPassesShort)

// ============================================================================
// MTF DEGRADATION
// ============================================================================
var int prev1HDirection = 0
var int prev4HDirection = 0
var int prevMTFAlignCount = 0
var float prevTrendScore = 0.0

h1Direction = mtf1Bullish ? 1 : -1
h4Direction = mtf2Bullish ? 1 : -1

h1DirectionFlip = prev1HDirection != 0 and h1Direction != prev1HDirection and barstate.isconfirmed
h4DirectionFlip = prev4HDirection != 0 and h4Direction != prev4HDirection and barstate.isconfirmed
h4ScoreDrop = prevTrendScore >= mtfDegradationScoreThreshold and trendScore < mtfDegradationScoreThreshold and barstate.isconfirmed
mtfAlignmentBreak = prevMTFAlignCount == 3 and mtfAlignCount < 3 and barstate.isconfirmed

mtfDegradationCondition = h1DirectionFlip or h4DirectionFlip or h4ScoreDrop or mtfAlignmentBreak

degradationType = h4DirectionFlip ? "4H FLIP" : h4ScoreDrop ? "4H SCORE" : mtfAlignmentBreak ? "MTF BREAK" : h1DirectionFlip ? "1H FLIP" : ""

if barstate.isconfirmed
    prev1HDirection := h1Direction
    prev4HDirection := h4Direction
    prevMTFAlignCount := mtfAlignCount
    prevTrendScore := trendScore

// ============================================================================
// RISK WARNING
// ============================================================================
currentSpread = currentBarRange
avgSpread = expectedRange

fomcRiskDetected = fomcRiskActive and barstate.isconfirmed
spreadSpikeDetected = spreadWarning and (currentSpread >= avgSpread * riskSpreadMultiplier) and barstate.isconfirmed

riskWarningCondition = fomcRiskDetected or spreadSpikeDetected

riskType = fomcRiskDetected ? "FOMC RISK" : spreadSpikeDetected ? "SPREAD SPIKE" : ""

riskContext = fomcRiskDetected ? "Fed day - stand down" : spreadSpikeDetected ? str.tostring(math.round(currentSpread / avgSpread * 10) / 10) + "x avg" : ""

// v2.3.0: TradingView chart link
chartLink = "https://tradingview.com/chart/?symbol=OANDA:" + syminfo.ticker

// v2.5.0: buildJsonPayload() removed â€” replaced by f_buildAlert() + f_buildJson()

// ============================================================================
// REGISTER ALERT CONDITIONS (v2.5.0 â€” 4-Emoji Standard)
// ============================================================================
// alertcondition() messages must be static strings.
// Using closest static equivalent per alert type with severity prefix.

// ALERT 0: Candidate (Long) - Quality detected, intra-bar
alertcondition(enableContextCandidate and contextJustCandidateLong, 
     title="CANDIDATE Long",
     message='ðŸŸ¡ [C] CANDIDATE | {{ticker}} | R-TRANSITION | K-NORMAL | CONDITIONAL')

// ALERT 0: Candidate (Short) - Quality detected, intra-bar
alertcondition(enableContextCandidate and contextJustCandidateShort, 
     title="CANDIDATE Short",
     message='ðŸŸ¡ [C] CANDIDATE | {{ticker}} | R-TRANSITION | K-NORMAL | CONDITIONAL')

// ALERT 1: Armed (Long) - Full permission, bar close confirmed
alertcondition(enableContextArmed and contextJustArmedLong and barstate.isconfirmed, 
     title="ARMED Long",
     message='ðŸŸ¢ [A] ARMED | {{ticker}} | R-EXPANSION | K-NORMAL | FULL')

// ALERT 2: Armed (Short) - Full permission, bar close confirmed
alertcondition(enableContextArmed and contextJustArmedShort and barstate.isconfirmed, 
     title="ARMED Short",
     message='ðŸŸ¢ [A] ARMED | {{ticker}} | R-EXPANSION | K-NORMAL | FULL')

// ALERT 3: Blocked - Explicit veto, bar close confirmed
alertcondition(enableContextDisarmed and contextJustDisarmed and barstate.isconfirmed, 
     title="BLOCKED",
     message='ðŸ”´ [B] BLOCKED | {{ticker}} | R-COMPRESSION | STAND_DOWN')

// ALERT 4: Info - Session reset, context only
alertcondition(enableSessionReset and sessionResetEvent, 
     title="INFO Session Reset",
     message='âšª [I] INFO | {{ticker}} | SESSION_RESET')

// ============================================================================
// DETAILED ALERTS (v2.5.0 â€” Institutional f_buildAlert)
// ============================================================================
// buildDetailMsg() removed â€” replaced by f_buildAlert() + f_buildJson()
// All alerts now use resolved variables from the Priority Resolver.
// Scan line format: [emoji] [prefix] TYPE | PAIR | PRIMARY_REASON | RISK_STATE | U-SCORE-XX
// Body format: Primary + Contributing + Permission + Execution (em-dash separated)

useAlertPerBar = alertMode == "alert() per bar"
useAlertBarClose = alertMode == "alert() bar close"
alertFreq = useAlertBarClose ? alert.freq_once_per_bar_close : alert.freq_once_per_bar

if useAlertPerBar or useAlertBarClose
    // --- State change: CANDIDATE fired (real-time, no bar close wait) ---
    if enableContextCandidate and contextJustCandidateLong
        string candAlert = f_buildAlert(ALERT_CANDIDATE, syminfo.ticker, primaryReason, contributingStr, finalPermission, resolvedExecution, riskCode, math.round(overallScore))
        string candJson = f_buildJson(ALERT_CANDIDATE, primaryReason, contributingStr, finalPermission, riskCode, resolvedExecution, math.round(overallScore))
        alert(candAlert + "\n" + candJson, alert.freq_once_per_bar)
    
    if enableContextCandidate and contextJustCandidateShort
        string candAlertS = f_buildAlert(ALERT_CANDIDATE, syminfo.ticker, primaryReason, contributingStr, finalPermission, resolvedExecution, riskCode, math.round(overallScore))
        string candJsonS = f_buildJson(ALERT_CANDIDATE, primaryReason, contributingStr, finalPermission, riskCode, resolvedExecution, math.round(overallScore))
        alert(candAlertS + "\n" + candJsonS, alert.freq_once_per_bar)
    
    // --- State change: ARMED fired (bar close confirmed) ---
    if enableContextArmed and contextJustArmedLong and barstate.isconfirmed
        string armAlert = f_buildAlert(ALERT_ARMED, syminfo.ticker, primaryReason, contributingStr, finalPermission, resolvedExecution, riskCode, math.round(overallScore))
        string armJson = f_buildJson(ALERT_ARMED, primaryReason, contributingStr, finalPermission, riskCode, resolvedExecution, math.round(overallScore))
        alert(armAlert + "\n" + armJson, alertFreq)
    
    if enableContextArmed and contextJustArmedShort and barstate.isconfirmed
        string armAlertS = f_buildAlert(ALERT_ARMED, syminfo.ticker, primaryReason, contributingStr, finalPermission, resolvedExecution, riskCode, math.round(overallScore))
        string armJsonS = f_buildJson(ALERT_ARMED, primaryReason, contributingStr, finalPermission, riskCode, resolvedExecution, math.round(overallScore))
        alert(armAlertS + "\n" + armJsonS, alertFreq)
    
    // --- State change: BLOCKED (was DISARMED â€” bar close confirmed) ---
    if enableContextDisarmed and contextJustDisarmed and barstate.isconfirmed
        string blkAlert = f_buildAlert(ALERT_BLOCKED, syminfo.ticker, primaryReason, contributingStr, finalPermission, EXECUTION_NONE, riskCode, math.round(overallScore))
        string blkJson = f_buildJson(ALERT_BLOCKED, primaryReason, contributingStr, finalPermission, riskCode, EXECUTION_NONE, math.round(overallScore))
        alert(blkAlert + "\n" + blkJson, alertFreq)
    
    // --- Session reset: INFO type ---
    if enableSessionReset and sessionResetEvent
        string infoHeader = f_alertHeader(ALERT_INFO, syminfo.ticker, "SESSION_RESET", riskCode, "U-SCORE-0")
        string infoBody = "Primary: SESSION_RESET\nContributing: [" + currentSession + "]\n\nPERMISSION: STAND_DOWN\nEXECUTION:\nNONE"
        string infoJson = '{"type":"INFO","pair":"' + syminfo.ticker + '","asset_class":"INDICES","primary":"SESSION_RESET","session":"' + currentSession + '"}'
        alert(infoHeader + "\n\u2014\n" + infoBody + "\n" + infoJson, alert.freq_once_per_bar)

// ============================================================================
// END OF UTCC INDICES v2.5.1
// ============================================================================
