<!DOCTYPE html>
<!-- Forex Command Centre v2.8.0 -->
<!-- UTCS Integration: Phase 1-4 (Alert Queue, Trade Capture, Quick Journal, Oanda History) -->
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Command Centre</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- UTCS Phase 1-4 Styles -->
    <link rel="stylesheet" href="css/alert-queue-ui.css">
    <link rel="stylesheet" href="css/trade-capture-ui.css">
    
    <style>
        /* ============================================
           CSS RESET & BASE
           ============================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* ============================================
           CSS VARIABLES - THEMES
           ============================================ */
        :root {
            /* Typography */
            --font-heading: 'JetBrains Mono', monospace;
            --font-body: 'Inter', sans-serif;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            
            /* Status Colours */
            --color-pass: #22c55e;
            --color-fail: #ef4444;
            --color-warning: #eab308;
            --color-info: #3b82f6;
            --color-perfect: #a855f7;
            
            /* Asset Class Info Panel */
        .asset-info-panel {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            display: none;
        }
        
        .asset-info-panel.active {
            display: block;
        }
        
        .asset-info-panel.forex { background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--color-pass); }
        .asset-info-panel.metals { background: rgba(234, 179, 8, 0.1); border-left: 3px solid #f59e0b; }
        .asset-info-panel.energy { background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--color-fail); }
        .asset-info-panel.indices { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--color-info); }
        .asset-info-panel.bonds { background: rgba(168, 85, 247, 0.1); border-left: 3px solid var(--color-perfect); }
        .asset-info-panel.crypto { background: rgba(249, 115, 22, 0.1); border-left: 3px solid #f97316; }
        
        .asset-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }
        
        .asset-info-badge {
            font-weight: 600;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        .asset-info-badge.forex { background: var(--color-pass); color: white; }
        .asset-info-badge.metals { background: #f59e0b; color: white; }
        .asset-info-badge.energy { background: var(--color-fail); color: white; }
        .asset-info-badge.indices { background: var(--color-info); color: white; }
        .asset-info-badge.bonds { background: var(--color-perfect); color: white; }
        .asset-info-badge.crypto { background: #f97316; color: white; }
        
        .asset-risk-badge {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
        }
        
        .asset-info-details {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .asset-warning {
            margin-top: var(--spacing-xs);
            padding: var(--spacing-xs);
            background: rgba(239, 68, 68, 0.15);
            border-radius: 4px;
            color: var(--color-fail);
            font-weight: 500;
        }
        
        /* Entry Zone Colours */
            --zone-hot: linear-gradient(135deg, #ef4444, #f97316);
            --zone-optimal: linear-gradient(135deg, #22c55e, #16a34a);
            --zone-acceptable: linear-gradient(135deg, #eab308, #ca8a04);
            --zone-extended: linear-gradient(135deg, #6b7280, #4b5563);
            
            /* Volatility State Colours */
            --vol-trend: #22c55e;
            --vol-explode: #a855f7;
            --vol-quiet: #3b82f6;
            --vol-low: #ef4444;
            
            /* Alert Type Colours */
            --alert-trade-ready: #22c55e;
            --alert-strong: #3b82f6;
            --alert-perfect: #a855f7;
            --alert-watch: #eab308;
            
            /* Drawdown Protocol Colours */
            --drawdown-normal: #22c55e;
            --drawdown-caution: #eab308;
            --drawdown-stop: #f97316;
            --drawdown-emergency: #ef4444;
        }
        
        /* Upcoming News Box */
        .news-stale-warning {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(234, 179, 8, 0.15);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            color: var(--color-warning);
            font-weight: 500;
            margin-bottom: var(--spacing-md);
            font-size: 0.85rem;
        }
        
        /* Floating Calendar FAB */
        .fab-calendar {
            position: fixed;
            bottom: var(--spacing-xl);
            right: calc(var(--spacing-xl) + 70px);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-info);
            color: #fff;
            border: none;
            text-decoration: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: transform 150ms ease, box-shadow 150ms ease;
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab-calendar:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }
        
        /* ============================================
           REGIME CHECK MODULE STYLES
           ============================================ */
        
        /* Status Banner */
        .regime-status-banner {
            margin-bottom: var(--spacing-lg);
        }
        
        .regime-status-blocked {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-md);
            color: var(--color-fail);
            font-weight: 500;
        }
        
        .regime-status-active {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid;
            border-radius: var(--radius-md);
            font-weight: 500;
        }
        
        .override-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: var(--color-warning);
            color: #000;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Regime Badges */
        .regime-badge-info {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
        }
        
        .regime-badge-warning {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: rgba(234, 179, 8, 0.2);
            border-radius: 4px;
            color: var(--color-warning);
        }
        
        /* Daily Context */
        .regime-form-card {
            padding: var(--spacing-md);
        }
        
        .regime-form-instruction {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
        }
        
        .regime-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .regime-form-warning {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(234, 179, 8, 0.1);
            border-radius: var(--radius-sm);
            color: var(--color-warning);
            font-size: 0.85rem;
            margin-bottom: var(--spacing-md);
        }
        
        .regime-locked-card {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin: var(--spacing-md);
        }
        
        .regime-locked-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .regime-locked-icon {
            font-size: 1.2rem;
        }
        
        .regime-locked-time {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .regime-locked-content {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .regime-locked-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .regime-locked-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .regime-locked-value {
            font-weight: 600;
        }
        
        /* Market State Colors */
        .regime-state-expansion { color: var(--color-pass); }
        .regime-state-balanced { color: var(--color-info); }
        .regime-state-transition { color: var(--color-warning); }
        .regime-state-compression { color: var(--color-fail); }
        
        /* Macro Colors */
        .regime-macro-clear { color: var(--color-pass); }
        .regime-macro-caution { color: var(--color-warning); }
        .regime-macro-stand-down { color: var(--color-fail); }
        
        /* Sessions Grid */
        .regime-sessions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            padding: 0 var(--spacing-md) var(--spacing-md);
        }
        
        .regime-session-card {
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .regime-session-form {
            padding: var(--spacing-md);
        }
        
        .regime-session-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .regime-session-icon {
            font-size: 1.2rem;
        }
        
        .regime-session-name {
            font-weight: 600;
        }
        
        .regime-session-badge {
            margin-left: auto;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .regime-session-badge.pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .regime-permission-badge {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #000;
        }
        
        .regime-session-fields {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .regime-session-fields .form-group {
            margin-bottom: 0;
        }
        
        .regime-session-fields .form-label {
            font-size: 0.75rem;
        }
        
        .regime-session-fields .form-select {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.85rem;
        }
        
        .form-hint {
            display: block;
            font-weight: 400;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .regime-session-locked {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
        }
        
        .regime-session-details {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            font-size: 0.85rem;
        }
        
        .regime-detail-row {
            display: flex;
            justify-content: space-between;
        }
        
        .regime-detail-row span:first-child {
            color: var(--text-muted);
        }
        
        .regime-session-time {
            margin-top: var(--spacing-sm);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-primary);
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Override Section */
        .override-not-needed {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            color: var(--color-pass);
        }
        
        .override-active {
            padding: var(--spacing-md);
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            margin: var(--spacing-md);
        }
        
        .override-active-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 700;
            color: var(--color-warning);
            margin-bottom: var(--spacing-sm);
        }
        
        .override-active-details {
            font-size: 0.85rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .override-active-details div {
            margin-bottom: 4px;
        }
        
        .override-active-rules {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .override-available {
            padding: var(--spacing-md);
        }
        
        .override-available-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .override-available-text {
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .override-rules-list {
            list-style: none;
            padding: 0;
            margin: 0 0 var(--spacing-md) 0;
            font-size: 0.85rem;
        }
        
        .override-rules-list li {
            padding: var(--spacing-xs) 0;
            padding-left: var(--spacing-md);
            position: relative;
            color: var(--text-secondary);
        }
        
        .override-rules-list li::before {
            content: "\2022";
            position: absolute;
            left: 0;
            color: var(--color-warning);
        }
        
        .override-confirm {
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-sm);
        }
        
        .btn-warning {
            background: var(--color-warning);
            color: #000;
        }
        
        .btn-warning:hover {
            background: #ca8a04;
        }
        
        .btn-warning:disabled {
            background: var(--border-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        /* Tracking Table */
        .tracking-stats {
            display: flex;
            gap: var(--spacing-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .tracking-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tracking-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-heading);
            color: var(--accent-primary);
        }
        
        .tracking-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .tracking-table-wrapper {
            overflow-x: auto;
            padding: 0 var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .tracking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .tracking-table th,
        .tracking-table td {
            padding: var(--spacing-sm);
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .tracking-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .text-pass { color: var(--color-pass); }
        .text-fail { color: var(--color-fail); }
        
        .tracking-add-form {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin: var(--spacing-md);
        }
        
        .tracking-add-form h4 {
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
        }
        
        .tracking-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .tracking-form-grid .form-group {
            margin-bottom: 0;
        }
        
        .tracking-form-grid .form-label {
            font-size: 0.7rem;
        }
        
        .tracking-form-grid .form-input,
        .tracking-form-grid .form-select {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.85rem;
        }
        
        .required {
            color: var(--color-fail);
        }
        
        /* Regime Tooltips */
        .regime-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            font-size: 0.65rem;
            color: var(--text-muted);
            cursor: help;
            vertical-align: middle;
        }
        
        .regime-tooltip-content {
            display: none;
            position: fixed;
            width: 300px;
            max-width: 90vw;
            padding: var(--spacing-md);
            background: var(--bg-primary);
            border: 2px solid var(--border-secondary);
            border-radius: var(--radius-md);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1.6;
            z-index: 9999;
            pointer-events: none;
        }
        
        .regime-tooltip-content::after {
            display: none; /* Hide arrow for fixed positioning */
        }
        
        .regime-tooltip:hover .regime-tooltip-content {
            display: block;
        }
        
        .regime-tooltip-content strong {
            color: var(--text-primary);
        }
        
        /* ============================================
           INSTITUTIONAL JOURNAL STYLES
           ============================================ */
        
        .journal-section {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .journal-section:last-of-type {
            border-bottom: none;
            margin-bottom: var(--spacing-md);
        }
        
        .journal-section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .journal-section-letter {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--accent-primary);
            color: #000;
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 50%;
        }
        
        .journal-section-title {
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .journal-section-badge {
            margin-left: auto;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .journal-section-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-fail);
        }
        
        .journal-section-badge.secondary {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .journal-section-badge.edge {
            background: rgba(168, 85, 247, 0.15);
            color: var(--color-perfect);
        }
        
        /* Permission Log */
        .permission-log-grid {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .permission-log-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }
        
        .permission-log-row.highlight {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
        }
        
        .permission-log-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            min-width: 140px;
        }
        .permission-log-value {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            text-transform: capitalize;
        }
        
        .permission-log-row .form-select {
            width: auto;
            min-width: 160px;
        }
        
        .permission-warning {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-sm);
            color: var(--color-fail);
            font-size: 0.85rem;
        }
        
        .permission-decision {
            margin-top: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .permission-decision-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .permission-decision-value {
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .permission-decision.decision-full {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
        }
        .permission-decision.decision-full .permission-decision-value {
            color: var(--color-pass);
        }
        
        .permission-decision.decision-conditional {
            background: rgba(234, 179, 8, 0.15);
            border: 1px solid var(--color-warning);
        }
        .permission-decision.decision-conditional .permission-decision-value {
            color: var(--color-warning);
        }
        
        .permission-decision.decision-blocked {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
        }
        .permission-decision.decision-blocked .permission-decision-value {
            color: var(--color-fail);
        }
        
        /* Execution Checklist */
        .execution-checklist,
        .management-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .execution-check,
        .management-check {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .execution-check:hover,
        .management-check:hover {
            background: var(--bg-hover);
        }
        
        .execution-check input,
        .management-check input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }
        
        .execution-check span,
        .management-check span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .execution-check input:checked + span,
        .management-check input:checked + span {
            color: var(--color-pass);
        }
        
        /* Review Question */
        .review-question {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--color-perfect);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .review-question-text {
            margin: 0;
            font-style: italic;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        /* ============================================
           QUICK SCAN GUIDE STYLES
           ============================================ */
        
        .quick-scan-guide {
            margin-bottom: var(--spacing-lg);
            border: 2px solid var(--accent-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .quick-scan-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: rgba(34, 197, 94, 0.1);
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .quick-scan-header:hover {
            background: rgba(34, 197, 94, 0.15);
        }
        
        .quick-scan-icon {
            font-size: 1.2rem;
        }
        
        .quick-scan-title {
            font-weight: 600;
            color: var(--accent-primary);
        }
        
        .quick-scan-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .quick-scan-toggle {
            margin-left: auto;
            color: var(--text-muted);
        }
        
        .quick-scan-content {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
        }
        
        .quick-scan-step {
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .quick-scan-step:last-of-type {
            border-bottom: none;
            margin-bottom: var(--spacing-md);
        }
        
        .quick-scan-step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            color: #000;
            font-weight: 700;
            font-size: 0.8rem;
            border-radius: 50%;
        }
        
        .step-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .quick-scan-question p {
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
        }
        
        .scan-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .scan-option {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .scan-option:hover {
            border-color: var(--border-secondary);
            background: var(--bg-hover);
        }
        
        .scan-option.selected {
            border-color: var(--accent-primary);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .scan-option-icon {
            font-size: 1.5rem;
            line-height: 1;
        }
        
        .scan-option-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.4;
        }
        
        .scan-option-text small {
            display: block;
            color: var(--text-muted);
            font-size: 0.75rem;
            margin-top: 4px;
        }
        
        .quick-scan-checklist {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .scan-check {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .scan-check:hover {
            background: var(--bg-hover);
        }
        
        .scan-check input {
            width: 18px;
            height: 18px;
            accent-color: var(--color-warning);
        }
        
        .scan-check span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .scan-check-result {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--color-warning);
            opacity: 0.7;
        }
        
        .scan-check input:checked ~ .scan-check-result {
            opacity: 1;
            font-weight: 600;
        }
        
        .quick-scan-driver p {
            margin-bottom: var(--spacing-sm);
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .driver-prompt {
            font-size: 1rem;
            font-style: italic;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .driver-prompt span {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .quick-scan-result {
            padding: var(--spacing-md);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .quick-scan-result p {
            margin: 0;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .scan-result-summary {
            display: flex;
            gap: var(--spacing-lg);
        }
        
        .scan-result-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .scan-result-item span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .scan-result-item strong {
            font-size: 1rem;
        }



        /* Dark Theme (Default) */
        [data-theme="dark"] {
            --bg-primary: #0a0a0f;
            --bg-secondary: #111118;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161e;
            --bg-hover: #1e1e2a;
            --bg-input: #0d0d12;
            
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            
            --border-primary: #27272a;
            --border-secondary: #3f3f46;
            --border-accent: #22c55e;
            
            --accent-primary: #22c55e;
            --accent-hover: #16a34a;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.5);
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #e2e8f0;
            --bg-input: #f8fafc;
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            
            --border-primary: #e2e8f0;
            --border-secondary: #cbd5e1;
            --border-accent: #16a34a;
            
            --accent-primary: #16a34a;
            --accent-hover: #15803d;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        /* ============================================
           BASE STYLES
           ============================================ */
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 600;
            line-height: 1.3;
            color: var(--text-primary);
        }

        h1 { font-size: 1.75rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        h4 { font-size: 1.125rem; }
        h5 { font-size: 1rem; }
        h6 { font-size: 0.875rem; }

        p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--accent-hover);
        }

        /* ============================================
           LAYOUT COMPONENTS
           ============================================ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-md);
        }

        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .app-title h1 {
            font-size: 1.25rem;
            color: var(--accent-primary);
        }

        .app-title span {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-heading);
        }

        /* ============================================
           TAB NAVIGATION
           ============================================ */
        .tab-nav {
            display: flex;
            gap: var(--spacing-xs);
            background: var(--bg-tertiary);
            padding: var(--spacing-xs);
            border-radius: var(--radius-lg);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-nav::-webkit-scrollbar {
            height: 4px;
        }

        .tab-nav::-webkit-scrollbar-track {
            background: transparent;
        }

        .tab-nav::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 2px;
        }

        .tab-btn {
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 500;
            padding: var(--spacing-sm) var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent-primary);
            color: #000;
        }

        /* ============================================
           TAB CONTENT
           ============================================ */
        .tab-content {
            display: none;
            padding: var(--spacing-lg) 0;
            animation: fadeIn 0.2s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .card:hover {
            border-color: var(--border-secondary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-primary);
        }

        .card-title {
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ============================================
           ARMED INSTRUMENTS PANEL (Institutional)
           ============================================ */
        .armed-panel-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .armed-section-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-color);
            margin-top: var(--spacing-sm);
        }

        .armed-section-header:first-child {
            margin-top: 0;
        }

        .armed-section-count {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 8px;
            background: var(--text-muted);
            color: #fff;
        }

        .armed-section-count.armed {
            background: var(--color-pass);
            color: #000;
        }

        .armed-section-count.candidate {
            background: var(--color-warning);
            color: #000;
        }

        .armed-col-headers {
            display: grid;
            grid-template-columns: 28px 72px 1fr 70px 52px 36px 42px;
            gap: var(--spacing-sm);
            padding: 2px var(--spacing-md);
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .armed-pair-row {
            display: grid;
            grid-template-columns: 28px 72px 1fr 70px 52px 36px 42px;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
        }

        .armed-pair-row:hover {
            filter: brightness(1.15);
        }

        /* Permission-based row colours */
        .armed-pair-row.permission-full {
            background: rgba(34, 197, 94, 0.12);
            border-left: 3px solid var(--color-pass);
        }

        .armed-pair-row.permission-conditional {
            background: rgba(234, 179, 8, 0.12);
            border-left: 3px solid var(--color-warning);
        }

        .armed-pair-row.permission-legacy {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--text-muted);
        }

        .armed-emoji {
            font-size: 0.9rem;
            text-align: center;
        }

        .armed-pair-name {
            font-weight: 700;
            color: var(--text-primary);
            font-family: var(--font-heading);
            font-size: 0.85rem;
            letter-spacing: 0.02em;
        }

        .armed-primary {
            color: var(--color-info);
            font-size: 0.8rem;
            font-family: var(--font-heading);
            font-weight: 500;
        }

        .armed-permission {
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
        }

        .armed-permission.full {
            color: var(--color-pass);
        }

        .armed-permission.conditional {
            color: var(--color-warning);
        }

        .armed-permission.stand-down {
            color: var(--color-fail);
        }

        .armed-maxrisk {
            font-size: 0.8rem;
            color: var(--text-primary);
            text-align: center;
            font-family: var(--font-heading);
            font-weight: 500;
        }

        .armed-score {
            font-size: 0.8rem;
            font-weight: 700;
            text-align: center;
            font-family: var(--font-heading);
        }

        .armed-age {
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-align: right;
        }

        .armed-empty {
            text-align: center;
            color: var(--text-muted);
            padding: var(--spacing-lg);
            font-size: 0.85rem;
        }

        .armed-error {
            text-align: center;
            color: var(--color-fail);
            padding: var(--spacing-md);
            font-size: 0.8rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-md);
        }

        .armed-panel-count {
            background: var(--color-pass);
            color: #000;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 2px 10px;
            border-radius: 10px;
        }

        .armed-panel-count.zero {
            background: var(--text-muted);
            color: #fff;
        }

        .armed-refresh-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ============================================
           FORM ELEMENTS
           ============================================ */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-family: var(--font-heading);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.9rem;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2371717a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }

        /* Checkbox styling */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            cursor: pointer;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            font-family: var(--font-heading);
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #000;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: var(--border-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-secondary);
        }

        .btn-danger {
            background: var(--color-fail);
            color: #fff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1rem;
        }

        /* ============================================
           BADGES
           ============================================ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            font-family: var(--font-heading);
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-pass { background: rgba(34, 197, 94, 0.15); color: var(--color-pass); }
        .badge-fail { background: rgba(239, 68, 68, 0.15); color: var(--color-fail); }
        .badge-warning { background: rgba(234, 179, 8, 0.15); color: var(--color-warning); }
        .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--color-info); }
        .badge-perfect { background: rgba(168, 85, 247, 0.15); color: var(--color-perfect); }

        /* Alert Type Badges */
        .badge-trade-ready { background: rgba(34, 197, 94, 0.15); color: var(--alert-trade-ready); }
        .badge-strong { background: rgba(59, 130, 246, 0.15); color: var(--alert-strong); }
        .badge-perfect-alert { background: rgba(168, 85, 247, 0.15); color: var(--alert-perfect); }
        .badge-watch { background: rgba(234, 179, 8, 0.15); color: var(--alert-watch); }

        /* Volatility Badges */
        .badge-vol-trend { background: rgba(34, 197, 94, 0.15); color: var(--vol-trend); }
        .badge-vol-explode { background: rgba(168, 85, 247, 0.15); color: var(--vol-explode); }
        .badge-vol-quiet { background: rgba(59, 130, 246, 0.15); color: var(--vol-quiet); }
        .badge-vol-low { background: rgba(239, 68, 68, 0.15); color: var(--vol-low); }

        /* Entry Zone Badges */
        .badge-zone-hot {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.2));
            color: #f97316;
        }
        .badge-zone-optimal {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.2));
            color: #22c55e;
        }
        .badge-zone-acceptable {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(202, 138, 4, 0.2));
            color: #eab308;
        }
        .badge-zone-extended {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        /* ============================================
           TABLES
           ============================================ */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .table th,
        .table td {
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-primary);
        }

        .table th {
            background: var(--bg-tertiary);
            font-family: var(--font-heading);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table tr:last-child td {
            border-bottom: none;
        }

        .table tr:hover td {
            background: var(--bg-hover);
        }

        /* ============================================
           GRID LAYOUTS
           ============================================ */
        .grid {
            display: grid;
            gap: var(--spacing-md);
        }

        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }

        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 640px) {
            .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
        }

        /* ============================================
           STAT BOXES
           ============================================ */
        .stat-box {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            text-align: center;
        }

        .stat-value {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-value.positive { color: var(--color-pass); }
        .stat-value.negative { color: var(--color-fail); }
        .stat-value.warning { color: var(--color-warning); }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ============================================
           DRAWDOWN PROTOCOL INDICATOR
           ============================================ */
        .drawdown-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .drawdown-indicator.normal {
            background: rgba(34, 197, 94, 0.1);
            color: var(--drawdown-normal);
            border: 1px solid var(--drawdown-normal);
        }

        .drawdown-indicator.caution {
            background: rgba(234, 179, 8, 0.1);
            color: var(--drawdown-caution);
            border: 1px solid var(--drawdown-caution);
        }

        .drawdown-indicator.stop {
            background: rgba(249, 115, 22, 0.1);
            color: var(--drawdown-stop);
            border: 1px solid var(--drawdown-stop);
        }

        .drawdown-indicator.emergency {
            background: rgba(239, 68, 68, 0.1);
            color: var(--drawdown-emergency);
            border: 1px solid var(--drawdown-emergency);
        }

        .drawdown-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ============================================
           ACTIVE TRADES WIDGET
           ============================================ */
        .no-trades-widget {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            gap: var(--spacing-sm);
        }
        
        .active-trades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-md);
        }
        
        .active-trade-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border-left: 4px solid var(--border-primary);
            transition: all var(--transition-fast);
        }
        
        .active-trade-card:hover {
            background: var(--bg-hover);
        }
        
        .active-trade-card.trade-long {
            border-left-color: var(--color-pass);
        }
        
        .active-trade-card.trade-short {
            border-left-color: var(--color-fail);
        }
        
        .active-trade-card.needs-attention {
            animation: attention-pulse 2s ease-in-out infinite;
        }
        
        @keyframes attention-pulse {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 12px rgba(234, 179, 8, 0.4); }
        }
        
        .trade-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .trade-card-pair {
            font-family: var(--font-heading);
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .trade-card-direction {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
        }
        
        .trade-card-direction.long {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-pass);
        }
        
        .trade-card-direction.short {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-fail);
        }
        
        .trade-card-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
        }
        
        .trade-card-stat {
            text-align: center;
        }
        
        .trade-card-stat-value {
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .trade-card-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .trade-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-primary);
        }
        
        .trade-card-age {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .trade-card-age.warning {
            color: var(--color-warning);
        }
        
        .trade-card-age.danger {
            color: var(--color-fail);
        }
        
        .trade-summary-bar {
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-md);
        }
        
        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .summary-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .summary-value {
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        @media (max-width: 600px) {
            .active-trades-grid {
                grid-template-columns: 1fr;
            }
            
            .trade-summary-bar {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }

        /* ============================================
           NEXTCLOUD SYNC
           ============================================ */
        .sync-action-box {
            background: var(--bg-tertiary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }
        
        .sync-action-box h4 {
            font-size: 1rem;
        }
        
        .sync-status-bar {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
            border-radius: var(--radius-md);
        }
        
        .sync-status-bar.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-fail);
        }
        
        .sync-status-bar.warning {
            background: rgba(234, 179, 8, 0.1);
            border-color: var(--color-warning);
        }
        
        .sync-status-icon {
            font-size: 1.2rem;
        }
        
        .sync-status-text {
            font-size: 0.9rem;
        }

        /* ============================================
           ACCORDION
           ============================================ */
        .accordion {
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .accordion-item {
            border-bottom: 1px solid var(--border-primary);
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: none;
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .accordion-header:hover {
            background: var(--bg-hover);
        }

        .accordion-icon {
            transition: transform var(--transition-fast);
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            display: none;
            padding: var(--spacing-md);
            background: var(--bg-card);
        }

        .accordion-item.open .accordion-content {
            display: block;
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.2s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-primary);
        }

        .modal-title {
            font-family: var(--font-heading);
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        /* ============================================
           FLOATING ACTION BUTTON (Active Trades)
           ============================================ */
        .fab {
            position: fixed;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: #000;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: transform var(--transition-fast), box-shadow var(--transition-fast);
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .fab-trade-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            background: var(--color-fail);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .fab-trade-count.zero {
            background: var(--text-muted);
        }

        /* ============================================
           VERDICT BOX
           ============================================ */
        .verdict-box {
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            text-align: center;
            font-family: var(--font-heading);
            border: 2px solid;
        }

        .verdict-box.ready {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--color-pass);
            color: var(--color-pass);
        }

        .verdict-box.caution {
            background: rgba(234, 179, 8, 0.1);
            border-color: var(--color-warning);
            color: var(--color-warning);
        }

        .verdict-box.blocked {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-fail);
            color: var(--color-fail);
        }

        .verdict-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--spacing-xs);
        }

        .verdict-status {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* ============================================
           PAIR CARD (Daily Scan)
           ============================================ */
        .pair-card {
            background: var(--bg-card);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .pair-card:hover {
            border-color: var(--border-secondary);
        }

        .pair-card.trade-ready {
            border-color: var(--color-pass);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        .pair-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .pair-name {
            font-family: var(--font-heading);
            font-size: 1rem;
            font-weight: 700;
        }

        .pair-criteria {
            display: flex;
            gap: 4px;
        }

        .criteria-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-secondary);
        }

        .criteria-dot.pass { background: var(--color-pass); }
        .criteria-dot.fail { background: var(--color-fail); }

        /* ============================================
           CRITERIA CHECKLIST
           ============================================ */
        .criteria-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            transition: border-color var(--transition-fast);
        }

        .criteria-item.pass {
            border-color: var(--color-pass);
        }

        .criteria-item.fail {
            border-color: var(--color-fail);
        }

        .criteria-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .criteria-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-heading);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .criteria-item.pass .criteria-number {
            background: var(--color-pass);
            color: #000;
        }

        .criteria-title {
            font-family: var(--font-heading);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .criteria-sub {
            padding-left: calc(24px + var(--spacing-sm));
        }

        .criteria-sub .checkbox-wrapper {
            margin-bottom: var(--spacing-xs);
        }

        /* ============================================
           STRUCTURE SAFETY NET
           ============================================ */
        #structure-safety-net {
            border: 2px solid var(--color-warning);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(234, 179, 8, 0.05) 100%);
        }

        .safety-net-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) var(--spacing-md);
            overflow: hidden;
            transition: border-color var(--transition-fast), background var(--transition-fast);
        }

        .safety-net-item.checked {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.05);
        }

        .safety-net-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-primary);
        }

        .safety-net-item.checked .safety-net-header {
            background: rgba(34, 197, 94, 0.1);
        }

        .safety-net-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-warning);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-heading);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .safety-net-item.checked .safety-net-number {
            background: var(--color-pass);
        }

        .safety-net-item.checked .safety-net-number::after {
            content: '\2714';
        }

        .safety-net-item.checked .safety-net-number {
            font-size: 0;
        }

        .safety-net-item.checked .safety-net-number::after {
            font-size: 0.85rem;
        }

        .safety-net-title {
            font-family: var(--font-heading);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .safety-net-content {
            padding: var(--spacing-md);
        }

        .safety-net-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            line-height: 1.5;
        }

        .structure-rr-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .structure-rr-box {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            text-align: center;
        }

        .structure-rr-box.highlight {
            border-color: var(--color-warning);
            background: rgba(234, 179, 8, 0.1);
        }

        .structure-rr-box.rr-good {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }

        .structure-rr-box.rr-bad {
            border-color: var(--color-fail);
            background: rgba(239, 68, 68, 0.1);
        }

        .structure-rr-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .structure-rr-value {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .structure-rr-box.rr-good .structure-rr-value {
            color: var(--color-pass);
        }

        .structure-rr-box.rr-bad .structure-rr-value {
            color: var(--color-fail);
        }

        .safety-net-verdict {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            margin: var(--spacing-md);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-secondary);
        }

        .safety-net-verdict.verdict-ready {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid var(--color-pass);
        }

        .safety-net-verdict.verdict-blocked {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--color-fail);
        }

        .safety-verdict-icon {
            font-size: 1.5rem;
        }

        .safety-verdict-text {
            font-family: var(--font-heading);
            font-size: 1rem;
            font-weight: 600;
        }

        .safety-net-verdict.verdict-ready .safety-verdict-text {
            color: var(--color-pass);
        }

        .safety-net-verdict.verdict-blocked .safety-verdict-text {
            color: var(--color-fail);
        }

        /* Correlation Check Styles */
        .correlation-warning {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .correlation-icon {
            font-size: 1.2rem;
        }

        .correlation-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-fail);
        }

        .correlation-groups {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin: var(--spacing-sm) 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .correlation-group {
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 4px 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .correlation-group:last-child {
            border-bottom: none;
        }

        .correlation-group strong {
            color: var(--text-primary);
        }

        .correlation-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .correlation-status.status-clear {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
        }

        .correlation-status.status-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
        }

        .correlation-groups-collapse {
            padding: 0 var(--spacing-md);
        }

        /* ============================================
           ENTRY STRATEGY STYLES
           ============================================ */
        #entry-strategy-card {
            border: 2px solid var(--accent-tertiary);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.03) 100%);
        }

        /* Entry Decision Panel - NEW */
        .entry-decision-panel {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--accent-tertiary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .decision-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--accent-tertiary);
        }

        .decision-context {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-xs);
            font-size: 0.85rem;
            margin-bottom: var(--spacing-sm);
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-xs);
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }

        .context-label { color: var(--text-muted); }
        .context-value { color: var(--text-primary); font-weight: 500; }

        .decision-recommendation {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .decision-recommendation.wait {
            background: rgba(234, 179, 8, 0.1);
            border-color: var(--color-warning);
        }

        .rec-type {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .rec-type strong {
            color: var(--color-pass);
            font-size: 1rem;
        }

        .decision-recommendation.wait .rec-type strong {
            color: var(--color-warning);
        }

        .rec-reason {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .decision-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Kill Zone Indicator - NEW */
        .kill-zone-indicator {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--color-perfect);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            animation: kz-pulse 2s ease-in-out infinite;
        }

        @keyframes kz-pulse {
            0%, 100% { box-shadow: 0 0 5px rgba(168, 85, 247, 0.3); }
            50% { box-shadow: 0 0 20px rgba(168, 85, 247, 0.6); }
        }

        .kz-icon { font-size: 1.5rem; }

        .kz-content { flex: 1; }

        .kz-name {
            font-weight: 600;
            color: var(--color-perfect);
        }

        .kz-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .kz-pairs {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .kz-timer {
            background: var(--color-perfect);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Session-Pair Rating - NEW */
        .session-pair-rating {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xs);
            font-size: 0.85rem;
        }

        .rating-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rating-optimal { background: var(--color-pass); color: white; }
        .rating-acceptable { background: var(--color-warning); color: black; }
        .rating-avoid { background: var(--color-fail); color: white; }
        .rating-neutral { background: var(--text-muted); color: white; }

        .rating-text { color: var(--text-muted); font-size: 0.8rem; }

        /* Limit Order Validation - NEW */
        .limit-validation {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            font-size: 0.85rem;
        }

        .limit-validation.valid {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
            color: var(--color-pass);
        }

        .limit-validation.invalid {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            color: var(--color-fail);
        }

        .limit-validation.warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid var(--color-warning);
            color: var(--color-warning);
        }

        .btn-use-structure {
            background: var(--accent-tertiary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: var(--spacing-sm);
            transition: all 0.2s ease;
        }

        .btn-use-structure:hover {
            background: var(--color-perfect);
            transform: translateY(-1px);
        }

        /* Scale-In Enhancements - NEW */
        .scale-grade-check {
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .scale-grade-check.pass {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-pass);
            color: var(--color-pass);
        }

        .scale-grade-check.warn {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid var(--color-warning);
            color: var(--color-warning);
        }

        .scale-calculations {
            background: var(--bg-primary);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
        }

        .scale-calc-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85rem;
        }

        .scale-calc-row .label { color: var(--text-muted); }
        .scale-calc-row .value { color: var(--text-primary); font-weight: 600; }
        .scale-calc-row .value.good { color: var(--color-pass); }
        .scale-calc-row .value.poor { color: var(--color-fail); }

        .entry-type-selector {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .entry-type-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .entry-type-btn:hover {
            border-color: var(--accent-tertiary);
            color: var(--text-primary);
        }

        .entry-type-btn.active {
            background: rgba(168, 85, 247, 0.15);
            border-color: var(--accent-tertiary);
            color: var(--accent-tertiary);
        }

        .entry-type-btn.recommended {
            position: relative;
        }

        .entry-type-btn.recommended::after {
            content: '\2714 REC';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--color-pass);
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        .entry-type-btn .entry-icon {
            display: block;
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .entry-type-btn .entry-label {
            font-size: 0.8rem;
        }

        .entry-details {
            display: none;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .entry-details.visible {
            display: block;
        }

        .limit-order-details, .scale-in-details {
            border: 1px solid var(--border-primary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
        }

        .scale-level {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-input);
            border-radius: var(--radius-sm);
        }

        .scale-level-number {
            width: 24px;
            height: 24px;
            background: var(--accent-tertiary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .scale-level input {
            flex: 1;
        }

        .scale-level .scale-percent {
            width: 60px;
            text-align: center;
        }

        .session-timing {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .session-box {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            transition: all 0.3s ease;
        }

        .session-box.active-session {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }

        .session-box .session-name {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .session-box .session-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .session-box .session-status {
            font-size: 0.75rem;
            margin-top: 4px;
            font-weight: 600;
        }

        .session-box.active-session .session-status {
            color: var(--color-pass);
        }

        .time-warning {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
            font-size: 0.8rem;
            color: var(--color-warning);
        }

        .entry-confirmation {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-primary);
        }

        /* ============================================
           STOP LOSS STRATEGY STYLES
           ============================================ */
        #sl-strategy-card {
            border: 2px solid var(--color-fail);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(239, 68, 68, 0.03) 100%);
        }

        .atr-calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .atr-input-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .atr-result {
            background: var(--bg-input);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            text-align: center;
        }

        .atr-result-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-fail);
        }

        .atr-result-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .volatility-guide {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .volatility-option {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volatility-option:hover {
            border-color: var(--text-muted);
        }

        .volatility-option.selected {
            border-color: var(--color-fail);
            background: rgba(239, 68, 68, 0.1);
        }

        .volatility-option .vol-name {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .volatility-option .vol-multiplier {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .volatility-option.selected .vol-multiplier {
            color: var(--color-fail);
        }

        .buffer-calculator {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }

        .buffer-row {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .buffer-row:last-child {
            margin-bottom: 0;
        }

        .buffer-label {
            flex: 1;
            font-size: 0.85rem;
        }

        .buffer-value {
            width: 120px;
            text-align: right;
            font-weight: 600;
        }

        .buffer-operator {
            width: 30px;
            text-align: center;
            font-weight: bold;
            color: var(--text-muted);
        }

        .sl-final-result {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--color-fail);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .sl-final-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-fail);
        }

        .sl-final-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* ============================================
           EXIT MANAGEMENT STYLES
           ============================================ */
        #exit-management-card {
            border: 2px solid var(--color-warning);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(245, 158, 11, 0.03) 100%);
        }

        .tp-levels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .tp-level-box {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
        }

        .tp-level-box.tp1 {
            border-color: var(--color-pass);
        }

        .tp-level-box.tp2 {
            border-color: var(--accent-tertiary);
        }

        .tp-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .tp-level-title {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .tp-level-box.tp1 .tp-level-title {
            color: var(--color-pass);
        }

        .tp-level-box.tp2 .tp-level-title {
            color: var(--accent-tertiary);
        }

        .tp-percent-input {
            width: 60px;
            text-align: center;
        }

        .trail-stop-config {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .trail-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            background: var(--bg-input);
            border-radius: var(--radius-sm);
        }

        .trail-option:last-child {
            margin-bottom: 0;
        }

        .trail-option label {
            flex: 1;
            font-size: 0.85rem;
        }

        .trail-option input[type="number"] {
            width: 80px;
        }

        .time-stop-config {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }

        .exit-rules-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }

        .exit-rule {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-size: 0.85rem;
        }

        .exit-rule:last-child {
            margin-bottom: 0;
        }

        .exit-rule-icon {
            flex-shrink: 0;
        }

        /* ============================================
           STRUCTURE ANALYSIS STYLES
           ============================================ */
        #structure-analysis {
            border: 2px solid var(--accent-primary);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(34, 197, 94, 0.03) 100%);
        }

        .structure-education {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin: var(--spacing-md);
            overflow: hidden;
        }

        .education-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-primary);
        }

        .education-header h3 {
            margin: 0;
            font-size: 1rem;
        }

        .education-content {
            padding: var(--spacing-md);
            max-height: 400px;
            overflow-y: auto;
        }

        .education-section {
            margin-bottom: var(--spacing-lg);
        }

        .education-section:last-child {
            margin-bottom: 0;
        }

        .education-section h4 {
            color: var(--accent-primary);
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }

        .education-section p {
            font-size: 0.85rem;
            line-height: 1.6;
            margin-bottom: var(--spacing-sm);
        }

        .education-section ul, .education-section ol {
            font-size: 0.85rem;
            padding-left: var(--spacing-lg);
            margin: 0;
        }

        .education-section li {
            margin-bottom: var(--spacing-xs);
            color: var(--text-secondary);
        }

        .education-section li strong {
            color: var(--text-primary);
        }

        .education-section.warning-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
        }

        .education-section.warning-box h4 {
            color: var(--color-fail);
        }

        .structure-step {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin: var(--spacing-sm) var(--spacing-md);
            overflow: hidden;
            transition: border-color var(--transition-fast);
        }

        .structure-step.completed {
            border-color: var(--color-pass);
        }

        .structure-step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-primary);
        }

        .structure-step.completed .structure-step-header {
            background: rgba(34, 197, 94, 0.1);
        }

        .structure-step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-heading);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .structure-step.completed .structure-step-number::after {
            content: '\2714';
        }

        .structure-step.completed .structure-step-number {
            font-size: 0;
        }

        .structure-step.completed .structure-step-number::after {
            font-size: 0.85rem;
        }

        .structure-step-title {
            font-family: var(--font-heading);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .structure-step-content {
            padding: var(--spacing-md);
        }

        .structure-checklist {
            margin-bottom: var(--spacing-sm);
        }

        .structure-checklist .checkbox-wrapper {
            margin-bottom: var(--spacing-xs);
        }

        /* R:R Analysis Box */
        .rr-analysis-box {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin: var(--spacing-md);
        }

        .rr-analysis-box h4 {
            margin: 0 0 var(--spacing-md) 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .rr-stat {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            text-align: center;
        }

        .rr-stat.highlight {
            border-color: var(--color-warning);
            background: rgba(234, 179, 8, 0.1);
        }

        .rr-stat.rr-good {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }

        .rr-stat.rr-bad {
            border-color: var(--color-fail);
            background: rgba(239, 68, 68, 0.1);
        }

        .rr-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .rr-stat-value {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rr-stat.rr-good .rr-stat-value {
            color: var(--color-pass);
        }

        .rr-stat.rr-bad .rr-stat-value {
            color: var(--color-fail);
        }

        .rr-verdict {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-md);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
        }

        .rr-verdict.verdict-good {
            background: rgba(34, 197, 94, 0.15);
        }

        .rr-verdict.verdict-bad {
            background: rgba(239, 68, 68, 0.15);
        }

        .rr-verdict-icon {
            font-size: 1.2rem;
        }

        .rr-verdict-text {
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Final Checks */
        .final-checks {
            padding: var(--spacing-md);
        }

        .final-checks .checkbox-wrapper {
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
        }

        .final-checks .checkbox-wrapper:last-child {
            margin-bottom: 0;
        }

        /* ============================================
           UTCC v2.5 INSTITUTIONAL CHECKLIST
           ============================================ */
        
        /* Main Checklist Container */
        .inst-checklist {
            background: var(--bg-secondary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-lg);
            margin: var(--spacing-md);
            overflow: hidden;
        }
        
        .inst-checklist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .inst-checklist-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-family: var(--font-heading);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .inst-checklist-badge {
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .inst-checklist-badge.hard {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-fail);
            border: 1px solid var(--color-fail);
        }
        
        .inst-checklist-badge.soft {
            background: rgba(234, 179, 8, 0.2);
            color: var(--color-warning);
            border: 1px solid var(--color-warning);
        }
        
        /* Individual Check Items */
        .inst-check-item {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-primary);
            transition: background var(--transition-fast);
        }
        
        .inst-check-item:last-child {
            border-bottom: none;
        }
        
        .inst-check-item:hover {
            background: var(--bg-hover);
        }
        
        .inst-check-item.check-pass {
            background: rgba(34, 197, 94, 0.08);
            border-left: 3px solid var(--color-pass);
        }
        
        .inst-check-item.check-fail {
            background: rgba(239, 68, 68, 0.08);
            border-left: 3px solid var(--color-fail);
        }
        
        .inst-check-item.check-warning {
            background: rgba(234, 179, 8, 0.08);
            border-left: 3px solid var(--color-warning);
        }
        
        .inst-check-item.check-neutral {
            background: rgba(107, 114, 128, 0.08);
            border-left: 3px solid var(--text-muted);
        }
        
        .inst-check-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            min-width: 28px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-secondary);
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        
        .inst-check-item.check-pass .inst-check-number {
            background: var(--color-pass);
            border-color: var(--color-pass);
            color: #000;
        }
        
        .inst-check-item.check-fail .inst-check-number {
            background: var(--color-fail);
            border-color: var(--color-fail);
            color: #fff;
        }
        
        .inst-check-item.check-warning .inst-check-number {
            background: var(--color-warning);
            border-color: var(--color-warning);
            color: #000;
        }
        
        .inst-check-content {
            flex: 1;
        }
        
        .inst-check-label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .inst-check-criteria {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }
        
        .inst-check-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .inst-check-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .inst-check-status.status-pass {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-pass);
        }
        
        .inst-check-status.status-fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-fail);
        }
        
        .inst-check-status.status-warning {
            background: rgba(234, 179, 8, 0.2);
            color: var(--color-warning);
        }
        
        .inst-check-status.status-pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        /* Tooltip/Rationale */
        .inst-check-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            font-size: 0.65rem;
            color: var(--text-muted);
            cursor: help;
        }
        
        .inst-check-tooltip:hover .tooltip-content {
            display: block;
        }
        
        .tooltip-content {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            padding: var(--spacing-sm);
            margin-bottom: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-secondary);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            text-align: left;
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--border-secondary);
        }
        
        /* RSI Matrix */
        .rsi-matrix {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .rsi-matrix-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }
        
        .rsi-matrix-grid {
            display: grid;
            grid-template-columns: auto 1fr 1fr;
            gap: 2px;
            font-size: 0.7rem;
        }
        
        .rsi-matrix-cell {
            padding: 4px 8px;
            background: var(--bg-secondary);
            text-align: center;
        }
        
        .rsi-matrix-cell.header {
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-input);
        }
        
        .rsi-matrix-cell.ideal {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-pass);
        }
        
        .rsi-matrix-cell.acceptable {
            background: rgba(234, 179, 8, 0.15);
            color: var(--color-warning);
        }
        
        .rsi-matrix-cell.neutral {
            background: rgba(107, 114, 128, 0.15);
            color: var(--text-muted);
        }
        
        /* ATR Volatility Guidance Panel */
        .atr-guidance-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin: var(--spacing-md);
            overflow: hidden;
        }
        
        .atr-guidance-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .atr-guidance-content {
            padding: var(--spacing-md);
        }
        
        .atr-tier {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .atr-tier:last-child {
            margin-bottom: 0;
        }
        
        .atr-tier.compressed {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid var(--color-pass);
        }
        
        .atr-tier.normal {
            background: rgba(59, 130, 246, 0.1);
            border-left: 3px solid var(--color-info);
        }
        
        .atr-tier.elevated {
            background: rgba(234, 179, 8, 0.1);
            border-left: 3px solid var(--color-warning);
        }
        
        .atr-tier.exhausted {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--color-fail);
        }
        
        .atr-tier.active {
            border-width: 3px;
            border-style: solid;
        }
        
        .atr-tier.compressed.active { border-color: var(--color-pass); }
        .atr-tier.normal.active { border-color: var(--color-info); }
        .atr-tier.elevated.active { border-color: var(--color-warning); }
        .atr-tier.exhausted.active { border-color: var(--color-fail); }
        
        .atr-tier-range {
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 70px;
        }
        
        .atr-tier-label {
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 80px;
        }
        
        .atr-tier-action {
            flex: 1;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .atr-current-value {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            background: var(--bg-input);
            border-radius: var(--radius-sm);
        }
        
        .atr-current-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .atr-current-number {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        /* 48h Cooldown Warning */
        .cooldown-warning {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-sm);
            margin-top: var(--spacing-sm);
        }
        
        .cooldown-warning-icon {
            font-size: 1.2rem;
        }
        
        .cooldown-warning-text {
            flex: 1;
            font-size: 0.8rem;
            color: var(--color-fail);
        }
        
        .cooldown-warning-time {
            font-family: var(--font-heading);
            font-weight: 600;
        }
        
        /* Entry Verdict Panel */
        .entry-verdict-panel {
            margin: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            text-align: center;
        }
        
        .entry-verdict-panel.verdict-approved {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
            border: 2px solid var(--color-pass);
        }
        
        .entry-verdict-panel.verdict-approved-reduced {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15), rgba(234, 179, 8, 0.05));
            border: 2px solid var(--color-warning);
        }
        
        .entry-verdict-panel.verdict-caution {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
            border: 2px solid #f97316;
        }
        
        .entry-verdict-panel.verdict-blocked {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
            border: 2px solid var(--color-fail);
        }
        
        .entry-verdict-panel.verdict-pending {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-secondary);
        }
        
        .entry-verdict-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-xs);
        }
        
        .entry-verdict-status {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .verdict-approved .entry-verdict-status { color: var(--color-pass); }
        .verdict-approved-reduced .entry-verdict-status { color: var(--color-warning); }
        .verdict-caution .entry-verdict-status { color: #f97316; }
        .verdict-blocked .entry-verdict-status { color: var(--color-fail); }
        .verdict-pending .entry-verdict-status { color: var(--text-muted); }
        
        .entry-verdict-reason {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .entry-verdict-checklist {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-sm);
            font-size: 0.75rem;
        }
        
        .verdict-check {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .verdict-check.pass { color: var(--color-pass); }
        .verdict-check.fail { color: var(--color-fail); }
        .verdict-check.warn { color: var(--color-warning); }
        
        /* Override Confirmation */
        .override-section {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(249, 115, 22, 0.1);
            border: 1px dashed #f97316;
            border-radius: var(--radius-sm);
        }
        
        .override-section label {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.85rem;
            color: #f97316;
            cursor: pointer;
        }
        
        .override-section input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #f97316;
        }


        /* ============================================
           THEME TOGGLE
           ============================================ */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--bg-tertiary);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-md);
        }

        .theme-toggle-btn {
            background: none;
            border: none;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }

        .theme-toggle-btn:hover {
            color: var(--text-primary);
        }

        .theme-toggle-btn.active {
            background: var(--accent-primary);
            color: #000;
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }
        .gap-lg { gap: var(--spacing-lg); }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        .text-pass { color: var(--color-pass); }
        .text-fail { color: var(--color-fail); }
        .text-warning { color: var(--color-warning); }
        .text-muted { color: var(--text-muted); }
        
        .mt-sm { margin-top: var(--spacing-sm); }
        .mt-md { margin-top: var(--spacing-md); }
        .mt-lg { margin-top: var(--spacing-lg); }
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .mb-md { margin-bottom: var(--spacing-md); }
        .mb-lg { margin-bottom: var(--spacing-lg); }

        .hidden { display: none !important; }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .app-header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .tab-nav {
                justify-content: flex-start;
            }

            .fab {
                bottom: var(--spacing-md);
                right: var(--spacing-md);
            }

            .fab-calendar {
                bottom: var(--spacing-md);
                right: calc(var(--spacing-md) + 70px);
            }

            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }

            .stat-value { font-size: 1.25rem; }
        }

        /* ============================================
           SCROLLBAR STYLING
           ============================================ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ============================================
           PHASE 2: EXIT STRATEGY ENHANCEMENT STYLES
           ============================================ */
        
        /* Friday Warning Banner */
        .friday-warning-banner {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(249, 115, 22, 0.2));
            border: 2px solid var(--color-warning);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            animation: pulse-warning 2s ease-in-out infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { box-shadow: 0 0 5px rgba(234, 179, 8, 0.3); }
            50% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.6); }
        }
        
        .friday-warning-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .friday-warning-icon {
            font-size: 2rem;
        }
        
        .friday-warning-text {
            flex: 1;
            min-width: 200px;
        }
        
        .friday-warning-text strong {
            display: block;
            color: var(--color-warning);
            font-size: 1.1rem;
        }
        
        .friday-warning-text span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .friday-warning-actions {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        /* Exit Protocol Summary */
        .exit-protocol-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-primary);
        }
        
        @media (max-width: 600px) {
            .exit-protocol-summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .protocol-stat {
            text-align: center;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        
        .protocol-stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
            font-family: var(--font-heading);
            color: var(--text-primary);
        }
        
        .protocol-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .protocol-stat-warning .protocol-stat-value {
            color: var(--color-warning);
        }
        
        /* Active Trades List */
        .active-trades-list {
            padding: var(--spacing-md);
        }
        
        .no-trades-message {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }
        
        .no-trades-icon {
            display: block;
            font-size: 2rem;
            margin-bottom: var(--spacing-sm);
        }
        
        /* Active Trade Card */
        .active-trade-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            overflow: hidden;
            transition: all var(--transition-fast);
        }
        
        .active-trade-card:last-child {
            margin-bottom: 0;
        }
        
        .active-trade-card.needs-review {
            border-color: var(--color-warning);
            background: linear-gradient(135deg, var(--bg-tertiary), rgba(234, 179, 8, 0.05));
        }
        
        .active-trade-card.critical {
            border-color: var(--color-fail);
            background: linear-gradient(135deg, var(--bg-tertiary), rgba(239, 68, 68, 0.05));
            animation: pulse-critical 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-critical {
            0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0); }
            50% { box-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        }
        
        .active-trade-card.at-breakeven {
            border-color: var(--color-pass);
        }
        
        .active-trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .trade-pair-dir {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .trade-pair-dir strong {
            font-size: 1rem;
        }
        
        .trade-age {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.8rem;
        }
        
        .trade-age.age-warning {
            color: var(--color-warning);
        }
        
        .trade-age.age-critical {
            color: var(--color-fail);
            font-weight: 600;
        }
        
        .active-trade-body {
            padding: var(--spacing-md);
        }
        
        .trade-levels-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        @media (max-width: 500px) {
            .trade-levels-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .trade-level {
            text-align: center;
        }
        
        .trade-level-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .trade-level-value {
            font-family: var(--font-heading);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        /* Exit Protocol Status */
        .exit-protocol-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
        }
        
        .protocol-step {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.85rem;
        }
        
        .protocol-step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .protocol-step-icon.pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        
        .protocol-step-icon.complete {
            background: var(--color-pass);
            color: white;
        }
        
        .protocol-step-text {
            color: var(--text-secondary);
        }
        
        .protocol-step-text.complete {
            color: var(--color-pass);
            text-decoration: line-through;
        }
        
        /* Trade Action Buttons */
        .trade-actions {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-primary);
        }
        
        .btn-tp1 {
            background: var(--color-pass);
            color: white;
        }
        
        .btn-tp1:hover {
            background: #16a34a;
        }
        
        .btn-be {
            background: var(--color-info);
            color: white;
        }
        
        .btn-be:hover {
            background: #2563eb;
        }
        
        .btn-trail {
            background: var(--color-perfect);
            color: white;
        }
        
        .btn-trail:hover {
            background: #9333ea;
        }
        
        /* Quick Actions Bar */
        .quick-actions-bar {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-primary);
        }
        
        .quick-actions-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        /* Trailing Stop Modal */
        .trail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .trail-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            max-width: 450px;
            width: 90%;
        }
        
        .trail-modal h3 {
            margin-bottom: var(--spacing-md);
        }
        
        .trail-option-card {
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 2px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .trail-option-card:hover {
            border-color: var(--accent-primary);
        }
        
        .trail-option-card.selected {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .trail-option-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .trail-option-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        /* Volatility Trail Recommendations */
        .vol-trail-recommendation {
            padding: var(--spacing-sm);
            background: rgba(168, 85, 247, 0.1);
            border: 1px solid var(--color-perfect);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            margin-bottom: var(--spacing-md);
        }
        
        .vol-trail-recommendation strong {
            color: var(--color-perfect);
        }
        
        /* Partial Close Tracker */
        .partial-close-tracker {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .partial-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }
        
        .partial-fill {
            height: 100%;
            background: var(--color-pass);
            transition: width 0.3s ease;
        }
        
        .partial-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* ============================================
           NEWS IMPACT MANAGEMENT SYSTEM STYLES
           ============================================ */
        
        /* News Reference Database */
        .news-reference-container {
            margin-top: var(--spacing-md);
        }
        
        .news-search-box {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .news-search-box input {
            flex: 1;
        }
        
        .news-currency-tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }
        
        .news-currency-tab {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .news-currency-tab:hover {
            background: var(--bg-hover);
        }
        
        .news-currency-tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .news-event-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            border-left: 4px solid var(--border-primary);
        }
        
        .news-event-card.impact-high {
            border-left-color: var(--color-fail);
        }
        
        .news-event-card.impact-medium {
            border-left-color: var(--color-warning);
        }
        
        .news-event-card.impact-low {
            border-left-color: var(--color-info);
        }
        
        .news-event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-sm);
        }
        
        .news-event-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .news-impact-badge {
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .news-impact-badge.high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-fail);
        }
        
        .news-impact-badge.medium {
            background: rgba(234, 179, 8, 0.2);
            color: var(--color-warning);
        }
        
        .news-impact-badge.low {
            background: rgba(59, 130, 246, 0.2);
            color: var(--color-info);
        }
        
        .news-bias-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .news-bias-box {
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
        }
        
        .news-bias-box.bullish {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .news-bias-box.bearish {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .news-bias-label {
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            margin-bottom: 2px;
            display: block;
        }
        
        .news-bias-box.bullish .news-bias-label {
            color: var(--color-pass);
        }
        
        .news-bias-box.bearish .news-bias-label {
            color: var(--color-fail);
        }
        
        /* Position News Warning Panel */
        .position-news-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid var(--color-warning);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .position-news-warning.critical {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-fail);
        }
        
        .position-news-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
        }
        
        .position-news-header .icon {
            font-size: 1.2rem;
        }
        
        .position-news-details {
            font-size: 0.85rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .position-news-action {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .position-news-action .action-btn {
            padding: 4px 12px;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            cursor: pointer;
        }
        
        .position-news-action .action-btn:hover {
            background: var(--bg-hover);
        }
        
        /* Pre-Trade News Buffer Warning */
        .news-buffer-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-fail);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-sm);
            display: none;
        }
        
        .news-buffer-warning.caution {
            background: rgba(234, 179, 8, 0.1);
            border-color: var(--color-warning);
        }
        
        .news-buffer-warning.active {
            display: block;
        }
        
        .news-buffer-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        
        .news-buffer-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .news-buffer-recommendation {
            margin-top: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }
        
        /* Calendar Status Indicator */
        .calendar-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .calendar-status::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .calendar-status.online {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-pass);
        }
        
        .calendar-status.online::before {
            background: var(--color-pass);
            box-shadow: 0 0 4px var(--color-pass);
        }
        
        .calendar-status.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-fail);
        }
        
        .calendar-status.offline::before {
            background: var(--color-fail);
        }
        
        /* Status Dots (small indicators) */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
            margin: 0 4px;
        }
        
        .status-dot.connected,
        .status-dot.online {
            background: var(--color-pass);
            box-shadow: 0 0 6px var(--color-pass);
            animation: pulse 2s infinite;
        }
        
        .status-dot.disconnected,
        .status-dot.offline {
            background: var(--color-fail);
            opacity: 0.7;
        }
        
        /* Broker Status Indicator */
        .broker-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .broker-status-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .broker-status-indicator.connected {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-pass);
        }
        
        .broker-status-indicator.connected::before {
            background: var(--color-pass);
            box-shadow: 0 0 4px var(--color-pass);
            animation: pulse 2s infinite;
        }
        
        .broker-status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-fail);
        }
        
        .broker-status-indicator.disconnected::before {
            background: var(--color-fail);
        }
        
        /* Quick Bias Lookup Panel */
        .quick-bias-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .quick-bias-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            cursor: pointer;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }
        
        .quick-bias-header:hover {
            background: var(--bg-hover);
        }
        
        .quick-bias-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
        }
        
        .quick-bias-toggle {
            transition: transform var(--transition-fast);
        }
        
        .quick-bias-panel.collapsed .quick-bias-toggle {
            transform: rotate(-90deg);
        }
        
        .quick-bias-panel.collapsed .quick-bias-content {
            display: none;
        }
        
        .quick-bias-content {
            padding: var(--spacing-md);
        }
        
        .quick-bias-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .quick-bias-result {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            min-height: 100px;
        }
        
        .quick-bias-result.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ============================================
           PHASE 3: TRADE GRADING SYSTEM STYLES
           ============================================ */
        
        .trade-grade-display {
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }
        
        .grade-badge-container {
            text-align: center;
        }
        
        .grade-badge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 700;
            font-family: var(--font-heading);
            margin: 0 auto var(--spacing-xs);
            border: 4px solid;
        }
        
        .grade-badge.grade-aplus {
            background: linear-gradient(135deg, #a855f7, #8b5cf6);
            border-color: #a855f7;
            color: white;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        
        .grade-badge.grade-a {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-color: #22c55e;
            color: white;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.4);
        }
        
        .grade-badge.grade-b {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: #3b82f6;
            color: white;
        }
        
        .grade-badge.grade-c {
            background: linear-gradient(135deg, #eab308, #ca8a04);
            border-color: #eab308;
            color: #000;
        }
        
        .grade-badge.grade-d {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
            color: white;
        }
        
        .grade-badge.grade-dis {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-color: #6b7280;
            color: white;
            font-style: italic;
        }
        
        .grade-label-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .grade-details {
            flex: 1;
            min-width: 200px;
        }
        
        .grade-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            justify-content: center;
        }
        
        .breakdown-item {
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-family: var(--font-heading);
        }
        
        .breakdown-item.item-pass {
            background: rgba(34, 197, 94, 0.15);
            color: var(--color-pass);
        }
        
        .breakdown-item.item-warn {
            background: rgba(234, 179, 8, 0.15);
            color: var(--color-warning);
        }
        
        .breakdown-item.item-fail {
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-fail);
        }
        
        .grade-position-rec {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .grade-position-rec .rec-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 4px;
        }
        
        .grade-position-rec .rec-value {
            font-weight: 700;
            font-family: var(--font-heading);
            font-size: 1rem;
        }
        
        .grade-position-rec.rec-full .rec-value {
            color: var(--color-pass);
        }
        
        .grade-position-rec.rec-reduced .rec-value {
            color: var(--color-warning);
        }
        
        .grade-position-rec.rec-skip .rec-value {
            color: var(--color-fail);
        }
        
        /* Grade Summary Card (for journal) */
        .grade-summary-card {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 4px 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }
        
        .grade-mini-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
        }
        
        .grade-mini-badge.grade-aplus { background: #a855f7; }
        .grade-mini-badge.grade-a { background: #22c55e; }
        .grade-mini-badge.grade-b { background: #3b82f6; }
        .grade-mini-badge.grade-c { background: #eab308; color: #000; }
        .grade-mini-badge.grade-d { background: #ef4444; }
        .grade-mini-badge.grade-dis { background: #6b7280; font-style: italic; }

        /* ============================================
           PHASE 4: RE-ENTRY RULES STYLES
           ============================================ */
        
        #reentry-rules-card {
            border: 2px solid var(--color-fail);
            animation: pulse-reentry 2s ease-in-out infinite;
        }
        
        @keyframes pulse-reentry {
            0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        }
        
        .reentry-check {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }
        
        .reentry-check.checked {
            color: var(--color-pass);
        }
        
        .reentry-check.unchecked {
            color: var(--color-fail);
        }
        
        .reentry-rule {
            font-size: 0.9rem;
        }
        
        .reentry-rule.satisfied {
            color: var(--color-pass);
            text-decoration: line-through;
        }
        
        /* ============================================
           PLAYBOOK MODULE STYLES v1.0
           ============================================ */

        /* Playbook Selection Header */
        .playbook-selection-header {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .regime-context {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .context-label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .context-value {
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
        }

        .context-value.regime-expansion { color: var(--color-pass); }
        .context-value.regime-balanced { color: var(--color-info); }
        .context-value.regime-contraction { color: var(--color-warning); }
        .context-value.regime-compression { color: var(--text-muted); }
        .context-value.regime-transition { color: var(--color-fail); }

        .selection-rule {
            padding: var(--spacing-sm);
            background: rgba(234, 179, 8, 0.1);
            border-left: 3px solid var(--color-warning);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            font-size: 0.85rem;
        }

        /* Section Subtitles */
        .section-subtitle {
            margin-bottom: var(--spacing-md);
            font-size: 1rem;
            color: var(--text-primary);
        }

        .section-subtitle.forbidden-title {
            color: var(--color-fail);
            margin-top: var(--spacing-xl);
        }

        /* Playbook Cards */
        .playbook-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .playbook-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .playbook-card:hover {
            border-color: var(--color-info);
            transform: translateY(-2px);
        }

        .playbook-card.selected {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }

        .playbook-card.preferred {
            border-color: var(--color-perfect);
        }

        .playbook-card.preferred::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--color-perfect);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .playbook-card-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .playbook-icon {
            font-size: 1.5rem;
        }

        .playbook-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .preferred-badge {
            margin-left: auto;
            font-size: 0.65rem;
            padding: 2px 6px;
            background: var(--color-perfect);
            color: white;
            border-radius: 4px;
            font-weight: 600;
        }

        .playbook-card-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: var(--spacing-sm);
        }

        .playbook-card-meta {
            display: flex;
            gap: var(--spacing-sm);
            font-size: 0.75rem;
        }

        .meta-item {
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .selected-indicator {
            position: absolute;
            top: var(--spacing-sm);
            right: var(--spacing-sm);
            color: var(--color-pass);
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Execution Model Cards */
        .execution-model-section {
            margin-bottom: var(--spacing-lg);
        }

        .execution-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .execution-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .execution-card:hover {
            border-color: var(--color-info);
        }

        .execution-card.selected {
            border-color: var(--color-pass);
            background: rgba(34, 197, 94, 0.1);
        }

        .execution-card-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .execution-icon {
            font-size: 1.25rem;
        }

        .execution-name {
            font-weight: 600;
        }

        .execution-card-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Lock Section */
        .playbook-lock-section {
            text-align: center;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
        }

        .lock-warning {
            margin-top: var(--spacing-sm);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Forbidden Section */
        .playbook-forbidden-section {
            padding: var(--spacing-md);
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-md);
        }

        .forbidden-list {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-sm);
        }

        .forbidden-item {
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--color-fail);
            border-radius: 4px;
            font-size: 0.85rem;
            text-decoration: line-through;
        }

        .forbidden-note {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Gate Warnings */
        .playbook-gate-warning,
        .playbook-gate-blocked {
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
        }

        .playbook-gate-warning {
            background: rgba(234, 179, 8, 0.1);
            border: 2px solid var(--color-warning);
        }

        .playbook-gate-blocked {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--color-fail);
        }

        .gate-icon {
            font-size: 2rem;
        }

        .gate-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: var(--spacing-xs);
        }

        .playbook-gate-warning .gate-title { color: var(--color-warning); }
        .playbook-gate-blocked .gate-title { color: var(--color-fail); }

        .gate-message {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .gate-note {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Locked State */
        .playbook-locked-state {
            background: var(--bg-secondary);
            border: 2px solid var(--color-pass);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .locked-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: rgba(34, 197, 94, 0.15);
            border-bottom: 1px solid var(--color-pass);
        }

        .locked-icon {
            font-size: 1.25rem;
        }

        .locked-title {
            font-weight: 600;
            color: var(--color-pass);
        }

        .locked-time {
            margin-left: auto;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .locked-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
        }

        .locked-playbook,
        .locked-execution {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .locked-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .locked-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .locked-criteria,
        .locked-forbidden {
            padding: var(--spacing-md);
        }

        .locked-criteria {
            border-bottom: 1px solid var(--border-color);
        }

        .criteria-title,
        .locked-forbidden .forbidden-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: var(--spacing-sm);
        }

        .locked-forbidden .forbidden-title {
            color: var(--color-fail);
        }

        .criteria-list,
        .forbidden-list-detail {
            margin: 0;
            padding-left: var(--spacing-lg);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .criteria-list li,
        .forbidden-list-detail li {
            margin-bottom: 4px;
        }

        .forbidden-list-detail li {
            color: var(--color-fail);
        }

        .locked-actions {
            display: flex;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        /* Leakage Warnings */
        #leakage-warnings-container {
            padding: 0 var(--spacing-md) var(--spacing-md);
        }

        .leakage-warning {
            margin-bottom: var(--spacing-md);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .leakage-warning.critical {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--color-fail);
        }

        .leakage-warning.warning {
            background: rgba(234, 179, 8, 0.1);
            border: 2px solid var(--color-warning);
        }

        .leakage-warning .warning-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(0, 0, 0, 0.1);
        }

        .leakage-warning .warning-icon {
            font-size: 1.25rem;
        }

        .leakage-warning .warning-title {
            font-weight: 600;
        }

        .leakage-warning.critical .warning-title { color: var(--color-fail); }
        .leakage-warning.warning .warning-title { color: var(--color-warning); }

        .leakage-warning .warning-badge {
            margin-left: auto;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .leakage-warning.critical .warning-badge {
            background: var(--color-fail);
            color: white;
        }

        .leakage-warning.warning .warning-badge {
            background: var(--color-warning);
            color: black;
        }

        .leakage-warning .warning-message {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Pre-Trade Gate Banner */
        .pretrade-gate-banner {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--color-fail);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
        }

        .pretrade-gate-banner .gate-icon {
            font-size: 1.5rem;
        }

        .pretrade-gate-banner .gate-content {
            flex: 1;
        }

        .pretrade-gate-banner .gate-title {
            font-weight: 600;
            color: var(--color-fail);
            margin-bottom: 4px;
        }

        .pretrade-gate-banner .gate-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
        }

        /* Playbook Module Card */
        .playbook-module-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
        }

        .playbook-module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .playbook-module-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .playbook-cards {
                grid-template-columns: 1fr;
            }
            
            .execution-cards {
                grid-template-columns: 1fr;
            }
            
            .locked-selection {
                grid-template-columns: 1fr;
            }
            
            .locked-actions {
                flex-direction: column;
            }
            
            .regime-context {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pretrade-gate-banner {
                flex-direction: column;
                text-align: center;
            }
        }


    /* Session Board Styles */

/* Trading Guide Styles */
/**
 * Trading Guide Styles
 * Forex Command Centre v2.1.0
 */

/* ============================================
   TRADING GUIDE MODAL
   ============================================ */

.trading-guide-modal {
    max-width: 1000px;
    width: 95%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.trading-guide-modal .modal-header {
    flex-shrink: 0;
}

.guide-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Navigation */
.guide-nav {
    width: 180px;
    flex-shrink: 0;
    background: var(--bg-tertiary);
    border-right: 1px solid var(--border-primary);
    padding: var(--spacing-sm);
    overflow-y: auto;
}

.guide-nav-btn {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    width: 100%;
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
}

.guide-nav-btn:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.guide-nav-btn.active {
    background: var(--accent-primary);
    color: #000;
    font-weight: 600;
}

/* Content Area */
.guide-content {
    flex: 1;
    padding: var(--spacing-lg);
    overflow-y: auto;
}

.guide-section {
    max-width: 700px;
}

.guide-section h2 {
    font-size: 1.4rem;
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
}

.guide-section h3 {
    font-size: 1.1rem;
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
}

.guide-section h4 {
    font-size: 1rem;
    margin-bottom: var(--spacing-xs);
    color: var(--text-primary);
}

.guide-section p {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: var(--spacing-sm);
}

.guide-section ul, .guide-section ol {
    margin-left: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    color: var(--text-secondary);
}

.guide-section li {
    margin-bottom: var(--spacing-xs);
    line-height: 1.5;
}

.guide-small {
    font-size: 0.85rem;
    color: var(--text-muted);
}

/* Hero Section */
.guide-hero {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(59, 130, 246, 0.05));
    border: 2px solid var(--color-perfect);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    text-align: center;
    margin-bottom: var(--spacing-lg);
}

.guide-hero h2 {
    color: var(--color-perfect);
    margin-bottom: var(--spacing-sm);
}

/* Highlight Box */
.guide-highlight {
    background: var(--bg-tertiary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--accent-primary);
    font-weight: 600;
    color: var(--text-primary);
    margin: var(--spacing-md) 0;
}

/* Gold Nugget */
.guide-nugget {
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid var(--color-warning);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    color: var(--color-warning);
    font-size: 0.9rem;
    margin: var(--spacing-md) 0;
}

/* Boxes */
.guide-box {
    background: var(--bg-tertiary);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
}

.guide-box strong {
    display: block;
    margin-bottom: var(--spacing-xs);
    color: var(--text-primary);
}

.guide-box p {
    margin-bottom: var(--spacing-xs);
}

.guide-box ul {
    margin-bottom: 0;
}

.guide-box-pass {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--color-pass);
}

.guide-box-warn {
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid var(--color-warning);
}

.guide-box-fail {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--color-fail);
}

.guide-box-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid var(--color-info);
}

/* Grid */
.guide-grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

@media (max-width: 600px) {
    .guide-grid-2 {
        grid-template-columns: 1fr;
    }
}

/* Flow Diagram */
.guide-flow {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
}

.flow-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--spacing-sm);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    min-width: 90px;
}

.flow-num {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-primary);
    color: #000;
    border-radius: 50%;
    font-weight: 700;
    font-size: 0.85rem;
    margin-bottom: var(--spacing-xs);
}

.flow-step strong {
    font-size: 0.8rem;
    color: var(--text-primary);
}

.flow-step span {
    font-size: 0.7rem;
    color: var(--text-muted);
}

.flow-arrow {
    font-size: 1.25rem;
    color: var(--text-muted);
}

/* Alert Cards */
.alert-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    overflow: hidden;
}

.alert-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-secondary);
}

.alert-icon {
    font-size: 1.25rem;
}

.alert-name {
    font-weight: 700;
    font-family: var(--font-heading);
    color: var(--text-primary);
}

.alert-body {
    padding: var(--spacing-md);
}

.alert-body p {
    margin-bottom: var(--spacing-xs);
}

.alert-candidate { border-left: 4px solid var(--color-warning); }
.alert-armed { border-left: 4px solid var(--color-pass); }
.alert-disarmed { border-left: 4px solid var(--color-fail); }
.alert-reset { border-left: 4px solid var(--color-info); }

/* Workflow Steps */
.workflow-step {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-primary);
}

.workflow-step:last-child {
    border-bottom: none;
}

.step-marker {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-primary);
    color: #000;
    border-radius: 50%;
    font-weight: 700;
    font-family: var(--font-heading);
}

.step-body {
    flex: 1;
}

.step-body h4 {
    margin-bottom: var(--spacing-sm);
}

/* Playbook Cards */
.playbook-card {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    overflow: hidden;
}

.playbook-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-sm) var(--spacing-md);
}

.playbook-header h4 {
    margin: 0;
    color: white;
}

.playbook-tag {
    font-size: 0.7rem;
    padding: 2px 8px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    color: white;
}

.playbook-continuation { background: var(--color-pass); }
.playbook-pullback { background: var(--color-info); }
.playbook-observation { background: var(--text-muted); }

.playbook-body {
    padding: var(--spacing-md);
}

/* Validation Cards */
.validation-card {
    display: flex;
    gap: var(--spacing-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.validation-marker {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    font-weight: 700;
    font-family: var(--font-heading);
    font-size: 0.85rem;
    color: white;
}

.validation-hard .validation-marker {
    background: var(--color-fail);
}

.validation-soft .validation-marker {
    background: var(--color-warning);
    color: #000;
}

.validation-body {
    flex: 1;
}

.validation-body h4 {
    margin-bottom: var(--spacing-xs);
}

/* Zone Cards */
.zone-card {
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
    overflow: hidden;
}

.zone-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-sm) var(--spacing-md);
}

.zone-badge {
    font-weight: 700;
    font-family: var(--font-heading);
    color: white;
    padding: 4px 12px;
    border-radius: var(--radius-sm);
}

.zone-distance {
    font-size: 0.8rem;
    color: var(--text-muted);
}

.zone-body {
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
}

.zone-hot .zone-header { background: linear-gradient(135deg, #ef4444, #f97316); }
.zone-hot .zone-badge { background: transparent; }

.zone-optimal .zone-header { background: linear-gradient(135deg, #22c55e, #16a34a); }
.zone-optimal .zone-badge { background: transparent; }

.zone-acceptable .zone-header { background: linear-gradient(135deg, #eab308, #ca8a04); }
.zone-acceptable .zone-badge { background: transparent; color: #000; }

.zone-extended .zone-header { background: linear-gradient(135deg, #6b7280, #4b5563); }
.zone-extended .zone-badge { background: transparent; }

/* Tables */
.guide-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    margin: var(--spacing-md) 0;
}

.guide-table th, .guide-table td {
    padding: var(--spacing-sm);
    text-align: left;
    border-bottom: 1px solid var(--border-primary);
}

.guide-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
}

.guide-table td {
    color: var(--text-secondary);
}

/* State Badges */
.state-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.state-expansion { background: var(--color-pass); color: white; }
.state-balanced { background: var(--color-info); color: white; }
.state-contraction { background: var(--color-warning); color: #000; }
.state-transition { background: var(--color-fail); color: white; }

/* Drawdown Badges */
.dd-normal { color: var(--color-pass); font-weight: 600; }
.dd-caution { color: var(--color-warning); font-weight: 600; }
.dd-stop { color: #f97316; font-weight: 600; }
.dd-emergency { color: var(--color-fail); font-weight: 600; }

/* Rules Lists */
.rules-list {
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
}

.rules-list h3 {
    margin-top: 0;
    margin-bottom: var(--spacing-md);
}

.rules-list ol {
    margin: 0;
}

.rules-list li {
    margin-bottom: var(--spacing-sm);
}

.rules-do {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--color-pass);
}

.rules-do h3 { color: var(--color-pass); }

.rules-dont {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--color-fail);
}

.rules-dont h3 { color: var(--color-fail); }

/* Confusion Flow */
.confusion-flow {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin: var(--spacing-md) 0;
}

.confusion-step {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    background: var(--bg-tertiary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
}

.confusion-step .q {
    color: var(--text-muted);
    font-weight: 500;
    min-width: 40px;
}

.confusion-step .a {
    margin-left: auto;
    color: var(--color-pass);
    font-weight: 600;
}

/* Glossary */
.glossary-section {
    margin-bottom: var(--spacing-xl);
}

.glossary {
    margin: 0;
}

.glossary dt {
    font-weight: 700;
    color: var(--accent-primary);
    margin-top: var(--spacing-md);
    margin-bottom: var(--spacing-xs);
}

.glossary dt:first-child {
    margin-top: 0;
}

.glossary dd {
    margin: 0 0 var(--spacing-sm) 0;
    padding-left: var(--spacing-md);
    color: var(--text-secondary);
    border-left: 2px solid var(--border-primary);
}

/* Text Utilities */
.text-pass { color: var(--color-pass); }
.text-fail { color: var(--color-fail); }
.text-warn { color: var(--color-warning); }
.text-info { color: var(--color-info); }

/* Responsive */
@media (max-width: 768px) {
    .guide-layout {
        flex-direction: column;
    }
    
    .guide-nav {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border-primary);
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
    }
    
    .guide-nav-btn {
        flex: 0 0 auto;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.75rem;
    }
    
    .guide-nav-btn span:first-child {
        display: none;
    }
    
    .guide-content {
        padding: var(--spacing-md);
    }
    
    .guide-flow {
        flex-direction: column;
    }
    
    .flow-arrow {
        transform: rotate(90deg);
    }
}

/**
 * Session Board & Gold Nugget Guide Styles
 * Forex Command Centre v2.1.0
 */

/* ============================================
   SESSION BOARD MODAL
   ============================================ */

.session-board-modal {
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
}

/* Locked Badge */
.sb-locked-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
    border: 2px solid var(--color-pass);
    border-radius: var(--radius-md);
    color: var(--color-pass);
    font-size: 1.25rem;
    font-weight: 700;
    font-family: var(--font-heading);
    margin-bottom: var(--spacing-md);
}

/* Summary Grid */
.sb-summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.sb-summary-item {
    background: var(--bg-tertiary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
}

.sb-label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.sb-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.sb-permission-full { color: var(--color-pass); }
.sb-permission-conditional { color: var(--color-warning); }
.sb-permission-standdown { color: var(--color-fail); }

/* Playbooks */
.sb-playbooks {
    margin-bottom: var(--spacing-md);
}

.sb-playbook-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-xs);
}

.sb-playbook-tag {
    background: var(--accent-primary);
    color: #000;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

/* Context */
.sb-context {
    background: var(--bg-tertiary);
    padding: var(--spacing-md);
    border-radius: var(--radius-sm);
    margin-bottom: var(--spacing-md);
}

.sb-context p {
    margin: var(--spacing-xs) 0 0 0;
    color: var(--text-secondary);
    font-style: italic;
}

/* Override Warning */
.sb-override-warning {
    background: rgba(249, 115, 22, 0.15);
    border: 1px solid #f97316;
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    color: #f97316;
    font-size: 0.85rem;
    font-weight: 500;
    margin-bottom: var(--spacing-md);
}

/* Actions */
.sb-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border-primary);
}

/* Form Styles */
.session-board-form {
    padding: var(--spacing-sm) 0;
}

.sb-prompt, .sb-override-prompt {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-lg);
}

.sb-prompt span, .sb-override-prompt span {
    font-size: 2rem;
    margin-bottom: var(--spacing-sm);
}

.sb-prompt strong, .sb-override-prompt strong {
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.sb-prompt p, .sb-override-prompt p {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin: 0;
}

.sb-override-prompt {
    background: rgba(249, 115, 22, 0.1);
    border: 1px solid #f97316;
}

.sb-override-prompt strong {
    color: #f97316;
}

/* Session Options */
.sb-session-options {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
}

.sb-session-option {
    flex: 1;
    min-width: 120px;
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    position: relative;
}

.sb-session-option:hover {
    border-color: var(--accent-primary);
}

.sb-session-option.selected {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--color-pass);
}

.sb-session-option.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.sb-session-option input {
    position: absolute;
    opacity: 0;
}

.sb-session-name {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
}

.sb-current-badge {
    display: inline-block;
    margin-top: 4px;
    padding: 2px 8px;
    background: var(--color-info);
    color: white;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 700;
}

/* Max Trades */
.sb-max-trades {
    display: flex;
    gap: var(--spacing-sm);
}

.sb-trade-option {
    flex: 1;
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    position: relative;
}

.sb-trade-option:hover {
    border-color: var(--accent-primary);
}

.sb-trade-option.selected {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--color-pass);
}

.sb-trade-option input {
    position: absolute;
    opacity: 0;
}

.sb-trade-option span {
    font-size: 1.5rem;
    font-weight: 700;
    font-family: var(--font-heading);
    color: var(--text-primary);
}

/* Playbook Options */
.sb-playbook-options {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.sb-playbook-option {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--bg-tertiary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.sb-playbook-option:hover {
    border-color: var(--accent-primary);
}

.sb-playbook-option:has(input:checked) {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--color-pass);
}

.sb-playbook-option input {
    width: 20px;
    height: 20px;
    accent-color: var(--color-pass);
}

.sb-pb-name {
    font-weight: 600;
    color: var(--text-primary);
}

.sb-pb-desc {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-left: auto;
}

/* Override Reason */
.sb-override-reason {
    background: rgba(249, 115, 22, 0.1);
    border: 1px solid #f97316;
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
}

.sb-override-reason .form-label {
    color: #f97316;
}

/* Form Actions */
.sb-form-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
    padding-top: var(--spacing-md);
    margin-top: var(--spacing-md);
    border-top: 1px solid var(--border-primary);
}

/* Mini Status (for header/nav) */
.sb-mini-status {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
}

.sb-mini-status.locked {
    background: rgba(34, 197, 94, 0.15);
    border: 1px solid var(--color-pass);
    color: var(--color-pass);
}

.sb-mini-status.unlocked {
    background: rgba(234, 179, 8, 0.15);
    border: 1px solid var(--color-warning);
    color: var(--color-warning);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}


/* ============================================
   GOLD NUGGET GUIDE MODAL
   ============================================ */

.gold-nugget-modal {
    max-width: 800px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
}

.gold-nugget-content {
    padding: var(--spacing-md);
}

/* Sections */
.gng-section {
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-primary);
}

.gng-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.gng-section h4 {
    font-size: 1.1rem;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
}

.gng-section p {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
    line-height: 1.6;
}

.gng-section ul, .gng-section ol {
    color: var(--text-secondary);
    margin-left: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
}

.gng-section li {
    margin-bottom: var(--spacing-xs);
}

/* Prime Section */
.gng-prime {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.05));
    border: 2px solid var(--color-perfect);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    text-align: center;
}

.gng-prime h4 {
    color: var(--color-perfect);
}

/* Highlight Text */
.gng-highlight {
    background: var(--bg-tertiary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    font-weight: 600;
    color: var(--text-primary) !important;
    border-left: 3px solid var(--accent-primary);
}

/* Gold Nugget Tips */
.gng-nugget {
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid var(--color-warning);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    color: var(--color-warning) !important;
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: var(--spacing-md);
}

/* Grid Layout */
.gng-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

@media (max-width: 500px) {
    .gng-grid {
        grid-template-columns: 1fr;
    }
}

.gng-card {
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
}

.gng-card strong {
    display: block;
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
}

.gng-card ul {
    margin: 0;
}

.gng-card.gng-pass {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--color-pass);
}

.gng-card.gng-warn {
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid var(--color-warning);
}

/* Alert Boxes */
.gng-alert-box {
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
    border-left: 4px solid var(--border-secondary);
}

.gng-alert-box.gng-candidate {
    border-left-color: var(--color-warning);
}

.gng-alert-box.gng-armed {
    border-left-color: var(--color-pass);
}

.gng-alert-box.gng-disarmed {
    border-left-color: var(--color-fail);
}

.gng-alert-box.gng-reset {
    border-left-color: var(--color-info);
}

.gng-alert-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
}

.gng-alert-icon {
    font-size: 1.25rem;
}

.gng-alert-name {
    font-weight: 700;
    font-family: var(--font-heading);
    color: var(--text-primary);
}

.gng-alert-meaning, .gng-alert-action {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* Steps */
.gng-step {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.gng-step-num {
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--accent-primary);
    color: #000;
    border-radius: 50%;
    font-weight: 700;
    font-family: var(--font-heading);
}

.gng-step-content {
    flex: 1;
}

.gng-step-content strong {
    display: block;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
}

.gng-step-content p {
    margin-bottom: var(--spacing-sm);
}

/* Checklist */
.gng-checklist {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
    margin: var(--spacing-md) 0;
}

@media (max-width: 600px) {
    .gng-checklist {
        grid-template-columns: 1fr;
    }
}

.gng-check-group {
    background: var(--bg-tertiary);
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
}

.gng-check-label {
    display: block;
    font-weight: 600;
    color: var(--accent-primary);
    margin-bottom: var(--spacing-xs);
    font-size: 0.85rem;
}

.gng-check-group ul {
    font-size: 0.85rem;
    margin: 0;
    padding-left: var(--spacing-md);
}

/* Non-Negotiable Rules */
.gng-rules {
    background: rgba(239, 68, 68, 0.05);
    border: 2px solid var(--color-fail);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.gng-rules h4 {
    color: var(--color-fail);
}

.gng-non-neg {
    margin: 0;
}

.gng-non-neg li {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
}

/* Confused Section */
.gng-confused {
    background: rgba(59, 130, 246, 0.05);
    border: 2px solid var(--color-info);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.gng-confused h4 {
    color: var(--color-info);
}

.gng-decision-tree {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.gng-decision {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    background: var(--bg-tertiary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
}

.gng-q {
    color: var(--text-muted);
    font-weight: 500;
}

.gng-a {
    margin-left: auto;
    font-weight: 600;
    color: var(--color-pass);
}


/* ============================================
   HEADER BUTTON FOR SESSION BOARD
   ============================================ */

.btn-session-board {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 6px 12px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-session-board:hover {
    border-color: var(--accent-primary);
    color: var(--accent-primary);
}

.btn-session-board.locked {
    background: rgba(34, 197, 94, 0.1);
    border-color: var(--color-pass);
    color: var(--color-pass);
}

.btn-session-board.unlocked {
    background: rgba(234, 179, 8, 0.1);
    border-color: var(--color-warning);
    color: var(--color-warning);
    animation: pulse 2s infinite;
}

.btn-gold-nugget {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 6px 12px;
    background: rgba(234, 179, 8, 0.1);
    border: 1px solid var(--color-warning);
    border-radius: var(--radius-md);
    color: var(--color-warning);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-gold-nugget:hover {
    background: rgba(234, 179, 8, 0.2);
}

    </style>
</head>
<body>
    <!-- ============================================
         APP HEADER
         ============================================ -->
    <header class="app-header">
        <div class="app-header-content">
            <div class="app-title">
                <h1>&#x1F4CA; Forex Command Centre</h1>
                <span>Pre-Trade</span>
            </div>
            
            <nav class="tab-nav">
                <button class="tab-btn" onclick="showTab('regime')">Regime</button>
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>

                <button class="tab-btn" onclick="showTab('playbook')">Playbook</button>
                <button class="tab-btn" onclick="showTab('validation')">Pre-Trade</button>
                <button class="tab-btn" onclick="showTab('journal')">Journal</button>
                <button class="tab-btn" onclick="showTab('performance')">Performance</button>
                
                <button class="tab-btn" onclick="showTab('reference')">Reference</button>
                <button class="tab-btn" onclick="showTab('settings')">Settings</button>
            </nav>
            

            <!-- Session Board & Gold Nugget Buttons -->
            <div class="header-quick-actions" style="display: flex; gap: 8px; margin-left: auto;">
                <button class="btn-session-board" id="btn-session-board" onclick="SessionBoard.showModal()" title="Session Board">
                    &#x1F4CB; <span id="session-board-status-text">Session Board</span>
                </button>
                <button class="btn-gold-nugget" onclick="TradingGuide.show()" title="UTCC Trading Reference">
                    &#x1F4D6; Guide
                </button>
            </div>
            
            <div class="theme-toggle">
                <span id="broker-global-status" class="status-dot disconnected" title="Broker: Disconnected" onclick="showTab('settings')"></span>
                <span id="calendar-status-indicator" class="status-dot offline" title="Calendar: Offline"></span>
                <button class="theme-toggle-btn active" onclick="setTheme('dark')" title="Dark Mode">&#x1F319;</button>
                <button class="theme-toggle-btn" onclick="setTheme('light')" title="Light Mode">&#x2600;</button>
            </div>
        </div>
    </header>

    <!-- ============================================
         MAIN CONTENT
         ============================================ -->
    <main class="container">
        
        <!-- ==========================================
             TAB 1: DASHBOARD
             ========================================== -->
        
        <!-- ============================================
             REGIME CHECK TAB
             ============================================ -->
        <section id="tab-regime" class="tab-content">
            
            <!-- Regime Status Banner -->
            <div class="regime-status-banner" id="regime-overall-status">
                <div class="regime-status-blocked">
                    <span>&#x1F6AB;</span>
                    <span>Complete Daily Context and Session Regime to enable trading</span>
                </div>
            </div>
            
            <!-- Daily Context Regime -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4C5; Daily Context Regime</h2>
                    <span class="regime-badge-info">Background State</span>
                </div>
                <div id="daily-context-container">
                    <!-- Rendered by JS -->
                </div>
            </div>
            
            <!-- Upcoming News (Rendered by RegimeModule) -->
            <div class="card mb-lg" id="upcoming-news-container">
                <!-- Rendered by regime-module.js -->
            </div>
            
            <!-- Session Regime Checks -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Time: Session Regime Checks</h2>
                    <span class="regime-badge-info">Operational Permission</span>
                </div>
                <p class="text-muted" style="padding: 0 var(--spacing-md); margin-bottom: var(--spacing-md); font-size: 0.85rem;">
                    Only declare regime for sessions you actively trade. Each session locks for 8 hours.
                </p>
                
                <div class="regime-sessions-grid">
                    <div id="session-tokyo-container" class="regime-session-card">
                        <!-- Rendered by JS -->
                    </div>
                    <div id="session-london-container" class="regime-session-card">
                        <!-- Rendered by JS -->
                    </div>
                    <div id="session-newyork-container" class="regime-session-card">
                        <!-- Rendered by JS -->
                    </div>
                </div>
            </div>
            
            <!-- Override Protocol -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">WARNING: Override Protocol</h2>
                    <span class="regime-badge-warning">Controlled Discretion</span>
                </div>
                <div id="override-status-container">
                    <!-- Rendered by JS -->
                </div>
            </div>
            
            <!-- Tracking Table -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CA; Regime Tracking</h2>
                    <button class="btn btn-secondary btn-sm" onclick="RegimeModule.resetRegimeData()">&#x1F5D1; Reset All</button>
                </div>
                <div id="tracking-table-container">
                    <!-- Rendered by JS -->
                </div>
            </div>
            
        </section>

        <section id="tab-dashboard" class="tab-content active">
            
            <!-- Account Overview -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Account Overview</h2>
                    <div id="drawdown-status" class="drawdown-indicator normal">
                        <span class="drawdown-dot"></span>
                        <span>NORMAL</span>
                    </div>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="dash-balance">$2,000</div>
                        <div class="stat-label">Balance (AUD)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dash-peak">$2,000</div>
                        <div class="stat-label">Peak Balance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dash-drawdown">0.0%</div>
                        <div class="stat-label">Drawdown</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="dash-open-positions">0</div>
                        <div class="stat-label">Open Positions</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick News Bias Lookup Panel -->
            <div class="quick-bias-panel" id="quick-bias-panel">
                <div class="quick-bias-header" onclick="toggleQuickBiasPanel()">
                    <div class="quick-bias-title">
                        <span>&#x1F4F0;</span>
                        <span>Quick News Bias Lookup</span>
                    </div>
                    <span class="quick-bias-toggle">&#x25BC;</span>
                </div>
                <div class="quick-bias-content">
                    <div class="quick-bias-selector">
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select class="form-select" id="quick-bias-currency" onchange="updateQuickBiasEvents()">
                                <option value="">Select currency...</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="AUD">AUD</option>
                                <option value="NZD">NZD</option>
                                <option value="CAD">CAD</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Type</label>
                            <select class="form-select" id="quick-bias-event" onchange="showQuickBiasResult()">
                                <option value="">Select event...</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-bias-result empty" id="quick-bias-result">
                        Select currency and event to see bias
                    </div>
                </div>
            </div>
            
            <!-- Position News Warning Panel (shown when open positions have upcoming news) -->
            <div id="position-news-warnings-container">
                <!-- Populated dynamically by JS when there are open positions with upcoming news -->
            </div>
            
            <!-- Active Trades Widget -->
            <div class="card mb-lg" id="active-trades-widget">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Active Trades</h2>
                    <div class="flex gap-sm align-center">
                        <span class="badge badge-info" id="widget-open-count">0 Open</span>
                        <button class="btn btn-secondary btn-sm" onclick="showTab('journal')">Manage &#x2192;</button>
                    </div>
                </div>
                
                <div id="active-trades-widget-content">
                    <div class="no-trades-widget" id="no-active-trades-widget">
                        <span style="font-size: 2rem; opacity: 0.5;">&#x1F52D;</span>
                        <span class="text-muted">No active trades</span>
                    </div>
                    
                    <div class="active-trades-grid" id="active-trades-grid" style="display: none;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Quick Trade Summary -->
                <div class="trade-summary-bar" id="trade-summary-bar" style="display: none;">
                    <div class="summary-item">
                        <span class="summary-label">Total Exposure:</span>
                        <span class="summary-value" id="widget-total-risk">0%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Floating P/L:</span>
                        <span class="summary-value" id="widget-floating-pnl">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Oldest Trade:</span>
                        <span class="summary-value" id="widget-oldest-trade">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Armed Instruments Panel -->
            <div class="card mb-lg" id="armed-panel">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Armed Instruments</h2>
                    <div class="flex gap-sm align-center">
                        <span class="armed-panel-count zero" id="armed-count">0</span>
                        <span class="armed-refresh-time" id="armed-refresh">--</span>
                    </div>
                </div>
                <div class="armed-panel-list" id="armed-list">
                    <div class="armed-empty">Connecting to state server...</div>
                </div>
            </div>
            
            <!-- Drawdown Protocol Box -->
            <div class="card mb-lg" id="drawdown-protocol-box">
                <div class="card-header">
                    <h2 class="card-title">Drawdown Protocol</h2>
                </div>
                <div class="grid grid-4">
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-normal);">
                        <div class="stat-value" style="font-size: 1rem;">0% to -5%</div>
                        <div class="stat-label">NORMAL</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1.5-2% risk</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-caution);">
                        <div class="stat-value" style="font-size: 1rem;">-5% to -10%</div>
                        <div class="stat-label">CAUTION</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1% risk, review</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-stop);">
                        <div class="stat-value" style="font-size: 1rem;">-10% to -15%</div>
                        <div class="stat-label">STOP</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1-week break</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-emergency);">
                        <div class="stat-value" style="font-size: 1rem;">-15%+</div>
                        <div class="stat-label">EMERGENCY</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1-month stop</div>
                    </div>
                </div>
            </div>
            
            <!-- Weekly Performance -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Weekly Performance</h2>
                    <span class="text-muted" id="week-date-range">This Week</span>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="week-trades">0</div>
                        <div class="stat-label">Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-winrate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-avg-r">0.0R</div>
                        <div class="stat-label">Avg R-Multiple</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-pnl">$0</div>
                        <div class="stat-label">P&L (AUD)</div>
                    </div>
                </div>
                
                <div class="grid grid-2 mt-md">
                    <div class="stat-box">
                        <div class="stat-value" id="week-expectancy">0.0R</div>
                        <div class="stat-label">Expectancy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-target">0 / 5-10</div>
                        <div class="stat-label">Target Progress</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                
                <div class="flex gap-md" style="flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showTab('validation')">
                        OK - Validate Setup
                    </button>
                    <button class="btn btn-primary" onclick="showTab('journal')">
                        &#x1F4CB; Log Trade
                    </button>
                </div>
            </div>
            
        </section>

        <!-- PLACEHOLDER: Other tabs will be added in subsequent chunks -->
        
        <!-- ==========================================
             PLAYBOOK TAB - Behavioural Architecture
             ========================================== -->
        <section id="tab-playbook" class="tab-content">
            <div class="card playbook-module-card">
                <div class="playbook-module-header">
                    <h2 class="playbook-module-title">&#x1F3AF; Playbook Selection</h2>
                    <button class="btn btn-secondary btn-sm" onclick="PlaybookModule.handleResetSelection()">&#x1F503; Reset</button>
                </div>
                
                <div id="playbook-selection-container">
                    <!-- Rendered by PlaybookModule.renderPlaybookSelection() -->
                    <p class="text-muted" style="padding: var(--spacing-md);">Loading playbook options...</p>
                </div>
            </div>
        </section>

        <section id="tab-validation" class="tab-content">
            
            <!-- UTCC v2.5 Institutional Pre-Trade Checklist -->
            
            <!-- Pre-Trade Gate Banner (shown when playbook not selected) -->
            <div id="pretrade-gate-banner" class="pretrade-gate-banner" style="display: none;">
                <span class="gate-icon">&#x1F6D1;</span>
                <div class="gate-content">
                    <div class="gate-title">PLAYBOOK NOT SELECTED</div>
                    <p class="gate-message">You must select and lock a playbook before accessing Pre-Trade validation.</p>
                </div>
                <button class="btn btn-primary" onclick="showTab('playbook')">Select Playbook</button>
            </div>
            
            <!-- Leakage Warning Container -->
            <div id="leakage-warnings-container" style="display: none;"></div>
            
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Pre-Trade Checklist</h2>
                    <button class="btn btn-secondary btn-sm" onclick="resetInstitutionalChecklist()">&#x1F503; Reset</button>
                </div>
                
                <p class="text-muted mb-md" style="padding: 0 var(--spacing-md); font-size: 0.85rem;">
                    6 HARD + 1 SOFT criteria. All HARD must pass. UTCC Armed = criteria already confirmed by system.
                </p>
                
                <!-- Basic Setup Info -->
                <div class="grid grid-3" style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label">Pair</label>
                        <select class="form-select" id="val-pair" onchange="checkCooldown(); updateInstitutionalChecklist(); checkCorrelation(); updateSessionPairRating();">
                            <option value="">Select Pair</option>
                            <optgroup label="Core Pairs">
                                <option value="AUDUSD">AUDUSD</option>
                                <option value="USDJPY">USDJPY</option>
                                <option value="EURUSD">EURUSD</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="EURJPY">EURJPY</option>
                                <option value="GBPJPY">GBPJPY</option>
                            </optgroup>
                            <optgroup label="AUD Crosses">
                                <option value="AUDCAD">AUDCAD</option>
                                <option value="AUDCHF">AUDCHF</option>
                                <option value="AUDJPY">AUDJPY</option>
                                <option value="AUDNZD">AUDNZD</option>
                            </optgroup>
                            <optgroup label="EUR Crosses">
                                <option value="EURAUD">EURAUD</option>
                                <option value="EURCAD">EURCAD</option>
                                <option value="EURGBP">EURGBP</option>
                                <option value="EURNZD">EURNZD</option>
                            </optgroup>
                            <optgroup label="GBP Crosses">
                                <option value="GBPAUD">GBPAUD</option>
                                <option value="GBPCAD">GBPCAD</option>
                                <option value="GBPCHF">GBPCHF</option>
                                <option value="GBPNZD">GBPNZD</option>
                            </optgroup>
                            <optgroup label="JPY Crosses">
                                <option value="CADJPY">CADJPY</option>
                                <option value="CHFJPY">CHFJPY</option>
                                <option value="NZDJPY">NZDJPY</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="NZDCAD">NZDCAD</option>
                                <option value="NZDCHF">NZDCHF</option>
                                <option value="NZDUSD">NZDUSD</option>
                                <option value="USDCAD">USDCAD</option>
                                <option value="USDCHF">USDCHF</option>
                                <option value="CADCHF">CADCHF</option>
                                <option value="EURCHF">EURCHF</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direction</label>
                        <select class="form-select" id="val-direction" onchange="updateInstitutionalChecklist(); updateRSIMatrix();">
                            <option value="">Select</option>
                            <option value="long">LONG</option>
                            <option value="short">SHORT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Session-Pair Rating</label>
                        <div class="session-pair-rating" id="session-pair-rating"></div>
                    </div>
                </div>
                
                <!-- Unified Pre-Trade Checklist (7 Checks) -->
                <div class="inst-checklist">
                    <div class="inst-checklist-header">
                        <span class="inst-checklist-title">&#x1F3DB; Pre-Trade Checklist</span>
                        <span class="inst-checklist-badge hard">6 HARD + 1 SOFT</span>
                    </div>
                    
                    <!-- Check 1: UTCC Armed State -->
                    <div class="inst-check-item" id="inst-check-1">
                        <span class="inst-check-number">1</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                UTCC Armed State
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">Permission gate. UTCC must show ARMED state on the 4H chart. If ARMED, all criteria (score, MTF, volatility) are already confirmed by the system. &#x2191; = Long, &#x2193; = Short. Direction is contextual, not instruction.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">UTCC panel shows &#x2191; ARMED or &#x2193; ARMED &mdash; if armed, criteria are already met</div>
                            <div class="inst-check-input">
                                <select class="form-select" id="check-utcc-armed" onchange="updateInstitutionalChecklist()" style="width: auto; min-width: 160px;">
                                    <option value="">Select Status</option>
                                    <option value="armed_long">&#x2191; ARMED</option>
                                    <option value="armed_short">&#x2193; ARMED</option>
                                    <option value="disarmed">DISARMED</option>
                                </select>
                                <span class="inst-check-status status-pending" id="check-1-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 2: 1H EMAs Stacked -->
                    <div class="inst-check-item" id="inst-check-2">
                        <span class="inst-check-number">2</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                1H EMAs Stacked Same Direction
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">1H gives TIMING &mdash; lower timeframe must confirm higher timeframe bias. Fast &gt; Mid &gt; Slow for longs, reversed for shorts.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">On 1H: Fast &gt; Mid &gt; Slow (bullish) or Fast &lt; Mid &lt; Slow (bearish), matching 4H</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-ema-stacked" onchange="updateInstitutionalChecklist()">
                                    <span>Confirmed on 1H chart</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-2-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 3: Price Acceptance/Rejection at EMA -->
                    <div class="inst-check-item" id="inst-check-3">
                        <span class="inst-check-number">3</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Price Acceptance/Rejection at EMA
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">Not just proximity. Price must show REACTION &mdash; acceptance (closes inside, rides it) or rejection (sharp displacement away). Just touching is meaningless.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Price shows clear acceptance OR rejection behaviour at EMA ribbon &mdash; not just touching</div>
                            <div class="inst-check-input">
                                <select class="form-select" id="check-ema-reaction" onchange="updateInstitutionalChecklist()" style="width: auto; min-width: 180px;">
                                    <option value="">Select Reaction</option>
                                    <option value="acceptance">Acceptance (holding at level)</option>
                                    <option value="rejection">Rejection (bouncing away)</option>
                                    <option value="touch_only">Just touched (no reaction)</option>
                                    <option value="none">No interaction</option>
                                </select>
                                <span class="inst-check-status status-pending" id="check-3-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 4: Price Failed Opposite Direction -->
                    <div class="inst-check-item" id="inst-check-4">
                        <span class="inst-check-number">4</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Price Failed to Do Opposite
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">Reaction, not prediction. For longs: price tried to go lower and FAILED. For shorts: price tried to go higher and FAILED. You trade the failure, not the prediction.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Price attempted the opposite direction and failed. Trading reaction, not prediction.</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-failed-opposite" onchange="updateInstitutionalChecklist()">
                                    <span id="failed-opposite-label">Price failed to break lower (for long) / higher (for short)</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-4-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 5: Alert Fired > 1 Candle Ago -->
                    <div class="inst-check-item" id="inst-check-5">
                        <span class="inst-check-number">5</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Alert Fired &gt; 1 Candle Ago
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">Kills FOMO. If the alert just fired this candle, you're chasing. Let it breathe. Wait for next candle minimum.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Alert fired on a PREVIOUS candle, not the current one. Prevents chasing.</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-alert-lag" onchange="updateInstitutionalChecklist()">
                                    <span>Alert fired on previous candle (not chasing)</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-5-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 6: 1H RSI Favourable (SOFT) -->
                    <div class="inst-check-item" id="inst-check-6">
                        <span class="inst-check-number">6</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                1H RSI Favourable
                                <span class="inst-checklist-badge soft">SOFT</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">MOMENTUM confirmation &mdash; RSI at extreme = higher probability entry. Affects position size, not entry permission.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">See RSI matrix below &mdash; affects position size, not entry permission</div>
                            <div class="inst-check-input">
                                <input type="number" class="form-input" id="check-rsi-value" placeholder="RSI value" min="0" max="100" style="width: 100px;" oninput="updateInstitutionalChecklist(); updateRSIMatrix();">
                                <span class="inst-check-status status-pending" id="check-6-status">PENDING</span>
                            </div>
                            
                            <!-- RSI Matrix -->
                            <div class="rsi-matrix" id="rsi-matrix">
                                <div class="rsi-matrix-title">RSI Position Size Matrix</div>
                                <div class="rsi-matrix-grid">
                                    <div class="rsi-matrix-cell header">Direction</div>
                                    <div class="rsi-matrix-cell header">RSI Level</div>
                                    <div class="rsi-matrix-cell header">Position Size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-ideal-dir">SHORT</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-short-ideal">&gt; 70 OVERBOUGHT</div>
                                    <div class="rsi-matrix-cell ideal">Full size (ideal)</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-acc-dir">SHORT</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-short-acc">50-70 PULLBACK</div>
                                    <div class="rsi-matrix-cell ideal">Full size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-mom-dir">SHORT</div>
                                    <div class="rsi-matrix-cell acceptable" id="rsi-short-mom">30-50 MOMENTUM</div>
                                    <div class="rsi-matrix-cell acceptable">75% size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-no-dir">SHORT</div>
                                    <div class="rsi-matrix-cell neutral" id="rsi-short-no">&lt; 30 OVERSOLD</div>
                                    <div class="rsi-matrix-cell neutral">No entry</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-ideal-dir">LONG</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-long-ideal">&lt; 30 OVERSOLD</div>
                                    <div class="rsi-matrix-cell ideal">Full size (ideal)</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-acc-dir">LONG</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-long-acc">30-50 PULLBACK</div>
                                    <div class="rsi-matrix-cell ideal">Full size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-mom-dir">LONG</div>
                                    <div class="rsi-matrix-cell acceptable" id="rsi-long-mom">50-70 MOMENTUM</div>
                                    <div class="rsi-matrix-cell acceptable">75% size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-no-dir">LONG</div>
                                    <div class="rsi-matrix-cell neutral" id="rsi-long-no">&gt; 70 OVERBOUGHT</div>
                                    <div class="rsi-matrix-cell neutral">No entry</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 7: No Stop Loss in Last 48h -->
                    <div class="inst-check-item" id="inst-check-7">
                        <span class="inst-check-number">7</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                No Stop Loss in Last 48h
                                <span class="inst-checklist-badge hard">HARD</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">DISCIPLINE &mdash; 48h cooldown prevents revenge trading after a loss. Auto-detected from your trade journal.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">No losing trade logged on this pair within the last 48 hours</div>
                            <div class="inst-check-input">
                                <span class="inst-check-status status-pending" id="check-7-status">Select pair first</span>
                            </div>
                            <div id="cooldown-warning-container"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Unified Verdict Panel -->
                <div class="entry-verdict-panel verdict-pending" id="entry-verdict-panel" style="margin: var(--spacing-md);">
                    <div class="entry-verdict-icon" id="entry-verdict-icon">&#x23F3;</div>
                    <div class="entry-verdict-status" id="entry-verdict-status">COMPLETE CHECKLIST</div>
                    <div class="entry-verdict-reason" id="entry-verdict-reason">Fill in the 7 checks above to see entry verdict</div>
                    <div class="entry-verdict-checklist" id="entry-verdict-checklist">
                        <span class="verdict-check" id="vc-1">&#x23F3; Armed</span>
                        <span class="verdict-check" id="vc-2">&#x23F3; EMAs</span>
                        <span class="verdict-check" id="vc-3">&#x23F3; Reaction</span>
                        <span class="verdict-check" id="vc-4">&#x23F3; Failed</span>
                        <span class="verdict-check" id="vc-5">&#x23F3; Lag</span>
                        <span class="verdict-check" id="vc-6">&#x23F3; RSI</span>
                        <span class="verdict-check" id="vc-7">&#x23F3; 48h</span>
                    </div>
                </div>
                
                <!-- SANITY CHECK WARNINGS -->
                <div class="sanity-warnings" style="margin: var(--spacing-lg) var(--spacing-md);">
                    <div class="sanity-warning" style="padding: var(--spacing-md); background: rgba(234, 179, 8, 0.1); border: 1px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                        <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">&#x26A0;</span>
                            <div>
                                <strong style="color: var(--color-warning);">Logs Are Not Justification</strong>
                                <p style="font-size: 0.85rem; margin: 4px 0 0 0; color: var(--text-secondary);">
                                    If UTCC disarms, the market wins the argument.<br>
                                    <em>"It downgraded because X"</em> is information.<br>
                                    <em>"I overrode it because Y"</em> is <strong>leakage</strong>.<br>
                                    <span style="color: var(--color-fail);">Disarm = No trade. No exceptions.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sanity-warning" style="padding: var(--spacing-md); background: rgba(59, 130, 246, 0.1); border: 1px solid var(--color-info); border-radius: var(--radius-md);">
                        <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">&#x23F1;</span>
                            <div>
                                <strong style="color: var(--color-info);">Trust Lag on Re-Arm</strong>
                                <p style="font-size: 0.85rem; margin: 4px 0 0 0; color: var(--text-secondary);">
                                    After quiet periods, first re-arm will feel late.<br>
                                    If you think <em>"This is obvious, UTCC is late"</em> &mdash; that's your edge trying to leak into prediction.<br>
                                    <span style="color: var(--color-pass);">Let price earn it. Late is correct.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ATR Volatility Guidance (Display Only) -->
                <div class="atr-guidance-panel">
                    <div class="atr-guidance-header">
                        <span>&#x1F4CA;</span>
                        <span>ATR Volatility Check (Position Sizing Guide)</span>
                    </div>
                    <div class="atr-guidance-content">
                        <div class="atr-tier compressed" id="atr-tier-compressed">
                            <span class="atr-tier-range">&lt; 30%</span>
                            <span class="atr-tier-label" style="color: var(--color-pass);">COMPRESSED</span>
                            <span class="atr-tier-action">Ideal entry. Volatility expansion likely. Full position size.</span>
                        </div>
                        <div class="atr-tier normal" id="atr-tier-normal">
                            <span class="atr-tier-range">30-60%</span>
                            <span class="atr-tier-label" style="color: var(--color-info);">NORMAL</span>
                            <span class="atr-tier-action">Good entry. Proceed with full size.</span>
                        </div>
                        <div class="atr-tier elevated" id="atr-tier-elevated">
                            <span class="atr-tier-range">60-80%</span>
                            <span class="atr-tier-label" style="color: var(--color-warning);">ELEVATED</span>
                            <span class="atr-tier-action">Caution. Move underway. Reduce position size by 50%.</span>
                        </div>
                        <div class="atr-tier exhausted" id="atr-tier-exhausted">
                            <span class="atr-tier-range">&gt; 80%</span>
                            <span class="atr-tier-label" style="color: var(--color-fail);">EXHAUSTED</span>
                            <span class="atr-tier-action">Pass. You are late. Wait for pullback or next setup.</span>
                        </div>
                        <div class="atr-current-value">
                            <span class="atr-current-label">Current ATR Percentile:</span>
                            <input type="number" class="form-input" id="val-atr-pct" placeholder="e.g. 45" min="0" max="100" style="width: 80px;" oninput="updateATRGuidance()">
                            <span class="atr-current-number" id="atr-current-tier">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- RSI Neutral Override Section (hidden by default) -->
                <div class="override-section" id="rsi-override-section" style="display: none; margin: 0 var(--spacing-md) var(--spacing-md);">
                    <label>
                        <input type="checkbox" id="rsi-override-confirm" onchange="updateInstitutionalChecklist()">
                        <span>I understand RSI is NEUTRAL (45-55). I am proceeding anyway with reduced conviction.</span>
                    </label>
                </div>

            
            <!-- Structure Analysis Section -->
            <div class="card mb-lg" id="structure-analysis">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CB; Structure Analysis</h2>
                    <button class="btn btn-secondary btn-sm" onclick="toggleStructureEducation()">&#x2139; What is Structure?</button>
                </div>
                
                <!-- Structure Education (hidden by default) -->
                <div id="structure-education" class="structure-education" style="display: none;">
                    <div class="education-header">
                        <h3>Understanding Price Structure</h3>
                        <button class="btn btn-sm" onclick="toggleStructureEducation()">&#x2715; Close</button>
                    </div>
                    
                    <div class="education-content">
                        <div class="education-section">
                            <h4>What is Structure?</h4>
                            <p>Structure refers to <strong>price levels where the market has previously reacted</strong>. These are not random lines - they're areas where buyers and sellers have fought battles before.</p>
                        </div>
                        
                        <div class="education-section">
                            <h4>For STOP LOSS - Look For:</h4>
                            <ul>
                                <li><strong>Swing Lows (for LONGS):</strong> Recent candle wicks that poked down and rejected - the lowest point before price moved up</li>
                                <li><strong>Swing Highs (for SHORTS):</strong> Recent candle wicks that poked up and rejected - the highest point before price moved down</li>
                                <li><strong>EMA Confluence:</strong> Areas where multiple EMAs cluster together (8/21/50)</li>
                                <li><strong>Round Numbers:</strong> Psychological levels like 1.1600, 0.7900, 150.00</li>
                                <li><strong>Previous Day High/Low:</strong> Key daily levels that often act as support/resistance</li>
                            </ul>
                        </div>
                        
                        <div class="education-section">
                            <h4>For TAKE PROFIT - Look For:</h4>
                            <ul>
                                <li><strong>Next Swing High/Low:</strong> The opposite of your SL structure - where price previously reversed</li>
                                <li><strong>S/R Zones on Chart:</strong> Horizontal levels where price has bounced multiple times</li>
                                <li><strong>EMA Resistance (for LONGS):</strong> Higher timeframe EMAs that might slow price down</li>
                                <li><strong>Fib Extensions:</strong> 1.272 or 1.618 extensions from recent swings</li>
                                <li><strong>Previous Week High/Low:</strong> Significant weekly levels</li>
                            </ul>
                        </div>
                        
                        <div class="education-section warning-box">
                            <h4>WARNING: Common Mistakes</h4>
                            <ul>
                                <li><strong>Placing SL exactly ON the level</strong> - Add 5-10 pip buffer BEYOND the structure</li>
                                <li><strong>Using arbitrary pip targets</strong> - 50 pips means nothing if there's resistance at 35 pips</li>
                                <li><strong>Ignoring obstacles</strong> - If there's a major S/R between entry and TP, that's your real TP</li>
                                <li><strong>Forcing trades</strong> - If structure gives you 1:0.8 R:R, skip the trade</li>
                            </ul>
                        </div>
                        
                        <div class="education-section">
                            <h4>Quick Structure Checklist</h4>
                            <ol>
                                <li>Zoom out to 4H/Daily - identify major S/R levels</li>
                                <li>Mark the nearest swing high AND swing low</li>
                                <li>Note where EMAs cluster</li>
                                <li>Check for round numbers nearby</li>
                                <li>Identify first obstacle in trade direction</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Stop Loss Structure -->
                <div class="structure-step" id="structure-step-1">
                    <div class="structure-step-header">
                        <span class="structure-step-number">1</span>
                        <span class="structure-step-title">Identify Stop Loss Level</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="structure-checklist">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="sl-swing-identified" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've identified the nearest swing high/low</span>
                            </label>
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="sl-buffer-added" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've added buffer beyond the level (not sitting ON it)</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-2 mt-sm">
                            <div class="form-group">
                                <label class="form-label">Structure Level</label>
                                <input type="number" class="form-input" id="val-sl-structure" step="0.00001" placeholder="e.g. 1.15900" oninput="calculateStructureLevels(); updateEntryDecisionPanel();">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Actual Stop Loss (with buffer)</label>
                                <input type="number" class="form-input" id="val-stop" step="0.00001" placeholder="e.g. 1.15850" oninput="calculateStructureLevels()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Entry Price -->
                <div class="structure-step" id="structure-step-2">
                    <div class="structure-step-header">
                        <span class="structure-step-number">2</span>
                        <span class="structure-step-title">Entry Price</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="form-group">
                            <label class="form-label">Entry Price</label>
                            <input type="number" class="form-input" id="val-entry" step="0.00001" placeholder="Current price or limit level" oninput="calculateStructureLevels(); updateEntryDecisionPanel(); calculateATRStop();">
                        </div>
                        <p class="text-muted" style="font-size: 0.75rem; margin-top: 4px;">
                            Entry type selection coming in next update (Market/Limit/Scale-in)
                        </p>
                    </div>
                </div>
                
                <!-- Step 3: Take Profit Structure -->
                <div class="structure-step" id="structure-step-3">
                    <div class="structure-step-header">
                        <span class="structure-step-number">3</span>
                        <span class="structure-step-title">Identify Take Profit Levels</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="structure-checklist">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="tp-structure-identified" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've identified the first S/R level in my direction (TP1)</span>
                            </label>
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="tp-path-clear" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">No major obstacles between entry and TP1</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-2 mt-sm">
                            <div class="form-group">
                                <label class="form-label">TP1 (First Target)</label>
                                <input type="number" class="form-input" id="val-tp1" step="0.00001" placeholder="First S/R level" oninput="calculateStructureLevels(); syncTPtoExitPlan();">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TP2 (Extended Target)</label>
                                <input type="number" class="form-input" id="val-tp2" step="0.00001" placeholder="Optional second target" oninput="calculateStructureLevels(); syncTPtoExitPlan();">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- R:R Analysis -->
                <div class="rr-analysis-box">
                    <h4>Risk:Reward Analysis</h4>
                    <div class="grid grid-4">
                        <div class="rr-stat">
                            <div class="rr-stat-label">Risk (pips)</div>
                            <div class="rr-stat-value" id="calc-risk-pips">--</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">Reward to TP1</div>
                            <div class="rr-stat-value" id="calc-reward-pips">--</div>
                        </div>
                        <div class="rr-stat highlight">
                            <div class="rr-stat-label">R:R to TP1</div>
                            <div class="rr-stat-value" id="calc-rr-tp1">--</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">R:R to TP2</div>
                            <div class="rr-stat-value" id="calc-rr-tp2">--</div>
                        </div>
                    </div>
                    
                    <div class="rr-verdict" id="rr-verdict">
                        <span class="rr-verdict-icon">&#x23F3;</span>
                        <span class="rr-verdict-text">Enter levels to calculate R:R</span>
                    </div>
                </div>
                
                <!-- Step 4: R:R Confirmation -->
                <div class="structure-step" id="structure-step-4">
                    <div class="structure-step-header">
                        <span class="structure-step-number">4</span>
                        <span class="structure-step-title">R:R Acceptable?</span>
                    </div>
                    <div class="structure-step-content">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="rr-acceptable" onchange="updateStructureAnalysis()">
                            <span class="checkbox-label">R:R is at least 1:1.5 to first target - this trade is worth taking</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Entry Strategy Section -->
            <div class="card mb-lg" id="entry-strategy-card">
                <div class="card-header">
                    <h2 class="card-title">&#x26A1; Entry Strategy</h2>
                </div>
                
                <!-- Entry Decision Panel - NEW -->
                <div style="padding: var(--spacing-md);">
                    <div class="entry-decision-panel" id="entry-decision-panel">
                        <div class="decision-header">
                            <span>&#x1F3AF;</span>
                            <span>Entry Decision Engine</span>
                        </div>
                        <div class="decision-context">
                            <div class="context-item">
                                <span class="context-label">Distance to S/R:</span>
                                <span class="context-value" id="distance-to-structure">-- pips</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Volatility:</span>
                                <span class="context-value" id="decision-volatility">--</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Session:</span>
                                <span class="context-value" id="decision-session">--</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Setup Grade:</span>
                                <span class="context-value" id="decision-grade">--</span>
                            </div>
                        </div>
                        <div class="decision-recommendation" id="entry-recommendation">
                            <div class="rec-type">RECOMMENDED: <strong id="rec-entry-type">--</strong></div>
                            <div class="rec-reason" id="rec-reason">Complete structure analysis first</div>
                        </div>
                        <div class="decision-warning" id="entry-decision-warning" style="display: none;">
                            <span>WARNING:</span>
                            <span id="entry-warning-text">Your selection differs from recommendation</span>
                        </div>
                    </div>
                </div>
                
                <!-- Kill Zone Indicator - NEW -->
                <div style="padding: 0 var(--spacing-md);">
                    <div class="kill-zone-indicator" id="kill-zone-indicator" style="display: none;">
                        <div class="kz-icon">&#x1F3AF;</div>
                        <div class="kz-content">
                            <div class="kz-name" id="kz-name">London Open</div>
                            <div class="kz-desc" id="kz-desc">High volatility breakout zone</div>
                            <div class="kz-pairs" id="kz-pairs">Optimal: EURUSD, GBPUSD</div>
                        </div>
                        <div class="kz-timer" id="kz-timer">-- min</div>
                    </div>
                </div>
                
                <!-- Entry Type Selection -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">Entry Type</label>
                    <div class="entry-type-selector">
                        <button type="button" class="entry-type-btn active" data-type="market" id="btn-market" onclick="selectEntryType('market')">
                            <span class="entry-icon">&#x1F3AF;</span>
                            <span class="entry-label">Market</span>
                        </button>
                        <button type="button" class="entry-type-btn" data-type="limit" id="btn-limit" onclick="selectEntryType('limit')">
                            <span class="entry-icon">&#x1F4CD;</span>
                            <span class="entry-label">Limit</span>
                        </button>
                        <button type="button" class="entry-type-btn" data-type="scale" id="btn-scale" onclick="selectEntryType('scale')">
                            <span class="entry-icon">&#x1F4CA;</span>
                            <span class="entry-label">Scale-In</span>
                        </button>
                    </div>
                    
                    <!-- Limit Order Details (hidden by default) -->
                    <div id="limit-order-details" class="entry-details">
                        <div class="limit-order-details">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--accent-tertiary);">&#x1F4CD; Limit Order Setup</h4>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                <div class="form-group">
                                    <label class="form-label">Limit Price</label>
                                    <input type="number" id="limit-entry-price" class="form-input" step="0.00001" placeholder="1.08500" oninput="updateLimitOrderCalcs()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Distance from Current (pips)</label>
                                    <input type="text" id="limit-distance" class="form-input" readonly placeholder="--">
                                </div>
                            </div>
                            <!-- Limit Validation - NEW -->
                            <div class="limit-validation" id="limit-validation" style="display: none;">
                                <span id="limit-val-icon">OK -</span>
                                <span id="limit-val-text">Limit at structure level</span>
                            </div>
                            <button type="button" class="btn-use-structure" onclick="useStructureForLimit()">
                                &#x1F4CD; Use Structure Level
                            </button>
                            <div class="time-warning" id="limit-expiry-note" style="margin-top: var(--spacing-sm);">
                                <span>Time: </span>
                                <span>Limit orders: max 24h expiry. Cancel if setup invalidates.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scale-In Details (hidden by default) -->
                    <div id="scale-in-details" class="entry-details">
                        <div class="scale-in-details">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--accent-tertiary);">&#x1F4CA; Scale-In Protocol (A+ Setups Only)</h4>
                            
                            <!-- Scale-In Grade Check - NEW -->
                            <div class="scale-grade-check" id="scale-grade-check">
                                <span id="scale-grade-icon">&#x23F3;</span>
                                <span id="scale-grade-text">Enter UTCC score to verify eligibility</span>
                            </div>
                            
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: var(--spacing-md);">
                                Entry 1: First structure test (50%) &#x2192; Entry 2: Deeper structure OR confirmation (50%)
                            </p>
                            <div class="scale-level">
                                <span class="scale-level-number">1</span>
                                <input type="number" id="scale-price-1" class="form-input" step="0.00001" placeholder="First structure level" oninput="updateScaleCalcs()">
                                <input type="number" id="scale-percent-1" class="form-input scale-percent" value="50" min="10" max="90" oninput="updateScaleCalcs()">
                                <span style="font-size: 0.8rem;">%</span>
                            </div>
                            <div class="scale-level">
                                <span class="scale-level-number">2</span>
                                <input type="number" id="scale-price-2" class="form-input" step="0.00001" placeholder="Deeper structure level" oninput="updateScaleCalcs()">
                                <input type="number" id="scale-percent-2" class="form-input scale-percent" value="50" min="10" max="90" oninput="updateScaleCalcs()">
                                <span style="font-size: 0.8rem;">%</span>
                            </div>
                            <div id="scale-validation" style="margin-top: var(--spacing-sm); font-size: 0.8rem;"></div>
                            
                            <!-- Scale Calculations - NEW -->
                            <div class="scale-calculations" id="scale-calculations" style="display: none;">
                                <div class="scale-calc-row">
                                    <span class="label">Average Entry:</span>
                                    <span class="value" id="scale-avg-entry">--</span>
                                </div>
                                <div class="scale-calc-row">
                                    <span class="label">Combined R:R:</span>
                                    <span class="value" id="scale-combined-rr">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Session Timing -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Session Timing (AEST)</label>
                    <div class="session-timing">
                        <div class="session-box" id="session-tokyo">
                            <div class="session-name">&#x1F1EF;&#x1F1F5; Tokyo</div>
                            <div class="session-time">09:00 - 18:00</div>
                            <div class="session-status" id="tokyo-status">--</div>
                        </div>
                        <div class="session-box" id="session-london">
                            <div class="session-name">&#x1F1EC;&#x1F1E7; London</div>
                            <div class="session-time">17:00 - 02:00</div>
                            <div class="session-status" id="london-status">--</div>
                        </div>
                        <div class="session-box" id="session-newyork">
                            <div class="session-name">&#x1F1FA;&#x1F1F8; New York</div>
                            <div class="session-time">22:00 - 07:00</div>
                            <div class="session-status" id="newyork-status">--</div>
                        </div>
                    </div>
                    <div id="session-warning" class="time-warning" style="display: none;">
                        <span>WARNING:</span>
                        <span id="session-warning-text">Low liquidity period - consider waiting for session open</span>
                    </div>
                </div>
                
                <!-- Entry Timing Considerations -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Timing Considerations</label>
                    <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="timing-not-news" onchange="updateEntryConfirmation(); checkNewsBuffer();">
                            <span class="checkbox-label">Not entering within 30min of major news</span>
                        </label>
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="timing-session-appropriate" onchange="updateEntryConfirmation()">
                            <span class="checkbox-label">Session liquidity appropriate for this pair</span>
                        </label>
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="timing-not-friday-close" onchange="updateEntryConfirmation()">
                            <span class="checkbox-label">Not entering within 4hrs of Friday close</span>
                        </label>
                    </div>
                    
                    <!-- Enhanced News Buffer Warning -->
                    <div class="news-buffer-warning" id="news-buffer-warning">
                        <div class="news-buffer-title">
                            <span>WARNING:</span>
                            <span id="news-buffer-title-text">High Impact News Warning</span>
                        </div>
                        <div class="news-buffer-content" id="news-buffer-content">
                            <!-- Populated by JS -->
                        </div>
                        <div class="news-buffer-recommendation" id="news-buffer-recommendation">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- News Buffer Check Button -->
                    <div style="margin-top: var(--spacing-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="manualNewsBufferCheck()">
                            &#x1F4C5; Check News for Selected Pair
                        </button>
                        <a href="https://www.forexfactory.com/calendar" target="_blank" class="btn btn-secondary btn-sm" style="margin-left: var(--spacing-sm); text-decoration: none;">
                            &#x1F4C6; Full Calendar
                        </a>
                    </div>
                </div>
                
                <!-- Entry Confirmation Summary -->
                <div class="entry-confirmation" style="padding: var(--spacing-md);">
                    <div id="entry-strategy-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem;">
                        <span id="entry-strategy-icon">&#x23F3;</span>
                        <span id="entry-strategy-text">Complete entry strategy setup</span>
                    </div>
                </div>
            </div>
            
            <!-- Stop Loss Strategy Section -->
            <div class="card mb-lg" id="sl-strategy-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F6D1; Stop Loss Strategy</h2>
                </div>
                
                <!-- ATR-Based Calculator -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">ATR-Based Stop Loss Calculator</label>
                    <div class="atr-calculator">
                        <div class="atr-input-group">
                            <label class="form-label" style="font-size: 0.75rem;">Current ATR (from UTCC)</label>
                            <input type="number" id="sl-atr-value" class="form-input" step="0.0001" placeholder="0.0085" oninput="calculateATRStop()">
                        </div>
                        <div class="atr-input-group">
                            <label class="form-label" style="font-size: 0.75rem;">ATR Multiplier</label>
                            <input type="number" id="sl-atr-multiplier" class="form-input" step="0.1" value="1.5" min="0.5" max="3" oninput="calculateATRStop()">
                        </div>
                        <div class="atr-result">
                            <div class="atr-result-value" id="atr-sl-pips">--</div>
                            <div class="atr-result-label">Suggested SL (pips)</div>
                        </div>
                        <div class="atr-result">
                            <div class="atr-result-value" id="atr-sl-price">--</div>
                            <div class="atr-result-label">SL Price Level</div>
                        </div>
                    </div>
                </div>
                
                <!-- Volatility State Guide -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Volatility State (from UTCC)</label>
                    <div class="volatility-guide">
                        <div class="volatility-option" data-vol="quiet" onclick="selectVolatility('quiet')">
                            <div class="vol-name">&#x1F634; QUIET</div>
                            <div class="vol-multiplier">0.75 - 1x ATR</div>
                        </div>
                        <div class="volatility-option selected" data-vol="trend" onclick="selectVolatility('trend')">
                            <div class="vol-name">&#x1F4C8; TREND</div>
                            <div class="vol-multiplier">1 - 1.5x ATR</div>
                        </div>
                        <div class="volatility-option" data-vol="explode" onclick="selectVolatility('explode')">
                            <div class="vol-name">&#x1F4A5; EXPLODE</div>
                            <div class="vol-multiplier">1.5 - 2x ATR</div>
                        </div>
                    </div>
                    <div id="volatility-advice" style="font-size: 0.8rem; color: var(--text-muted); padding: var(--spacing-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                        &#x1F4CA; TREND conditions: Standard stop distance. Use 1-1.5x ATR for balanced risk.
                    </div>
                </div>
                
                <!-- SL Confirmation -->
                <div style="padding: var(--spacing-md); border-top: 1px solid var(--border-primary);">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="sl-strategy-confirmed" onchange="updateSLStrategyStatus()">
                        <span class="checkbox-label">Stop loss is placed beyond structure with appropriate buffer for volatility</span>
                    </label>
                    <div id="sl-strategy-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem; margin-top: var(--spacing-sm);">
                        <span id="sl-strategy-icon">&#x23F3;</span>
                        <span id="sl-strategy-text">Configure stop loss strategy</span>
                    </div>
                </div>
            </div>
            
            <!-- Exit Management Section -->
            <div class="card mb-lg" id="exit-management-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Exit Management Plan</h2>
                </div>
                
                <!-- TP Levels with Partials -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">Take Profit Levels & Partials</label>
                    <div class="tp-levels-grid">
                        <div class="tp-level-box tp1">
                            <div class="tp-level-header">
                                <span class="tp-level-title">TP1 - First Target</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="exit-tp1-percent" class="form-input tp-percent-input" value="50" min="25" max="75" oninput="updateExitPartials()">
                                    <span style="font-size: 0.8rem;">%</span>
                                </div>
                            </div>
                            <input type="number" id="exit-tp1-price" class="form-input" step="0.00001" placeholder="From Structure Analysis" oninput="updateExitPlan()">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                Close half position, move SL to breakeven
                            </div>
                        </div>
                        <div class="tp-level-box tp2">
                            <div class="tp-level-header">
                                <span class="tp-level-title">TP2 - Final Target</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="exit-tp2-percent" class="form-input tp-percent-input" value="50" min="25" max="75" readonly>
                                    <span style="font-size: 0.8rem;">%</span>
                                </div>
                            </div>
                            <input type="number" id="exit-tp2-price" class="form-input" step="0.00001" placeholder="From Structure Analysis" oninput="updateExitPlan()">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                Let runner ride with trailing stop
                            </div>
                        </div>
                    </div>
                    <div id="partials-validation" style="font-size: 0.8rem; text-align: center;"></div>
                </div>
                
                <!-- Trail Stop Configuration -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Trailing Stop Strategy (after TP1)</label>
                    <div class="trail-stop-config">
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-breakeven" value="breakeven" checked onchange="updateTrailMethod()">
                            <label for="trail-breakeven">Move to Breakeven only</label>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-structure" value="structure" onchange="updateTrailMethod()">
                            <label for="trail-structure">Trail behind structure (swing points)</label>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-atr" value="atr" onchange="updateTrailMethod()">
                            <label for="trail-atr">ATR-based trail</label>
                            <input type="number" id="trail-atr-multiple" class="form-input" value="1.5" step="0.5" min="1" max="3" disabled>
                            <span style="font-size: 0.75rem;">x ATR</span>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-fixed" value="fixed" onchange="updateTrailMethod()">
                            <label for="trail-fixed">Fixed pips trail</label>
                            <input type="number" id="trail-fixed-pips" class="form-input" value="20" min="5" max="100" disabled>
                            <span style="font-size: 0.75rem;">pips</span>
                        </div>
                    </div>
                </div>
                
                <!-- Time Stop -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Time-Based Exit Rule</label>
                    <div class="time-stop-config">
                        <span>If no progress after</span>
                        <input type="number" id="time-stop-hours" class="form-input" style="width: 70px;" value="24" min="4" max="72">
                        <span>hours, review and consider closing</span>
                    </div>
                </div>
                
                <!-- Exit Rules Acknowledgment -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Exit Rules</label>
                    <div class="exit-rules-box">
                        <div class="exit-rule">
                            <span class="exit-rule-icon">1.</span>
                            <span>At TP1: Close partial, move SL to breakeven</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">2.</span>
                            <span>Opposite UTCC signal = immediate exit (don't wait for SL)</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">3.</span>
                            <span>Time stop triggered = reassess, don't hold dead trades</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">4.</span>
                            <span>Never move SL against position (only to reduce risk)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Exit Plan Confirmation -->
                <div style="padding: var(--spacing-md); border-top: 1px solid var(--border-primary);">
                    <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                        <input type="checkbox" id="exit-plan-acknowledged" onchange="updateExitPlanStatus()">
                        <span class="checkbox-label">I have a clear exit plan with defined TP levels and trail strategy</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="exit-opposite-signal" onchange="updateExitPlanStatus()">
                        <span class="checkbox-label">Exit on opposite UTCC direction signal (trend reversal)</span>
                    </label>
                    <div id="exit-plan-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem; margin-top: var(--spacing-sm);">
                        <span id="exit-plan-icon">&#x23F3;</span>
                        <span id="exit-plan-text">Configure exit management plan</span>
                    </div>
                </div>
            </div>
            
            <!-- Correlation Check -->
            <div class="card mb-lg" id="correlation-check-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F517; Correlation Check</h2>
                </div>
                
                <div id="correlation-status" class="correlation-status">
                    <div class="correlation-status-icon">&#x23F3;</div>
                    <div class="correlation-status-text">Select a pair to check correlation</div>
                </div>
                
                <!-- Correlation Block Warning (shows when correlated) -->
                <div id="correlation-block" style="display: none; padding: var(--spacing-md); background: rgba(239, 68, 68, 0.15); border: 2px solid var(--color-fail); border-radius: var(--radius-md); margin: var(--spacing-md);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <span style="font-size: 1.5rem;">&#x1F6AB;</span>
                        <strong style="color: var(--color-fail); font-size: 1.1rem;">TRADE BLOCKED - Correlated Exposure</strong>
                    </div>
                    <p id="correlation-block-reason" style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                        You have open positions in correlated pairs.
                    </p>
                    
                    <!-- Override Option -->
                    <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-sm);">
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="correlation-override" onchange="handleCorrelationOverride()">
                            <span class="checkbox-label"><strong>Override block</strong> - I understand and accept doubled currency exposure</span>
                        </label>
                        <div id="correlation-override-warning" style="display: none; font-size: 0.8rem; color: var(--color-warning); margin-top: var(--spacing-sm);">
                            WARNING: <strong>Half position size required!</strong> Reduce your position to 50% of normal to manage correlation risk.
                        </div>
                    </div>
                </div>
                
                <div class="correlation-groups-collapse" style="padding: var(--spacing-md);">
                    <button class="btn btn-sm btn-secondary" onclick="toggleCorrelationGroups()">Show Correlation Groups</button>
                    <div id="correlation-groups-content" style="display: none;">
                        <div class="correlation-groups mt-sm">
                            <div class="correlation-group"><strong>AUD:</strong> AUDUSD, AUDJPY, AUDNZD, AUDCAD, AUDCHF, EURAUD, GBPAUD</div>
                            <div class="correlation-group"><strong>EUR:</strong> EURUSD, EURJPY, EURGBP, EURAUD, EURCAD, EURNZD, EURCHF</div>
                            <div class="correlation-group"><strong>GBP:</strong> GBPUSD, GBPJPY, EURGBP, GBPAUD, GBPCAD, GBPCHF, GBPNZD</div>
                            <div class="correlation-group"><strong>JPY:</strong> USDJPY, EURJPY, GBPJPY, AUDJPY, NZDJPY, CADJPY, CHFJPY</div>
                            <div class="correlation-group"><strong>NZD:</strong> NZDUSD, NZDJPY, AUDNZD, NZDCAD, NZDCHF, EURNZD, GBPNZD</div>
                            <div class="correlation-group"><strong>CAD:</strong> USDCAD, CADJPY, AUDCAD, EURCAD, GBPCAD, NZDCAD, CADCHF</div>
                            <div class="correlation-group"><strong>CHF:</strong> USDCHF, CHFJPY, AUDCHF, EURCHF, GBPCHF, NZDCHF, CADCHF</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden checkbox for validation (auto-checked when clear or override accepted) -->
                <input type="checkbox" id="correlation-accepted" style="display: none;" onchange="updateValidationVerdict()">
            </div>
            
            <!-- Phase 4: Re-Entry Rules Check -->
            <div class="card mb-lg" id="reentry-rules-card" style="display: none;">
                <div class="card-header" style="background: rgba(239, 68, 68, 0.1);">
                    <h2 class="card-title" style="color: var(--color-fail);">RE-ENTRY BLOCK</h2>
                </div>
                
                <div class="reentry-block-content" style="padding: var(--spacing-md);">
                    <div class="reentry-warning-box" style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--color-fail); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 1.5rem;">&#x1F6D1;</span>
                            <strong style="color: var(--color-fail); font-size: 1.1rem;">WAIT PERIOD ACTIVE</strong>
                        </div>
                        <p id="reentry-reason" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                            Recent stop loss hit on this pair. Re-entry rules apply.
                        </p>
                        <div id="reentry-timer" style="font-family: var(--font-heading); font-size: 1.2rem; color: var(--color-warning);">
                            Time remaining: --
                        </div>
                    </div>
                    
                    <div class="reentry-rules-list" style="background: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-md);">
                        <h4 style="margin-bottom: var(--spacing-sm);">Re-Entry Requirements:</h4>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-time">&#x2610;</span>
                            <span>4-hour minimum wait after stop loss</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-fresh">&#x2610;</span>
                            <span>Fresh setup (not same pattern)</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-score">&#x2610;</span>
                            <span id="reentry-score-req">Higher score than stopped trade (need: --)</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-session">&#x2610;</span>
                            <span>Different session preferred</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-md);">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="reentry-override" onchange="handleReentryOverride()">
                            <span class="checkbox-label"><strong>Override re-entry block</strong> - I confirm all re-entry requirements are met</span>
                        </label>
                    </div>
                </div>
                
                <input type="checkbox" id="reentry-accepted" style="display: none;" onchange="updateValidationVerdict()">
            </div>
            
            <!-- Final Confirmation -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">OK - Final Confirmation</h2>
                </div>
                
                <div class="final-checks">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="final-structure-supports" onchange="updateStructureAnalysis()">
                        <span class="checkbox-label"><strong>Structure supports this trade</strong> - I'm entering because the levels make sense, not because I want to be in a trade</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="final-risk-sized" onchange="updateStructureAnalysis()">
                        <span class="checkbox-label"><strong>Position is properly sized</strong> - Risk is within my drawdown-adjusted limit</span>
                    </label>
                </div>
            </div>
            
            <!-- Validation Verdict -->
            <div class="card">
                <div class="verdict-box" id="validation-verdict">
                    <div class="verdict-label">Trade Status</div>
                    <div class="verdict-status" id="verdict-status">INCOMPLETE</div>
                    <div class="text-muted mt-sm" style="font-size: 0.8rem;" id="verdict-reason">Complete structure analysis and confirmations</div>
                    
                    <!-- Phase 3: Trade Grade Display -->
                    <div class="trade-grade-display" id="trade-grade-display" style="display: none;">
                        <div class="grade-badge-container">
                            <div class="grade-badge" id="grade-badge">--</div>
                            <div class="grade-label-text">Setup Grade</div>
                        </div>
                        <div class="grade-details">
                            <div class="grade-breakdown" id="grade-breakdown"></div>
                        </div>
                        <div class="grade-position-rec" id="grade-position-rec">
                            <span class="rec-label">Recommended Position:</span>
                            <span class="rec-value" id="grade-position-value">--</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-lg mt-lg" style="width: 100%;" id="execute-trade-btn" disabled onclick="executeTradeFromValidation()">
                    EXECUTE TRADE
                </button>
            </div>
            
        </section>
        
        <section id="tab-journal" class="tab-content">
            
            <!-- Institutional Trade Journal -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4D3; Institutional Trade Journal</h2>
                    <button class="btn btn-secondary btn-sm" onclick="clearTradeForm()">&#x1F4CD; Clear Form</button>
                </div>
                
                <!-- SECTION A: Trade Metadata -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">A</span>
                        <span class="journal-section-title">Trade Metadata</span>
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-input" id="trade-datetime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Instrument</label>
                            <select class="form-select" id="trade-pair">
                                <option value="">Select Instrument</option>
                                <optgroup label="--- FOREX ---"></optgroup>
                                <optgroup label="Core Pairs">
                                    <option value="AUDUSD">AUDUSD</option>
                                    <option value="USDJPY">USDJPY</option>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                    <option value="EURJPY">EURJPY</option>
                                    <option value="GBPJPY">GBPJPY</option>
                                </optgroup>
                                <optgroup label="AUD Crosses">
                                    <option value="AUDCAD">AUDCAD</option>
                                    <option value="AUDCHF">AUDCHF</option>
                                    <option value="AUDJPY">AUDJPY</option>
                                    <option value="AUDNZD">AUDNZD</option>
                                </optgroup>
                                <optgroup label="EUR Crosses">
                                    <option value="EURAUD">EURAUD</option>
                                    <option value="EURCAD">EURCAD</option>
                                    <option value="EURGBP">EURGBP</option>
                                    <option value="EURNZD">EURNZD</option>
                                </optgroup>
                                <optgroup label="GBP Crosses">
                                    <option value="GBPAUD">GBPAUD</option>
                                    <option value="GBPCAD">GBPCAD</option>
                                    <option value="GBPCHF">GBPCHF</option>
                                    <option value="GBPNZD">GBPNZD</option>
                                </optgroup>
                                <optgroup label="JPY Crosses">
                                    <option value="CADJPY">CADJPY</option>
                                    <option value="CHFJPY">CHFJPY</option>
                                    <option value="NZDJPY">NZDJPY</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="NZDCAD">NZDCAD</option>
                                    <option value="NZDCHF">NZDCHF</option>
                                    <option value="NZDUSD">NZDUSD</option>
                                    <option value="USDCAD">USDCAD</option>
                                    <option value="USDCHF">USDCHF</option>
                                    <option value="CADCHF">CADCHF</option>
                                    <option value="EURCHF">EURCHF</option>
                                </optgroup>
                                <optgroup label="--- METALS ---"></optgroup>
                                <optgroup label="Precious Metals">
                                    <option value="XAUUSD">XAUUSD (Gold)</option>
                                    <option value="XAGUSD">XAGUSD (Silver)</option>
                                </optgroup>
                                <optgroup label="--- INDICES ---"></optgroup>
                                <optgroup label="US Indices">
                                    <option value="US30USD">US30USD (Dow)</option>
                                    <option value="SPX500USD">SPX500USD (S&P)</option>
                                    <option value="NAS100USD">NAS100USD (Nasdaq)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which session are you trading?</strong><br><br>
                                        <strong>Tokyo (9am&ndash;5pm AEST):</strong> Your primary Asian session. JPY/AUD pairs most active. Moderate volatility.<br><br>
                                        <strong>London (5pm&ndash;10pm AEST):</strong> Your primary European session. EUR/GBP/CHF pairs most active. Highest liquidity.<br><br>
                                        <strong>New York:</strong> Prep only &mdash; outside your availability window. Mark levels, do not execute.<br><br>
                                        <strong>Overlap:</strong> Prep only &mdash; volatile, unpredictable. Observation and level marking.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-session">
                                <option value="">Select</option>
                                <option value="tokyo">Tokyo</option>
                                <option value="london">London</option>
                                <option value="newyork">New York</option>
                                <option value="overlap">London/NY Overlap</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trade Type
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which playbook are you executing?</strong> You must name this BEFORE seeing the alert.<br><br>
                                        <strong>Continuation:</strong> Trend in place; EMA ribbon pullback; enter on rejection/acceptance. Best in Expansion regime.<br><br>
                                        <strong>Pullback:</strong> Deep retracement to slow EMA or key swing level; wait for reclaim. Best in Expansion.<br><br>
                                        <strong>Range Expansion:</strong> Breakout from compression/range; requires confirmation (retest). Only in Contraction regime after proof.<br><br>
                                        <strong>Mean Reversion:</strong> Fade at defined range extremes only. Balanced regime only. Reduced size.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-type">
                                <option value="">Select</option>
                                <option value="continuation">Continuation</option>
                                <option value="pullback">Pullback</option>
                                <option value="range-expansion">Range Expansion</option>
                                <option value="mean-reversion">Mean Reversion</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Direction</label>
                            <select class="form-select" id="trade-direction">
                                <option value="">Select</option>
                                <option value="long">LONG</option>
                                <option value="short">SHORT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Permission TF
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which timeframe granted permission?</strong><br><br>
                                        <strong>4H:</strong> Primary permission timeframe. Gives directional bias. Standard for swing entries.<br><br>
                                        <strong>1H:</strong> Secondary. Used when 4H is already aligned and 1H provides the ARMED signal.<br><br>
                                        <strong>Daily:</strong> Context timeframe only. Rarely the direct permission source; confirms higher structure.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-permission-tf">
                                <option value="">Select</option>
                                <option value="4H">4H</option>
                                <option value="1H">1H</option>
                                <option value="Daily">Daily</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Execution TF
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which timeframe are you entering on?</strong><br><br>
                                        <strong>1H:</strong> Standard execution timeframe. Best for swing entries with clear structure.<br><br>
                                        <strong>15m:</strong> Tight entry refinement. Use when 1H structure is confirmed and you want a tighter stop.<br><br>
                                        <strong>5m:</strong> Scalp precision. Rarely used; only for very tight risk entries. Higher noise.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-execution-tf">
                                <option value="">Select</option>
                                <option value="1H">1H</option>
                                <option value="15m">15m</option>
                                <option value="5m">5m</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION B: Permission Log (AUTO-POPULATED from Pre-Trade) -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">B</span>
                        <span class="journal-section-title">Permission Log</span>
                        <span class="journal-section-badge" style="background: var(--color-info); color: #fff;">Auto</span>
                    </div>
                    
                    <div id="permission-log-readonly" class="permission-log-grid" style="opacity: 0.85;">
                        <div class="permission-log-row">
                            <span class="permission-log-label">Market Regime</span>
                            <span class="permission-log-value" id="perm-display-regime">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Structure Quality</span>
                            <span class="permission-log-value" id="perm-display-structure">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Volatility Context</span>
                            <span class="permission-log-value" id="perm-display-vol">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Session Window</span>
                            <span class="permission-log-value" id="perm-display-session">--</span>
                        </div>
                        <div class="permission-log-row highlight">
                            <span class="permission-log-label">Permission State</span>
                            <span class="permission-log-value" id="perm-display-state">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Reason</span>
                            <span class="permission-log-value" id="perm-display-reason" style="font-size:0.75rem;">--</span>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; text-align: center;">
                        &#x2139; Auto-populated from Pre-Trade validation. Edit in Pre-Trade tab.
                    </div>

                    <!-- Hidden fields to preserve data in collectTradeFormData -->
                    <input type="hidden" id="trade-market-regime" value="">
                    <input type="hidden" id="trade-structure-quality" value="">
                    <input type="hidden" id="trade-vol-context" value="">
                    <input type="hidden" id="trade-session-window" value="">
                    <input type="hidden" id="trade-permission-state" value="">
                    <input type="hidden" id="trade-permission-reason" value="">
                    <input type="hidden" id="trade-permission-evidence" value="">
                </div>
                
                                <!-- SECTION C: Execution Quality -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">C</span>
                        <span class="journal-section-title">Execution Quality</span>
                    </div>
                    
                    <div class="execution-checklist">
                        <label class="execution-check">
                            <input type="checkbox" id="exec-type-declared">
                            <span>Trade type declared pre-entry
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You named your playbook (Continuation, Pullback, etc.) <strong>before</strong> seeing the chart or alert. If you decided the type after the alert, uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-single-trigger">
                            <span>Single execution trigger used
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You used exactly <strong>one</strong> trigger to enter (e.g. BOS, rejection candle, reclaim). No freestyle entries or combining multiple conflicting triggers.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-planned-price">
                            <span>Entry at planned price
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Your actual entry was at or near the price you planned. If you chased or entered impulsively at a worse price, uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-stop-invalidation">
                            <span>Stop placed at invalidation
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Your stop is at the level where your <strong>trade thesis is wrong</strong> &mdash; not an arbitrary ATR distance. The stop should make structural sense.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-spread-ok">
                            <span>Spread acceptable
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Spread was within normal range for this pair and session. If spread was abnormally wide (news, dead zone, illiquid hours), uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="form-group mt-md">
                        <label class="form-label">Entry Trigger Description</label>
                        <input type="text" class="form-input" id="trade-entry-trigger" placeholder="e.g. 1H BOS in direction of 4H, rejection at key level...">
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">Entry Price</label>
                            <input type="number" class="form-input" id="trade-entry" step="0.00001" placeholder="1.23456">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stop Loss</label>
                            <input type="number" class="form-input" id="trade-stop" step="0.00001" placeholder="1.23000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Take Profit</label>
                            <input type="number" class="form-input" id="trade-tp" step="0.00001" placeholder="1.24000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Exit Price</label>
                            <input type="number" class="form-input" id="trade-exit" step="0.00001" placeholder="Leave blank if open">
                        </div>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Position Size (Units)</label>
                            <input type="number" class="form-input" id="trade-units" placeholder="e.g. 15000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risk Amount (AUD)</label>
                            <input type="number" class="form-input" id="trade-risk-amount" step="0.01" placeholder="e.g. 30.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risk %
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Position risk as percentage of account.</strong> Must match your permission state and drawdown level.<br><br>
                                        <strong>0.25%:</strong> Override trades only. Maximum risk when trading against a block.<br><br>
                                        <strong>0.5%:</strong> Conditional permission or drawdown caution (-3% to -5%). Reduced conviction.<br><br>
                                        <strong>1%:</strong> Conservative normal. Use during early system adoption or minor drawdown.<br><br>
                                        <strong>1.5%:</strong> Standard risk. FULL permission + clean structure + entry window.<br><br>
                                        <strong>2%:</strong> Maximum allowed. Only with FULL permission, HOT zone, perfect conditions. Absolute ceiling &mdash; never exceed.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-risk-pct">
                                <option value="0.25">0.25% (Override)</option>
                                <option value="0.5">0.5%</option>
                                <option value="1">1%</option>
                                <option value="1.5" selected>1.5%</option>
                                <option value="2">2%</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION D: Management Discipline -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">D</span>
                        <span class="journal-section-title">Management Discipline</span>
                    </div>
                    
                    <div class="management-checklist">
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-no-early-stop">
                            <span>No early stop movement
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You did <strong>not</strong> widen your stop after entry. Stops only move to breakeven or tighter &mdash; never further from entry. Widening is a discipline failure.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-partial-rules">
                            <span>Partial rules followed
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You followed your partial take-profit rules: close 50% at TP1 (1R), move stop to breakeven, let remainder run. No improvising.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-exit-rules">
                            <span>Exit rules respected
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You exited because <strong>the reason changed</strong> (structure break, opposite signal, news, time stop) &mdash; not because of fear or hope. Emotional exits = uncheck.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-no-revenge">
                            <span>No revenge management
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        After a loss, you did <strong>not</strong> re-enter the same pair, increase size, or lower your standards to &ldquo;make it back&rdquo;. 48h cooldown respected.
                                    </span>
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Exit Reason
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Why did this trade close?</strong><br><br>
                                        <strong>TP Hit:</strong> Price reached your take-profit level. System worked.<br>
                                        <strong>SL Hit:</strong> Price reached invalidation. Accept -1R as cost of business.<br>
                                        <strong>Manual Win/Loss:</strong> You closed before TP/SL. Must have a structural reason.<br>
                                        <strong>Breakeven:</strong> Neutral &mdash; does NOT reset loss streaks or failure counters.<br>
                                        <strong>News Event:</strong> Closed to avoid high-impact news. Defensive; valid.<br>
                                        <strong>Time Stop:</strong> Trade went nowhere within time limit (24&ndash;48h for 1H, 3&ndash;5 days for 4H).
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-exit-reason">
                                <option value="">Select (if closed)</option>
                                <option value="TP_HIT">TP Hit</option>
                                <option value="SL_HIT">SL Hit</option>
                                <option value="MANUAL_WIN">Manual Close - Win</option>
                                <option value="MANUAL_LOSS">Manual Close - Loss</option>
                                <option value="BREAKEVEN">Breakeven</option>
                                <option value="PARTIAL">Partial Close</option>
                                <option value="NEWS">News Event</option>
                                <option value="TIME_STOP">Time Stop</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trade Status</label>
                            <select class="form-select" id="trade-status">
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Slippage (pips)</label>
                            <input type="number" class="form-input" id="trade-slippage" step="0.1" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <!-- SECTION E: Outcome Metrics -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">E</span>
                        <span class="journal-section-title">Outcome Metrics</span>
                        <span class="journal-section-badge secondary">Secondary</span>
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">R-Multiple</label>
                            <input type="number" class="form-input" id="trade-r-display" step="0.01" readonly placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MAE (pips)
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Max Adverse Excursion:</strong> How many pips did price go AGAINST you before the trade ended?<br><br>
                                        If this is often close to your stop loss, your stops might be too tight.
                                    </span>
                                </span>
                            </label>
                            <input type="number" class="form-input" id="trade-mae" step="0.1" placeholder="e.g. 15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MFE (pips)
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Max Favourable Excursion:</strong> How many pips did price go IN YOUR FAVOUR before the trade ended?<br><br>
                                        If this is much bigger than your actual profit, you might be exiting too early.
                                    </span>
                                </span>
                            </label>
                            <input type="number" class="form-input" id="trade-mfe" step="0.1" placeholder="e.g. 45">
                        </div>
                        <div class="form-group">
                            <label class="form-label">UTCC Score</label>
                            <input type="number" class="form-input" id="trade-trend-score" min="0" max="100" placeholder="0-100">
                        </div>
                    </div>
                </div>
                
                <!-- SECTION F: Post-Trade Review -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">F</span>
                        <span class="journal-section-title">Post-Trade Review</span>
                        <span class="journal-section-badge edge">Edge-Focused</span>
                    </div>
                    
                    <div class="review-question">
                        <p class="review-question-text">Did I lose money because the model failed, or because I failed the model?</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trade Classification</label>
                        <select class="form-select" id="trade-classification">
                            <option value="">Select classification</option>
                            <option value="model-win">Model Win - System worked as designed</option>
                            <option value="model-loss">Model Loss - Valid setup, market moved against</option>
                            <option value="execution-error">Execution Error - Good setup, poor execution</option>
                            <option value="permission-violation">Permission Violation - Should not have traded</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Setup Notes</label>
                        <textarea class="form-textarea" id="trade-notes" placeholder="Why did you take this trade? What was the setup rationale?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lessons / Edge Refinement</label>
                        <textarea class="form-textarea" id="trade-lessons" placeholder="What did you learn? How does this refine your edge?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Screenshot Link</label>
                        <input type="url" class="form-input" id="trade-screenshot" placeholder="https://...">
                    </div>
                </div>
                
                <!-- Hidden fields for backwards compatibility -->
                <input type="hidden" id="trade-alert-type" value="MANUAL">
                <input type="hidden" id="trade-entry-zone" value="">
                <input type="hidden" id="trade-vol-state" value="">
                <input type="hidden" id="trade-mtf" value="">
                <input type="hidden" id="trade-grade" value="">
                
                <button class="btn btn-primary btn-lg mt-md" style="width: 100%;" onclick="saveTrade()">
                    &#x1F4BE; Save Trade
                </button>
            </div>
            
            <!-- Friday Close Warning Banner -->
            <div class="friday-warning-banner" id="friday-warning-banner" style="display: none;">
                <div class="friday-warning-content">
                    <span class="friday-warning-icon">WARNING:</span>
                    <div class="friday-warning-text">
                        <strong>FRIDAY CLOSE WARNING</strong>
                        <span>Review all open positions before weekend. Holding over weekend = increased gap risk.</span>
                    </div>
                    <div class="friday-warning-actions">
                        <button class="btn btn-warning btn-sm" onclick="reviewAllOpenTrades()">Review All</button>
                        <button class="btn btn-secondary btn-sm" onclick="dismissFridayWarning()">Dismiss</button>
                    </div>
                </div>
            </div>
            
            <!-- Active Trade Management Panel -->
            <div class="card mb-lg" id="active-trade-management">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Active Trade Management</h2>
                    <div class="flex gap-sm align-center">
                        <span class="badge badge-info" id="open-positions-count">0 Open</span>
                        <button class="btn btn-secondary btn-sm" onclick="refreshTradeAges()">&#x1F504; Refresh</button>
                    </div>
                </div>
                
                <!-- Exit Protocol Status Summary -->
                <div class="exit-protocol-summary" id="exit-protocol-summary">
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-awaiting-tp1">0</span>
                        <span class="protocol-stat-label">Awaiting TP1</span>
                    </div>
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-at-breakeven">0</span>
                        <span class="protocol-stat-label">At Breakeven</span>
                    </div>
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-trailing">0</span>
                        <span class="protocol-stat-label">Trailing</span>
                    </div>
                    <div class="protocol-stat protocol-stat-warning" id="trades-needing-review-stat">
                        <span class="protocol-stat-value" id="trades-needing-review">0</span>
                        <span class="protocol-stat-label">Need Review</span>
                    </div>
                </div>
                
                <!-- Active Trades List -->
                <div class="active-trades-list" id="active-trades-list">
                    <div class="no-trades-message" id="no-active-trades">
                        <span class="no-trades-icon">&#x1F4CD;</span>
                        <span>No active trades</span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions-bar" id="quick-actions-bar" style="display: none;">
                    <span class="quick-actions-label">Quick Actions:</span>
                    <button class="btn btn-secondary btn-sm" onclick="moveAllToBE()">Move All to BE</button>
                    <button class="btn btn-warning btn-sm" onclick="closeAllAtMarket()">Close All @ Market</button>
                </div>
            </div>
            
            <!-- Trade History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Trade History</h2>
                    <div class="flex gap-sm">
                        <button class="btn btn-sm" style="background:#6b7280;color:#fff;" onclick="bulkDismissTrades()" id="bulk-dismiss-btn" title="Dismiss all ungraded trades as test/legacy">&#x1F5D1; Dismiss Ungraded</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportTrades()">&#x1F4E4; Export CSV</button>
                        <button class="btn btn-danger btn-sm" onclick="clearAllTrades()">&#x1F5D1; Clear All</button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-md mb-md" style="flex-wrap: wrap;">
                    <select class="form-select" id="filter-pair" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Instruments</option>
                        <optgroup label="Forex - Core">
                            <option value="AUDUSD">AUDUSD</option>
                            <option value="USDJPY">USDJPY</option>
                            <option value="EURUSD">EURUSD</option>
                            <option value="GBPUSD">GBPUSD</option>
                            <option value="EURJPY">EURJPY</option>
                            <option value="GBPJPY">GBPJPY</option>
                        </optgroup>
                        <optgroup label="Forex - Crosses">
                            <option value="AUDCAD">AUDCAD</option>
                            <option value="AUDCHF">AUDCHF</option>
                            <option value="AUDJPY">AUDJPY</option>
                            <option value="AUDNZD">AUDNZD</option>
                            <option value="EURAUD">EURAUD</option>
                            <option value="EURCAD">EURCAD</option>
                            <option value="EURGBP">EURGBP</option>
                            <option value="EURNZD">EURNZD</option>
                            <option value="GBPAUD">GBPAUD</option>
                            <option value="GBPCAD">GBPCAD</option>
                            <option value="GBPCHF">GBPCHF</option>
                            <option value="GBPNZD">GBPNZD</option>
                            <option value="CADJPY">CADJPY</option>
                            <option value="CHFJPY">CHFJPY</option>
                            <option value="NZDJPY">NZDJPY</option>
                            <option value="NZDCAD">NZDCAD</option>
                            <option value="NZDCHF">NZDCHF</option>
                            <option value="NZDUSD">NZDUSD</option>
                            <option value="USDCAD">USDCAD</option>
                            <option value="USDCHF">USDCHF</option>
                            <option value="CADCHF">CADCHF</option>
                            <option value="EURCHF">EURCHF</option>
                        </optgroup>
                        <optgroup label="Metals">
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="XAGUSD">XAGUSD</option>
                            <option value="XPTUSD">XPTUSD</option>
                            <option value="XCUUSD">XCUUSD</option>
                        </optgroup>
                        <optgroup label="Energy">
                            <option value="WTICOUSD">WTICOUSD</option>
                            <option value="BCOUSD">BCOUSD</option>
                            <option value="NATGASUSD">NATGASUSD</option>
                        </optgroup>
                        <optgroup label="Indices - US">
                            <option value="US30USD">US30USD</option>
                            <option value="SPX500USD">SPX500USD</option>
                            <option value="NAS100USD">NAS100USD</option>
                            <option value="US2000USD">US2000USD</option>
                        </optgroup>
                        <optgroup label="Indices - Europe">
                            <option value="DE30EUR">DE30EUR</option>
                            <option value="UK100GBP">UK100GBP</option>
                            <option value="FR40EUR">FR40EUR</option>
                            <option value="EU50EUR">EU50EUR</option>
                        </optgroup>
                        <optgroup label="Indices - Asia">
                            <option value="JP225USD">JP225USD</option>
                            <option value="JP225YJPY">JP225YJPY</option>
                            <option value="HK33HKD">HK33HKD</option>
                            <option value="CN50USD">CN50USD</option>
                            <option value="AU200AUD">AU200AUD</option>
                        </optgroup>
                        <optgroup label="Bonds">
                            <option value="USB02YUSD">USB02YUSD</option>
                            <option value="USB05YUSD">USB05YUSD</option>
                            <option value="USB10YUSD">USB10YUSD</option>
                            <option value="USB30YUSD">USB30YUSD</option>
                            <option value="UK10YBGBP">UK10YBGBP</option>
                            <option value="DE10YBEUR">DE10YBEUR</option>
                        </optgroup>
                        <optgroup label="Crypto">
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="MBTCUSD">MBTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="LTCUSD">LTCUSD</option>
                            <option value="BCHUSD">BCHUSD</option>
                        </optgroup>
                    </select>
                    <select class="form-select" id="filter-alert" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Alerts</option>
                        <option value="TRADE_READY">B+</option>
                        <option value="STRONG_BULL">A BULL</option>
                        <option value="STRONG_BEAR">A BEAR</option>
                        <option value="PERFECT_BULL">A+ BULL</option>
                        <option value="PERFECT_BEAR">A+ BEAR</option>
                        <option value="MANUAL">MANUAL</option>
                    </select>
                    <select class="form-select" id="filter-grade" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Grades</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="DIS">Dismissed</option>
                        <option value="none">No Grade</option>
                    </select>
                    <select class="form-select" id="filter-result" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Results</option>
                        <option value="win">Winners</option>
                        <option value="loss">Losers</option>
                        <option value="breakeven">Breakeven</option>
                    </select>
                    <select class="form-select" id="filter-source" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Sources</option>
                        <option value="auto">Auto-Captured</option>
                        <option value="manual">Manual Entry</option>
                    </select>
                </div>
                
                <div class="table-wrapper">
                    <table class="table" id="trade-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Pair</th>
                                <th>Dir</th>
                                <th>Source</th>
                                <th>Alert</th>
                                <th>Grade</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>R-Multiple</th>
                                <th>Score</th>
                                <th>Zone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trade-history-body">
                            <tr>
                                <td colspan="12" class="text-center text-muted">No trades recorded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination placeholder -->
                <div class="flex justify-between items-center mt-md">
                    <span class="text-muted" id="trade-count">0 trades</span>
                    <div class="flex gap-sm">
                        <button class="btn btn-secondary btn-sm" id="prev-page" disabled> Prev</button>
                        <button class="btn btn-secondary btn-sm" id="next-page" disabled>Next &#x2192;</button>
                    </div>
                </div>
            </div>
            
        </section>
        
        <section id="tab-performance" class="tab-content">
            
            <!-- Overall Stats -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Overall Performance</h2>
                    <select class="form-select" id="perf-period" style="width: auto;" onchange="updatePerformanceStats()">
                        <option value="all">All Time</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="perf-total-trades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-win-rate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-avg-r">0.0R</div>
                        <div class="stat-label">Avg R-Multiple</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-expectancy">0.0R</div>
                        <div class="stat-label">Expectancy</div>
                    </div>
                </div>
                
                <div class="grid grid-4 mt-md">
                    <div class="stat-box">
                        <div class="stat-value" id="perf-profit-factor">0.0</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value positive" id="perf-largest-win">0R</div>
                        <div class="stat-label">Largest Win</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value negative" id="perf-largest-loss">0R</div>
                        <div class="stat-label">Largest Loss</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-avg-winner">0R</div>
                        <div class="stat-label">Avg Winner</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance by Session -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Session</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Session</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Best</th>
                                <th>Worst</th>
                            </tr>
                        </thead>
                        <tbody id="session-stats-body">
                            <tr>
                                <td><span class="badge badge-info">Asian</span></td>
                                <td id="sess-asian-trades">0</td>
                                <td id="sess-asian-wr">0%</td>
                                <td id="sess-asian-avg">0R</td>
                                <td id="sess-asian-total">0R</td>
                                <td id="sess-asian-best" class="text-pass">0R</td>
                                <td id="sess-asian-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-warning">London</span></td>
                                <td id="sess-london-trades">0</td>
                                <td id="sess-london-wr">0%</td>
                                <td id="sess-london-avg">0R</td>
                                <td id="sess-london-total">0R</td>
                                <td id="sess-london-best" class="text-pass">0R</td>
                                <td id="sess-london-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-pass">NY</span></td>
                                <td id="sess-ny-trades">0</td>
                                <td id="sess-ny-wr">0%</td>
                                <td id="sess-ny-avg">0R</td>
                                <td id="sess-ny-total">0R</td>
                                <td id="sess-ny-best" class="text-pass">0R</td>
                                <td id="sess-ny-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-perfect">Overlap</span></td>
                                <td id="sess-overlap-trades">0</td>
                                <td id="sess-overlap-wr">0%</td>
                                <td id="sess-overlap-avg">0R</td>
                                <td id="sess-overlap-total">0R</td>
                                <td id="sess-overlap-best" class="text-pass">0R</td>
                                <td id="sess-overlap-worst" class="text-fail">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Performance by Alert Type -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Alert Type</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Alert Type</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Expectancy</th>
                            </tr>
                        </thead>
                        <tbody id="alert-stats-body">
                            <tr>
                                <td><span class="badge badge-trade-ready">B+</span></td>
                                <td id="alert-tr-trades">0</td>
                                <td id="alert-tr-wr">0%</td>
                                <td id="alert-tr-avg">0R</td>
                                <td id="alert-tr-total">0R</td>
                                <td id="alert-tr-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-strong">A</span></td>
                                <td id="alert-strong-trades">0</td>
                                <td id="alert-strong-wr">0%</td>
                                <td id="alert-strong-avg">0R</td>
                                <td id="alert-strong-total">0R</td>
                                <td id="alert-strong-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-perfect-alert">A+</span></td>
                                <td id="alert-perfect-trades">0</td>
                                <td id="alert-perfect-wr">0%</td>
                                <td id="alert-perfect-avg">0R</td>
                                <td id="alert-perfect-total">0R</td>
                                <td id="alert-perfect-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-watch">MANUAL</span></td>
                                <td id="alert-manual-trades">0</td>
                                <td id="alert-manual-wr">0%</td>
                                <td id="alert-manual-avg">0R</td>
                                <td id="alert-manual-total">0R</td>
                                <td id="alert-manual-exp">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Performance by Grade -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Grade</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Grade</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Expectancy</th>
                                <th>Best</th>
                                <th>Worst</th>
                            </tr>
                        </thead>
                        <tbody id="grade-stats-body">
                            <tr>
                                <td><span class="grade-mini-badge grade-aplus">A+</span></td>
                                <td id="grade-aplus-trades">0</td>
                                <td id="grade-aplus-wr">0%</td>
                                <td id="grade-aplus-avg">0R</td>
                                <td id="grade-aplus-total">0R</td>
                                <td id="grade-aplus-exp">0R</td>
                                <td id="grade-aplus-best" class="text-pass">0R</td>
                                <td id="grade-aplus-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-a">A</span></td>
                                <td id="grade-a-trades">0</td>
                                <td id="grade-a-wr">0%</td>
                                <td id="grade-a-avg">0R</td>
                                <td id="grade-a-total">0R</td>
                                <td id="grade-a-exp">0R</td>
                                <td id="grade-a-best" class="text-pass">0R</td>
                                <td id="grade-a-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-b">B</span></td>
                                <td id="grade-b-trades">0</td>
                                <td id="grade-b-wr">0%</td>
                                <td id="grade-b-avg">0R</td>
                                <td id="grade-b-total">0R</td>
                                <td id="grade-b-exp">0R</td>
                                <td id="grade-b-best" class="text-pass">0R</td>
                                <td id="grade-b-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-c">C</span></td>
                                <td id="grade-c-trades">0</td>
                                <td id="grade-c-wr">0%</td>
                                <td id="grade-c-avg">0R</td>
                                <td id="grade-c-total">0R</td>
                                <td id="grade-c-exp">0R</td>
                                <td id="grade-c-best" class="text-pass">0R</td>
                                <td id="grade-c-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-d">D</span></td>
                                <td id="grade-d-trades">0</td>
                                <td id="grade-d-wr">0%</td>
                                <td id="grade-d-avg">0R</td>
                                <td id="grade-d-total">0R</td>
                                <td id="grade-d-exp">0R</td>
                                <td id="grade-d-best" class="text-pass">0R</td>
                                <td id="grade-d-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-d">?</span></td>
                                <td id="grade-none-trades">0</td>
                                <td id="grade-none-wr">0%</td>
                                <td id="grade-none-avg">0R</td>
                                <td id="grade-none-total">0R</td>
                                <td id="grade-none-exp">0R</td>
                                <td id="grade-none-best" class="text-pass">0R</td>
                                <td id="grade-none-worst" class="text-fail">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Grade Performance Summary -->
                <div class="grid grid-3 mt-md">
                    <div class="stat-box" style="border-left: 3px solid var(--color-perfect);">
                        <div class="stat-value" id="grade-best-performer">--</div>
                        <div class="stat-label">Best Performing Grade</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--color-warning);">
                        <div class="stat-value" id="grade-most-traded">--</div>
                        <div class="stat-label">Most Traded Grade</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--color-info);">
                        <div class="stat-value" id="grade-correlation">--</div>
                        <div class="stat-label">Grade-Performance Correlation</div>
                    </div>
                </div>
            </div>
            
            <!-- Losing Trade Analysis -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Losing Trade Analysis</h2>
                </div>
                
                <div class="grid grid-3">
                    <div class="stat-box">
                        <div class="stat-value" id="loss-count">0</div>
                        <div class="stat-label">Total Losses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="loss-avg">0R</div>
                        <div class="stat-label">Avg Loss Size</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="loss-streak">0</div>
                        <div class="stat-label">Max Losing Streak</div>
                    </div>
                </div>
                
                <div class="mt-md">
                    <h4 style="font-size: 0.85rem; margin-bottom: 8px;">Common Loss Patterns</h4>
                    <div id="loss-patterns" class="text-muted" style="font-size: 0.85rem;">
                        No losing trades to analyse yet.
                    </div>
                </div>
            </div>
            
            <!-- AI Insights -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CA; AI Insights</h2>
                    <button class="btn btn-secondary btn-sm" onclick="generateInsights()">&#x1F503; Refresh</button>
                </div>
                
                <div id="ai-insights" class="text-secondary" style="font-size: 0.9rem; line-height: 1.7;">
                    <p>Not enough trade data for insights. Complete at least 10 trades to generate personalised analysis.</p>
                </div>
            </div>
            
            <!-- Export for Claude Review -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4E4; Export for Claude Review</h2>
                </div>
                
                <p class="text-secondary mb-md">Generate a comprehensive report of your trading performance, lessons learned, and system usage. Copy and paste into Claude for coaching, analysis, and suggestions for improving the Command Centre and UTCC system.</p>
                
                <div class="flex gap-md mb-md">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Export Period</label>
                        <select class="form-select" id="export-period">
                            <option value="week">Last 7 Days</option>
                            <option value="month" selected>Last 30 Days</option>
                            <option value="quarter">Last 90 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Include</label>
                        <div class="flex gap-sm" style="flex-wrap: wrap;">
                            <label class="checkbox-label"><input type="checkbox" id="export-trades" checked> Trades</label>
                            <label class="checkbox-label"><input type="checkbox" id="export-lessons" checked> Lessons</label>
                            <label class="checkbox-label"><input type="checkbox" id="export-settings" checked> Settings</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-sm">
                    <button class="btn btn-primary" onclick="generateClaudeExport()">&#x1F4CB; Generate Report</button>
                    <button class="btn btn-secondary" onclick="copyExportToClipboard()" id="copy-export-btn" disabled>&#x1F4CB; Copy to Clipboard</button>
                </div>
                
                <div id="claude-export-preview" class="mt-md" style="display: none;">
                    <label class="form-label">Preview (scroll to review, then copy)</label>
                    <textarea id="claude-export-text" class="form-input" style="height: 400px; font-family: var(--font-heading); font-size: 0.8rem; line-height: 1.5;" readonly></textarea>
                </div>
            </div>
            
        </section>
        
        <section id="tab-reference" class="tab-content">
            
            
            <!-- Asset Class Trading Guides -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CA; Asset Class Trading Guides</h2>
                </div>
                
                <div class="accordion">
                    
                    <!-- METALS GUIDE -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x1F947; Metals (XAUUSD, XAGUSD, XPTUSD, XCUUSD)</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md">
                                <h4>What Moves Metals</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>USD strength/weakness:</strong> Inverse correlation (USD up = metals down)</li>
                                    <li><strong>Real interest rates:</strong> Higher real rates = bearish gold (opportunity cost)</li>
                                    <li><strong>Risk sentiment:</strong> Gold/silver as safe havens during fear</li>
                                    <li><strong>Inflation expectations:</strong> Hedge against currency debasement</li>
                                    <li><strong>Central bank buying:</strong> Structural demand from China, Russia, etc.</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Best Trading Sessions (AEST)</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Session</th><th>AEST</th><th>Quality</th></tr></thead>
                                        <tbody>
                                            <tr><td>London Open</td><td>5:00 PM - 7:00 PM</td><td style="color: var(--color-warning);">High volatility, trend starts</td></tr>
                                            <tr><td>London/NY Overlap</td><td>11:00 PM - 2:00 AM</td><td style="color: var(--color-pass);">Best liquidity, strongest moves</td></tr>
                                            <tr><td>NY Session</td><td>11:00 PM - 7:00 AM</td><td style="color: var(--color-info);">USD data releases</td></tr>
                                            <tr><td>Asian Session</td><td>9:00 AM - 5:00 PM</td><td style="color: var(--text-muted);">Lower volatility, consolidation</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Correlations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>XAUUSD vs DXY:</strong> Strong inverse (-0.8 typical)</li>
                                    <li><strong>XAUUSD vs US10Y:</strong> Inverse (yields up = gold down)</li>
                                    <li><strong>XAGUSD vs XAUUSD:</strong> High positive (silver follows gold, 2-3x more volatile)</li>
                                    <li><strong>XCUUSD:</strong> Industrial metal - follows risk sentiment, China demand</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Risk Considerations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li>Gold can gap significantly on geopolitical events</li>
                                    <li>Silver is 2-3x more volatile than gold (wider stops needed)</li>
                                    <li>Platinum/Copper are industrial - follow economic cycle</li>
                                    <li>FOMC and NFP create large moves in gold</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">UTCC Calibration</h5>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Metal</th><th>ATR Filter</th><th>ADX Threshold</th><th>Entry HOT</th></tr></thead>
                                        <tbody>
                                            <tr><td>Gold</td><td>70%</td><td>18</td><td>0.3 ATR</td></tr>
                                            <tr><td>Silver</td><td>60%</td><td>16</td><td>0.4 ATR</td></tr>
                                            <tr><td>Platinum</td><td>55%</td><td>15</td><td>0.5 ATR</td></tr>
                                            <tr><td>Copper</td><td>50%</td><td>14</td><td>0.5 ATR</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ENERGY GUIDE -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x1F6E2; Energy (WTICOUSD, BCOUSD, NATGASUSD)</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md">
                                <h4>What Moves Energy</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>Supply/demand balance:</strong> OPEC+ decisions, US shale production</li>
                                    <li><strong>Inventory data:</strong> EIA weekly report (Wednesday)</li>
                                    <li><strong>Geopolitics:</strong> Middle East tensions, Russia sanctions</li>
                                    <li><strong>USD strength:</strong> Oil priced in USD globally</li>
                                    <li><strong>Economic growth:</strong> Demand proxy for global activity</li>
                                    <li><strong>Weather:</strong> NatGas especially (heating/cooling demand)</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Best Trading Sessions (AEST)</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Session</th><th>AEST</th><th>Quality</th></tr></thead>
                                        <tbody>
                                            <tr><td>NYMEX Open</td><td>11:30 PM</td><td style="color: var(--color-warning);">Initial volatility</td></tr>
                                            <tr><td>EIA Report</td><td>Wed ~12:30 AM</td><td style="color: var(--color-fail);">HIGH IMPACT - 4h buffer</td></tr>
                                            <tr><td>NYMEX Core</td><td>11:30 PM - 5:00 AM</td><td style="color: var(--color-pass);">Best liquidity</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md" style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-fail);">
                                <h4 style="color: var(--color-fail); margin-bottom: 8px;">WARNING: Key Events - NO ENTRY ZONES</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>EIA Crude Inventory:</strong> Wednesday ~12:30 AM AEST (4h buffer mandatory)</li>
                                    <li><strong>API Report:</strong> Tuesday evening (preview, less impact)</li>
                                    <li><strong>OPEC+ Meetings:</strong> Check calendar - massive impact</li>
                                    <li><strong>Baker Hughes Rig Count:</strong> Friday evening</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Correlations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>WTI vs Brent:</strong> Very high positive (~0.95) - trade one, not both</li>
                                    <li><strong>Oil vs AUD/CAD:</strong> Commodity currencies follow oil</li>
                                    <li><strong>NatGas:</strong> More independent - weather driven</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Risk Considerations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li>Monday gaps common (weekend geopolitics)</li>
                                    <li>EIA day = avoid new entries 4h before</li>
                                    <li>NatGas is extremely volatile - reduce position size to 1% max</li>
                                    <li>Brent typically trades at premium to WTI</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">UTCC Calibration</h5>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Energy</th><th>ATR Filter</th><th>ADX Threshold</th><th>Entry HOT</th></tr></thead>
                                        <tbody>
                                            <tr><td>WTI/Brent</td><td>55%</td><td>17</td><td>0.5 ATR</td></tr>
                                            <tr><td>NatGas</td><td>40%</td><td>14</td><td>0.8 ATR</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- INDICES GUIDE -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x1F4C8; Indices (13 Instruments)</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md">
                                <h4>Your Tradeable Indices</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 0.85rem;">
                                    <div><strong>US:</strong> US30USD, SPX500USD, NAS100USD, US2000USD</div>
                                    <div><strong>Europe:</strong> DE30EUR, UK100GBP, FR40EUR, EU50EUR</div>
                                    <div><strong>Asia/Pacific:</strong> JP225USD, JP225YJPY, HK33HKD, CN50USD, AU200AUD</div>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>What Moves Indices</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>Central bank policy:</strong> Fed, ECB, BOJ, BOE decisions</li>
                                    <li><strong>Earnings season:</strong> Quarterly corporate results</li>
                                    <li><strong>Economic data:</strong> GDP, employment, PMI</li>
                                    <li><strong>Risk sentiment:</strong> Risk-on = indices up</li>
                                    <li><strong>Bond yields:</strong> Rising yields can pressure equities</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Best Trading Sessions (AEST)</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Index Group</th><th>Best Session</th><th>AEST</th></tr></thead>
                                        <tbody>
                                            <tr><td>US (US30, SPX500, NAS100)</td><td>NY Session</td><td>11:30 PM - 6:00 AM</td></tr>
                                            <tr><td>European (DE30, UK100, FR40)</td><td>London</td><td>5:00 PM - 1:30 AM</td></tr>
                                            <tr><td>Asian (JP225, HK33, CN50)</td><td>Tokyo/HK</td><td>10:00 AM - 4:00 PM</td></tr>
                                            <tr><td>AU200</td><td>ASX Session</td><td>10:00 AM - 4:00 PM</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Index Characteristics</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Index</th><th>Volatility</th><th>Character</th></tr></thead>
                                        <tbody>
                                            <tr><td>US30 (Dow)</td><td style="color: var(--color-warning);">Medium</td><td>30 blue chips, price-weighted</td></tr>
                                            <tr><td>SPX500</td><td style="color: var(--color-warning);">Medium</td><td>Broad market, most watched</td></tr>
                                            <tr><td>NAS100</td><td style="color: var(--color-fail);">High</td><td>Tech-heavy, volatile</td></tr>
                                            <tr><td>US2000</td><td style="color: var(--color-fail);">High</td><td>Small caps, risk proxy</td></tr>
                                            <tr><td>DE30 (DAX)</td><td style="color: var(--color-fail);">High</td><td>Export-heavy, volatile</td></tr>
                                            <tr><td>UK100 (FTSE)</td><td style="color: var(--color-warning);">Medium</td><td>Commodity/financial heavy</td></tr>
                                            <tr><td>JP225</td><td style="color: var(--color-warning);">Medium</td><td>BOJ sensitive, yen inverse</td></tr>
                                            <tr><td>HK33/CN50</td><td style="color: var(--color-fail);">High</td><td>China policy sensitive</td></tr>
                                            <tr><td>AU200</td><td style="color: var(--color-warning);">Medium</td><td>Mining/banks heavy</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Correlations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>US indices:</strong> High correlation (0.85+) - don't overexpose</li>
                                    <li><strong>SPX500 vs NAS100:</strong> NAS leads in risk-on, lags in risk-off</li>
                                    <li><strong>DAX vs SPX500:</strong> Follows US but European hours</li>
                                    <li><strong>AU200 vs China:</strong> Mining exposure link</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">Risk Note</h5>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0;">US indices gap on major earnings (AAPL, MSFT, NVDA). FOMC creates large moves across ALL indices. Avoid holding unhedged through these events.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BONDS GUIDE -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x1F4B5; Bonds (6 Instruments)</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md" style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-info);">
                                <h4 style="color: var(--color-info); margin-bottom: 8px;">&#x1F4A1; Understanding Bond Pricing</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>Price UP = Yield DOWN</strong> (inverse relationship)</li>
                                    <li>Long bond position = betting yields will fall</li>
                                    <li>Short bond position = betting yields will rise</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Your Bond Instruments</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Symbol</th><th>Bond</th><th>Duration</th><th>Sensitivity</th></tr></thead>
                                        <tbody>
                                            <tr><td>USB02YUSD</td><td>US 2-Year</td><td>Short</td><td>Fed policy, front-end</td></tr>
                                            <tr><td>USB05YUSD</td><td>US 5-Year</td><td>Medium</td><td>Balanced</td></tr>
                                            <tr><td>USB10YUSD</td><td>US 10-Year</td><td>Long</td><td>Benchmark, most watched</td></tr>
                                            <tr><td>USB30YUSD</td><td>US 30-Year</td><td>Very Long</td><td>Most volatile</td></tr>
                                            <tr><td>UK10YBGBP</td><td>UK 10-Year Gilt</td><td>Long</td><td>BOE policy</td></tr>
                                            <tr><td>DE10YBEUR</td><td>German 10-Year Bund</td><td>Long</td><td>ECB policy</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>What Moves Bonds</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>Interest rate expectations:</strong> Fed/ECB/BOE policy outlook</li>
                                    <li><strong>Inflation data:</strong> CPI, PCE releases - massive impact</li>
                                    <li><strong>Risk sentiment:</strong> Flight to safety = bonds up (yields down)</li>
                                    <li><strong>Supply (auctions):</strong> Treasury/Gilt/Bund auction results</li>
                                    <li><strong>Central bank guidance:</strong> Forward guidance shifts</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md" style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-fail);">
                                <h4 style="color: var(--color-fail); margin-bottom: 8px;">WARNING: High Impact Events</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Event</th><th>AEST</th><th>Impact</th></tr></thead>
                                        <tbody>
                                            <tr><td>US CPI/NFP</td><td>10:30 PM</td><td style="color: var(--color-fail);">Massive moves - 4h buffer</td></tr>
                                            <tr><td>FOMC Decision</td><td>6:00 AM</td><td style="color: var(--color-fail);">Trend setter - avoid</td></tr>
                                            <tr><td>Treasury Auctions</td><td>Varies</td><td style="color: var(--color-warning);">Supply impact</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Key Relationships</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>2Y vs 10Y spread:</strong> Yield curve (inversion = recession signal)</li>
                                    <li><strong>US10Y vs Gold:</strong> Inverse (yields up = gold down)</li>
                                    <li><strong>US10Y vs USD:</strong> Generally positive</li>
                                    <li><strong>Bund vs Treasury:</strong> Spread trades on policy divergence</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">UTCC Calibration</h5>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Duration</th><th>ATR Filter</th><th>Character</th></tr></thead>
                                        <tbody>
                                            <tr><td>Short (2Y)</td><td>45%</td><td>Fed sensitive, less volatile</td></tr>
                                            <tr><td>Medium (5Y)</td><td>50%</td><td>Balanced</td></tr>
                                            <tr><td>Long (10Y+)</td><td>55%</td><td>More volatile, trend following</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CRYPTO GUIDE -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x20BF; Crypto (BTCUSD, ETHUSD, BCHUSD, LTCUSD, MBTCUSD)</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md">
                                <h4>What Moves Crypto</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>Bitcoin dominance:</strong> BTC leads, alts follow</li>
                                    <li><strong>Risk sentiment:</strong> Correlates with tech/growth stocks</li>
                                    <li><strong>Regulatory news:</strong> SEC, government actions</li>
                                    <li><strong>Institutional flows:</strong> ETF inflows/outflows</li>
                                    <li><strong>Halving cycles:</strong> ~4 year BTC supply reduction</li>
                                    <li><strong>Exchange events:</strong> Hacks, delistings, liquidity issues</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Trading Sessions (24/7 Market)</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Period</th><th>AEST</th><th>Quality</th></tr></thead>
                                        <tbody>
                                            <tr><td>US Session</td><td>11:00 PM - 7:00 AM</td><td style="color: var(--color-pass);">Highest volume, best setups</td></tr>
                                            <tr><td>European</td><td>5:00 PM - 1:00 AM</td><td style="color: var(--color-info);">Good liquidity</td></tr>
                                            <tr><td>Asian</td><td>9:00 AM - 5:00 PM</td><td style="color: var(--text-muted);">Often consolidation</td></tr>
                                            <tr><td>Weekend</td><td>All day</td><td style="color: var(--color-warning);">Reduced liquidity, wider spreads</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Instrument Notes</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Symbol</th><th>What It Is</th><th>Notes</th></tr></thead>
                                        <tbody>
                                            <tr><td>BTCUSD</td><td>Bitcoin</td><td>Market leader - primary trading instrument</td></tr>
                                            <tr><td>MBTCUSD</td><td>Micro Bitcoin</td><td>Smaller position sizing option</td></tr>
                                            <tr><td>ETHUSD</td><td>Ethereum</td><td>Tech/DeFi proxy, more volatile than BTC</td></tr>
                                            <tr><td>LTCUSD</td><td>Litecoin</td><td>"Silver to BTC's gold"</td></tr>
                                            <tr><td>BCHUSD</td><td>Bitcoin Cash</td><td>BTC fork, follows BTC</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Correlations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li><strong>BTC vs ETH:</strong> High (0.8+) but ETH more volatile</li>
                                    <li><strong>BTC vs NAS100:</strong> Moderate positive (risk asset)</li>
                                    <li><strong>Altcoins vs BTC:</strong> Follow with leverage (both ways)</li>
                                    <li><strong>Crypto vs USD:</strong> Generally inverse</li>
                                </ul>
                            </div>
                            
                            <div class="mb-md" style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-fail);">
                                <h4 style="color: var(--color-fail); margin-bottom: 8px;">WARNING: Risk Considerations</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li>24/7 market = no daily close, can't "sleep easy"</li>
                                    <li>Weekend liquidity drops - gaps possible Monday</li>
                                    <li>News-driven moves can be extreme (50%+ in days)</li>
                                    <li>No circuit breakers - can move indefinitely</li>
                                    <li>Regulatory headlines create instant volatility</li>
                                    <li><strong>Position size: 1% max recommended</strong></li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">UTCC Calibration</h5>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Crypto</th><th>ATR Filter</th><th>ADX Threshold</th><th>Entry HOT</th></tr></thead>
                                        <tbody>
                                            <tr><td>BTC/BCH/LTC</td><td>40%</td><td>14</td><td>0.8 ATR</td></tr>
                                            <tr><td>ETH</td><td>35%</td><td>13</td><td>1.0 ATR</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                                    <strong>Crypto Rules:</strong> US Session only for best setups. Reduce size on weekends. BTC is the benchmark. No scheduled news - sentiment driven.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TRADE DEGRADATION PROTOCOL -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>WARNING: Trade Degradation Protocol</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md" style="background: rgba(234, 179, 8, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-warning);">
                                <h4 style="color: var(--color-warning); margin-bottom: 8px;">&#x1F4A1; The Three-Option Mindset</h4>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px;">You have THREE options in every trade, not two:</p>
                                <ol style="margin-left: 20px; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
                                    <li><strong>TP hit</strong> - planned profit</li>
                                    <li><strong>SL hit</strong> - planned loss</li>
                                    <li><strong>Managed exit</strong> - setup invalidates, exit at BE or small loss/gain</li>
                                </ol>
                                <p style="font-size: 0.85rem; color: var(--color-warning); margin-top: 8px; margin-bottom: 0;"><strong>Option 3 is what separates professionals from gamblers.</strong></p>
                            </div>
                            
                            <div class="mb-md">
                                <h4>What is Trade Degradation?</h4>
                                <p style="font-size: 0.85rem; color: var(--text-secondary);">When the conditions that justified your entry no longer exist, the trade has "degraded." You entered a specific setup - when that setup breaks down, you're now in a <em>different</em> trade than the one you planned.</p>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Degradation Warning Signs</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Signal</th><th>Severity</th><th>Meaning</th></tr></thead>
                                        <tbody>
                                            <tr><td>1H direction flips</td><td style="color: var(--color-warning);">WARNING</td><td>Early alert - monitor closely</td></tr>
                                            <tr><td>1H goes to Mix</td><td style="color: var(--color-warning);">WARNING</td><td>Momentum stalling</td></tr>
                                            <tr><td>4H score drops below 75</td><td style="color: var(--color-fail);">SERIOUS</td><td>Setup weakening</td></tr>
                                            <tr><td>4H direction flips to Mix</td><td style="color: var(--color-fail);">CRITICAL</td><td>Original setup NO LONGER EXISTS</td></tr>
                                            <tr><td>MTF alignment breaks (3/3 to 2/3)</td><td style="color: var(--color-fail);">CRITICAL</td><td>Higher TF support gone</td></tr>
                                            <tr><td>Price stalls at entry after profit</td><td style="color: var(--color-warning);">ALERT</td><td>Momentum exhausted</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Decision Framework</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Scenario</th><th>Action</th></tr></thead>
                                        <tbody>
                                            <tr><td>1H flips against, 4H/Daily hold strong</td><td>Monitor closely, keep stop at original level</td></tr>
                                            <tr><td>1H flips + price stalls at key level</td><td>Consider partial profit or trail stop</td></tr>
                                            <tr><td>1H flips + 4H starts weakening/goes Mix</td><td style="color: var(--color-fail);"><strong>Strong exit signal - don't wait for stop</strong></td></tr>
                                            <tr><td>4H goes Mix while 1H against you</td><td style="color: var(--color-fail);"><strong>Managed exit protocol - act now</strong></td></tr>
                                            <tr><td>All three timeframes flip against you</td><td style="color: var(--color-fail);">You missed your exit window</td></tr>
                                            <tr><td>Price returns to entry after showing profit</td><td style="color: var(--color-warning);">Breakeven exit opportunity</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>The Protocol Step-by-Step</h4>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                    <h5 style="margin-bottom: 8px; color: var(--color-warning);">Step 1: 1H Flips Against Your Position</h5>
                                    <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                        <li>This is a WARNING, not an exit command</li>
                                        <li>Immediately check the 4H score and direction</li>
                                        <li>Monitor price action at nearby S/R levels</li>
                                        <li>Do NOT panic exit on 1H alone</li>
                                    </ul>
                                </div>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                                    <h5 style="margin-bottom: 8px; color: var(--color-fail);">Step 2: 4H Drops to Mix (While 1H Against You)</h5>
                                    <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                        <li><strong>The original setup NO LONGER EXISTS</strong></li>
                                        <li>You are now in a <em>different</em> trade than the one you entered</li>
                                        <li>Managed exit options:
                                            <ul style="margin-left: 20px; margin-top: 4px;">
                                                <li>Exit at breakeven if price returns to entry</li>
                                                <li>Take partial profits if in profit</li>
                                                <li>Trail stop aggressively to lock in gains</li>
                                                <li><strong>Do NOT wait passively for full SL hit</strong></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                                <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                    <h5 style="margin-bottom: 8px; color: var(--color-info);">Step 3: Price Stalls at Entry After Profit</h5>
                                    <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                        <li>Combined with degraded MTF = clear exit signal</li>
                                        <li>Momentum is gone</li>
                                        <li>The market is telling you the move is done</li>
                                        <li>Exit and reassess</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mb-md" style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; border-left: 3px solid var(--color-fail);">
                                <h4 style="color: var(--color-fail); margin-bottom: 8px;">&#x1F4A5; Real Example (Learn From This)</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li>Long position entered with all 5 criteria aligned</li>
                                    <li>1H flipped Mix, then Bear - warning observed but not acted on</li>
                                    <li>4H dropped to Mix - setup invalidated, still not acted on</li>
                                    <li>Price rallied halfway to TP, then stalled at entry</li>
                                    <li>Overnight reversal hit full SL</li>
                                </ul>
                                <p style="font-size: 0.85rem; color: var(--color-fail); margin-top: 8px; margin-bottom: 0;"><strong>What should have happened:</strong> When 4H went Mix while 1H was bearish, managed exit protocol should have triggered. Exit at breakeven or small loss - NOT full SL.</p>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Alerts to Set for Open Trades</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Alert</th><th>Trigger</th><th>What To Do</th></tr></thead>
                                        <tbody>
                                            <tr><td>1H Direction Flip</td><td>1H changes from trade direction to Mix/Opposite</td><td>Go to alert mode, watch 4H</td></tr>
                                            <tr><td>4H Score Drop</td><td>4H score drops below 75</td><td>Assess managed exit</td></tr>
                                            <tr><td>4H Direction Flip</td><td>4H goes to Mix</td><td style="color: var(--color-fail);"><strong>Managed exit protocol</strong></td></tr>
                                            <tr><td>Price at Entry</td><td>Price returns to entry after profit</td><td>Potential BE exit point</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Asset-Specific Degradation Notes</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Asset Class</th><th>Degradation Speed</th><th>Notes</th></tr></thead>
                                        <tbody>
                                            <tr><td>Forex</td><td>Moderate</td><td>Standard protocol applies</td></tr>
                                            <tr><td>Crypto</td><td style="color: var(--color-fail);">Fast</td><td>24/7 means faster degradation cycles</td></tr>
                                            <tr><td>Indices</td><td>Session-dependent</td><td>Can degrade quickly on news</td></tr>
                                            <tr><td>Energy</td><td style="color: var(--color-fail);">Event-driven</td><td>EIA can instantly degrade setup</td></tr>
                                            <tr><td>Metals</td><td>USD-driven</td><td>Watch DXY for early degradation signals</td></tr>
                                            <tr><td>Bonds</td><td style="color: var(--color-fail);">Data-driven</td><td>CPI/FOMC = instant setup change</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">&#x1F3AF; Key Insight</h5>
                                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">The 1H gives you EARLY WARNING, not exit commands. The 4H is your anchor - when the 4H starts agreeing with the 1H reversal, that's your real signal to act.</p>
                                <p style="font-size: 0.85rem; color: var(--color-pass); margin: 0;"><strong>Full SL hits should be rare exceptions, not the norm.</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- POSITION SIZING BY ASSET CLASS -->
                    <div class="accordion-item">
                        <button class="accordion-header" onclick="toggleAccordion(this)">
                            <span>&#x1F4B0; Position Sizing by Asset Class</span>
                            <span class="accordion-icon">&#x25BC;</span>
                        </button>
                        <div class="accordion-content">
                            <div class="mb-md">
                                <h4>Recommended Risk Per Trade</h4>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.85rem;">
                                        <thead><tr><th>Asset Class</th><th>Standard Risk</th><th>Reasoning</th></tr></thead>
                                        <tbody>
                                            <tr><td>Forex</td><td style="color: var(--color-pass);">1.5-2%</td><td>Core, most experience</td></tr>
                                            <tr><td>Metals</td><td style="color: var(--color-info);">1.5%</td><td>Higher volatility than forex</td></tr>
                                            <tr><td>Energy</td><td style="color: var(--color-warning);">1%</td><td>Event risk (EIA), gaps</td></tr>
                                            <tr><td>Indices</td><td style="color: var(--color-info);">1.5%</td><td>Correlated to forex sentiment</td></tr>
                                            <tr><td>Bonds</td><td style="color: var(--color-warning);">1%</td><td>CPI/FOMC sensitivity</td></tr>
                                            <tr><td>Crypto</td><td style="color: var(--color-fail);">1% max</td><td>Extreme volatility, 24/7 risk</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="mb-md">
                                <h4>Cross-Asset Correlation Management</h4>
                                <ul style="margin-left: 20px; color: var(--text-secondary); font-size: 0.85rem; line-height: 1.8;">
                                    <li>Maximum 2 correlated positions across ALL asset classes</li>
                                    <li>US indices + NAS100 + crypto = triple risk-on exposure</li>
                                    <li>Gold long + USD short forex = similar directional bet</li>
                                    <li>Check cross-asset correlation before adding positions</li>
                                </ul>
                            </div>
                            
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px;">
                                <h5 style="margin-bottom: 8px;">News Buffer Rules (All Assets)</h5>
                                <div class="table-wrapper">
                                    <table class="table" style="font-size: 0.8rem;">
                                        <thead><tr><th>Impact</th><th>Buffer</th><th>Action</th></tr></thead>
                                        <tbody>
                                            <tr><td style="color: var(--color-fail);">High</td><td>4 hours</td><td>No new entries</td></tr>
                                            <tr><td style="color: var(--color-warning);">Medium</td><td>2 hours</td><td>Reduce to 1% risk</td></tr>
                                            <tr><td>Scheduled reports</td><td>See calendar</td><td>Plan around</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
        </section>
        
        <section id="tab-settings" class="tab-content">
            
            <!-- Theme Settings -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Appearance</h2>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <div class="flex gap-md">
                        <button class="btn btn-secondary" id="theme-dark-btn" onclick="setTheme('dark')">&#x1F319; Dark</button>
                        <button class="btn btn-secondary" id="theme-light-btn" onclick="setTheme('light')">&#x2600; Light</button>
                    </div>
                </div>
            </div>
            
            <!-- Account Settings -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Account Settings</h2>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Account Balance (AUD)</label>
                        <input type="number" class="form-input" id="settings-balance" value="2000" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peak Balance (AUD)</label>
                        <input type="number" class="form-input" id="settings-peak" value="2000" step="0.01">
                        <span class="text-muted" style="font-size: 0.75rem;">For drawdown calculation</span>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Default Risk %</label>
                        <select class="form-select" id="settings-risk">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="1.5" selected>1.5%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="settings-currency">
                            <option value="AUD" selected>AUD</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary mt-md" onclick="saveSettings()">&#x1F4BE; Save Settings</button>
            </div>
            
            <!-- Broker Connection (rendered by broker-ui.js) -->
            <div id="broker-status-panel" class="mb-lg"></div>
            
            <!-- Server Storage -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4BE; Server Storage</h2>
                    <div id="server-storage-status">
                        <span class="badge">Local Only</span>
                    </div>
                </div>
                
                <p class="text-muted mb-md" style="font-size: 0.85rem;">
                    Sync your data to the server for backup and cross-device access.
                </p>
                
                <div class="grid grid-2 mb-md">
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Last Save:</strong> <span id="server-last-save">Never</span></p>
                        <p style="font-size: 0.85rem;"><strong>Last Load:</strong> <span id="server-last-load">Never</span></p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Server:</strong> <span id="server-url">forex.pineros.club</span></p>
                        <p style="font-size: 0.85rem;"><strong>Status:</strong> <span id="server-status">Unknown</span></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-sm">
                        <input type="checkbox" id="server-auto-save" checked>
                        Auto-save every 60 seconds
                    </label>
                </div>
                
                <div class="flex gap-md">
                    <button class="btn btn-primary" onclick="serverStorageSave()">&#x1F4BE; Save to Server</button>
                    <button class="btn btn-secondary" onclick="serverStorageLoad()">&#x1F4E5; Load from Server</button>
                </div>
                
                <div id="server-storage-message" class="mt-md" style="display: none;"></div>
            </div>
            
            <!-- Data Management -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Data Management</h2>
                </div>
                
                <div class="flex gap-md" style="flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportAllData()">&#x1F4E4; Export All Data (JSON)</button>
                    <label class="btn btn-secondary" style="cursor: pointer;">
                        &#x1F525; Import Data
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                </div>
                
                <div class="mt-lg" style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid var(--color-fail);">
                    <h4 style="color: var(--color-fail); margin-bottom: 8px;">WARNING: Danger Zone</h4>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">This action cannot be undone. All trades, scans, and settings will be permanently deleted.</p>
                    <button class="btn btn-danger" onclick="clearAllData()">&#x1F5D1; Clear All Data</button>
                </div>
            </div>
            
            <!-- System Info -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Information</h2>
                </div>
                
                <div class="grid grid-2">
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Version:</strong> 2.6.0</p>
                        <p style="font-size: 0.85rem;"><strong>Indicator:</strong> UTCC v2.5</p>
                        <p style="font-size: 0.85rem;"><strong>Broker:</strong> Oanda</p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Storage Used:</strong> <span id="storage-used">0 KB</span></p>
                        <p style="font-size: 0.85rem;"><strong>Trades Logged:</strong> <span id="trades-logged">0</span></p>
                        <p style="font-size: 0.85rem;"><strong>Last Backup:</strong> <span id="last-backup">Never</span></p>
                    </div>
                </div>
            </div>
            
        </section>
        
        <!-- ==========================================
             TAB: TRADE GUIDE (NEW)
             ========================================== -->
        
    </main>

    <!-- ============================================
         FLOATING ACTION BUTTONS
         ============================================ -->
    <a href="https://www.forexfactory.com/calendar" target="_blank" class="fab-calendar" title="Forex Factory Calendar">
        &#x1F4C5;
    </a>
    <button class="fab" id="fab-active-trades" onclick="scrollToActiveTrades()" title="Active Trades">
        &#x1F4CA;
        <span class="fab-trade-count zero" id="fab-trade-count">0</span>
    </button>

    <!-- ============================================
         JAVASCRIPT - FOREX TRADING COMMAND CENTRE
         ============================================ -->
    <script>
        // ============================================
        // CHUNK 1: CORE STATE & UTILITIES
        // ============================================

        // Application State
        const APP_VERSION = '2.7.0';
        const STORAGE_KEYS = {
            trades: 'ftcc_trades',
            scans: 'ftcc_scans',
            settings: 'ftcc_settings',
            theme: 'ftcc_theme',
            goals: 'ftcc_goals',
            lastBackup: 'ftcc_last_backup'
        };

        // Default Settings
        const DEFAULT_SETTINGS = {
            accountBalance: 2000,
            peakBalance: 2000,
            defaultRisk: 1.5,
            currency: 'AUD',
            autoSave: true,
            backupReminder: 7 // days
        };

        // Core Pairs & Rotation Pairs
        const CORE_PAIRS = ['AUDUSD', 'USDJPY', 'EURUSD'];
        const ROTATION_PAIRS = ['GBPUSD', 'EURJPY', 'GBPJPY', 'AUDJPY', 'NZDJPY', 'NZDUSD', 'USDCAD', 'USDCHF', 'EURGBP'];
        const ALL_PAIRS = [...CORE_PAIRS, ...ROTATION_PAIRS];

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function formatCurrency(amount, currency = 'AUD') {
            return new Intl.NumberFormat('en-AU', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num, decimals = 2) {
            return Number(num).toFixed(decimals);
        }

        function formatDate(date, format = 'short') {
            const d = new Date(date);
            if (format === 'short') {
                return d.toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit', year: '2-digit' });
            }
            return d.toLocaleDateString('en-AU', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatDateTime(date) {
            const d = new Date(date);
            return d.toLocaleDateString('en-AU', { 
                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getWeekRange(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(d.setDate(diff));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: monday, end: sunday };
        }

        function isThisWeek(date) {
            const { start, end } = getWeekRange();
            const d = new Date(date);
            return d >= start && d <= end;
        }

        // ============================================
        // LOCAL STORAGE FUNCTIONS
        // ============================================

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Storage save error:', e);
                showToast('Storage error - data may not be saved', 'error');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error('Storage load error:', e);
                return defaultValue;
            }
        }

        function getStorageSize() {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
                }
            }
            return (total / 1024).toFixed(2) + ' KB';
        }

        // ============================================
        // SETTINGS MANAGEMENT
        // ============================================

        function loadSettings() {
            const saved = loadFromStorage(STORAGE_KEYS.settings, DEFAULT_SETTINGS);
            const settings = { ...DEFAULT_SETTINGS, ...saved };
            
            // Apply to UI
            const balanceInput = document.getElementById('settings-balance');
            const peakInput = document.getElementById('settings-peak');
            const riskSelect = document.getElementById('settings-risk');
            const currencySelect = document.getElementById('settings-currency');
            
            if (balanceInput) balanceInput.value = settings.accountBalance;
            if (peakInput) peakInput.value = settings.peakBalance;
            if (riskSelect) riskSelect.value = settings.defaultRisk;
            if (currencySelect) currencySelect.value = settings.currency;
            
            return settings;
        }

        function saveSettings() {
            const settings = {
                accountBalance: parseFloat(document.getElementById('settings-balance')?.value) || 2000,
                peakBalance: parseFloat(document.getElementById('settings-peak')?.value) || 2000,
                defaultRisk: parseFloat(document.getElementById('settings-risk')?.value) || 1.5,
                currency: document.getElementById('settings-currency')?.value || 'AUD',
                autoSave: true,
                backupReminder: 7
            };
            
            saveToStorage(STORAGE_KEYS.settings, settings);
            showToast('Settings saved successfully', 'success');
            
            // Update dashboard
            updateDashboard();
            updateSystemInfo();
        }

        function getSettings() {
            return loadFromStorage(STORAGE_KEYS.settings, DEFAULT_SETTINGS);
        }

        // ============================================
        // SERVER STORAGE UI FUNCTIONS
        // ============================================

        function serverStorageSave() {
            showServerMessage('Saving to server...', 'info');
            
            if (typeof ServerStorage !== 'undefined') {
                ServerStorage.saveAll().then(result => {
                    if (result.success) {
                        showServerMessage('Saved successfully!', 'success');
                        updateServerStorageStatus();
                    } else {
                        showServerMessage('Save failed: ' + (result.error || 'Unknown error'), 'error');
                    }
                }).catch(err => {
                    showServerMessage('Save error: ' + err.message, 'error');
                });
            } else {
                showServerMessage('ServerStorage not loaded', 'error');
            }
        }

        function serverStorageLoad() {
            if (!confirm('Load from server? This will replace your current local data.')) {
                return;
            }
            
            showServerMessage('Loading from server...', 'info');
            
            if (typeof ServerStorage !== 'undefined') {
                ServerStorage.loadAll().then(result => {
                    if (result.success) {
                        showServerMessage('Loaded successfully! Refreshing...', 'success');
                        updateServerStorageStatus();
                        // Refresh UI
                        setTimeout(() => {
                            loadSettings();
                            loadTrades();
                            updateDashboard();
                        }, 500);
                    } else {
                        showServerMessage('Load failed: ' + (result.error || 'Unknown error'), 'error');
                    }
                }).catch(err => {
                    showServerMessage('Load error: ' + err.message, 'error');
                });
            } else {
                showServerMessage('ServerStorage not loaded', 'error');
            }
        }

        function showServerMessage(message, type) {
            const msgEl = document.getElementById('server-storage-message');
            if (!msgEl) return;
            
            const colors = {
                success: 'var(--color-pass)',
                error: 'var(--color-fail)',
                warning: 'var(--color-warning)',
                info: 'var(--color-info)'
            };
            
            msgEl.style.display = 'block';
            msgEl.style.padding = '8px 12px';
            msgEl.style.borderRadius = '4px';
            msgEl.style.background = type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 
                                     type === 'success' ? 'rgba(34, 197, 94, 0.1)' : 
                                     'rgba(59, 130, 246, 0.1)';
            msgEl.style.color = colors[type] || colors.info;
            msgEl.textContent = message;
            
            if (type !== 'info') {
                setTimeout(() => { msgEl.style.display = 'none'; }, 5000);
            }
        }

        function updateServerStorageStatus() {
            const lastSave = localStorage.getItem('ftcc_server_last_save');
            const lastLoad = localStorage.getItem('ftcc_server_last_load');
            
            const saveEl = document.getElementById('server-last-save');
            const loadEl = document.getElementById('server-last-load');
            const statusEl = document.getElementById('server-storage-status');
            
            if (saveEl) {
                saveEl.textContent = lastSave ? formatDateTimeShort(lastSave) : 'Never';
            }
            if (loadEl) {
                loadEl.textContent = lastLoad ? formatDateTimeShort(lastLoad) : 'Never';
            }
            if (statusEl && lastSave) {
                statusEl.innerHTML = '<span class="badge badge-pass">Synced</span>';
            }
        }

        function formatDateTimeShort(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-AU', { 
                day: '2-digit', 
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ============================================
        // THEME MANAGEMENT
        // ============================================

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            saveToStorage(STORAGE_KEYS.theme, theme);
            
            // Update toggle buttons
            document.querySelectorAll('.theme-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(theme)) {
                    btn.classList.add('active');
                }
            });
        }

        function loadTheme() {
            const theme = loadFromStorage(STORAGE_KEYS.theme, 'dark');
            setTheme(theme);
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function showTab(tabId) {
            // ============================================
            // GATING CHECKS (before showing tab)
            // ============================================
            
            // Gate Pre-Trade access through Playbook
            if (tabId === 'validation') {
                // First check regime access
                if (window.RegimeModule) {
                    const regimeAccess = window.RegimeModule.checkPreTradeAccess();
                    if (!regimeAccess.allowed) {
                        alert(regimeAccess.reason);
                        showTab('regime');
                        return;
                    }
                }
                
                // Then check playbook access
                if (window.PlaybookModule) {
                    const playbookAccess = window.PlaybookModule.canAccessPreTrade();
                    if (!playbookAccess.allowed) {
                        // Show gate banner
                        const banner = document.getElementById('pretrade-gate-banner');
                        if (banner) {
                            banner.style.display = 'flex';
                            const msgEl = banner.querySelector('.gate-message');
                            if (msgEl) msgEl.textContent = playbookAccess.reason;
                        }
                        showTab('playbook');
                        return;
                    } else {
                        // Hide gate banner
                        const banner = document.getElementById('pretrade-gate-banner');
                        if (banner) banner.style.display = 'none';
                    }
                }
            }
            
            // Gate Playbook access through Regime
            if (tabId === 'playbook') {
                if (window.RegimeModule) {
                    const data = window.RegimeModule.loadRegimeData();
                    if (!data.dailyContext || !data.dailyContext.locked) {
                        alert('Complete Daily Context Regime first');
                        showTab('regime');
                        return;
                    }
                }
            }
            
            // ============================================
            // STANDARD TAB SWITCHING
            // ============================================
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const targetTab = document.getElementById('tab-' + tabId);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Activate the clicked button
            const clickedBtn = document.querySelector(`[onclick="showTab('${tabId}')"]`);
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            }
            
            // Refresh tab-specific data
            switch(tabId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'playbook':
                    // Render playbook selection UI
                    if (window.PlaybookModule) {
                        PlaybookModule.renderPlaybookSelection('playbook-selection-container');
                    }
                    break;
                case 'validation':
                    // Validation is user-driven
                    break;
                case 'journal':
                    loadTrades();
                    break;
                case 'performance':
                    updatePerformanceStats();
                    break;
                case 'guide':
                    // Static content
                    break;
                case 'reference':
                    // Static content
                    break;
                case 'settings':
                    loadSettings();
                    updateSystemInfo();
                    break;
            }
        }

        // ============================================
        // MODAL MANAGEMENT
        // ============================================

        function scrollToActiveTrades() {
            var widget = document.getElementById('active-trades-widget');
            if (widget) {
                widget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Brief highlight pulse
                widget.style.outline = '2px solid var(--accent-primary)';
                widget.style.outlineOffset = '4px';
                setTimeout(function() {
                    widget.style.outline = '';
                    widget.style.outlineOffset = '';
                }, 1500);
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ============================================
        // ACTIVE TRADES FAB BADGE
        // ============================================

        function updateFabTradeCount() {
            var countBadge = document.getElementById('fab-trade-count');
            var widgetCount = document.getElementById('widget-open-count');
            if (!countBadge) return;

            var count = 0;
            if (widgetCount) {
                var match = widgetCount.textContent.match(/(\d+)/);
                if (match) count = parseInt(match[1]);
            }

            countBadge.textContent = count;
            countBadge.className = 'fab-trade-count' + (count === 0 ? ' zero' : '');
        }

        // Update FAB badge whenever the widget count changes
        var _fabObserver = new MutationObserver(updateFabTradeCount);
        var _fabTarget = document.getElementById('widget-open-count');
        if (_fabTarget) {
            _fabObserver.observe(_fabTarget, { childList: true, characterData: true, subtree: true });
        }
        // Initial update
        setTimeout(updateFabTradeCount, 2000);

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'info', duration = 3000) {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Add toast styles if not exists
            if (!document.getElementById('toast-styles')) {
                const styles = document.createElement('style');
                styles.id = 'toast-styles';
                styles.textContent = `
                    .toast {
                        position: fixed;
                        bottom: 100px;
                        right: 20px;
                        padding: 12px 20px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                        font-size: 0.9rem;
                        max-width: 350px;
                        box-shadow: var(--shadow-lg);
                    }
                    .toast-success { background: var(--color-pass); color: white; }
                    .toast-error { background: var(--color-fail); color: white; }
                    .toast-warning { background: var(--color-warning); color: #000; }
                    .toast-info { background: var(--color-info); color: white; }
                    .toast button {
                        background: none;
                        border: none;
                        color: inherit;
                        font-size: 1.2rem;
                        cursor: pointer;
                        opacity: 0.8;
                    }
                    .toast button:hover { opacity: 1; }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => toast.remove(), duration);
            }
        }

        // ============================================
        // SYSTEM INFO
        // ============================================

        function updateSystemInfo() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const lastBackup = loadFromStorage(STORAGE_KEYS.lastBackup, null);
            
            const storageEl = document.getElementById('storage-used');
            const tradesEl = document.getElementById('trades-logged');
            const backupEl = document.getElementById('last-backup');
            
            if (storageEl) storageEl.textContent = getStorageSize();
            if (tradesEl) tradesEl.textContent = trades.length;
            if (backupEl) backupEl.textContent = lastBackup ? formatDate(lastBackup) : 'Never';
            
            // Check backup reminder
            checkBackupReminder();
        }

        function checkBackupReminder() {
            const lastBackup = loadFromStorage(STORAGE_KEYS.lastBackup, null);
            const settings = getSettings();
            
            if (!lastBackup) {
                showToast('Reminder: Export a backup of your data', 'warning', 5000);
                return;
            }
            
            const daysSinceBackup = Math.floor((Date.now() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
            if (daysSinceBackup >= settings.backupReminder) {
                showToast(`It's been ${daysSinceBackup} days since your last backup`, 'warning', 5000);
            }
        }

        // ============================================
        // AUTO-SAVE SYSTEM
        // ============================================

        const autoSave = debounce(() => {
            const settings = getSettings();
            if (settings.autoSave) {
                // Auto-save is handled by individual save functions
                console.log('Auto-save triggered');
            }
        }, 1000);

        // Watch for changes on input fields
        document.addEventListener('input', (e) => {
            if (e.target.matches('input, select, textarea')) {
                autoSave();
            }
        });

        // ============================================
        // INITIALISATION
        // ============================================

        function initApp() {
            console.log(`Forex Trading Command Centre v${APP_VERSION} initialising...`);
            
            // Load theme
            loadTheme();
            
            // Load settings
            loadSettings();
            
            // Set today's date on scan
            const scanDate = document.getElementById('scan-date');
            if (scanDate) {
                scanDate.value = new Date().toISOString().split('T')[0];
            }
            
            // Update dashboard
            updateDashboard();
            
            // Update system info
            updateSystemInfo();
            
            // Load trades for journal
            loadTrades();
            
            // Initialize entry strategy (session timing)
            initEntryStrategy();
            
            // Load economic calendar data
            loadEconomicCalendar().then(loaded => {
                if (loaded) {
                    console.log('Economic calendar loaded successfully');
                } else {
                    console.log('Economic calendar not available - using reference mode');
                }
            });
            
            // Update server storage status
            updateServerStorageStatus();
            
            console.log('App initialised successfully');
        }

        // Run on DOM ready
        document.addEventListener('DOMContentLoaded', initApp);

        // CHUNK 1 COMPLETE - Core utilities, storage, theme, tabs, active trades FAB, toasts
        // NEWS MANAGEMENT moved to regime-module.js

        // ============================================
        // CHUNK 2: DASHBOARD & DRAWDOWN
        // ============================================

        function updateDashboard() {
            const settings = getSettings();
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            
            // Update Account Overview
            updateAccountOverview(settings, trades);
            
            // Update Drawdown Status
            updateDrawdownStatus(settings);
            
            // Update Weekly Performance
            updateWeeklyStats(trades);
            
            // Update Active Trades Widget
            updateActiveTradesWidget(trades);
        }

        function updateAccountOverview(settings, trades) {
            const balance = settings.accountBalance;
            const peak = settings.peakBalance;
            const drawdown = calculateDrawdown(balance, peak);
            const openPositions = trades.filter(t => t.status === 'open').length;
            
            // Update display elements
            const balanceEl = document.getElementById('dash-balance');
            const peakEl = document.getElementById('dash-peak');
            const drawdownEl = document.getElementById('dash-drawdown');
            const openEl = document.getElementById('dash-open-positions');
            
            if (balanceEl) balanceEl.textContent = formatCurrency(balance);
            if (peakEl) peakEl.textContent = formatCurrency(peak);
            if (drawdownEl) {
                drawdownEl.textContent = formatNumber(drawdown, 1) + '%';
                drawdownEl.className = 'stat-value ' + getDrawdownColourClass(drawdown);
            }
            if (openEl) openEl.textContent = openPositions;
        }

        function calculateDrawdown(currentBalance, peakBalance) {
            if (peakBalance <= 0) return 0;
            const drawdown = ((peakBalance - currentBalance) / peakBalance) * 100;
            return Math.max(0, drawdown);
        }

        function getDrawdownStatus(drawdownPercent) {
            if (drawdownPercent < 5) return { level: 'normal', text: 'NORMAL', risk: '1.5-2%' };
            if (drawdownPercent < 10) return { level: 'caution', text: 'CAUTION', risk: '1%' };
            if (drawdownPercent < 15) return { level: 'stop', text: 'STOP', risk: '0.5%' };
            return { level: 'emergency', text: 'EMERGENCY', risk: '0%' };
        }

        function getDrawdownColourClass(drawdownPercent) {
            if (drawdownPercent < 5) return 'text-pass';
            if (drawdownPercent < 10) return 'text-warning';
            if (drawdownPercent < 15) return 'text-fail';
            return 'text-fail';
        }

        function updateDrawdownStatus(settings) {
            const drawdown = calculateDrawdown(settings.accountBalance, settings.peakBalance);
            const status = getDrawdownStatus(drawdown);
            
            const statusEl = document.getElementById('drawdown-status');
            if (statusEl) {
                statusEl.className = `drawdown-indicator ${status.level}`;
                statusEl.innerHTML = `
                    <span class="drawdown-dot"></span>
                    <span>${status.text}</span>
                `;
            }
            
            // Update protocol box highlighting
            updateDrawdownProtocolHighlight(status.level);
            
            // Show warning if in danger zone
            if (status.level === 'stop') {
                showToast(' STOP TRADING - Take a 1-week break', 'error', 10000);
            } else if (status.level === 'emergency') {
                showToast(' EMERGENCY - Cease all trading immediately', 'error', 10000);
            }
        }

        function updateDrawdownProtocolHighlight(level) {
            // Remove all highlights first
            document.querySelectorAll('#drawdown-protocol-box .stat-box').forEach(box => {
                box.style.opacity = '0.5';
                box.style.transform = 'scale(1)';
            });
            
            // Highlight current level
            const levels = ['normal', 'caution', 'stop', 'emergency'];
            const index = levels.indexOf(level);
            const boxes = document.querySelectorAll('#drawdown-protocol-box .stat-box');
            
            if (boxes[index]) {
                boxes[index].style.opacity = '1';
                boxes[index].style.transform = 'scale(1.02)';
            }
        }

        function updateWeeklyStats(trades) {
            // Filter trades from this week that are closed
            const weekTrades = trades.filter(t => 
                isThisWeek(t.openDate || t.date) && t.status === 'closed'
            );
            
            const totalTrades = weekTrades.length;
            const winners = weekTrades.filter(t => (t.rMultiple || 0) > 0);
            const winRate = totalTrades > 0 ? (winners.length / totalTrades) * 100 : 0;
            
            // Calculate average R-multiple
            const totalR = weekTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
            const avgR = totalTrades > 0 ? totalR / totalTrades : 0;
            
            // Calculate P&L
            const totalPnL = weekTrades.reduce((sum, t) => sum + (t.pnl || 0), 0);
            
            // Calculate expectancy
            const avgWin = winners.length > 0 
                ? winners.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / winners.length 
                : 0;
            const losers = weekTrades.filter(t => (t.rMultiple || 0) < 0);
            const avgLoss = losers.length > 0 
                ? Math.abs(losers.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / losers.length) 
                : 0;
            const winRateDecimal = winRate / 100;
            const expectancy = (winRateDecimal * avgWin) - ((1 - winRateDecimal) * avgLoss);
            
            // Update UI
            const tradesEl = document.getElementById('week-trades');
            const winrateEl = document.getElementById('week-winrate');
            const avgREl = document.getElementById('week-avg-r');
            const pnlEl = document.getElementById('week-pnl');
            const expectancyEl = document.getElementById('week-expectancy');
            const targetEl = document.getElementById('week-target');
            const dateRangeEl = document.getElementById('week-date-range');
            
            if (tradesEl) tradesEl.textContent = totalTrades;
            if (winrateEl) {
                winrateEl.textContent = formatNumber(winRate, 0) + '%';
                winrateEl.className = 'stat-value ' + (winRate >= 50 ? 'text-pass' : 'text-fail');
            }
            if (avgREl) {
                avgREl.textContent = formatNumber(avgR, 2) + 'R';
                avgREl.className = 'stat-value ' + (avgR >= 0 ? 'text-pass' : 'text-fail');
            }
            if (pnlEl) {
                pnlEl.textContent = formatCurrency(totalPnL);
                pnlEl.className = 'stat-value ' + (totalPnL >= 0 ? 'text-pass' : 'text-fail');
            }
            if (expectancyEl) {
                expectancyEl.textContent = formatNumber(expectancy, 2) + 'R';
                expectancyEl.className = 'stat-value ' + (expectancy >= 0 ? 'text-pass' : 'text-fail');
            }
            if (targetEl) {
                const targetClass = totalTrades >= 5 && totalTrades <= 10 ? 'text-pass' : 
                                   totalTrades > 10 ? 'text-warning' : '';
                targetEl.textContent = `${totalTrades} / 5-10`;
                targetEl.className = 'stat-value ' + targetClass;
            }
            
            // Update date range display
            if (dateRangeEl) {
                const { start, end } = getWeekRange();
                dateRangeEl.textContent = `${formatDate(start)} - ${formatDate(end)}`;
            }
        }

        function getRecommendedRisk() {
            const settings = getSettings();
            const drawdown = calculateDrawdown(settings.accountBalance, settings.peakBalance);
            const status = getDrawdownStatus(drawdown);
            
            switch(status.level) {
                case 'normal': return 1.5;
                case 'caution': return 1;
                case 'stop': return 0.5;
                case 'emergency': return 0;
                default: return 1.5;
            }
        }

        // CHUNK 2 COMPLETE - Dashboard & Drawdown

        // ============================================
        // ACTIVE TRADES WIDGET
        // ============================================
        
        function updateActiveTradesWidget(trades) {
            const openTrades = trades.filter(t => t.status === 'open');
            const grid = document.getElementById('active-trades-grid');
            const noTradesMsg = document.getElementById('no-active-trades-widget');
            const summaryBar = document.getElementById('trade-summary-bar');
            const countBadge = document.getElementById('widget-open-count');
            
            if (countBadge) countBadge.textContent = `${openTrades.length} Open`;
            
            if (openTrades.length === 0) {
                if (grid) grid.style.display = 'none';
                if (noTradesMsg) noTradesMsg.style.display = 'flex';
                if (summaryBar) summaryBar.style.display = 'none';
                return;
            }
            
            if (noTradesMsg) noTradesMsg.style.display = 'none';
            if (grid) grid.style.display = 'grid';
            if (summaryBar) summaryBar.style.display = 'flex';
            
            // Render trade cards
            if (grid) {
                grid.innerHTML = openTrades.map(trade => renderActiveTradeCard(trade)).join('');
            }
            
            // Update summary bar
            updateTradeSummaryBar(openTrades);
        }
        
        function renderActiveTradeCard(trade) {
            const isLong = trade.direction === 'long';
            const dirClass = isLong ? 'long' : 'short';
            const tradeAge = getTradeAge(trade.date);
            const ageClass = tradeAge.hours >= 48 ? 'danger' : tradeAge.hours >= 24 ? 'warning' : '';
            const needsAttention = tradeAge.hours >= 24 || !trade.stop;
            
            // Calculate current R if we have the data
            const riskPips = trade.entry && trade.stop ? Math.abs(trade.entry - trade.stop) : 0;
            const rrText = trade.tp && riskPips > 0 
                ? (Math.abs(trade.tp - trade.entry) / riskPips).toFixed(1) 
                : '--';
            
            return `
                <div class="active-trade-card trade-${dirClass} ${needsAttention ? 'needs-attention' : ''}">
                    <div class="trade-card-header">
                        <span class="trade-card-pair">${trade.pair}</span>
                        <span class="trade-card-direction ${dirClass}">${isLong ? '&#x25B2; LONG' : '&#x25BC; SHORT'}</span>
                    </div>
                    
                    <div class="trade-card-stats">
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value">${trade.entry || '--'}</div>
                            <div class="trade-card-stat-label">Entry</div>
                        </div>
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value" style="color: var(--color-fail);">${trade.stop || '--'}</div>
                            <div class="trade-card-stat-label">Stop</div>
                        </div>
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value" style="color: var(--color-pass);">${trade.tp || '--'}</div>
                            <div class="trade-card-stat-label">TP</div>
                        </div>
                    </div>
                    
                    <div class="trade-card-stats">
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value">${rrText}R</div>
                            <div class="trade-card-stat-label">Target R:R</div>
                        </div>
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value">${trade.trendScore || '--'}</div>
                            <div class="trade-card-stat-label">Score</div>
                        </div>
                        <div class="trade-card-stat">
                            <div class="trade-card-stat-value">${getGradeBadge(trade.grade, trade.dismissReason)}</div>
                            <div class="trade-card-stat-label">Grade</div>
                        </div>
                    </div>
                    
                    <div class="trade-card-footer">
                        <div class="trade-card-age ${ageClass}">
                            &#x23F1; ${tradeAge.text}
                        </div>
                        <div>
                            ${getAlertBadge(trade.alertType)}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getTradeAge(dateStr) {
            if (!dateStr) return { hours: 0, text: '--' };
            
            const tradeDate = new Date(dateStr);
            const now = new Date();
            const diffMs = now - tradeDate;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            let text;
            if (diffDays > 0) {
                text = `${diffDays}d ${diffHours % 24}h`;
            } else if (diffHours > 0) {
                text = `${diffHours}h`;
            } else {
                const diffMins = Math.floor(diffMs / (1000 * 60));
                text = `${diffMins}m`;
            }
            
            return { hours: diffHours, text };
        }
        
        function updateTradeSummaryBar(openTrades) {
            const settings = getSettings();
            
            // Calculate total exposure
            let totalRisk = 0;
            openTrades.forEach(trade => {
                if (trade.riskAmount && settings.accountBalance > 0) {
                    totalRisk += (trade.riskAmount / settings.accountBalance) * 100;
                }
            });
            
            // Find oldest trade
            let oldestAge = { hours: 0, text: '--' };
            openTrades.forEach(trade => {
                const age = getTradeAge(trade.date);
                if (age.hours > oldestAge.hours) {
                    oldestAge = age;
                }
            });
            
            // Update elements
            const riskEl = document.getElementById('widget-total-risk');
            const pnlEl = document.getElementById('widget-floating-pnl');
            const oldestEl = document.getElementById('widget-oldest-trade');
            
            if (riskEl) {
                riskEl.textContent = `${totalRisk.toFixed(1)}%`;
                riskEl.style.color = totalRisk > 6 ? 'var(--color-fail)' : 
                                    totalRisk > 4 ? 'var(--color-warning)' : 'var(--color-pass)';
            }
            
            if (pnlEl) {
                // Floating P/L requires live price data - show as unavailable
                pnlEl.textContent = 'N/A';
                pnlEl.title = 'Live price data not available';
            }
            
            if (oldestEl) {
                oldestEl.textContent = oldestAge.text;
                oldestEl.style.color = oldestAge.hours >= 48 ? 'var(--color-fail)' : 
                                       oldestAge.hours >= 24 ? 'var(--color-warning)' : '';
            }
        }

        // ============================================
        // CHUNK 3: DAILY SCAN
        // ============================================

        function initDailyScan() {
            const scanDate = document.getElementById('scan-date');
            if (scanDate && !scanDate.value) {
                scanDate.value = new Date().toISOString().split('T')[0];
            }
            loadScanData();
        }

        function getScanKey(date, session) {
            return `${date}_${session}`;
        }

        function loadScanData() {
            const date = document.getElementById('scan-date')?.value || new Date().toISOString().split('T')[0];
            const session = document.getElementById('scan-session')?.value || 'asian';
            const scanKey = getScanKey(date, session);
            
            const allScans = loadFromStorage(STORAGE_KEYS.scans, {});
            const scanData = allScans[scanKey] || {};
            
            // Apply saved data to pair cards
            ALL_PAIRS.forEach(pair => {
                const pairData = scanData[pair] || getEmptyPairData();
                updatePairCardFromData(pair, pairData);
            });
        }

        function getEmptyPairData() {
            return {
                trendScore: null,
                mtf: null,
                volatility: null,
                entryZone: null,
                newsSafe: false,
                direction: null,
                notes: ''
            };
        }

        function updatePairCardFromData(pair, data) {
            const card = document.getElementById(`pair-${pair.toLowerCase()}`);
            if (!card) return;
            
            // Update criteria dots
            const dots = card.querySelectorAll('.criteria-dot');
            const criteria = [
                data.trendScore >= 80,
                data.mtf === 3,
                ['trend', 'explode', 'quiet'].includes(data.volatility),
                ['hot', 'optimal'].includes(data.entryZone),
                data.newsSafe
            ];
            
            dots.forEach((dot, i) => {
                dot.classList.remove('pass', 'fail');
                if (criteria[i] === true) {
                    dot.classList.add('pass');
                } else if (criteria[i] === false && data.trendScore !== null) {
                    dot.classList.add('fail');
                }
            });
            
            // Highlight if TRADE READY (all 5 criteria met)
            const allMet = criteria.every(c => c === true);
            card.classList.toggle('trade-ready', allMet);
            
            // Update expanded details if they exist
            const detailsDiv = card.querySelector('.pair-details');
            if (detailsDiv) {
                updatePairDetails(pair, data, detailsDiv);
            }
        }

        function updatePairDetails(pair, data, container) {
            const trendInput = container.querySelector(`[data-field="trendScore"]`);
            const mtfSelect = container.querySelector(`[data-field="mtf"]`);
            const volSelect = container.querySelector(`[data-field="volatility"]`);
            const zoneSelect = container.querySelector(`[data-field="entryZone"]`);
            const newsCheck = container.querySelector(`[data-field="newsSafe"]`);
            const dirSelect = container.querySelector(`[data-field="direction"]`);
            
            if (trendInput) trendInput.value = data.trendScore || '';
            if (mtfSelect) mtfSelect.value = data.mtf || '';
            if (volSelect) volSelect.value = data.volatility || '';
            if (zoneSelect) zoneSelect.value = data.entryZone || '';
            if (newsCheck) newsCheck.checked = data.newsSafe || false;
            if (dirSelect) dirSelect.value = data.direction || '';
        }

        function togglePairCard(pair) {
            const card = document.getElementById(`pair-${pair.toLowerCase()}`);
            if (!card) return;
            
            let detailsDiv = card.querySelector('.pair-details');
            
            if (detailsDiv) {
                // Toggle visibility
                detailsDiv.classList.toggle('hidden');
            } else {
                // Create details section
                detailsDiv = document.createElement('div');
                detailsDiv.className = 'pair-details';
                detailsDiv.innerHTML = createPairDetailsHTML(pair);
                card.appendChild(detailsDiv);
                
                // Load any saved data
                loadScanData();
            }
        }

        function createPairDetailsHTML(pair) {
            return `
                <div class="pair-details-grid">
                    <div class="form-group">
                        <label class="form-label">Trend Score</label>
                        <input type="number" class="form-input" data-pair="${pair}" data-field="trendScore" 
                               min="0" max="100" placeholder="0-100" onchange="onPairDataChange('${pair}')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">MTF</label>
                        <select class="form-select" data-pair="${pair}" data-field="mtf" onchange="onPairDataChange('${pair}')">
                            <option value="">-</option>
                            <option value="3">3/3</option>
                            <option value="2">2/3</option>
                            <option value="1">1/3</option>
                            <option value="0">0/3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Volatility</label>
                        <select class="form-select" data-pair="${pair}" data-field="volatility" onchange="onPairDataChange('${pair}')">
                            <option value="">-</option>
                            <option value="trend">TREND</option>
                            <option value="explode">EXPLODE</option>
                            <option value="quiet">QUIET</option>
                            <option value="low">LOW</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Entry Zone</label>
                        <select class="form-select" data-pair="${pair}" data-field="entryZone" onchange="onPairDataChange('${pair}')">
                            <option value="">-</option>
                            <option value="hot">HOT</option>
                            <option value="optimal">OPTIMAL</option>
                            <option value="acceptable">ACCEPTABLE</option>
                            <option value="extended">EXTENDED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direction</label>
                        <select class="form-select" data-pair="${pair}" data-field="direction" onchange="onPairDataChange('${pair}')">
                            <option value="">-</option>
                            <option value="long">LONG</option>
                            <option value="short">SHORT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-wrapper" style="margin-top: 1.5rem;">
                            <input type="checkbox" data-pair="${pair}" data-field="newsSafe" onchange="onPairDataChange('${pair}')">
                            <span class="checkbox-label">News Safe</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-sm mt-sm">
                    <button class="btn btn-primary btn-sm" onclick="validateFromScan('${pair}')"> Validate</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearPairData('${pair}')">Clear</button>
                </div>
            `;
        }

        function onPairDataChange(pair) {
            // Get current values
            const data = getPairDataFromUI(pair);
            
            // Update the card display
            updatePairCardFromData(pair, data);
            
            // Auto-save
            saveScanDataSilent();
        }

        function getPairDataFromUI(pair) {
            const card = document.getElementById(`pair-${pair.toLowerCase()}`);
            if (!card) return getEmptyPairData();
            
            const trendInput = card.querySelector(`[data-field="trendScore"]`);
            const mtfSelect = card.querySelector(`[data-field="mtf"]`);
            const volSelect = card.querySelector(`[data-field="volatility"]`);
            const zoneSelect = card.querySelector(`[data-field="entryZone"]`);
            const newsCheck = card.querySelector(`[data-field="newsSafe"]`);
            const dirSelect = card.querySelector(`[data-field="direction"]`);
            
            return {
                trendScore: trendInput ? parseInt(trendInput.value) || null : null,
                mtf: mtfSelect ? parseInt(mtfSelect.value) || null : null,
                volatility: volSelect ? volSelect.value || null : null,
                entryZone: zoneSelect ? zoneSelect.value || null : null,
                newsSafe: newsCheck ? newsCheck.checked : false,
                direction: dirSelect ? dirSelect.value || null : null
            };
        }

        function saveScanData() {
            saveScanDataSilent();
            showToast('Scan data saved', 'success');
        }

        function saveScanDataSilent() {
            const date = document.getElementById('scan-date')?.value || new Date().toISOString().split('T')[0];
            const session = document.getElementById('scan-session')?.value || 'asian';
            const scanKey = getScanKey(date, session);
            
            const allScans = loadFromStorage(STORAGE_KEYS.scans, {});
            
            // Collect data from all pairs
            const scanData = {};
            ALL_PAIRS.forEach(pair => {
                const data = getPairDataFromUI(pair);
                // Only save if there's actual data
                if (data.trendScore !== null || data.mtf !== null || data.volatility !== null) {
                    scanData[pair] = data;
                }
            });
            
            allScans[scanKey] = scanData;
            saveToStorage(STORAGE_KEYS.scans, allScans);
        }

        function resetAllScans() {
            if (!confirm('Reset all pairs for this scan session?')) return;
            
            ALL_PAIRS.forEach(pair => {
                clearPairData(pair, false);
            });
            
            saveScanDataSilent();
            showToast('All scans reset', 'info');
        }

        function clearPairData(pair, save = true) {
            const card = document.getElementById(`pair-${pair.toLowerCase()}`);
            if (!card) return;
            
            // Clear all inputs
            card.querySelectorAll('input[type="number"], select').forEach(el => {
                el.value = '';
            });
            card.querySelectorAll('input[type="checkbox"]').forEach(el => {
                el.checked = false;
            });
            
            // Reset dots
            card.querySelectorAll('.criteria-dot').forEach(dot => {
                dot.classList.remove('pass', 'fail');
            });
            
            // Remove trade-ready class
            card.classList.remove('trade-ready');
            
            if (save) {
                saveScanDataSilent();
                showToast(`${pair} cleared`, 'info');
            }
        }

        function validateFromScan(pair) {
            const data = getPairDataFromUI(pair);
            
            // Switch to validation tab
            showTab('validation');
            
            // Pre-fill validation form
            setTimeout(() => {
                const pairSelect = document.getElementById('val-pair');
                const dirSelect = document.getElementById('val-direction');
                const trendInput = document.getElementById('val-trend-score');
                const mtfSelect = document.getElementById('val-mtf');
                const volSelect = document.getElementById('val-volatility');
                const zoneSelect = document.getElementById('val-entry-zone');
                
                if (pairSelect) pairSelect.value = pair;
                if (dirSelect && data.direction) dirSelect.value = data.direction;
                if (trendInput && data.trendScore) trendInput.value = data.trendScore;
                if (mtfSelect && data.mtf) mtfSelect.value = data.mtf;
                if (volSelect && data.volatility) volSelect.value = data.volatility;
                if (zoneSelect && data.entryZone) zoneSelect.value = data.entryZone;
                
                // Trigger validation update
                updateCriteria();
            }, 100);
        }

        // Add click handlers to existing pair cards
        function initPairCardClicks() {
            ALL_PAIRS.forEach(pair => {
                const card = document.getElementById(`pair-${pair.toLowerCase()}`);
                if (card && !card.hasAttribute('data-click-init')) {
                    card.setAttribute('data-click-init', 'true');
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', (e) => {
                        // Don't toggle if clicking on inputs
                        if (e.target.matches('input, select, button')) return;
                        togglePairCard(pair);
                    });
                }
            });
        }

        // Add styles for pair details
        const pairDetailsStyles = document.createElement('style');
        pairDetailsStyles.textContent = `
            .pair-details {
                margin-top: var(--spacing-md);
                padding-top: var(--spacing-md);
                border-top: 1px solid var(--border-primary);
            }
            .pair-details.hidden {
                display: none;
            }
            .pair-details-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-sm);
            }
            .pair-card.trade-ready {
                border-color: var(--color-pass) !important;
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            }
            .pair-card.trade-ready .pair-name {
                color: var(--color-pass);
            }
            .criteria-dot.pass {
                background-color: var(--color-pass);
            }
            .criteria-dot.fail {
                background-color: var(--color-fail);
            }
            @media (max-width: 600px) {
                .pair-details-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        `;
        document.head.appendChild(pairDetailsStyles);

        // Initialize pair card clicks on load
        document.addEventListener('DOMContentLoaded', initPairCardClicks);

        // CHUNK 3 COMPLETE - Daily Scan

        // ============================================
        // CHUNK 4: PRE-TRADE VALIDATION
        // ============================================

        function updateCriteria() {
            const criteria = [
                checkCriterion1(),
                checkCriterion2(),
                checkCriterion3(),
                checkCriterion4(),
                checkCriterion5()
            ];
            
            // Update visual indicators for each criterion
            criteria.forEach((passed, index) => {
                const criteriaEl = document.getElementById(`criteria-${index + 1}`);
                if (criteriaEl) {
                    criteriaEl.classList.remove('pass', 'fail');
                    const numEl = criteriaEl.querySelector('.criteria-number');
                    if (passed === true) {
                        criteriaEl.classList.add('pass');
                        if (numEl) numEl.textContent = '';
                    } else if (passed === false) {
                        criteriaEl.classList.add('fail');
                        if (numEl) numEl.textContent = index + 1;
                    } else {
                        if (numEl) numEl.textContent = index + 1;
                    }
                }
            });
            
            // Update count badge
            const passedCount = criteria.filter(c => c === true).length;
            const badge = document.getElementById('criteria-count-badge');
            if (badge) {
                badge.textContent = `${passedCount}/5 Met`;
                badge.className = 'badge';
                if (passedCount === 5) {
                    badge.classList.add('badge-pass');
                } else if (passedCount >= 3) {
                    badge.classList.add('badge-warning');
                } else {
                    badge.classList.add('badge-fail');
                }
            }
            
            // Update verdict
            updateValidationVerdict(criteria);
            
            // Calculate R:R if prices are filled
            calculateRR();
        }

        function checkCriterion1() {
            // Trend Score 80 + sub-checks
            const score = parseInt(document.getElementById('val-trend-score')?.value) || 0;
            const emasStacked = document.getElementById('val-emas-stacked')?.checked || false;
            const price200 = document.getElementById('val-price-200')?.checked || false;
            const adx = document.getElementById('val-adx')?.checked || false;
            
            if (!score && !emasStacked && !price200 && !adx) return null; // Not filled
            
            return score >= 80 && emasStacked && price200 && adx;
        }

        function checkCriterion2() {
            // MTF Alignment 3/3
            const mtf = document.getElementById('val-mtf')?.value;
            const aligned1h = document.getElementById('val-1h-aligned')?.checked || false;
            const aligned4h = document.getElementById('val-4h-aligned')?.checked || false;
            const alignedDaily = document.getElementById('val-daily-aligned')?.checked || false;
            
            if (!mtf && !aligned1h && !aligned4h && !alignedDaily) return null;
            
            return mtf === '3' && aligned1h && aligned4h && alignedDaily;
        }

        function checkCriterion3() {
            // Volatility Ready (TREND/EXPLODE/QUIET + ATR 80%)
            const vol = document.getElementById('val-volatility')?.value;
            const atrFilter = document.getElementById('val-atr-filter')?.checked || false;
            const atrPct = parseInt(document.getElementById('val-atr-pct')?.value) || 0;
            
            if (!vol) return null;
            
            const validVol = ['trend', 'explode', 'quiet'].includes(vol);
            const validAtr = atrFilter && atrPct >= 80;
            
            return validVol && validAtr;
        }

        function checkCriterion4() {
            // Entry Zone HOT/OPTIMAL + S/R distance
            const zone = document.getElementById('val-entry-zone')?.value;
            const srDistance = document.getElementById('val-sr-distance')?.checked || false;
            
            if (!zone) return null;
            
            const validZone = ['hot', 'optimal'].includes(zone);
            return validZone && srDistance;
        }

        function checkCriterion5() {
            // News Safety
            const newsSafe = document.getElementById('val-news-safe')?.checked || false;
            const newsChecked = document.getElementById('val-news-checked')?.checked || false;
            
            if (!newsChecked) return null;
            
            return newsSafe;
        }

        function updateValidationVerdict(criteria) {
            const verdictBox = document.getElementById('validation-verdict');
            const verdictStatus = verdictBox?.querySelector('.verdict-status');
            const verdictDesc = document.getElementById('verdict-reason');
            const executeBtn = document.getElementById('execute-trade-btn');
            
            if (!verdictBox) return;
            
            const passedCount = criteria.filter(c => c === true).length;
            const failedCount = criteria.filter(c => c === false).length;
            const pendingCount = criteria.filter(c => c === null).length;
            
            // Check safety net status
            const safetyCheckboxes = [
                'safety-sl-identified',
                'safety-sl-buffer',
                'safety-tp1-identified',
                'safety-rr-acceptable',
                'safety-path-clear',
                'safety-correlation-checked',
                'safety-final-confirm'
            ];
            const safetyNetComplete = safetyCheckboxes.every(id => {
                const checkbox = document.getElementById(id);
                return checkbox?.checked;
            });
            
            let verdict, desc, className;
            
            if (passedCount === 5 && safetyNetComplete) {
                verdict = '&#x2714; TRADE READY';
                desc = 'All criteria met + Structure verified. Execute with confidence!';
                className = 'verdict-ready';
                if (executeBtn) executeBtn.disabled = false;
            } else if (passedCount === 5 && !safetyNetComplete) {
                verdict = '&#x23F3; STRUCTURE CHECK';
                desc = 'Criteria passed. Complete Structure Safety Net below.';
                className = 'verdict-pending';
                if (executeBtn) executeBtn.disabled = true;
            } else if (failedCount > 0) {
                verdict = '&#x1F6AB; BLOCKED';
                desc = `${failedCount} criteria failed. Do NOT trade.`;
                className = 'verdict-blocked';
                if (executeBtn) executeBtn.disabled = true;
            } else if (pendingCount > 0) {
                verdict = '&#x23F3; INCOMPLETE';
                desc = `${pendingCount} criteria not yet checked.`;
                className = 'verdict-pending';
                if (executeBtn) executeBtn.disabled = true;
            } else {
                verdict = 'WARNING: CAUTION';
                desc = 'Review criteria before proceeding.';
                className = 'verdict-caution';
                if (executeBtn) executeBtn.disabled = true;
            }
            
            verdictBox.className = `verdict-box ${className}`;
            if (verdictStatus) verdictStatus.innerHTML = verdict;
            if (verdictDesc) verdictDesc.textContent = desc;
        }

        function calculateRR() {
            const direction = document.getElementById('val-direction')?.value;
            const entry = parseFloat(document.getElementById('val-entry-price')?.value) || 0;
            const stop = parseFloat(document.getElementById('val-stop-price')?.value) || 0;
            const tp1 = parseFloat(document.getElementById('val-tp1-price')?.value) || 0;
            const tp2 = parseFloat(document.getElementById('val-tp2-price')?.value) || 0;
            
            if (!entry || !stop) return;
            
            const risk = Math.abs(entry - stop);
            
            // Calculate R:R for TP1
            let rr1 = 0, rr2 = 0;
            if (tp1 && risk > 0) {
                const reward1 = Math.abs(tp1 - entry);
                rr1 = reward1 / risk;
            }
            
            // Calculate R:R for TP2
            if (tp2 && risk > 0) {
                const reward2 = Math.abs(tp2 - entry);
                rr2 = reward2 / risk;
            }
            
            // Update displays
            const rr1El = document.getElementById('val-rr1');
            const rr2El = document.getElementById('val-rr2');
            
            if (rr1El) {
                rr1El.textContent = `1:${formatNumber(rr1, 1)}`;
                rr1El.className = rr1 >= 1.5 ? 'text-pass' : rr1 >= 1 ? 'text-warning' : 'text-fail';
            }
            if (rr2El && tp2) {
                rr2El.textContent = `1:${formatNumber(rr2, 1)}`;
                rr2El.className = rr2 >= 2 ? 'text-pass' : rr2 >= 1.5 ? 'text-warning' : 'text-fail';
            }
            
            // Calculate position size
            calculateValidationPosition(risk);
        }

        function calculateValidationPosition(riskPips) {
            const settings = getSettings();
            const recommendedRisk = getRecommendedRisk();
            const riskAmount = settings.accountBalance * (recommendedRisk / 100);
            
            const posSizeEl = document.getElementById('val-position-size');
            const riskAmountEl = document.getElementById('val-risk-amount');
            
            if (riskPips && riskPips > 0) {
                const pipValue = 0.0001; // Standard for most pairs
                const units = Math.floor(riskAmount / (riskPips * pipValue));
                if (posSizeEl) posSizeEl.textContent = units.toLocaleString();
                if (riskAmountEl) riskAmountEl.textContent = `$${riskAmount.toFixed(2)}`;
            } else {
                if (posSizeEl) posSizeEl.textContent = '--';
                if (riskAmountEl) riskAmountEl.textContent = '--';
            }
        }

        // ============================================
        // PRE-TRADE VALIDATION (NEW STRUCTURE-BASED)
        // ============================================

        function toggleStructureEducation() {
            const eduEl = document.getElementById('structure-education');
            if (eduEl) {
                eduEl.style.display = eduEl.style.display === 'none' ? 'block' : 'none';
            }
        }

        function toggleCorrelationGroups() {
            const groupsEl = document.getElementById('correlation-groups-content');
            if (groupsEl) {
                groupsEl.style.display = groupsEl.style.display === 'none' ? 'block' : 'none';
            }
        }

        // ============================================
        // ENTRY STRATEGY FUNCTIONS
        // ============================================
        
        let selectedEntryType = 'market';
        let recommendedEntryType = 'market';
        
        // Session-Pair Optimization Matrix
        const sessionPairMatrix = {
            tokyo: {
                optimal: ['USDJPY', 'EURJPY', 'AUDJPY', 'GBPJPY', 'AUDUSD', 'NZDUSD', 'AUDNZD'],
                acceptable: ['EURUSD', 'GBPUSD', 'NZDJPY', 'CADJPY'],
                avoid: ['EURGBP', 'GBPCHF', 'EURCHF', 'USDCHF']
            },
            london: {
                optimal: ['EURUSD', 'GBPUSD', 'EURGBP', 'GBPCHF', 'EURCHF', 'USDCHF', 'EURJPY'],
                acceptable: ['USDJPY', 'AUDUSD', 'GBPJPY', 'USDCAD'],
                avoid: ['AUDNZD', 'NZDJPY']
            },
            newyork: {
                optimal: ['EURUSD', 'GBPUSD', 'USDCAD', 'USDJPY', 'USDCHF'],
                acceptable: ['AUDUSD', 'NZDUSD', 'EURJPY', 'GBPJPY'],
                avoid: ['AUDNZD', 'EURGBP', 'NZDJPY']
            },
            overlap: {
                optimal: ['EURUSD', 'GBPUSD', 'USDCHF', 'USDCAD'],
                acceptable: ['USDJPY', 'AUDUSD', 'EURJPY'],
                avoid: []
            }
        };
        
        // Kill Zone Definitions (AEST hours)
        const killZones = {
            londonOpen: {
                startHour: 17, startMin: 0,
                endHour: 18, endMin: 30,
                name: 'London Open',
                description: 'High volatility breakout zone - Asian range breaks',
                pairs: ['EURUSD', 'GBPUSD', 'EURGBP', 'EURJPY']
            },
            nyOpen: {
                startHour: 22, startMin: 0,
                endHour: 23, endMin: 30,
                name: 'New York Open',
                description: 'USD pairs most active - continuation or reversal',
                pairs: ['EURUSD', 'GBPUSD', 'USDCAD', 'USDJPY', 'USDCHF']
            },
            londonNyOverlap: {
                startHour: 22, startMin: 0,
                endHour: 2, endMin: 0,
                name: 'LON/NY Overlap',
                description: 'Maximum liquidity - best execution window',
                pairs: ['EURUSD', 'GBPUSD']
            },
            asianBreak: {
                startHour: 17, startMin: 0,
                endHour: 17, endMin: 30,
                name: 'Asian Range Break',
                description: 'London breaks overnight consolidation',
                pairs: ['USDJPY', 'EURJPY', 'GBPJPY', 'AUDJPY']
            }
        };
        
        // Entry Decision Engine
        function getRecommendedEntryType() {
            const distanceEl = document.getElementById('distance-to-structure');
            const volatility = document.getElementById('val-volatility')?.value || '';
            const score = parseInt(document.getElementById('val-utcc-score')?.value) || 0;
            
            // Calculate distance to structure
            const entry = parseFloat(document.getElementById('val-entry')?.value) || 0;
            const slStructure = parseFloat(document.getElementById('val-sl-structure')?.value) || 0;
            const pair = document.getElementById('val-pair')?.value || '';
            const pipMultiplier = pair.includes('JPY') ? 100 : 10000;
            
            let distanceToStructure = 0;
            if (entry && slStructure) {
                distanceToStructure = Math.abs(entry - slStructure) * pipMultiplier;
            }
            
            // Update display
            if (distanceEl) {
                distanceEl.textContent = distanceToStructure > 0 ? `${distanceToStructure.toFixed(1)} pips` : '-- pips';
            }
            
            // Decision logic
            let recommendation = { type: 'MARKET', reason: 'Default entry method', confidence: 'MEDIUM' };
            
            // Rule 1: EXPLODE volatility = Market only
            if (volatility.toUpperCase() === 'EXPLODE') {
                recommendation = {
                    type: 'MARKET',
                    reason: 'EXPLODE volatility - limits will be skipped in fast markets',
                    confidence: 'HIGH'
                };
            }
            // Rule 2: Very close to structure (<10 pips) = Market
            else if (distanceToStructure > 0 && distanceToStructure < 10) {
                recommendation = {
                    type: 'MARKET',
                    reason: `Only ${distanceToStructure.toFixed(1)} pips from structure - enter now`,
                    confidence: 'HIGH'
                };
            }
            // Rule 3: Moderate distance (10-30 pips) = Limit
            else if (distanceToStructure >= 10 && distanceToStructure <= 30) {
                recommendation = {
                    type: 'LIMIT',
                    reason: 'Set limit at structure for better entry price',
                    confidence: 'HIGH'
                };
            }
            // Rule 4: Far from structure + A+ setup = Scale-in
            else if (distanceToStructure > 30 && score >= 85) {
                recommendation = {
                    type: 'SCALE',
                    reason: `${distanceToStructure.toFixed(1)} pips away - scale into A+ setup`,
                    confidence: 'MEDIUM'
                };
            }
            // Rule 5: Far from structure, not A+ = Wait
            else if (distanceToStructure > 30) {
                recommendation = {
                    type: 'WAIT',
                    reason: `${distanceToStructure.toFixed(1)} pips from structure - wait for pullback`,
                    confidence: 'HIGH'
                };
            }
            
            return recommendation;
        }
        
        function updateEntryDecisionPanel() {
            const recommendation = getRecommendedEntryType();
            recommendedEntryType = recommendation.type;
            
            // Update volatility display
            const volEl = document.getElementById('decision-volatility');
            const volatility = document.getElementById('val-volatility')?.value || '--';
            if (volEl) volEl.textContent = volatility.toUpperCase() || '--';
            
            // Update session display
            const sessionEl = document.getElementById('decision-session');
            const currentSession = getCurrentSessionName();
            if (sessionEl) sessionEl.textContent = currentSession;
            
            // Update grade display
            const gradeEl = document.getElementById('decision-grade');
            const score = parseInt(document.getElementById('val-utcc-score')?.value) || 0;
            let grade = '--';
            if (score >= 85) grade = 'A+';
            else if (score >= 80) grade = 'A';
            else if (score >= 75) grade = 'B';
            else if (score > 0) grade = 'C';
            if (gradeEl) gradeEl.textContent = grade;
            
            // Update recommendation display
            const recTypeEl = document.getElementById('rec-entry-type');
            const recReasonEl = document.getElementById('rec-reason');
            const recBox = document.getElementById('entry-recommendation');
            
            if (recTypeEl) recTypeEl.textContent = recommendation.type;
            if (recReasonEl) recReasonEl.textContent = recommendation.reason;
            if (recBox) {
                recBox.classList.toggle('wait', recommendation.type === 'WAIT');
            }
            
            // Update button recommendation badges
            document.querySelectorAll('.entry-type-btn').forEach(btn => {
                btn.classList.remove('recommended');
            });
            const recBtnId = recommendation.type === 'MARKET' ? 'btn-market' : 
                             recommendation.type === 'LIMIT' ? 'btn-limit' : 
                             recommendation.type === 'SCALE' ? 'btn-scale' : null;
            if (recBtnId) {
                const recBtn = document.getElementById(recBtnId);
                if (recBtn) recBtn.classList.add('recommended');
            }
            
            // Show warning if selection differs
            const warningEl = document.getElementById('entry-decision-warning');
            const warningTextEl = document.getElementById('entry-warning-text');
            
            if (warningEl && recommendation.type !== 'WAIT') {
                const selectionDiffers = selectedEntryType.toUpperCase() !== recommendation.type;
                warningEl.style.display = selectionDiffers ? 'flex' : 'none';
                if (warningTextEl && selectionDiffers) {
                    warningTextEl.textContent = `You selected ${selectedEntryType.toUpperCase()} but ${recommendation.type} is recommended`;
                }
            } else if (warningEl) {
                warningEl.style.display = 'none';
            }
        }
        
        function getCurrentSessionName() {
            const now = new Date();
            const aestOffset = 11;
            const utcHours = now.getUTCHours();
            const aestHours = (utcHours + aestOffset) % 24;
            
            const tokyoActive = aestHours >= 9 && aestHours < 18;
            const londonActive = aestHours >= 17 || aestHours < 2;
            const nyActive = aestHours >= 22 || aestHours < 7;
            
            if (londonActive && nyActive) return 'LON/NY Overlap';
            if (nyActive) return 'New York';
            if (londonActive) return 'London';
            if (tokyoActive) return 'Tokyo';
            return 'Off-Hours';
        }
        
        function getCurrentSession() {
            const name = getCurrentSessionName();
            if (name === 'LON/NY Overlap') return 'overlap';
            if (name === 'New York') return 'newyork';
            if (name === 'London') return 'london';
            if (name === 'Tokyo') return 'tokyo';
            return null;
        }
        
        function getSessionPairRating(pair) {
            const session = getCurrentSession();
            if (!session || !sessionPairMatrix[session]) return { rating: 'NEUTRAL', session: 'Off-Hours' };
            
            const matrix = sessionPairMatrix[session];
            let rating = 'NEUTRAL';
            
            if (matrix.optimal.includes(pair)) rating = 'OPTIMAL';
            else if (matrix.acceptable.includes(pair)) rating = 'ACCEPTABLE';
            else if (matrix.avoid.includes(pair)) rating = 'AVOID';
            
            return { rating, session: getCurrentSessionName() };
        }
        
        // ============================================
        // ASSET CLASS DETECTION SYSTEM
        // ============================================
        
        const ASSET_CLASS_CONFIG = {
            forex: {
                symbols: ['AUDUSD', 'USDJPY', 'EURUSD', 'GBPUSD', 'EURJPY', 'GBPJPY', 'AUDCAD', 'AUDCHF', 'AUDJPY', 'AUDNZD', 'EURAUD', 'EURCAD', 'EURGBP', 'EURNZD', 'GBPAUD', 'GBPCAD', 'GBPCHF', 'GBPNZD', 'CADJPY', 'CHFJPY', 'NZDJPY', 'NZDCAD', 'NZDCHF', 'NZDUSD', 'USDCAD', 'USDCHF', 'CADCHF', 'EURCHF'],
                name: 'Forex',
                risk: '1.5-2%',
                bestSession: 'Depends on pair - check session rating',
                warning: null,
                details: 'Standard forex pair. Use session rating for optimal timing.'
            },
            metals: {
                symbols: ['XAUUSD', 'XAGUSD', 'XPTUSD', 'XCUUSD'],
                name: 'Metals',
                risk: '1.5%',
                bestSession: 'London/NY overlap (11pm-2am AEST)',
                warning: 'Inverse USD correlation. Check DXY direction.',
                details: 'Gold/Silver: Safe haven, inverse USD. Platinum/Copper: Industrial, risk-on.'
            },
            energy: {
                symbols: ['WTICOUSD', 'BCOUSD', 'NATGASUSD'],
                name: 'Energy',
                risk: '1%',
                bestSession: 'NYMEX hours (11:30pm-5am AEST)',
                warning: 'EIA Report Wednesday ~12:30am AEST - 4h buffer required!',
                details: 'Oil: OPEC/geopolitics driven. NatGas: Extremely volatile, weather sensitive.'
            },
            indices: {
                symbols: ['US30USD', 'SPX500USD', 'NAS100USD', 'US2000USD', 'DE30EUR', 'UK100GBP', 'FR40EUR', 'EU50EUR', 'JP225USD', 'JP225YJPY', 'HK33HKD', 'CN50USD', 'AU200AUD'],
                name: 'Indices',
                risk: '1.5%',
                bestSession: 'Match to index region',
                warning: null,
                details: 'US: 11:30pm-6am AEST. Europe: 5pm-1:30am. Asia: 10am-4pm.'
            },
            bonds: {
                symbols: ['USB02YUSD', 'USB05YUSD', 'USB10YUSD', 'USB30YUSD', 'UK10YBGBP', 'DE10YBEUR'],
                name: 'Bonds',
                risk: '1%',
                bestSession: 'NY session for US, London for EU',
                warning: 'CPI/FOMC = massive volatility. Price UP = Yield DOWN.',
                details: 'Long = betting yields fall. Short = betting yields rise. 30Y most volatile.'
            },
            crypto: {
                symbols: ['BTCUSD', 'MBTCUSD', 'ETHUSD', 'LTCUSD', 'BCHUSD'],
                name: 'Crypto',
                risk: '1% MAX',
                bestSession: 'US session (11pm-7am AEST)',
                warning: '24/7 market - reduced weekend liquidity. No circuit breakers!',
                details: 'BTC leads, alts follow. High correlation with NAS100. Sentiment driven.'
            }
        };
        
        function getAssetClass(symbol) {
            if (!symbol) return null;
            const upperSymbol = symbol.toUpperCase();
            
            for (const [className, config] of Object.entries(ASSET_CLASS_CONFIG)) {
                if (config.symbols.includes(upperSymbol)) {
                    return { class: className, ...config };
                }
            }
            return null;
        }
        
        function updateAssetClassInfo() {
            const pair = document.getElementById('val-pair')?.value;
            const panel = document.getElementById('asset-info-panel');
            const badge = document.getElementById('asset-class-badge');
            const riskEl = document.getElementById('asset-risk-suggest');
            const detailsEl = document.getElementById('asset-info-details');
            const warningEl = document.getElementById('asset-warning');
            
            if (!panel) return;
            
            if (!pair) {
                panel.classList.remove('active', 'forex', 'metals', 'energy', 'indices', 'bonds', 'crypto');
                return;
            }
            
            const assetInfo = getAssetClass(pair);
            
            if (!assetInfo) {
                panel.classList.remove('active');
                return;
            }
            
            // Update panel
            panel.classList.remove('forex', 'metals', 'energy', 'indices', 'bonds', 'crypto');
            panel.classList.add('active', assetInfo.class);
            
            badge.className = 'asset-info-badge ' + assetInfo.class;
            badge.textContent = assetInfo.name;
            
            riskEl.textContent = assetInfo.risk;
            
            detailsEl.innerHTML = '<strong>Session:</strong> ' + assetInfo.bestSession + '<br>' + assetInfo.details;
            
            if (assetInfo.warning) {
                warningEl.style.display = 'block';
                warningEl.innerHTML = 'WARNING: ' + assetInfo.warning;
            } else {
                warningEl.style.display = 'none';
            }
            
            // Check for specific time-based warnings
            checkAssetTimeWarnings(assetInfo, pair);
        }
        
        function checkAssetTimeWarnings(assetInfo, pair) {
            const warningEl = document.getElementById('asset-warning');
            const now = new Date();
            const dayOfWeek = now.getUTCDay();
            const utcHours = now.getUTCHours();
            
            // Energy: EIA warning on Wednesday
            if (assetInfo.class === 'energy') {
                // Wednesday in UTC (EIA is ~14:30 UTC = 12:30am AEST Thursday)
                if (dayOfWeek === 3 && utcHours >= 10 && utcHours <= 18) {
                    warningEl.style.display = 'block';
                    warningEl.innerHTML = '&#x1F6A8; <strong>EIA DAY!</strong> Report expected ~14:30 UTC. Avoid new entries until after release.';
                }
            }
            
            // Crypto: Weekend liquidity warning
            if (assetInfo.class === 'crypto') {
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    warningEl.style.display = 'block';
                    warningEl.innerHTML = 'WARNING: <strong>WEEKEND:</strong> Reduced liquidity, wider spreads. Consider smaller position or wait for Monday.';
                }
            }
            
            // Bonds: Check if near FOMC (simplified - would need calendar integration)
            // For now just show the standard warning
        }
        
        // Expose to global scope
        window.getAssetClass = getAssetClass;
        window.updateAssetClassInfo = updateAssetClassInfo;
        
        function updateSessionPairRating() {
            const pair = document.getElementById('val-pair')?.value;
            const ratingEl = document.getElementById('session-pair-rating');
            
            if (!ratingEl) return;
            
            if (!pair) {
                ratingEl.innerHTML = '';
                return;
            }
            
            const { rating, session } = getSessionPairRating(pair);
            
            const badgeClass = rating === 'OPTIMAL' ? 'rating-optimal' :
                              rating === 'ACCEPTABLE' ? 'rating-acceptable' :
                              rating === 'AVOID' ? 'rating-avoid' : 'rating-neutral';
            
            ratingEl.innerHTML = `
                <span class="rating-badge ${badgeClass}">${rating}</span>
                <span class="rating-text">for ${session} session</span>
            `;
        }
        
        function getCurrentKillZone() {
            const now = new Date();
            const aestOffset = 11;
            const utcHours = now.getUTCHours();
            const utcMins = now.getUTCMinutes();
            const aestHours = (utcHours + aestOffset) % 24;
            const aestMins = utcMins;
            const currentTime = aestHours + (aestMins / 60);
            
            for (const [key, zone] of Object.entries(killZones)) {
                const startTime = zone.startHour + (zone.startMin / 60);
                let endTime = zone.endHour + (zone.endMin / 60);
                
                // Handle overnight zones
                if (endTime < startTime) {
                    if (currentTime >= startTime || currentTime < endTime) {
                        const remaining = currentTime >= startTime ? 
                            (24 - currentTime) + endTime : endTime - currentTime;
                        return { ...zone, key, remainingMins: Math.round(remaining * 60) };
                    }
                } else {
                    if (currentTime >= startTime && currentTime < endTime) {
                        const remaining = endTime - currentTime;
                        return { ...zone, key, remainingMins: Math.round(remaining * 60) };
                    }
                }
            }
            return null;
        }
        
        function updateKillZoneIndicator() {
            const kzIndicator = document.getElementById('kill-zone-indicator');
            const killZone = getCurrentKillZone();
            
            if (!kzIndicator) return;
            
            if (killZone) {
                kzIndicator.style.display = 'flex';
                document.getElementById('kz-name').textContent = killZone.name;
                document.getElementById('kz-desc').textContent = killZone.description;
                document.getElementById('kz-pairs').textContent = `Optimal: ${killZone.pairs.join(', ')}`;
                document.getElementById('kz-timer').textContent = `${killZone.remainingMins} min`;
            } else {
                kzIndicator.style.display = 'none';
            }
        }
        
        function useStructureForLimit() {
            const slStructure = document.getElementById('val-sl-structure')?.value;
            const direction = document.getElementById('val-direction')?.value;
            const entry = document.getElementById('val-entry')?.value;
            
            // For long: limit should be at or below support
            // For short: limit should be at or above resistance
            // Use the entry price as the limit (assumes entry is at structure)
            
            if (entry) {
                document.getElementById('limit-entry-price').value = entry;
                updateLimitOrderCalcs();
                showToast('Limit price set from structure level', 'success');
            } else {
                showToast('Enter structure levels first', 'warning');
            }
        }
        
        function validateLimitOrder() {
            const limitPrice = parseFloat(document.getElementById('limit-entry-price')?.value) || 0;
            const entry = parseFloat(document.getElementById('val-entry')?.value) || 0;
            const slStructure = parseFloat(document.getElementById('val-sl-structure')?.value) || 0;
            const direction = document.getElementById('val-direction')?.value;
            const pair = document.getElementById('val-pair')?.value || '';
            const pipMultiplier = pair.includes('JPY') ? 100 : 10000;
            
            const validationEl = document.getElementById('limit-validation');
            const iconEl = document.getElementById('limit-val-icon');
            const textEl = document.getElementById('limit-val-text');
            
            if (!validationEl || !limitPrice) {
                if (validationEl) validationEl.style.display = 'none';
                return;
            }
            
            validationEl.style.display = 'flex';
            
            // Check distance from structure
            const distanceFromEntry = Math.abs(limitPrice - entry) * pipMultiplier;
            
            if (distanceFromEntry <= 5) {
                validationEl.className = 'limit-validation valid';
                iconEl.innerHTML = 'OK -';
                textEl.textContent = 'Limit at structure level - good entry';
            } else if (distanceFromEntry <= 15) {
                validationEl.className = 'limit-validation warning';
                iconEl.innerHTML = 'WARNING:';
                textEl.textContent = `${distanceFromEntry.toFixed(1)} pips from structure - consider adjusting`;
            } else {
                validationEl.className = 'limit-validation invalid';
                iconEl.innerHTML = '&#x23F3;';
                textEl.textContent = `${distanceFromEntry.toFixed(1)} pips from structure - in "no man\'s land"`;
            }
        }
        
        function updateScaleGradeCheck() {
            const score = parseInt(document.getElementById('val-utcc-score')?.value) || 0;
            const gradeCheckEl = document.getElementById('scale-grade-check');
            const iconEl = document.getElementById('scale-grade-icon');
            const textEl = document.getElementById('scale-grade-text');
            
            if (!gradeCheckEl) return;
            
            if (score >= 85) {
                gradeCheckEl.className = 'scale-grade-check pass';
                iconEl.innerHTML = 'OK -';
                textEl.textContent = `Score ${score} = A+ Grade - Scale-in approved`;
            } else if (score > 0) {
                gradeCheckEl.className = 'scale-grade-check warn';
                iconEl.innerHTML = 'WARNING:';
                textEl.textContent = `Score ${score} - Scale-in only for A+ (&#x2265;85). Consider Market/Limit instead.`;
            } else {
                gradeCheckEl.className = 'scale-grade-check';
                iconEl.innerHTML = '&#x23F3;';
                textEl.textContent = 'Enter UTCC score to verify eligibility';
            }
        }
        
        function selectEntryType(type) {
            selectedEntryType = type;
            
            // Update button states
            document.querySelectorAll('.entry-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            // Show/hide relevant details
            const limitDetails = document.getElementById('limit-order-details');
            const scaleDetails = document.getElementById('scale-in-details');
            
            if (limitDetails) {
                limitDetails.classList.toggle('visible', type === 'limit');
            }
            if (scaleDetails) {
                scaleDetails.classList.toggle('visible', type === 'scale');
            }
            
            updateEntryConfirmation();
        }
        
        function updateLimitOrderCalcs() {
            const limitPrice = parseFloat(document.getElementById('limit-entry-price')?.value) || 0;
            const currentEntry = parseFloat(document.getElementById('val-entry')?.value) || 0;
            const pair = document.getElementById('val-pair')?.value || '';
            const pipMultiplier = pair.includes('JPY') ? 100 : 10000;
            
            if (limitPrice && currentEntry) {
                const distance = Math.abs(limitPrice - currentEntry) * pipMultiplier;
                document.getElementById('limit-distance').value = distance.toFixed(1) + ' pips';
            } else {
                document.getElementById('limit-distance').value = '--';
            }
            
            updateEntryConfirmation();
        }
        
        function updateScaleCalcs() {
            const percent1 = parseInt(document.getElementById('scale-percent-1')?.value) || 0;
            const percent2 = parseInt(document.getElementById('scale-percent-2')?.value) || 0;
            const total = percent1 + percent2;
            
            const validationEl = document.getElementById('scale-validation');
            if (validationEl) {
                if (total === 100) {
                    validationEl.innerHTML = '<span style="color: var(--color-pass);">&#x2713; Total: 100% - Valid split</span>';
                } else if (total < 100) {
                    validationEl.innerHTML = `<span style="color: var(--color-warning);">WARNING: Total: ${total}% - Need ${100 - total}% more</span>`;
                } else {
                    validationEl.innerHTML = `<span style="color: var(--color-fail);">&#x2716; Total: ${total}% - Exceeds 100%</span>`;
                }
            }
            
            updateEntryConfirmation();
        }
        
        function updateSessionTiming() {
            const now = new Date();
            const aestOffset = 11; // AEDT (adjust to 10 for AEST)
            const utcHours = now.getUTCHours();
            const aestHours = (utcHours + aestOffset) % 24;
            
            // Session times in AEST
            // Tokyo: 09:00 - 18:00 AEST
            // London: 17:00 - 02:00 AEST
            // New York: 22:00 - 07:00 AEST
            
            const tokyoActive = aestHours >= 9 && aestHours < 18;
            const londonActive = aestHours >= 17 || aestHours < 2;
            const nyActive = aestHours >= 22 || aestHours < 7;
            
            const tokyoBox = document.getElementById('session-tokyo');
            const londonBox = document.getElementById('session-london');
            const nyBox = document.getElementById('session-newyork');
            
            if (tokyoBox) {
                tokyoBox.classList.toggle('active-session', tokyoActive);
                document.getElementById('tokyo-status').textContent = tokyoActive ? 'ACTIVE' : 'Closed';
            }
            if (londonBox) {
                londonBox.classList.toggle('active-session', londonActive);
                document.getElementById('london-status').textContent = londonActive ? 'ACTIVE' : 'Closed';
            }
            if (nyBox) {
                nyBox.classList.toggle('active-session', nyActive);
                document.getElementById('newyork-status').textContent = nyActive ? 'ACTIVE' : 'Closed';
            }
            
            // Check for low liquidity periods
            const anySessionActive = tokyoActive || londonActive || nyActive;
            const warningEl = document.getElementById('session-warning');
            
            if (warningEl) {
                if (!anySessionActive) {
                    warningEl.style.display = 'flex';
                    document.getElementById('session-warning-text').textContent = 
                        'Low liquidity period - spreads may be wider, consider waiting';
                } else {
                    warningEl.style.display = 'none';
                }
            }
            
            // Check Friday close warning
            const dayOfWeek = now.getDay();
            const isFriday = dayOfWeek === 5;
            const isNearClose = isFriday && aestHours >= 3 && aestHours < 7; // Fri close ~07:00 AEST
            
            if (isNearClose && warningEl) {
                warningEl.style.display = 'flex';
                document.getElementById('session-warning-text').textContent = 
                    'WARNING: Approaching Friday close - weekend gap risk!';
            }
            
            // Update Kill Zone indicator
            updateKillZoneIndicator();
            
            // Update Entry Decision Panel session info
            updateEntryDecisionPanel();
        }
        
        function updateEntryConfirmation() {
            const notNews = document.getElementById('timing-not-news')?.checked;
            const sessionOk = document.getElementById('timing-session-appropriate')?.checked;
            const notFriday = document.getElementById('timing-not-friday-close')?.checked;
            
            // Check entry type specific requirements
            let entryTypeValid = true;
            
            if (selectedEntryType === 'limit') {
                entryTypeValid = !!document.getElementById('limit-entry-price')?.value;
            } else if (selectedEntryType === 'scale') {
                const p1 = parseInt(document.getElementById('scale-percent-1')?.value) || 0;
                const p2 = parseInt(document.getElementById('scale-percent-2')?.value) || 0;
                const price1 = document.getElementById('scale-price-1')?.value;
                const price2 = document.getElementById('scale-price-2')?.value;
                entryTypeValid = (p1 + p2 === 100) && price1 && price2;
            }
            
            const allTimingChecked = notNews && sessionOk && notFriday;
            const allComplete = allTimingChecked && entryTypeValid;
            
            const iconEl = document.getElementById('entry-strategy-icon');
            const textEl = document.getElementById('entry-strategy-text');
            
            if (iconEl && textEl) {
                if (allComplete) {
                    iconEl.innerHTML = 'OK -';
                    textEl.textContent = `Entry strategy confirmed: ${selectedEntryType.toUpperCase()} order`;
                    textEl.style.color = 'var(--color-pass)';
                } else if (allTimingChecked || entryTypeValid) {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Complete all timing confirmations';
                    textEl.style.color = 'var(--color-warning)';
                } else {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Complete entry strategy setup';
                    textEl.style.color = 'var(--text-muted)';
                }
            }
            
            // Trigger overall validation update
            updateValidationVerdict();
        }
        
        // Update sessions on load and every minute
        function initEntryStrategy() {
            updateSessionTiming();
            setInterval(updateSessionTiming, 60000);
        }

        // ============================================
        // STOP LOSS STRATEGY FUNCTIONS
        // ============================================
        
        let selectedVolatility = 'trend';
        
        function selectVolatility(vol) {
            selectedVolatility = vol;
            
            // Update button states
            document.querySelectorAll('.volatility-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.vol === vol);
            });
            
            // Update advice text
            const adviceEl = document.getElementById('volatility-advice');
            const multiplierEl = document.getElementById('sl-atr-multiplier');
            
            const advice = {
                quiet: { text: '&#x1F634; QUIET conditions: Tighter stops acceptable. Use 0.75-1x ATR. Watch for breakout.', mult: 1.0 },
                trend: { text: '&#x1F4C8; TREND conditions: Standard stop distance. Use 1-1.5x ATR for balanced risk.', mult: 1.5 },
                explode: { text: '&#x1F4A5; EXPLODE conditions: Wider stops required! Use 1.5-2x ATR to avoid noise stops.', mult: 2.0 }
            };
            
            if (adviceEl) adviceEl.innerHTML = advice[vol].text;
            if (multiplierEl) multiplierEl.value = advice[vol].mult;
            
            calculateATRStop();
        }
        
        function calculateATRStop() {
            const atr = parseFloat(document.getElementById('sl-atr-value')?.value) || 0;
            const multiplier = parseFloat(document.getElementById('sl-atr-multiplier')?.value) || 1.5;
            const entry = parseFloat(document.getElementById('val-entry')?.value) || 0;
            const direction = document.getElementById('val-direction')?.value || '';
            const pair = document.getElementById('val-pair')?.value || '';
            
            const pipMultiplier = pair.includes('JPY') ? 100 : 10000;
            
            // Calculate SL distance
            const slDistance = atr * multiplier;
            const slPips = slDistance * pipMultiplier;
            
            // Update displays
            const pipsEl = document.getElementById('atr-sl-pips');
            const priceEl = document.getElementById('atr-sl-price');
            
            if (pipsEl) pipsEl.textContent = atr > 0 ? slPips.toFixed(1) : '--';
            
            if (priceEl && entry > 0 && atr > 0) {
                let slPrice;
                const dir = direction.toUpperCase();
                if (dir === 'LONG') {
                    slPrice = entry - slDistance;
                } else if (dir === 'SHORT') {
                    slPrice = entry + slDistance;
                }
                
                if (slPrice) {
                    const decimals = pair.includes('JPY') ? 3 : 5;
                    priceEl.textContent = slPrice.toFixed(decimals);
                } else {
                    priceEl.textContent = '--';
                }
            } else {
                if (priceEl) priceEl.textContent = '--';
            }
            
            updateSLStrategyStatus();
        }
        
        function syncStructureToBuffer() {
            const structureLevel = document.getElementById('val-sl-structure')?.value;
            const bufferField = document.getElementById('sl-structure-level');
            if (bufferField && structureLevel) {
                bufferField.value = structureLevel;
            }
            
            // Also sync direction
            const mainDirection = document.getElementById('val-direction')?.value;
            const bufferDirection = document.getElementById('sl-direction');
            if (bufferDirection && mainDirection) {
                bufferDirection.value = mainDirection;
            }
            
            calculateBufferedSL();
        }
        
        function calculateBufferedSL() {
            const structureLevel = parseFloat(document.getElementById('sl-structure-level')?.value) || 0;
            const bufferPips = parseFloat(document.getElementById('sl-buffer-pips')?.value) || 5;
            const direction = document.getElementById('sl-direction')?.value || '';
            const pair = document.getElementById('val-pair')?.value || '';
            
            const resultEl = document.getElementById('sl-final-result');
            const priceEl = document.getElementById('sl-final-price');
            
            if (!structureLevel || !direction) {
                if (resultEl) resultEl.style.display = 'none';
                return;
            }
            
            const pipValue = pair.includes('JPY') ? 0.01 : 0.0001;
            const bufferDistance = bufferPips * pipValue;
            
            let finalSL;
            if (direction === 'long') {
                finalSL = structureLevel - bufferDistance;
            } else {
                finalSL = structureLevel + bufferDistance;
            }
            
            const decimals = pair.includes('JPY') ? 3 : 5;
            
            if (resultEl) resultEl.style.display = 'block';
            if (priceEl) priceEl.textContent = finalSL.toFixed(decimals);
            
            updateSLStrategyStatus();
        }
        
        function applySLToValidation() {
            const finalSL = document.getElementById('sl-final-price')?.textContent;
            const valStop = document.getElementById('val-stop');
            
            if (finalSL && finalSL !== '--' && valStop) {
                valStop.value = finalSL;
                calculateStructureLevels();
                showToast('SL applied to validation', 'success');
            }
        }
        
        function updateSLStrategyStatus() {
            const confirmed = document.getElementById('sl-strategy-confirmed')?.checked;
            const hasATR = !!document.getElementById('sl-atr-value')?.value;
            const hasBuffer = !!document.getElementById('sl-structure-level')?.value;
            
            const iconEl = document.getElementById('sl-strategy-icon');
            const textEl = document.getElementById('sl-strategy-text');
            
            if (iconEl && textEl) {
                if (confirmed) {
                    iconEl.innerHTML = 'OK -';
                    textEl.textContent = 'Stop loss strategy confirmed';
                    textEl.style.color = 'var(--color-pass)';
                } else if (hasATR || hasBuffer) {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Confirm stop loss placement';
                    textEl.style.color = 'var(--color-warning)';
                } else {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Configure stop loss strategy';
                    textEl.style.color = 'var(--text-muted)';
                }
            }
            
            updateValidationVerdict();
        }

        // ============================================
        // EXIT MANAGEMENT FUNCTIONS
        // ============================================
        
        function updateExitPartials() {
            const tp1Percent = parseInt(document.getElementById('exit-tp1-percent')?.value) || 50;
            const tp2PercentEl = document.getElementById('exit-tp2-percent');
            
            if (tp2PercentEl) {
                tp2PercentEl.value = 100 - tp1Percent;
            }
            
            const validationEl = document.getElementById('partials-validation');
            if (validationEl) {
                if (tp1Percent >= 25 && tp1Percent <= 75) {
                    validationEl.innerHTML = `<span style="color: var(--color-pass);">&#x2713; TP1: ${tp1Percent}% | TP2: ${100 - tp1Percent}%</span>`;
                } else {
                    validationEl.innerHTML = `<span style="color: var(--color-warning);">WARNING: Keep TP1 between 25-75%</span>`;
                }
            }
            
            updateExitPlanStatus();
        }
        
        function syncTPtoExitPlan() {
            const valTp1 = document.getElementById('val-tp1')?.value;
            const valTp2 = document.getElementById('val-tp2')?.value;
            const tp1Price = document.getElementById('exit-tp1-price');
            const tp2Price = document.getElementById('exit-tp2-price');
            
            if (tp1Price && valTp1) {
                tp1Price.value = valTp1;
            }
            if (tp2Price && valTp2) {
                tp2Price.value = valTp2;
            }
            
            updateExitPlanStatus();
        }
        
        function updateExitPlan() {
            // Sync with Structure Analysis TP values if empty
            const tp1Price = document.getElementById('exit-tp1-price');
            const tp2Price = document.getElementById('exit-tp2-price');
            const valTp1 = document.getElementById('val-tp1')?.value;
            const valTp2 = document.getElementById('val-tp2')?.value;
            
            if (tp1Price && !tp1Price.value && valTp1) {
                tp1Price.value = valTp1;
            }
            if (tp2Price && !tp2Price.value && valTp2) {
                tp2Price.value = valTp2;
            }
            
            updateExitPlanStatus();
        }
        
        function updateTrailMethod() {
            const atrInput = document.getElementById('trail-atr-multiple');
            const fixedInput = document.getElementById('trail-fixed-pips');
            const atrRadio = document.getElementById('trail-atr');
            const fixedRadio = document.getElementById('trail-fixed');
            
            if (atrInput) atrInput.disabled = !atrRadio?.checked;
            if (fixedInput) fixedInput.disabled = !fixedRadio?.checked;
            
            updateExitPlanStatus();
        }
        
        function updateExitPlanStatus() {
            const planAcknowledged = document.getElementById('exit-plan-acknowledged')?.checked;
            const oppositeSignal = document.getElementById('exit-opposite-signal')?.checked;
            const tp1Price = document.getElementById('exit-tp1-price')?.value;
            
            const allComplete = planAcknowledged && oppositeSignal;
            const hasPartialSetup = tp1Price || planAcknowledged || oppositeSignal;
            
            const iconEl = document.getElementById('exit-plan-icon');
            const textEl = document.getElementById('exit-plan-text');
            
            if (iconEl && textEl) {
                if (allComplete) {
                    iconEl.innerHTML = 'OK -';
                    textEl.textContent = 'Exit management plan confirmed';
                    textEl.style.color = 'var(--color-pass)';
                } else if (hasPartialSetup) {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Complete exit plan confirmations';
                    textEl.style.color = 'var(--color-warning)';
                } else {
                    iconEl.innerHTML = '&#x23F3;';
                    textEl.textContent = 'Configure exit management plan';
                    textEl.style.color = 'var(--text-muted)';
                }
            }
            
            updateValidationVerdict();
        }
        
        function syncTPFromStructure() {
            const valTp1 = document.getElementById('val-tp1')?.value;
            const valTp2 = document.getElementById('val-tp2')?.value;
            const exitTp1 = document.getElementById('exit-tp1-price');
            const exitTp2 = document.getElementById('exit-tp2-price');
            
            if (exitTp1 && valTp1) exitTp1.value = valTp1;
            if (exitTp2 && valTp2) exitTp2.value = valTp2;
            
            updateExitPartials();
        }

        function updateStructureAnalysis() {
            // Update step completion status
            const step1Complete = document.getElementById('sl-swing-identified')?.checked && 
                                  document.getElementById('sl-buffer-added')?.checked;
            const step3Complete = document.getElementById('tp-structure-identified')?.checked && 
                                  document.getElementById('tp-path-clear')?.checked;
            const step4Complete = document.getElementById('rr-acceptable')?.checked;
            
            // Visual updates for steps
            const step1El = document.getElementById('structure-step-1');
            const step3El = document.getElementById('structure-step-3');
            const step4El = document.getElementById('structure-step-4');
            
            if (step1El) step1El.classList.toggle('completed', step1Complete);
            if (step3El) step3El.classList.toggle('completed', step3Complete);
            if (step4El) step4El.classList.toggle('completed', step4Complete);
            
            // Check step 2 (entry price filled)
            const entryFilled = !!document.getElementById('val-entry')?.value;
            const step2El = document.getElementById('structure-step-2');
            if (step2El) step2El.classList.toggle('completed', entryFilled);
            
            // Update overall validation verdict
            updateValidationVerdict();
        }

        function calculateStructureLevels() {
            const entry = parseFloat(document.getElementById('val-entry')?.value) || 0;
            const stop = parseFloat(document.getElementById('val-stop')?.value) || 0;
            const tp1 = parseFloat(document.getElementById('val-tp1')?.value) || 0;
            const tp2 = parseFloat(document.getElementById('val-tp2')?.value) || 0;
            
            // Get pip multiplier based on pair
            const pair = document.getElementById('val-pair')?.value || '';
            const pipMultiplier = pair.includes('JPY') ? 100 : 10000;
            
            // Calculate risk and reward in pips
            const riskPips = entry && stop ? Math.abs(entry - stop) * pipMultiplier : 0;
            const rewardPips = entry && tp1 ? Math.abs(tp1 - entry) * pipMultiplier : 0;
            const reward2Pips = entry && tp2 ? Math.abs(tp2 - entry) * pipMultiplier : 0;
            
            // Update displays
            const riskEl = document.getElementById('calc-risk-pips');
            const rewardEl = document.getElementById('calc-reward-pips');
            const rr1El = document.getElementById('calc-rr-tp1');
            const rr2El = document.getElementById('calc-rr-tp2');
            
            if (riskEl) riskEl.textContent = riskPips > 0 ? riskPips.toFixed(1) : '--';
            if (rewardEl) rewardEl.textContent = rewardPips > 0 ? rewardPips.toFixed(1) : '--';
            
            // Calculate R:R
            let rr1 = 0, rr2 = 0;
            if (riskPips > 0 && rewardPips > 0) {
                rr1 = rewardPips / riskPips;
            }
            if (riskPips > 0 && reward2Pips > 0) {
                rr2 = reward2Pips / riskPips;
            }
            
            // Update R:R displays with styling
            if (rr1El) {
                rr1El.textContent = rr1 > 0 ? `1:${rr1.toFixed(2)}` : '--';
                const rr1Box = rr1El.closest('.rr-stat');
                if (rr1Box) {
                    rr1Box.classList.remove('rr-good', 'rr-bad', 'highlight');
                    if (rr1 >= 1.5) rr1Box.classList.add('rr-good');
                    else if (rr1 > 0 && rr1 < 1) rr1Box.classList.add('rr-bad');
                    else rr1Box.classList.add('highlight');
                }
            }
            
            if (rr2El) {
                rr2El.textContent = rr2 > 0 ? `1:${rr2.toFixed(2)}` : '--';
            }
            
            // Update R:R verdict
            const verdictEl = document.getElementById('rr-verdict');
            if (verdictEl) {
                if (rr1 >= 1.5) {
                    verdictEl.className = 'rr-verdict verdict-good';
                    verdictEl.innerHTML = '<span class="rr-verdict-icon">OK -</span><span class="rr-verdict-text">Good R:R - Trade is worth taking</span>';
                } else if (rr1 > 0 && rr1 < 1.5) {
                    verdictEl.className = 'rr-verdict verdict-bad';
                    verdictEl.innerHTML = '<span class="rr-verdict-icon">WARNING:</span><span class="rr-verdict-text">Poor R:R - Consider skipping this trade</span>';
                } else {
                    verdictEl.className = 'rr-verdict';
                    verdictEl.innerHTML = '<span class="rr-verdict-icon">&#x23F3;</span><span class="rr-verdict-text">Enter levels to calculate R:R</span>';
                }
            }
            
            // Trigger structure analysis update
            updateStructureAnalysis();
        }

        function updateValidationVerdict() {
            const verdictBox = document.getElementById('validation-verdict');
            const verdictStatus = document.getElementById('verdict-status');
            const verdictDesc = document.getElementById('verdict-reason');
            const executeBtn = document.getElementById('execute-trade-btn');
            
            if (!verdictBox) return;
            
            // Check entry strategy requirements
            const notNews = document.getElementById('timing-not-news')?.checked;
            const sessionOk = document.getElementById('timing-session-appropriate')?.checked;
            const notFriday = document.getElementById('timing-not-friday-close')?.checked;
            const entryTimingComplete = notNews && sessionOk && notFriday;
            
            // Check SL strategy
            const slStrategyConfirmed = document.getElementById('sl-strategy-confirmed')?.checked;
            
            // Check exit plan
            const exitPlanConfirmed = document.getElementById('exit-plan-acknowledged')?.checked && 
                                      document.getElementById('exit-opposite-signal')?.checked;
            
            // Check all requirements
            const utccArmed = document.getElementById('check-utcc-armed')?.value;
            const utccValid = utccArmed === 'armed_long' || utccArmed === 'armed_short';
            
            const checks = {
                pair: !!document.getElementById('val-pair')?.value,
                direction: !!document.getElementById('val-direction')?.value,
                utccScore: utccValid,
                slStructure: document.getElementById('sl-swing-identified')?.checked && 
                             document.getElementById('sl-buffer-added')?.checked,
                tpStructure: document.getElementById('tp-structure-identified')?.checked && 
                             document.getElementById('tp-path-clear')?.checked,
                rrAcceptable: document.getElementById('rr-acceptable')?.checked,
                entryStrategy: entryTimingComplete,
                slStrategy: slStrategyConfirmed,
                exitPlan: exitPlanConfirmed,
                correlation: document.getElementById('correlation-accepted')?.checked,
                finalStructure: document.getElementById('final-structure-supports')?.checked,
                finalRisk: document.getElementById('final-risk-sized')?.checked
            };
            
            const totalChecks = Object.values(checks).filter(v => v).length;
            const allComplete = Object.values(checks).every(v => v);
            const totalRequired = Object.keys(checks).length;
            
            let verdict, desc, className;
            
            if (allComplete) {
                verdict = '&#x2714; TRADE READY';
                desc = 'All checks passed. Execute with confidence!';
                className = 'verdict-ready';
                if (executeBtn) executeBtn.disabled = false;
            } else if (totalChecks >= totalRequired - 3) {
                verdict = '&#x23F3; ALMOST READY';
                desc = `${totalRequired - totalChecks} more checks needed`;
                className = 'verdict-pending';
                if (executeBtn) executeBtn.disabled = true;
            } else {
                verdict = '&#x23F3; INCOMPLETE';
                desc = `Complete structure analysis and confirmations (${totalChecks}/${totalRequired})`;
                className = 'verdict-pending';
                if (executeBtn) executeBtn.disabled = true;
            }
            
            verdictBox.className = `verdict-box ${className}`;
            if (verdictStatus) verdictStatus.innerHTML = verdict;
            if (verdictDesc) verdictDesc.textContent = desc;
        }

        function resetValidation() {
            // Clear all inputs
            document.querySelectorAll('#tab-validation input, #tab-validation select').forEach(el => {
                if (el.type === 'checkbox') {
                    el.checked = false;
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else {
                    el.value = '';
                }
            });
            
            // Reset structure step styling
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`structure-step-${i}`);
                if (stepEl) stepEl.classList.remove('completed');
            }
            
            // Reset R:R displays
            const rrElements = ['calc-risk-pips', 'calc-reward-pips', 'calc-rr-tp1', 'calc-rr-tp2'];
            rrElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '--';
            });
            
            // Reset R:R verdict
            const rrVerdict = document.getElementById('rr-verdict');
            if (rrVerdict) {
                rrVerdict.className = 'rr-verdict';
                rrVerdict.innerHTML = '<span class="rr-verdict-icon">&#x23F3;</span><span class="rr-verdict-text">Enter levels to calculate R:R</span>';
            }
            
            // Reset verdict
            const verdictBox = document.getElementById('validation-verdict');
            const verdictStatus = document.getElementById('verdict-status');
            const verdictDesc = document.getElementById('verdict-reason');
            const executeBtn = document.getElementById('execute-trade-btn');
            
            if (verdictBox) verdictBox.className = 'verdict-box';
            if (verdictStatus) verdictStatus.innerHTML = '&#x23F3; INCOMPLETE';
            if (verdictDesc) verdictDesc.textContent = 'Complete structure analysis and confirmations';
            if (executeBtn) executeBtn.disabled = true;
            
            // Hide education if open
            const eduEl = document.getElementById('structure-education');
            if (eduEl) eduEl.style.display = 'none';
            
            // Reset entry strategy
            selectEntryType('market');
            const limitDetails = document.getElementById('limit-order-details');
            const scaleDetails = document.getElementById('scale-in-details');
            if (limitDetails) limitDetails.classList.remove('visible');
            if (scaleDetails) scaleDetails.classList.remove('visible');
            
            // Reset entry strategy summary
            const entryIcon = document.getElementById('entry-strategy-icon');
            const entryText = document.getElementById('entry-strategy-text');
            if (entryIcon) entryIcon.innerHTML = '&#x23F3;';
            if (entryText) {
                entryText.textContent = 'Complete entry strategy setup';
                entryText.style.color = 'var(--text-muted)';
            }
            
            // Reset SL strategy
            selectVolatility('trend');
            document.getElementById('sl-atr-value').value = '';
            document.getElementById('sl-atr-multiplier').value = '1.5';
            const slStructEl = document.getElementById('sl-structure-level');
            if (slStructEl) slStructEl.value = '';
            const slBufferEl = document.getElementById('sl-buffer-pips');
            if (slBufferEl) slBufferEl.value = '5';
            const slDirEl = document.getElementById('sl-direction');
            if (slDirEl) slDirEl.selectedIndex = 0;
            document.getElementById('sl-strategy-confirmed').checked = false;
            
            const slResult = document.getElementById('sl-final-result');
            if (slResult) slResult.style.display = 'none';
            
            const atrPips = document.getElementById('atr-sl-pips');
            const atrPrice = document.getElementById('atr-sl-price');
            if (atrPips) atrPips.textContent = '--';
            if (atrPrice) atrPrice.textContent = '--';
            
            // Reset SL strategy summary
            const slIcon = document.getElementById('sl-strategy-icon');
            const slText = document.getElementById('sl-strategy-text');
            if (slIcon) slIcon.innerHTML = '&#x23F3;';
            if (slText) {
                slText.textContent = 'Configure stop loss strategy';
                slText.style.color = 'var(--text-muted)';
            }
            
            // Reset Exit Management
            document.getElementById('exit-tp1-percent').value = '50';
            document.getElementById('exit-tp2-percent').value = '50';
            document.getElementById('exit-tp1-price').value = '';
            document.getElementById('exit-tp2-price').value = '';
            document.getElementById('trail-breakeven').checked = true;
            document.getElementById('trail-atr-multiple').disabled = true;
            document.getElementById('trail-fixed-pips').disabled = true;
            document.getElementById('time-stop-hours').value = '24';
            document.getElementById('exit-plan-acknowledged').checked = false;
            document.getElementById('exit-opposite-signal').checked = false;
            
            const partialsVal = document.getElementById('partials-validation');
            if (partialsVal) partialsVal.innerHTML = '';
            
            // Reset Exit Plan summary
            const exitIcon = document.getElementById('exit-plan-icon');
            const exitText = document.getElementById('exit-plan-text');
            if (exitIcon) exitIcon.innerHTML = '&#x23F3;';
            if (exitText) {
                exitText.textContent = 'Configure exit management plan';
                exitText.style.color = 'var(--text-muted)';
            }
            
            // Reset Correlation
            const corrStatus = document.getElementById('correlation-status');
            const corrBlock = document.getElementById('correlation-block');
            const corrAccepted = document.getElementById('correlation-accepted');
            const corrOverride = document.getElementById('correlation-override');
            const corrOverrideWarning = document.getElementById('correlation-override-warning');
            
            if (corrStatus) {
                corrStatus.className = 'correlation-status';
                corrStatus.innerHTML = '<div class="correlation-status-icon">&#x23F3;</div><div class="correlation-status-text">Select a pair to check correlation</div>';
            }
            if (corrBlock) corrBlock.style.display = 'none';
            if (corrAccepted) corrAccepted.checked = false;
            if (corrOverride) corrOverride.checked = false;
            if (corrOverrideWarning) corrOverrideWarning.style.display = 'none';
            
            showToast('Validation reset', 'info');
        }

        // ============================================
        // CORRELATION CHECK
        // ============================================
        
        function checkCorrelation() {
            const selectedPair = document.getElementById('val-pair')?.value;
            const statusEl = document.getElementById('correlation-status');
            const blockEl = document.getElementById('correlation-block');
            const acceptedEl = document.getElementById('correlation-accepted');
            const overrideEl = document.getElementById('correlation-override');
            
            // Reset override checkbox
            if (overrideEl) overrideEl.checked = false;
            document.getElementById('correlation-override-warning').style.display = 'none';
            
            if (!selectedPair) {
                if (statusEl) {
                    statusEl.className = 'correlation-status';
                    statusEl.innerHTML = '<div class="correlation-status-icon">&#x23F3;</div><div class="correlation-status-text">Select a pair to check correlation</div>';
                }
                if (blockEl) blockEl.style.display = 'none';
                if (acceptedEl) acceptedEl.checked = false;
                updateValidationVerdict();
                return;
            }
            
            // Get open trades from journal
            const trades = JSON.parse(localStorage.getItem('forexTrades') || '[]');
            const openTrades = trades.filter(t => t.status === 'open');
            
            if (openTrades.length === 0) {
                if (statusEl) {
                    statusEl.className = 'correlation-status status-clear';
                    statusEl.innerHTML = '<div class="correlation-status-icon">OK -</div><div class="correlation-status-text">No open positions - no correlation risk</div>';
                }
                if (blockEl) blockEl.style.display = 'none';
                if (acceptedEl) acceptedEl.checked = true; // Auto-accept when clear
                updateValidationVerdict();
                return;
            }
            
            // Find which currencies are in the selected pair
            const selectedCurrencies = [];
            for (const [currency, pairs] of Object.entries(correlationGroups)) {
                if (pairs.includes(selectedPair)) {
                    selectedCurrencies.push(currency);
                }
            }
            
            // Check if any open trades share the same currency exposure
            const correlatedPairs = [];
            for (const trade of openTrades) {
                for (const currency of selectedCurrencies) {
                    if (correlationGroups[currency]?.includes(trade.pair)) {
                        correlatedPairs.push(trade.pair);
                        break;
                    }
                }
            }
            
            // Remove duplicates and the selected pair itself
            const uniqueCorrelated = [...new Set(correlatedPairs)].filter(p => p !== selectedPair);
            
            if (uniqueCorrelated.length > 0) {
                // BLOCKED - correlated exposure detected
                if (statusEl) {
                    statusEl.className = 'correlation-status status-warning';
                    statusEl.innerHTML = `<div class="correlation-status-icon">&#x1F6AB;</div><div class="correlation-status-text">BLOCKED: Correlated with ${uniqueCorrelated.join(', ')}</div>`;
                }
                if (blockEl) {
                    blockEl.style.display = 'block';
                    document.getElementById('correlation-block-reason').textContent = 
                        `You have open positions in ${uniqueCorrelated.join(', ')} which share currency exposure with ${selectedPair}.`;
                }
                if (acceptedEl) acceptedEl.checked = false; // Block until override
                updateValidationVerdict();
            } else {
                // CLEAR - no correlation
                if (statusEl) {
                    statusEl.className = 'correlation-status status-clear';
                    statusEl.innerHTML = '<div class="correlation-status-icon">OK -</div><div class="correlation-status-text">No correlated open positions</div>';
                }
                if (blockEl) blockEl.style.display = 'none';
                if (acceptedEl) acceptedEl.checked = true; // Auto-accept when clear
                updateValidationVerdict();
            }
        }
        
        function handleCorrelationOverride() {
            const overrideChecked = document.getElementById('correlation-override')?.checked;
            const warningEl = document.getElementById('correlation-override-warning');
            const acceptedEl = document.getElementById('correlation-accepted');
            
            if (warningEl) {
                warningEl.style.display = overrideChecked ? 'block' : 'none';
            }
            
            if (acceptedEl) {
                acceptedEl.checked = overrideChecked;
            }
            
            if (overrideChecked) {
                showToast('Correlation override accepted - USE HALF POSITION SIZE', 'warning');
            }
            
            updateValidationVerdict();
        }


        function executeTradeFromValidation() {
            // Get core validation data
            const pair = document.getElementById('val-pair')?.value;
            const direction = document.getElementById('val-direction')?.value;
            const timeframe = document.getElementById('val-timeframe')?.value;
            const utccScore = document.getElementById('val-utcc-score')?.value;
            const volatility = document.getElementById('val-volatility')?.value;
            const entryZone = document.getElementById('val-entry-zone')?.value;
            const atrPct = document.getElementById('val-atr-pct')?.value;
            
            // Get structure analysis data
            const entry = document.getElementById('val-entry')?.value;
            const stop = document.getElementById('val-stop')?.value;
            const tp1 = document.getElementById('val-tp1')?.value;
            const tp2 = document.getElementById('val-tp2')?.value;
            
            // Get entry strategy data (Chunk 2)
            const entryType = selectedEntryType || 'market';
            const limitPrice = document.getElementById('limit-entry-price')?.value;
            const scalePrice1 = document.getElementById('scale-price-1')?.value;
            const scalePrice2 = document.getElementById('scale-price-2')?.value;
            const scalePercent1 = document.getElementById('scale-percent-1')?.value;
            const scalePercent2 = document.getElementById('scale-percent-2')?.value;
            
            // Get SL strategy data (Chunk 3)
            const atrValue = document.getElementById('sl-atr-value')?.value;
            const atrMultiplier = document.getElementById('sl-atr-multiplier')?.value;
            const slFinalPrice = document.getElementById('sl-final-price')?.textContent;
            
            // Get exit management data (Chunk 4)
            const tp1Percent = document.getElementById('exit-tp1-percent')?.value || '50';
            const tp2Percent = document.getElementById('exit-tp2-percent')?.value || '50';
            const tp1Price = document.getElementById('exit-tp1-price')?.value;
            const tp2Price = document.getElementById('exit-tp2-price')?.value;
            const trailMethod = document.querySelector('input[name="trail-method"]:checked')?.value || 'breakeven';
            const trailAtrMultiple = document.getElementById('trail-atr-multiple')?.value;
            const trailFixedPips = document.getElementById('trail-fixed-pips')?.value;
            const timeStopHours = document.getElementById('time-stop-hours')?.value || '24';
            
            // Get correlation override status (Chunk 5)
            const correlationOverride = document.getElementById('correlation-override')?.checked || false;
            
            if (!pair || !direction) {
                showToast('Please select pair and direction', 'warning');
                return;
            }
            
            // Build comprehensive notes
            let notes = [];
            
            // Entry strategy details
            if (entryType === 'limit' && limitPrice) {
                notes.push(`Entry: LIMIT @ ${limitPrice}`);
            } else if (entryType === 'scale' && scalePrice1 && scalePrice2) {
                notes.push(`Entry: SCALE-IN - ${scalePercent1}% @ ${scalePrice1}, ${scalePercent2}% @ ${scalePrice2}`);
            } else {
                notes.push(`Entry: MARKET @ ${entry || 'current'}`);
            }
            
            // Exit plan details
            notes.push(`Exit Plan: TP1 ${tp1Percent}% @ ${tp1Price || tp1 || '--'}, TP2 ${tp2Percent}% @ ${tp2Price || tp2 || '--'}`);
            notes.push(`Trail: ${trailMethod.toUpperCase()}${trailMethod === 'atr' ? ` (${trailAtrMultiple}x)` : trailMethod === 'fixed' ? ` (${trailFixedPips} pips)` : ''}`);
            notes.push(`Time Stop: ${timeStopHours}h`);
            
            // SL strategy
            if (atrValue && atrMultiplier) {
                notes.push(`SL Strategy: ATR ${atrValue} &#xD7; ${atrMultiplier}`);
            }
            
            // Correlation warning
            if (correlationOverride) {
                notes.push(`WARNING: CORRELATION OVERRIDE - Half position size!`);
            }
            
            // Switch to journal tab and pre-fill
            showTab('journal');
            
            setTimeout(() => {
                // Pre-fill journal form
                const tradeDateEl = document.getElementById('trade-datetime');
                const tradePairEl = document.getElementById('trade-pair');
                const tradeDirEl = document.getElementById('trade-direction');
                const tradeEntryEl = document.getElementById('trade-entry');
                const tradeStopEl = document.getElementById('trade-stop');
                const tradeTpEl = document.getElementById('trade-tp');
                const tradeScoreEl = document.getElementById('trade-trend-score');
                const tradeZoneEl = document.getElementById('trade-entry-zone');
                const tradeVolEl = document.getElementById('trade-vol-state');
                const tradeMtfEl = document.getElementById('trade-mtf');
                const tradeSessionEl = document.getElementById('trade-session');
                const tradeNotesEl = document.getElementById('trade-notes');
                const tradeAlertEl = document.getElementById('trade-alert-type');
                
                if (tradeDateEl) tradeDateEl.value = new Date().toISOString().slice(0, 16);
                if (tradePairEl) tradePairEl.value = pair;
                if (tradeDirEl) tradeDirEl.value = direction;
                
                // Use appropriate entry price based on entry type
                let entryPrice = entry;
                if (entryType === 'limit' && limitPrice) entryPrice = limitPrice;
                else if (entryType === 'scale' && scalePrice1) entryPrice = scalePrice1;
                if (tradeEntryEl) tradeEntryEl.value = entryPrice || '';
                
                // Use final SL price if calculated, otherwise use structure SL
                const finalStop = (slFinalPrice && slFinalPrice !== '--') ? slFinalPrice : stop;
                if (tradeStopEl) tradeStopEl.value = finalStop || '';
                
                if (tradeTpEl) tradeTpEl.value = tp1Price || tp1 || '';
                if (tradeScoreEl) tradeScoreEl.value = utccScore || '';
                if (tradeZoneEl) tradeZoneEl.value = entryZone?.toUpperCase() || '';
                if (tradeVolEl) tradeVolEl.value = volatility?.toUpperCase() || '';
                
                // MTF is captured from checkboxes
                const mtfCount = [
                    document.getElementById('check-timing-session')?.checked,
                    document.getElementById('check-timing-news')?.checked,
                    document.getElementById('check-timing-friday')?.checked
                ].filter(Boolean).length;
                if (tradeMtfEl) tradeMtfEl.value = `${mtfCount}/3`;
                
                if (tradeAlertEl) tradeAlertEl.value = 'TRADE_READY';
                if (tradeNotesEl) tradeNotesEl.value = notes.join('\n');
                
                // Determine session based on current time (AEST)
                const hour = new Date().getHours();
                let session = 'asian';
                if (hour >= 17 && hour < 22) session = 'london';
                else if (hour >= 22 || hour < 6) session = 'ny';
                if (tradeSessionEl) tradeSessionEl.value = session;
                
                // v2.9.0: Auto-populate Permission Log from Regime module
                try {
                    let regimeData = null;
                    if (window.RegimeModule && RegimeModule.loadRegimeData) {
                        regimeData = RegimeModule.loadRegimeData();
                    }
                    const sessionData = regimeData?.sessions?.[session] || {};
                    
                    // Populate hidden fields
                    const setHidden = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
                    setHidden('trade-market-regime', sessionData.regime || regimeData?.dailyContext?.regime || '');
                    setHidden('trade-structure-quality', sessionData.structure || '');
                    setHidden('trade-vol-context', sessionData.volatility || '');
                    setHidden('trade-session-window', sessionData.sessionWindow || '');
                    setHidden('trade-permission-state', sessionData.permissionState || 'full');
                    
                    // Build decision reason from available data
                    const parts = [];
                    if (sessionData.regime) parts.push(sessionData.regime);
                    if (sessionData.structure) parts.push(sessionData.structure);
                    if (sessionData.sessionWindow) parts.push(sessionData.sessionWindow);
                    if (parts.length > 0) {
                        setHidden('trade-permission-reason', parts.join(' + ') + ' = ' + (sessionData.permissionState || 'FULL').toUpperCase());
                    }
                    
                    // Update read-only display
                    updatePermissionLogDisplay();
                } catch (e) {
                    console.warn('[Execute] Permission log auto-fill error:', e);
                }
                
                showToast('Trade details transferred to journal', 'success');
            }, 100);
        }

        // Add validation-specific styles
        const validationStyles = document.createElement('style');
        validationStyles.textContent = `
            .criteria-item {
                padding: var(--spacing-md);
                border: 1px solid var(--border-primary);
                border-radius: var(--radius-md);
                margin-bottom: var(--spacing-sm);
                transition: all var(--transition-fast);
            }
            .criteria-item.pass {
                border-color: var(--color-pass);
                background: rgba(34, 197, 94, 0.1);
            }
            .criteria-item.fail {
                border-color: var(--color-fail);
                background: rgba(239, 68, 68, 0.1);
            }
            .criteria-header {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
            }
            .criteria-number {
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--bg-tertiary);
                border-radius: 50%;
                font-weight: 600;
                font-size: 0.9rem;
            }
            .criteria-item.pass .criteria-number {
                background: var(--color-pass);
                color: white;
            }
            .criteria-item.fail .criteria-number {
                background: var(--color-fail);
                color: white;
            }
            .criteria-title {
                font-weight: 500;
            }
            .criteria-sub {
                margin-top: var(--spacing-sm);
                padding-left: calc(28px + var(--spacing-md));
            }
            .verdict-box {
                padding: var(--spacing-lg);
                border-radius: var(--radius-lg);
                text-align: center;
                margin-top: var(--spacing-lg);
            }
            .verdict-ready {
                background: rgba(34, 197, 94, 0.15);
                border: 2px solid var(--color-pass);
            }
            .verdict-blocked {
                background: rgba(239, 68, 68, 0.15);
                border: 2px solid var(--color-fail);
            }
            .verdict-caution {
                background: rgba(234, 179, 8, 0.15);
                border: 2px solid var(--color-warning);
            }
            .verdict-pending {
                background: var(--bg-tertiary);
                border: 2px solid var(--border-primary);
            }
            #verdict-text {
                font-size: 1.5rem;
                font-weight: 700;
                margin-bottom: var(--spacing-xs);
            }
            #verdict-desc {
                color: var(--text-secondary);
            }
        `;
        document.head.appendChild(validationStyles);

        // CHUNK 4 COMPLETE - Pre-Trade Validation

        // ============================================
        // UTCC v2.5 INSTITUTIONAL CHECKLIST SYSTEM
        // ============================================

        function updateInstitutionalChecklist() {
            const pair = document.getElementById('val-pair')?.value || '';
            const direction = document.getElementById('val-direction')?.value || '';
            const rsiOverride = document.getElementById('rsi-override-confirm')?.checked || false;
            
            // ============================================
            // CHECK 1: UTCC Armed State (HARD)
            // ============================================
            const utccArmed = document.getElementById('check-utcc-armed')?.value || '';
            const check1Pass = utccArmed === 'armed_long' || utccArmed === 'armed_short';
            updateCheckStatus(1, check1Pass, 
                utccArmed === 'armed_long' ? 'PASS - \u2191 ARMED' :
                utccArmed === 'armed_short' ? 'PASS - \u2193 ARMED' :
                utccArmed === 'disarmed' ? 'FAIL - DISARMED' : 'PENDING');
            
            // ============================================
            // CHECK 2: 1H EMAs Stacked (HARD)
            // ============================================
            const emaStacked = document.getElementById('check-ema-stacked')?.checked || false;
            const check2Pass = emaStacked;
            updateCheckStatus(2, check2Pass, emaStacked ? 'PASS' : 'PENDING');
            
            // ============================================
            // CHECK 3: Price Acceptance/Rejection at EMA (HARD)
            // ============================================
            const emaReaction = document.getElementById('check-ema-reaction')?.value || '';
            const check3Pass = emaReaction === 'acceptance' || emaReaction === 'rejection';
            updateCheckStatus(3, check3Pass, 
                emaReaction === 'acceptance' ? 'PASS - Acceptance' :
                emaReaction === 'rejection' ? 'PASS - Rejection' :
                emaReaction === 'touch_only' ? 'FAIL - Just touch, no reaction' :
                emaReaction === 'none' ? 'FAIL - No interaction' : 'PENDING');
            
            // ============================================
            // CHECK 4: Price Failed Opposite Direction (HARD)
            // ============================================
            const failedOpposite = document.getElementById('check-failed-opposite')?.checked || false;
            const check4Pass = failedOpposite;
            updateCheckStatus(4, check4Pass, failedOpposite ? 'PASS - Reaction confirmed' : 'PENDING');
            
            // Update failed opposite label based on direction
            const failedLabel = document.getElementById('failed-opposite-label');
            if (failedLabel && direction) {
                failedLabel.textContent = direction === 'long' 
                    ? 'Price failed to break lower (bulls defended)'
                    : 'Price failed to break higher (bears defended)';
            }
            
            // ============================================
            // CHECK 5: Alert Fired > 1 Candle Ago (HARD)
            // ============================================
            const alertLag = document.getElementById('check-alert-lag')?.checked || false;
            const check5Pass = alertLag;
            updateCheckStatus(5, check5Pass, alertLag ? 'PASS - Not chasing' : 'PENDING');
            
            // ============================================
            // CHECK 6: 1H RSI Favourable (SOFT)
            // ============================================
            const rsiValue = parseFloat(document.getElementById('check-rsi-value')?.value) || 0;
            let rsiStatus = 'PENDING';
            let rsiLevel = 'pending';
            let positionSizeRec = 'Full size';
            
            if (rsiValue > 0 && direction) {
                if (direction === 'short') {
                    if (rsiValue > 70) { rsiStatus = 'OVERBOUGHT - IDEAL'; rsiLevel = 'pass'; positionSizeRec = 'Full size'; }
                    else if (rsiValue >= 50) { rsiStatus = 'PULLBACK'; rsiLevel = 'pass'; positionSizeRec = 'Full size'; }
                    else if (rsiValue >= 30) { rsiStatus = 'MOMENTUM'; rsiLevel = 'warning'; positionSizeRec = '75% size'; }
                    else { rsiStatus = 'OVERSOLD - NO ENTRY'; rsiLevel = 'fail'; positionSizeRec = 'Do not enter'; }
                } else if (direction === 'long') {
                    if (rsiValue < 30) { rsiStatus = 'OVERSOLD - IDEAL'; rsiLevel = 'pass'; positionSizeRec = 'Full size'; }
                    else if (rsiValue <= 50) { rsiStatus = 'PULLBACK'; rsiLevel = 'pass'; positionSizeRec = 'Full size'; }
                    else if (rsiValue <= 70) { rsiStatus = 'MOMENTUM'; rsiLevel = 'warning'; positionSizeRec = '75% size'; }
                    else { rsiStatus = 'OVERBOUGHT - NO ENTRY'; rsiLevel = 'fail'; positionSizeRec = 'Do not enter'; }
                }
            }
            
            const check6Status = document.getElementById('check-6-status');
            if (check6Status) {
                check6Status.textContent = rsiValue > 0 ? `${rsiStatus} (${positionSizeRec})` : 'Enter RSI value';
                check6Status.className = 'inst-check-status status-' + (rsiLevel === 'pass' ? 'pass' : rsiLevel === 'warning' ? 'warning' : rsiLevel === 'fail' ? 'fail' : 'pending');
            }
            
            const check6Item = document.getElementById('inst-check-6');
            if (check6Item) {
                check6Item.className = 'inst-check-item' + (rsiLevel === 'pass' ? ' check-pass' : rsiLevel === 'warning' ? ' check-warning' : rsiLevel === 'neutral' ? ' check-neutral' : rsiLevel === 'fail' ? ' check-fail' : '');
            }
            
            // Show/hide RSI override section
            const overrideSection = document.getElementById('rsi-override-section');
            if (overrideSection) {
                overrideSection.style.display = (rsiLevel === 'neutral') ? 'block' : 'none';
            }
            
            // ============================================
            // CHECK 7: 48h Cooldown (HARD) - auto-detected
            // ============================================
            const cooldownData = checkCooldown();
            const check7Pass = cooldownData.pass;
            
            // ============================================
            // UNIFIED VERDICT
            // ============================================
            const rsiOk = rsiLevel === 'pass' || rsiLevel === 'warning' || (rsiLevel === 'neutral' && rsiOverride);
            const hardChecksPassed = check1Pass && check2Pass && check3Pass && check4Pass && check5Pass && check7Pass;
            
            // Update verdict mini-icons
            updateVerdictCheck('vc-1', check1Pass, utccArmed);
            updateVerdictCheck('vc-2', check2Pass, emaStacked);
            updateVerdictCheck('vc-3', check3Pass, emaReaction);
            updateVerdictCheck('vc-4', check4Pass, failedOpposite);
            updateVerdictCheck('vc-5', check5Pass, alertLag);
            updateVerdictCheck('vc-6', rsiOk, rsiValue > 0);
            updateVerdictCheck('vc-7', check7Pass, pair);
            
            updateEntryVerdict(hardChecksPassed, rsiLevel, rsiOk, positionSizeRec, cooldownData);
            
            // ============================================
            // LEAKAGE DETECTION INTEGRATION
            // ============================================
            if (window.PlaybookModule) {
                const tradeData = {
                    score: check1Pass ? 85 : 0,
                    entryZone: 'optimal',
                    regime: getCurrentRegimeState(),
                    playbook: PlaybookModule.getSelectedPlaybook()?.id,
                    positionSize: (rsiLevel === 'pass') ? 'full' : 'reduced',
                    hasOverride: window.RegimeModule?.hasActiveOverride() || false,
                    conviction: (rsiLevel === 'pass' && hardChecksPassed) ? 'high' : 'medium',
                    correlatedPositions: getCorrelatedOpenPositions(pair),
                    criteriaPass: (check1Pass ? 1 : 0) + (check2Pass ? 1 : 0) + (check3Pass ? 1 : 0) + (check4Pass ? 1 : 0) + (check5Pass ? 1 : 0) + (check7Pass ? 1 : 0),
                    criteriaTrial: 6
                };
                
                PlaybookModule.renderLeakageWarnings('leakage-warnings-container', tradeData);
            }
        }
        
        // Helper function to get current regime state
        function getCurrentRegimeState() {
            if (window.RegimeModule) {
                const data = window.RegimeModule.loadRegimeData();
                return data.dailyContext?.marketState || null;
            }
            return null;
        }
        
        // Helper function to get correlated open positions
        function getCorrelatedOpenPositions(currentPair) {
            if (!currentPair) return [];
            
            const trades = JSON.parse(localStorage.getItem('ftcc_trades') || '[]');
            const openTrades = trades.filter(t => t.status === 'open');
            
            // Simple correlation check based on shared currencies
            const currentBase = currentPair.substring(0, 3);
            const currentQuote = currentPair.substring(3, 6);
            
            return openTrades.filter(t => {
                if (!t.pair || t.pair === currentPair) return false;
                const base = t.pair.substring(0, 3);
                const quote = t.pair.substring(3, 6);
                return base === currentBase || base === currentQuote || 
                       quote === currentBase || quote === currentQuote;
            });
        }

        function updateCheckStatus(checkNum, passed, statusText) {
            const statusEl = document.getElementById(`check-${checkNum}-status`);
            const itemEl = document.getElementById(`inst-check-${checkNum}`);
            
            if (statusEl) {
                statusEl.textContent = statusText;
                statusEl.className = 'inst-check-status status-' + (passed ? 'pass' : statusText === 'PENDING' ? 'pending' : 'fail');
            }
            
            if (itemEl) {
                itemEl.classList.remove('check-pass', 'check-fail');
                if (passed) itemEl.classList.add('check-pass');
                else if (statusText !== 'PENDING') itemEl.classList.add('check-fail');
            }
        }

        function updateVerdictCheck(id, passed, hasValue) {
            const el = document.getElementById(id);
            if (!el) return;
            
            const label = el.textContent.split(' ').pop();
            if (!hasValue) {
                el.innerHTML = '&#x23F3; ' + label;
                el.className = 'verdict-check';
            } else if (passed) {
                el.innerHTML = 'OK - ' + label;
                el.className = 'verdict-check pass';
            } else {
                el.innerHTML = '&#x2716; ' + label;
                el.className = 'verdict-check fail';
            }
        }

        function updateEntryVerdict(hardPass, rsiLevel, rsiOk, positionSize, cooldownData) {
            const panel = document.getElementById('entry-verdict-panel');
            const icon = document.getElementById('entry-verdict-icon');
            const status = document.getElementById('entry-verdict-status');
            const reason = document.getElementById('entry-verdict-reason');
            
            if (!panel) return;
            
            panel.classList.remove('verdict-approved', 'verdict-approved-reduced', 'verdict-caution', 'verdict-blocked', 'verdict-pending');
            
            if (!hardPass) {
                // BLOCKED
                panel.classList.add('verdict-blocked');
                icon.innerHTML = '&#x26D4;';
                status.textContent = 'ENTRY BLOCKED';
                
                let reasons = [];
                const utccArmed = document.getElementById('check-utcc-armed')?.value || '';
                if (!utccArmed || (utccArmed !== 'armed_long' && utccArmed !== 'armed_short')) {
                    if (utccArmed === 'disarmed') reasons.push('UTCC disarmed');
                    else reasons.push('UTCC not armed');
                }
                if (!document.getElementById('check-ema-stacked')?.checked) reasons.push('EMAs not stacked');
                const emaReaction = document.getElementById('check-ema-reaction')?.value || '';
                if (emaReaction === 'touch_only') reasons.push('Just touch - no reaction');
                else if (emaReaction === 'none') reasons.push('No EMA reaction');
                else if (!emaReaction) reasons.push('EMA reaction not checked');
                if (!document.getElementById('check-failed-opposite')?.checked) reasons.push('No failed opposite');
                if (!document.getElementById('check-alert-lag')?.checked) reasons.push('Chasing alert (same candle)');
                if (!cooldownData.pass) reasons.push(`48h cooldown: ${cooldownData.hoursLeft}h remaining`);
                
                reason.textContent = reasons.join(' | ');
            } else if (rsiLevel === 'neutral' && !document.getElementById('rsi-override-confirm')?.checked) {
                // CAUTION - RSI Neutral
                panel.classList.add('verdict-caution');
                icon.innerHTML = 'WARNING:';
                status.textContent = 'ENTRY CAUTION - RSI NEUTRAL';
                reason.textContent = 'RSI 45-55 = no momentum edge. Tick override box to proceed with reduced conviction.';
            } else if (rsiLevel === 'fail') {
                // BLOCKED - Wrong RSI direction
                panel.classList.add('verdict-blocked');
                icon.innerHTML = '&#x26D4;';
                status.textContent = 'ENTRY BLOCKED - RSI WRONG DIRECTION';
                reason.textContent = 'RSI indicates momentum against your trade direction.';
            } else if (rsiLevel === 'pass') {
                // APPROVED FULL
                panel.classList.add('verdict-approved');
                icon.innerHTML = '&#x2705;';
                status.textContent = 'ENTRY APPROVED - FULL SIZE';
                reason.textContent = 'All 6 HARD checks passed. RSI IDEAL. Execute with confidence.';
            } else if (rsiLevel === 'warning' || (rsiLevel === 'neutral' && document.getElementById('rsi-override-confirm')?.checked)) {
                // APPROVED REDUCED
                panel.classList.add('verdict-approved-reduced');
                icon.innerHTML = '&#x2705;';
                status.textContent = 'ENTRY APPROVED - REDUCED SIZE';
                reason.textContent = rsiLevel === 'warning' ? 
                    'All 6 HARD checks passed. RSI ACCEPTABLE. Use 50-75% position size.' :
                    'All 6 HARD checks passed. RSI NEUTRAL with override. Proceed with caution.';
            } else {
                // PENDING
                panel.classList.add('verdict-pending');
                icon.innerHTML = '&#x23F3;';
                status.textContent = 'COMPLETE CHECKLIST';
                reason.textContent = 'Fill in the 7 checks above to see entry verdict';
            }
        }

        function checkCooldown() {
            const pair = document.getElementById('val-pair')?.value || '';
            const statusEl = document.getElementById('check-7-status');
            const container = document.getElementById('cooldown-warning-container');
            const itemEl = document.getElementById('inst-check-7');
            
            if (!pair) {
                if (statusEl) {
                    statusEl.textContent = 'Select pair first';
                    statusEl.className = 'inst-check-status status-pending';
                }
                if (container) container.innerHTML = '';
                if (itemEl) itemEl.classList.remove('check-pass', 'check-fail');
                return { pass: false, hoursLeft: 0 };
            }
            
            // Check trade journal for recent losses on this pair
            const trades = JSON.parse(localStorage.getItem('ftcc_trades') || '[]');
            const now = new Date();
            const cutoff = new Date(now.getTime() - (48 * 60 * 60 * 1000)); // 48 hours ago
            
            const recentLoss = trades.find(t => {
                if (t.pair !== pair) return false;
                if (t.status !== 'closed') return false;
                if (t.outcome !== 'loss' && t.outcome !== 'stop_loss') return false;
                const closeDate = new Date(t.closeDate || t.entryDate);
                return closeDate > cutoff;
            });
            
            if (recentLoss) {
                const closeDate = new Date(recentLoss.closeDate || recentLoss.entryDate);
                const hoursLeft = Math.ceil((cutoff.getTime() + (48 * 60 * 60 * 1000) - now.getTime()) / (60 * 60 * 1000));
                
                if (statusEl) {
                    statusEl.textContent = `FAIL - ${hoursLeft}h cooldown`;
                    statusEl.className = 'inst-check-status status-fail';
                }
                if (itemEl) {
                    itemEl.classList.remove('check-pass');
                    itemEl.classList.add('check-fail');
                }
                if (container) {
                    container.innerHTML = `
                        <div class="cooldown-warning">
                            <span class="cooldown-warning-icon">&#x23F1;</span>
                            <span class="cooldown-warning-text">
                                Loss on ${pair} at ${closeDate.toLocaleDateString()}. 
                                <span class="cooldown-warning-time">${hoursLeft}h cooldown remaining.</span>
                            </span>
                        </div>
                    `;
                }
                return { pass: false, hoursLeft: hoursLeft };
            } else {
                if (statusEl) {
                    statusEl.textContent = 'PASS - No recent loss';
                    statusEl.className = 'inst-check-status status-pass';
                }
                if (itemEl) {
                    itemEl.classList.remove('check-fail');
                    itemEl.classList.add('check-pass');
                }
                if (container) container.innerHTML = '';
                return { pass: true, hoursLeft: 0 };
            }
        }

        function updateRSIMatrix() {
            const direction = document.getElementById('val-direction')?.value || '';
            const rsiValue = parseFloat(document.getElementById('check-rsi-value')?.value) || 0;
            
            // Highlight active row based on direction and RSI
            const rows = ['rsi-short-ideal', 'rsi-short-acc', 'rsi-neutral', 'rsi-long-acc', 'rsi-long-ideal'];
            rows.forEach(id => {
                const el = document.getElementById(id);
                const dirEl = document.getElementById(id + '-dir');
                if (el) el.style.fontWeight = 'normal';
                if (dirEl) dirEl.style.fontWeight = 'normal';
            });
            
            if (!direction || !rsiValue) return;
            
            let activeRow = null;
            if (direction === 'short') {
                if (rsiValue > 65) activeRow = 'rsi-short-ideal';
                else if (rsiValue >= 55) activeRow = 'rsi-short-acc';
                else if (rsiValue >= 45) activeRow = 'rsi-neutral';
            } else {
                if (rsiValue < 35) activeRow = 'rsi-long-ideal';
                else if (rsiValue <= 45) activeRow = 'rsi-long-acc';
                else if (rsiValue <= 55) activeRow = 'rsi-neutral';
            }
            
            if (activeRow) {
                const el = document.getElementById(activeRow);
                const dirEl = document.getElementById(activeRow + '-dir');
                if (el) el.style.fontWeight = '700';
                if (dirEl) dirEl.style.fontWeight = '700';
            }
        }

        function updateATRGuidance() {
            const atrPct = parseFloat(document.getElementById('val-atr-pct')?.value) || 0;
            const tierLabel = document.getElementById('atr-current-tier');
            
            // Remove active from all tiers
            ['compressed', 'normal', 'elevated', 'exhausted'].forEach(tier => {
                const el = document.getElementById('atr-tier-' + tier);
                if (el) el.classList.remove('active');
            });
            
            if (!atrPct) {
                if (tierLabel) tierLabel.textContent = '--';
                return;
            }
            
            let activeTier = '';
            let tierText = '';
            
            if (atrPct < 30) { activeTier = 'compressed'; tierText = 'COMPRESSED - Full size'; }
            else if (atrPct < 60) { activeTier = 'normal'; tierText = 'NORMAL - Full size'; }
            else if (atrPct < 80) { activeTier = 'elevated'; tierText = 'ELEVATED - Reduce 50%'; }
            else { activeTier = 'exhausted'; tierText = 'EXHAUSTED - Pass'; }
            
            const activeEl = document.getElementById('atr-tier-' + activeTier);
            if (activeEl) activeEl.classList.add('active');
            if (tierLabel) {
                tierLabel.textContent = tierText;
                tierLabel.style.color = activeTier === 'compressed' ? 'var(--color-pass)' : 
                                        activeTier === 'normal' ? 'var(--color-info)' :
                                        activeTier === 'elevated' ? 'var(--color-warning)' : 'var(--color-fail)';
            }
        }

        function resetInstitutionalChecklist() {
            // Reset all inputs
            const selects = ['val-pair', 'val-direction', 'check-utcc-armed', 'check-ema-reaction'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            
            const checkboxes = ['check-ema-stacked', 'rsi-override-confirm', 'check-alert-lag', 'check-failed-opposite'];
            checkboxes.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = false;
            });
            
            const inputs = ['check-rsi-value', 'val-atr-pct'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // Reset all check statuses (1-7)
            for (let i = 1; i <= 7; i++) {
                const statusEl = document.getElementById(`check-${i}-status`);
                const itemEl = document.getElementById(`inst-check-${i}`);
                if (statusEl) {
                    statusEl.textContent = i === 7 ? 'Select pair first' : 'PENDING';
                    statusEl.className = 'inst-check-status status-pending';
                }
                if (itemEl) itemEl.classList.remove('check-pass', 'check-fail', 'check-warning', 'check-neutral');
            }
            
            // Reset verdict checks
            ['vc-1', 'vc-2', 'vc-3', 'vc-4', 'vc-5', 'vc-6', 'vc-7'].forEach((id, i) => {
                const el = document.getElementById(id);
                const labels = ['Armed', 'EMAs', 'Reaction', 'Failed', 'Lag', 'RSI', '48h'];
                if (el) {
                    el.innerHTML = '&#x23F3; ' + labels[i];
                    el.className = 'verdict-check';
                }
            });
            
            // Reset unified verdict panel
            const panel = document.getElementById('entry-verdict-panel');
            const icon = document.getElementById('entry-verdict-icon');
            const status = document.getElementById('entry-verdict-status');
            const reason = document.getElementById('entry-verdict-reason');
            
            if (panel) panel.className = 'entry-verdict-panel verdict-pending';
            if (icon) icon.innerHTML = '&#x23F3;';
            if (status) status.textContent = 'COMPLETE CHECKLIST';
            if (reason) reason.textContent = 'Fill in the 7 checks above to see entry verdict';
            
            // Reset other displays
            const overrideSection = document.getElementById('rsi-override-section');
            if (overrideSection) overrideSection.style.display = 'none';
            
            const cooldownContainer = document.getElementById('cooldown-warning-container');
            if (cooldownContainer) cooldownContainer.innerHTML = '';
            
            const atrTier = document.getElementById('atr-current-tier');
            if (atrTier) atrTier.textContent = '--';
            
            ['compressed', 'normal', 'elevated', 'exhausted'].forEach(tier => {
                const el = document.getElementById('atr-tier-' + tier);
                if (el) el.classList.remove('active');
            });
        }

        // UTCC v2.5 INSTITUTIONAL CHECKLIST COMPLETE


        // ============================================
        // CHUNK 5: TRADE JOURNAL CRUD
        // ============================================

        let currentEditTradeId = null;
        let tradeHistoryPage = 1;
        const TRADES_PER_PAGE = 15;

        function loadTrades() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            updateOpenPositions(trades);
            updateTradeHistory(trades);
            updateTradeCount(trades);
            // Phase 2: Update active trade management panel
            if (typeof updateActiveTradeManagement === 'function') {
                updateActiveTradeManagement();
            }
        }

        function saveTrade() {
            const trade = collectTradeFormData();
            
            if (!validateTradeData(trade)) return;
            
            // Calculate R-multiple if closed
            if (trade.status === 'closed' && trade.exit && trade.entry && trade.stop) {
                trade.rMultiple = calculateRMultiple(trade);
                trade.pnl = calculatePnL(trade);
            }
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            
            if (currentEditTradeId) {
                // Update existing trade (preserve auto-capture metadata)
                const index = trades.findIndex(t => t.id === currentEditTradeId);
                if (index !== -1) {
                    const existing = trades[index];
                    // Protect auto-capture fields from being clobbered by empty form values
                    const protectedFields = [
                        'autoCapture', 'oandaTradeId', 'brokerTradeId', 'autoJournalled',
                        'autoJournalledAt', '_source', 'cbSessionId', 'cbRiskMultiplier',
                        'openTime', 'closeTime', 'exitPrice', 'realizedPL', 'financing',
                        'netPL', 'duration', 'rValue', 'outcome', 'accountId', 'broker',
                        'utccTier', 'utccCriteriaPass', 'alertId', 'reviewedAt',
                        'dismissReason', 'dismissedAt', 'createdAt'
                    ];
                    // Only overwrite form fields that have actual values
                    const merged = { ...existing };
                    for (const [key, val] of Object.entries(trade)) {
                        // Skip empty/null form values for protected fields
                        if (protectedFields.includes(key) && (val === '' || val === null || val === undefined)) continue;
                        // For alertType: don't overwrite AUTO_CAPTURE with MANUAL
                        if (key === 'alertType' && existing.alertType === 'AUTO_CAPTURE' && val === 'MANUAL') continue;
                        merged[key] = val;
                    }
                    merged.updatedAt = new Date().toISOString();
                    trades[index] = merged;
                }
                currentEditTradeId = null;
            } else {
                // Add new trade
                trade.id = generateId();
                trade.createdAt = new Date().toISOString();
                trades.unshift(trade);
            }
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            
            // Update settings if balance changed
            if (trade.status === 'closed' && trade.pnl) {
                updateBalanceFromTrade(trade.pnl);
            }
            
            clearTradeForm();
            loadTrades();
            updateDashboard();
            showToast('Trade saved successfully', 'success');
            
            // Trigger auto-backup if enabled
            triggerAutoBackup();
        }

        function collectTradeFormData() {
            return {
                // Section A: Metadata
                date: document.getElementById('trade-datetime')?.value || new Date().toISOString(),
                pair: document.getElementById('trade-pair')?.value || '',
                direction: document.getElementById('trade-direction')?.value || '',
                session: document.getElementById('trade-session')?.value || '',
                tradeType: document.getElementById('trade-type')?.value || '',
                permissionTF: document.getElementById('trade-permission-tf')?.value || '',
                executionTF: document.getElementById('trade-execution-tf')?.value || '',
                
                // Section B: Permission Log
                marketRegime: document.getElementById('trade-market-regime')?.value || '',
                structureQuality: document.getElementById('trade-structure-quality')?.value || '',
                volContext: document.getElementById('trade-vol-context')?.value || '',
                sessionWindow: document.getElementById('trade-session-window')?.value || '',
                permissionState: document.getElementById('trade-permission-state')?.value || '',
                permissionReason: document.getElementById('trade-permission-reason')?.value || '',
                permissionEvidence: document.getElementById('trade-permission-evidence')?.value || '',
                
                // Section C: Execution Quality
                execTypeDeclared: document.getElementById('exec-type-declared')?.checked || false,
                execSingleTrigger: document.getElementById('exec-single-trigger')?.checked || false,
                execPlannedPrice: document.getElementById('exec-planned-price')?.checked || false,
                execStopInvalidation: document.getElementById('exec-stop-invalidation')?.checked || false,
                execSpreadOk: document.getElementById('exec-spread-ok')?.checked || false,
                entryTrigger: document.getElementById('trade-entry-trigger')?.value || '',
                entry: parseFloat(document.getElementById('trade-entry')?.value) || null,
                stop: parseFloat(document.getElementById('trade-stop')?.value) || null,
                tp: parseFloat(document.getElementById('trade-tp')?.value) || null,
                exit: parseFloat(document.getElementById('trade-exit')?.value) || null,
                units: parseInt(document.getElementById('trade-units')?.value) || null,
                riskAmount: parseFloat(document.getElementById('trade-risk-amount')?.value) || null,
                riskPct: parseFloat(document.getElementById('trade-risk-pct')?.value) || 1.5,
                
                // Section D: Management Discipline
                mgmtNoEarlyStop: document.getElementById('mgmt-no-early-stop')?.checked || false,
                mgmtPartialRules: document.getElementById('mgmt-partial-rules')?.checked || false,
                mgmtExitRules: document.getElementById('mgmt-exit-rules')?.checked || false,
                mgmtNoRevenge: document.getElementById('mgmt-no-revenge')?.checked || false,
                exitReason: document.getElementById('trade-exit-reason')?.value || '',
                status: document.getElementById('trade-status')?.value || 'open',
                slippage: parseFloat(document.getElementById('trade-slippage')?.value) || 0,
                
                // Section E: Outcome Metrics
                mae: parseFloat(document.getElementById('trade-mae')?.value) || null,
                mfe: parseFloat(document.getElementById('trade-mfe')?.value) || null,
                trendScore: parseInt(document.getElementById('trade-trend-score')?.value) || null,
                
                // Section F: Post-Trade Review
                classification: document.getElementById('trade-classification')?.value || '',
                notes: document.getElementById('trade-notes')?.value || '',
                lessons: document.getElementById('trade-lessons')?.value || '',
                screenshot: document.getElementById('trade-screenshot')?.value || '',
                
                // Backwards compatibility (hidden fields)
                alertType: document.getElementById('trade-alert-type')?.value || 'MANUAL',
                entryZone: document.getElementById('trade-entry-zone')?.value || '',
                volState: document.getElementById('trade-vol-state')?.value || '',
                mtf: document.getElementById('trade-mtf')?.value || '',
                grade: document.getElementById('trade-grade')?.value || ''
            };
        }

        function validateTradeData(trade) {
            if (!trade.pair) {
                showToast('Please select a pair', 'warning');
                return false;
            }
            if (!trade.direction) {
                showToast('Please select direction', 'warning');
                return false;
            }
            if (!trade.entry) {
                showToast('Please enter entry price', 'warning');
                return false;
            }
            return true;
        }

        function calculateRMultiple(trade) {
            const { direction, entry, stop, exit } = trade;
            if (!entry || !stop || !exit) return 0;
            
            const risk = Math.abs(entry - stop);
            if (risk === 0) return 0;
            
            let pnlPips;
            if (direction === 'long') {
                pnlPips = exit - entry;
            } else {
                pnlPips = entry - exit;
            }
            
            return pnlPips / risk;
        }

        function calculatePnL(trade) {
            if (!trade.rMultiple || !trade.riskAmount) return 0;
            return trade.rMultiple * trade.riskAmount;
        }

        function updateBalanceFromTrade(pnl) {
            const settings = getSettings();
            settings.accountBalance += pnl;
            
            // Update peak if new high
            if (settings.accountBalance > settings.peakBalance) {
                settings.peakBalance = settings.accountBalance;
            }
            
            saveToStorage(STORAGE_KEYS.settings, settings);
        }

        function updateOpenPositions(trades) {
            const openTrades = trades.filter(t => t.status === 'open');
            const tbody = document.getElementById('open-positions-body');
            const countEl = document.getElementById('open-positions-count');
            
            if (countEl) countEl.textContent = `${openTrades.length} Open`;
            
            if (!tbody) return;
            
            if (openTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No open positions</td></tr>';
                return;
            }
            
            tbody.innerHTML = openTrades.map(trade => `
                <tr>
                    <td>${formatDate(trade.date)}</td>
                    <td><strong>${trade.pair}</strong></td>
                    <td><span class="badge ${trade.direction === 'long' ? 'badge-pass' : 'badge-fail'}">${trade.direction?.toUpperCase()}</span></td>
                    <td>${trade.entry || '-'}</td>
                    <td>${trade.stop || '-'}</td>
                    <td>${trade.tp || '-'}</td>
                    <td>${trade.units?.toLocaleString() || '-'}</td>
                    <td>${getAlertBadge(trade.alertType)}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editTrade('${trade.id}')">Edit</button>
                        <button class="btn btn-primary btn-sm" onclick="closeTrade('${trade.id}')">Close</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateTradeHistory(trades) {
            const closedTrades = trades.filter(t => t.status === 'closed' || t.status === 'closed_pending_review' || t.status === 'complete');
            const filteredTrades = filterTradesForHistory(closedTrades);
            const tbody = document.getElementById('trade-history-body');
            
            if (!tbody) return;
            
            // Paginate
            const totalPages = Math.ceil(filteredTrades.length / TRADES_PER_PAGE);
            const startIndex = (tradeHistoryPage - 1) * TRADES_PER_PAGE;
            const pageTrades = filteredTrades.slice(startIndex, startIndex + TRADES_PER_PAGE);
            
            if (pageTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">No trades recorded yet</td></tr>';
                updatePaginationButtons(0, 0);
                return;
            }
            
            tbody.innerHTML = pageTrades.map(trade => {
                const rVal = trade.rMultiple || trade.rValue || 0;
                const rClass = rVal > 0 ? 'text-pass' : rVal < 0 ? 'text-fail' : '';
                const isAuto = trade.autoCapture === true || trade.autoJournalled === true || trade.alertType === 'AUTO_CAPTURE';
                const sourceBadge = isAuto 
                    ? '<span class="badge badge-info" title="Auto-captured from broker">AUTO</span>'
                    : '<span class="badge" title="Manually entered">MAN</span>';
                return `
                    <tr>
                        <td>${formatDate(trade.date)}</td>
                        <td><strong>${trade.pair}</strong></td>
                        <td><span class="badge ${trade.direction === 'long' ? 'badge-pass' : 'badge-fail'}">${trade.direction?.toUpperCase()?.charAt(0)}</span></td>
                        <td>${sourceBadge}</td>
                        <td>${getAlertBadge(trade.alertType)}</td>
                        <td>${getGradeBadge(trade.grade, trade.dismissReason)}</td>
                        <td>${trade.entry || '-'}</td>
                        <td>${trade.exit || trade.exitPrice || '-'}</td>
                        <td class="${rClass}"><strong>${formatNumber(rVal, 2)}R</strong></td>
                        <td>${trade.trendScore || '-'}</td>
                        <td>${getZoneBadge(trade.entryZone)}</td>
                        <td>
                            ${!trade.grade ? `<button class="btn btn-sm" style="background:#6b7280;color:#fff;font-size:0.65rem;padding:2px 6px;" onclick="dismissTrade('${trade.id}')" title="Dismiss as test/legacy">DIS</button>` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="editTrade('${trade.id}')"></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTrade('${trade.id}')"></button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePaginationButtons(tradeHistoryPage, totalPages);
        }

        function filterTradesForHistory(trades) {
            const pairFilter = document.getElementById('filter-pair')?.value || '';
            const alertFilter = document.getElementById('filter-alert')?.value || '';
            const gradeFilter = document.getElementById('filter-grade')?.value || '';
            const resultFilter = document.getElementById('filter-result')?.value || '';
            const sourceFilter = document.getElementById('filter-source')?.value || '';
            
            return trades.filter(trade => {
                if (pairFilter && trade.pair !== pairFilter) return false;
                if (alertFilter && trade.alertType !== alertFilter) return false;
                if (gradeFilter) {
                    if (gradeFilter === 'none' && trade.grade) return false;
                    if (gradeFilter !== 'none' && trade.grade !== gradeFilter) return false;
                }
                if (resultFilter) {
                    const r = trade.rMultiple || trade.rValue || 0;
                    if (resultFilter === 'win' && r <= 0) return false;
                    if (resultFilter === 'loss' && r >= 0) return false;
                    if (resultFilter === 'breakeven' && Math.abs(r) > 0.1) return false;
                }
                if (sourceFilter) {
                    const isAuto = trade.autoCapture === true || trade.autoJournalled === true || trade.alertType === 'AUTO_CAPTURE';
                    if (sourceFilter === 'auto' && !isAuto) return false;
                    if (sourceFilter === 'manual' && isAuto) return false;
                }
                return true;
            });
        }

        function filterTrades() {
            tradeHistoryPage = 1;
            loadTrades();
        }

        function updateTradeCount(trades) {
            const closedTrades = trades.filter(t => t.status === 'closed' || t.status === 'closed_pending_review' || t.status === 'complete');
            const countEl = document.getElementById('trade-count');
            if (countEl) countEl.textContent = `${closedTrades.length} trades`;
            
            // Update bulk dismiss button visibility and count
            const ungradedCount = closedTrades.filter(t => !t.grade).length;
            const bulkBtn = document.getElementById('bulk-dismiss-btn');
            if (bulkBtn) {
                if (ungradedCount > 0) {
                    bulkBtn.style.display = '';
                    bulkBtn.innerHTML = `&#x1F5D1; Dismiss Ungraded (${ungradedCount})`;
                } else {
                    bulkBtn.style.display = 'none';
                }
            }
        }

        function updatePaginationButtons(currentPage, totalPages) {
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
                prevBtn.onclick = () => { tradeHistoryPage--; loadTrades(); };
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
                nextBtn.onclick = () => { tradeHistoryPage++; loadTrades(); };
            }
        }

        function getAlertBadge(alertType) {
            const badges = {
                'TRADE_READY': '<span class="badge badge-pass">READY</span>',
                'STRONG_BULL': '<span class="badge badge-info">AB</span>',
                'STRONG_BEAR': '<span class="badge badge-info">AS</span>',
                'PERFECT_BULL': '<span class="badge badge-perfect">A+B</span>',
                'PERFECT_BEAR': '<span class="badge badge-perfect">A+S</span>',
                'MANUAL': '<span class="badge">MANUAL</span>'
            };
            return badges[alertType] || '<span class="badge">-</span>';
        }

        function getZoneBadge(zone) {
            const badges = {
                'HOT': '<span class="zone-badge zone-hot">HOT</span>',
                'OPTIMAL': '<span class="zone-badge zone-optimal">OPT</span>',
                'ACCEPTABLE': '<span class="zone-badge zone-acceptable">ACC</span>',
                'EXTENDED': '<span class="zone-badge zone-extended">EXT</span>'
            };
            return badges[zone] || '-';
        }

        function editTrade(tradeId) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const trade = trades.find(t => t.id === tradeId);
            
            if (!trade) {
                showToast('Trade not found', 'error');
                return;
            }
            
            currentEditTradeId = tradeId;
            
            // Populate form
            document.getElementById('trade-datetime').value = trade.date?.slice(0, 16) || '';
            document.getElementById('trade-pair').value = trade.pair || '';
            document.getElementById('trade-direction').value = trade.direction || '';
            document.getElementById('trade-entry').value = trade.entry || '';
            document.getElementById('trade-stop').value = trade.stop || '';
            document.getElementById('trade-tp').value = trade.tp || '';
            document.getElementById('trade-exit').value = trade.exit || trade.exitPrice || '';
            document.getElementById('trade-units').value = trade.units || '';
            document.getElementById('trade-risk-amount').value = trade.riskAmount || '';
            document.getElementById('trade-alert-type').value = trade.alertType || 'MANUAL';
            document.getElementById('trade-trend-score').value = trade.trendScore || '';
            document.getElementById('trade-entry-zone').value = trade.entryZone || '';
            document.getElementById('trade-vol-state').value = trade.volState || '';
            document.getElementById('trade-mtf').value = trade.mtf || '';
            document.getElementById('trade-grade').value = trade.grade || '';
            document.getElementById('trade-session').value = trade.session || '';
            document.getElementById('trade-exit-reason').value = trade.exitReason || '';
            document.getElementById('trade-screenshot').value = trade.screenshot || '';
            document.getElementById('trade-status').value = trade.status || 'open';
            document.getElementById('trade-notes').value = trade.notes || '';
            document.getElementById('trade-lessons').value = trade.lessons || '';
            
            // v2.9.0: Populate permission log hidden fields + read-only display
            const setIfExists = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
            setIfExists('trade-market-regime', trade.marketRegime);
            setIfExists('trade-structure-quality', trade.structureQuality);
            setIfExists('trade-vol-context', trade.volContext);
            setIfExists('trade-session-window', trade.sessionWindow);
            setIfExists('trade-permission-state', trade.permissionState);
            setIfExists('trade-permission-reason', trade.permissionReason);
            setIfExists('trade-permission-evidence', trade.permissionEvidence);
            updatePermissionLogDisplay();
            
            // Scroll to form
            document.querySelector('#tab-journal .card').scrollIntoView({ behavior: 'smooth' });
            showToast('Editing trade - make changes and save', 'info');
        }

        function closeTrade(tradeId) {
            const exitPrice = prompt('Enter exit price:');
            if (!exitPrice) return;
            
            const exitReason = prompt('Exit reason (TP_HIT, SL_HIT, MANUAL_WIN, MANUAL_LOSS, etc.):');
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) {
                showToast('Trade not found', 'error');
                return;
            }
            
            trades[index].exit = parseFloat(exitPrice);
            trades[index].exitReason = exitReason || 'MANUAL';
            trades[index].status = 'closed';
            trades[index].closedAt = new Date().toISOString();
            
            // Calculate R-multiple
            trades[index].rMultiple = calculateRMultiple(trades[index]);
            trades[index].pnl = calculatePnL(trades[index]);
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            
            // Update balance
            if (trades[index].pnl) {
                updateBalanceFromTrade(trades[index].pnl);
            }
            
            loadTrades();
            updateDashboard();
            showToast('Trade closed', 'success');
        }

        function deleteTrade(tradeId) {
            if (!confirm('Are you sure you want to delete this trade?')) return;
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const filtered = trades.filter(t => t.id !== tradeId);
            
            saveToStorage(STORAGE_KEYS.trades, filtered);
            loadTrades();
            showToast('Trade deleted', 'info');
        }

        /**
         * Dismiss a single trade as test/legacy with reason code
         */
        function dismissTrade(tradeId) {
            const reasons = ['TEST', 'LEGACY', 'CANNOT_RECALL', 'DUPLICATE'];
            const reason = prompt(
                'Dismiss reason:\n\n' +
                '1 = TEST (test/practice trade)\n' +
                '2 = LEGACY (old trade, no longer relevant)\n' +
                '3 = CANNOT_RECALL (cannot remember reasoning)\n' +
                '4 = DUPLICATE (duplicate entry)\n\n' +
                'Enter 1-4:'
            );
            
            if (!reason) return;
            const reasonIndex = parseInt(reason) - 1;
            if (isNaN(reasonIndex) || reasonIndex < 0 || reasonIndex >= reasons.length) {
                showToast('Invalid selection. Enter 1-4.', 'warning');
                return;
            }
            
            const dismissReason = reasons[reasonIndex];
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const trade = trades.find(t => t.id === tradeId);
            
            if (trade) {
                trade.grade = 'DIS';
                trade.status = 'complete';
                trade.dismissReason = dismissReason;
                trade.dismissedAt = new Date().toISOString();
                trade.notes = (trade.notes || '') + `\n[${new Date().toLocaleString()}] Dismissed: ${dismissReason}`;
                saveToStorage(STORAGE_KEYS.trades, trades);
                // v2.8.1: Also dismiss in TradeCapture (pending trades store)
                if (typeof TradeCapture !== 'undefined' && TradeCapture.dismissTrade) {
                    TradeCapture.dismissTrade(tradeId, dismissReason);
                }
                loadTrades();
                // v2.8.2: Refresh review queue banner
                if (typeof BrokerDashboard !== 'undefined' && BrokerDashboard.reviewQueue) {
                    BrokerDashboard.reviewQueue.renderBanner();
                }
                showToast(`Trade dismissed: ${dismissReason}`, 'info');
            }
        }

        /**
         * Bulk dismiss all ungraded closed trades
         */
        function bulkDismissTrades() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const ungraded = trades.filter(t => t.status === 'closed' && !t.grade);
            
            if (ungraded.length === 0) {
                showToast('No ungraded trades to dismiss', 'info');
                return;
            }
            
            const reasons = ['TEST', 'LEGACY', 'CANNOT_RECALL'];
            const reason = prompt(
                `Bulk dismiss ${ungraded.length} ungraded trade(s).\n\n` +
                'Dismiss reason for ALL:\n' +
                '1 = TEST (test/practice trades)\n' +
                '2 = LEGACY (old trades, no longer relevant)\n' +
                '3 = CANNOT_RECALL (cannot remember reasoning)\n\n' +
                'Enter 1-3:'
            );
            
            if (!reason) return;
            const reasonIndex = parseInt(reason) - 1;
            if (isNaN(reasonIndex) || reasonIndex < 0 || reasonIndex >= reasons.length) {
                showToast('Invalid selection. Enter 1-3.', 'warning');
                return;
            }
            
            const dismissReason = reasons[reasonIndex];
            
            if (!confirm(`Dismiss ${ungraded.length} trades as ${dismissReason}? This cannot be easily undone.`)) return;
            
            const now = new Date().toISOString();
            let count = 0;
            trades.forEach(t => {
                if ((t.status === 'closed' || t.status === 'closed_pending_review') && !t.grade) {
                    t.grade = 'DIS';
                    t.status = 'complete';
                    t.dismissReason = dismissReason;
                    t.dismissedAt = now;
                    t.notes = (t.notes || '') + `\n[${new Date().toLocaleString()}] Bulk dismissed: ${dismissReason}`;
                    count++;
                }
            });
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            // v2.8.1: Also bulk dismiss in TradeCapture (pending trades store)
            if (typeof TradeCapture !== 'undefined' && TradeCapture.bulkDismissPendingTrades) {
                TradeCapture.bulkDismissPendingTrades(dismissReason);
            }
            loadTrades();
            // v2.8.2: Refresh review queue banner
            if (typeof BrokerDashboard !== 'undefined' && BrokerDashboard.reviewQueue) {
                BrokerDashboard.reviewQueue.renderBanner();
            }
            showToast(`${count} trades dismissed as ${dismissReason}`, 'success');
        }

        function clearTradeForm() {
            currentEditTradeId = null;
            
            document.querySelectorAll('#tab-journal .card:first-child input').forEach(el => {
                if (el.type === 'datetime-local') {
                    el.value = new Date().toISOString().slice(0, 16);
                } else if (el.type === 'checkbox') {
                    el.checked = false;
                } else if (el.type !== 'hidden') {
                    el.value = '';
                }
            });
            document.querySelectorAll('#tab-journal .card:first-child select').forEach(el => {
                el.selectedIndex = 0;
            });
            document.querySelectorAll('#tab-journal .card:first-child textarea').forEach(el => {
                el.value = '';
            });
            
            // Reset permission read-only display
            ['perm-display-regime', 'perm-display-structure', 'perm-display-vol',
             'perm-display-session', 'perm-display-state', 'perm-display-reason'].forEach(id => {
                const el = document.getElementById(id);
                if (el) { el.textContent = '--'; el.style.color = ''; }
            });
            // Clear hidden permission fields
            ['trade-market-regime', 'trade-structure-quality', 'trade-vol-context',
             'trade-session-window', 'trade-permission-state', 'trade-permission-reason',
             'trade-permission-evidence'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }
        
        // v2.9.0: Update read-only permission log display from hidden fields
        function updatePermissionLogDisplay() {
            const get = (id) => document.getElementById(id)?.value || '--';
            const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || '--'; };
            
            set('perm-display-regime', get('trade-market-regime').charAt(0).toUpperCase() + get('trade-market-regime').slice(1));
            set('perm-display-structure', get('trade-structure-quality').charAt(0).toUpperCase() + get('trade-structure-quality').slice(1));
            set('perm-display-vol', get('trade-vol-context').charAt(0).toUpperCase() + get('trade-vol-context').slice(1));
            set('perm-display-session', get('trade-session-window').charAt(0).toUpperCase() + get('trade-session-window').slice(1));
            
            const stateVal = get('trade-permission-state').toUpperCase();
            const stateEl = document.getElementById('perm-display-state');
            if (stateEl) {
                stateEl.textContent = stateVal || '--';
                stateEl.style.color = stateVal === 'FULL' ? 'var(--color-pass)' :
                    stateVal === 'CONDITIONAL' ? 'var(--color-warning)' :
                    stateVal === 'OVERRIDE' || stateVal === 'VIOLATION' ? 'var(--color-fail)' : '';
                stateEl.style.fontWeight = '600';
            }
            
            set('perm-display-reason', get('trade-permission-reason'));
        }

        // Permission state change handler
        function onPermissionStateChange() {
            var state = document.getElementById('trade-permission-state');
            var stateVal = state ? state.value : '';
            var warning = document.getElementById('permission-violation-warning');
            if (warning) {
                warning.style.display = (stateVal === 'violation' || stateVal === 'override') ? 'block' : 'none';
            }
        }
        
        // Auto-resolve permission decision from the 5 context fields
        function resolvePermissionDecision() {
            var regime = document.getElementById('trade-market-regime');
            var structure = document.getElementById('trade-structure-quality');
            var vol = document.getElementById('trade-vol-context');
            var session = document.getElementById('trade-session-window');
            var permState = document.getElementById('trade-permission-state');
            
            var regimeVal = regime ? regime.value : '';
            var structVal = structure ? structure.value : '';
            var volVal = vol ? vol.value : '';
            var sessionVal = session ? session.value : '';
            var permVal = permState ? permState.value : '';
            
            var decisionEl = document.getElementById('permission-decision');
            var decisionValEl = document.getElementById('permission-decision-value');
            var blockWarn = document.getElementById('permission-block-warning');
            
            // Need at least one field filled to show anything
            var anyFilled = regimeVal || structVal || volVal || sessionVal;
            if (!anyFilled) {
                if (decisionEl) decisionEl.style.display = 'none';
                if (blockWarn) blockWarn.style.display = 'none';
                return;
            }
            
            // Hard-block conditions
            var blocks = [];
            if (regimeVal === 'transition') blocks.push('Transition regime');
            if (structVal === 'damaged') blocks.push('Damaged structure');
            if (sessionVal === 'dead') blocks.push('Dead zone');
            
            // Conditional conditions
            var conditionals = [];
            if (regimeVal === 'balanced') conditionals.push('Balanced regime');
            if (regimeVal === 'compression') conditionals.push('Compression regime');
            if (structVal === 'overlapping') conditionals.push('Overlapping structure');
            if (volVal === 'divergent') conditionals.push('Divergent volatility');
            if (volVal === 'contracting') conditionals.push('Contracting volatility');
            if (sessionVal === 'sweep') conditionals.push('Sweep window');
            
            var decision = '';
            var cssClass = '';
            
            if (blocks.length > 0) {
                decision = 'BLOCKED \u2014 ' + blocks.join('; ');
                cssClass = 'decision-blocked';
            } else if (conditionals.length > 0) {
                decision = 'CONDITIONAL \u2014 ' + conditionals.join('; ') + ' \u2192 reduced size + stricter filters';
                cssClass = 'decision-conditional';
            } else if (regimeVal && structVal && volVal && sessionVal) {
                decision = 'FULL \u2014 all fields supportive';
                cssClass = 'decision-full';
            } else {
                decision = 'INCOMPLETE \u2014 fill all fields';
                cssClass = 'decision-conditional';
            }
            
            if (decisionEl) {
                decisionEl.style.display = 'flex';
                decisionEl.className = 'permission-decision ' + cssClass;
            }
            if (decisionValEl) {
                decisionValEl.textContent = decision;
            }
            
            // Show block warning if hard-block detected but permission is not OVERRIDE
            if (blockWarn) {
                blockWarn.style.display = (blocks.length > 0 && permVal !== 'override' && permVal !== '') ? 'block' : 'none';
            }
            
            // Also trigger the existing violation warning check
            onPermissionStateChange();
        }
        
        // Add event listeners when DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            var permSelect = document.getElementById('trade-permission-state');
            if (permSelect) {
                permSelect.addEventListener('change', onPermissionStateChange);
                permSelect.addEventListener('change', resolvePermissionDecision);
            }
            
            // Listen to all 5 permission log dropdowns
            var permFields = [
                'trade-market-regime', 'trade-structure-quality',
                'trade-vol-context', 'trade-session-window',
                'trade-permission-state'
            ];
            for (var i = 0; i < permFields.length; i++) {
                var el = document.getElementById(permFields[i]);
                if (el) {
                    el.addEventListener('change', resolvePermissionDecision);
                }
            }
        });

        // ============================================
        // PHASE 2: EXIT STRATEGY ENHANCEMENT
        // ============================================
        
        // Check if it's Friday close warning time (Friday after 4pm AEST)
        function checkFridayWarning() {
            const now = new Date();
            const day = now.getDay(); // 0=Sun, 5=Fri
            const hour = now.getHours();
            
            // Friday after 4pm AEST
            if (day === 5 && hour >= 16) {
                const trades = loadFromStorage(STORAGE_KEYS.trades, []);
                const openTrades = trades.filter(t => t.status === 'open');
                
                if (openTrades.length > 0) {
                    const banner = document.getElementById('friday-warning-banner');
                    if (banner) banner.style.display = 'block';
                    return true;
                }
            }
            
            const banner = document.getElementById('friday-warning-banner');
            if (banner) banner.style.display = 'none';
            return false;
        }
        
        function dismissFridayWarning() {
            const banner = document.getElementById('friday-warning-banner');
            if (banner) banner.style.display = 'none';
            sessionStorage.setItem('fridayWarningDismissed', 'true');
        }
        
        function reviewAllOpenTrades() {
            showTab('journal');
            showToast('Review each open position and decide: Close or Hold', 'warning');
        }
        
        // Calculate trade age in hours
        function getTradeAgeHours(tradeDate) {
            const now = new Date();
            const opened = new Date(tradeDate);
            return (now - opened) / (1000 * 60 * 60);
        }
        
        // Get trade age display string
        function formatTradeAge(hours) {
            if (hours < 1) return `${Math.round(hours * 60)}m`;
            if (hours < 24) return `${Math.round(hours)}h`;
            const days = Math.floor(hours / 24);
            const remainingHours = Math.round(hours % 24);
            return `${days}d ${remainingHours}h`;
        }
        
        // Update Active Trade Management Panel
        function updateActiveTradeManagement() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const openTrades = trades.filter(t => t.status === 'open');
            
            // Update counts
            const countEl = document.getElementById('open-positions-count');
            if (countEl) countEl.textContent = `${openTrades.length} Open`;
            
            // Update protocol summary
            let awaitingTP1 = 0, atBreakeven = 0, trailing = 0, needReview = 0;
            
            openTrades.forEach(trade => {
                const ageHours = getTradeAgeHours(trade.date);
                
                if (!trade.tp1Hit) awaitingTP1++;
                if (trade.slMovedToBE) atBreakeven++;
                if (trade.trailingActive) trailing++;
                if (ageHours >= 24 && !trade.timeWarningAcknowledged) needReview++;
            });
            
            document.getElementById('trades-awaiting-tp1').textContent = awaitingTP1;
            document.getElementById('trades-at-breakeven').textContent = atBreakeven;
            document.getElementById('trades-trailing').textContent = trailing;
            document.getElementById('trades-needing-review').textContent = needReview;
            
            // Highlight review stat if needed
            const reviewStat = document.getElementById('trades-needing-review-stat');
            if (reviewStat) {
                reviewStat.style.display = needReview > 0 ? 'block' : 'block';
                reviewStat.classList.toggle('protocol-stat-warning', needReview > 0);
            }
            
            // Render active trades list
            const listEl = document.getElementById('active-trades-list');
            const noTradesEl = document.getElementById('no-active-trades');
            const quickActionsEl = document.getElementById('quick-actions-bar');
            
            if (openTrades.length === 0) {
                if (noTradesEl) noTradesEl.style.display = 'block';
                if (quickActionsEl) quickActionsEl.style.display = 'none';
                return;
            }
            
            if (noTradesEl) noTradesEl.style.display = 'none';
            if (quickActionsEl) quickActionsEl.style.display = 'flex';
            
            listEl.innerHTML = openTrades.map(trade => renderActiveTradeCard(trade)).join('');
            
            // Check Friday warning
            checkFridayWarning();
        }
        
        // Render a single active trade card
        function renderActiveTradeCard(trade) {
            const ageHours = getTradeAgeHours(trade.date);
            const ageStr = formatTradeAge(ageHours);
            
            // Determine card state
            let cardClass = 'active-trade-card';
            let ageClass = 'trade-age';
            
            if (ageHours >= 48) {
                cardClass += ' critical';
                ageClass += ' age-critical';
            } else if (ageHours >= 24) {
                cardClass += ' needs-review';
                ageClass += ' age-warning';
            }
            
            if (trade.slMovedToBE) {
                cardClass += ' at-breakeven';
            }
            
            // Calculate current partial close percentage
            const partialsClosed = (trade.partialCloses || []).reduce((sum, p) => sum + p.percent, 0);
            
            // Volatility-based trail recommendation
            const volState = trade.volState || 'TREND';
            const trailRec = getTrailRecommendation(volState);
            
            return `
                <div class="${cardClass}" data-trade-id="${trade.id}">
                    <div class="active-trade-header">
                        <div class="trade-pair-dir">
                            <strong>${trade.pair}</strong>
                            <span class="badge ${trade.direction === 'long' ? 'badge-pass' : 'badge-fail'}">${trade.direction?.toUpperCase()}</span>
                        </div>
                        <div class="${ageClass}">
                            <span>&#x23F1;</span>
                            <span>${ageStr}</span>
                            ${ageHours >= 24 ? '<span class="badge badge-warning">REVIEW</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="active-trade-body">
                        <div class="trade-levels-row">
                            <div class="trade-level">
                                <span class="trade-level-label">Entry</span>
                                <span class="trade-level-value">${trade.entry || '--'}</span>
                            </div>
                            <div class="trade-level">
                                <span class="trade-level-label">Stop</span>
                                <span class="trade-level-value" style="color: var(--color-fail);">${trade.stop || '--'}</span>
                            </div>
                            <div class="trade-level">
                                <span class="trade-level-label">TP1</span>
                                <span class="trade-level-value" style="color: var(--color-pass);">${trade.tp || '--'}</span>
                            </div>
                            <div class="trade-level">
                                <span class="trade-level-label">Units</span>
                                <span class="trade-level-value">${trade.units?.toLocaleString() || '--'}</span>
                            </div>
                        </div>
                        
                        <!-- Exit Protocol Status -->
                        <div class="exit-protocol-row">
                            <div class="protocol-step">
                                <span class="protocol-step-icon ${trade.tp1Hit ? 'complete' : 'pending'}">${trade.tp1Hit ? '&#x2713;' : '1'}</span>
                                <span class="protocol-step-text ${trade.tp1Hit ? 'complete' : ''}">TP1 Hit - Close 50%</span>
                            </div>
                            <div class="protocol-step">
                                <span class="protocol-step-icon ${trade.slMovedToBE ? 'complete' : 'pending'}">${trade.slMovedToBE ? '&#x2713;' : '2'}</span>
                                <span class="protocol-step-text ${trade.slMovedToBE ? 'complete' : ''}">Move SL to BE</span>
                            </div>
                            <div class="protocol-step">
                                <span class="protocol-step-icon ${trade.trailingActive ? 'complete' : 'pending'}">${trade.trailingActive ? '&#x2713;' : '3'}</span>
                                <span class="protocol-step-text ${trade.trailingActive ? 'complete' : ''}">Trail Stop</span>
                            </div>
                        </div>
                        
                        ${!trade.tp1Hit && volState ? `
                        <div class="vol-trail-recommendation">
                            <strong>${volState}:</strong> ${trailRec.recommendation}
                        </div>
                        ` : ''}
                        
                        ${partialsClosed > 0 ? `
                        <div class="partial-close-tracker">
                            <div class="partial-bar">
                                <div class="partial-fill" style="width: ${partialsClosed}%;"></div>
                            </div>
                            <div class="partial-labels">
                                <span>${partialsClosed}% closed</span>
                                <span>${100 - partialsClosed}% remaining</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Trade Actions -->
                        <div class="trade-actions">
                            ${!trade.tp1Hit ? `
                            <button class="btn btn-sm btn-tp1" onclick="recordTP1Hit('${trade.id}')">&#x1F4B0; TP1 Hit - Close 50%</button>
                            ` : ''}
                            ${trade.tp1Hit && !trade.slMovedToBE ? `
                            <button class="btn btn-sm btn-be" onclick="moveToBE('${trade.id}')">&#x1F6E1; Move SL to BE</button>
                            ` : ''}
                            ${trade.slMovedToBE && !trade.trailingActive ? `
                            <button class="btn btn-sm btn-trail" onclick="openTrailModal('${trade.id}')">&#x1F4C8; Set Trail Stop</button>
                            ` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="editTrade('${trade.id}')">&#x270F; Edit</button>
                            <button class="btn btn-sm btn-primary" onclick="closeTrade('${trade.id}')">Close Trade</button>
                            ${ageHours >= 24 ? `
                            <button class="btn btn-sm btn-warning" onclick="acknowledgeTimeWarning('${trade.id}')">Reviewed &#x2713;</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Get volatility-based trail recommendation
        function getTrailRecommendation(volState) {
            const recommendations = {
                'TREND': { 
                    recommendation: 'Trail behind swing points. Standard trailing.',
                    atrMultiple: 1.5
                },
                'EXPLODE': { 
                    recommendation: 'Use wider trail (2x ATR) - expect larger swings.',
                    atrMultiple: 2.0
                },
                'QUIET': { 
                    recommendation: 'Tighter trail (1x ATR) - smaller moves expected.',
                    atrMultiple: 1.0
                },
                'NORMAL': { 
                    recommendation: 'Standard trail (1.5x ATR).',
                    atrMultiple: 1.5
                },
                'LOW': { 
                    recommendation: 'Consider manual trail or breakeven only - low follow-through.',
                    atrMultiple: 1.0
                }
            };
            return recommendations[volState] || recommendations['TREND'];
        }
        
        // Record TP1 hit and partial close
        function recordTP1Hit(tradeId) {
            const closePercent = 50; // Standard 50% close at TP1
            const exitPrice = prompt('Enter TP1 exit price:');
            if (!exitPrice) return;
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) {
                showToast('Trade not found', 'error');
                return;
            }
            
            const trade = trades[index];
            
            // Initialize arrays if needed
            if (!trade.partialCloses) trade.partialCloses = [];
            
            // Record partial close
            trade.partialCloses.push({
                percent: closePercent,
                price: parseFloat(exitPrice),
                time: new Date().toISOString(),
                type: 'TP1'
            });
            
            trade.tp1Hit = true;
            trade.tp1HitAt = new Date().toISOString();
            trade.tp1ClosePercent = closePercent;
            
            // Update units remaining
            if (trade.units) {
                trade.unitsRemaining = Math.round(trade.units * (1 - closePercent / 100));
            }
            
            // Auto-suggest moving SL to BE
            trade.notes = (trade.notes || '') + `\n[${new Date().toLocaleString()}] TP1 hit @ ${exitPrice}. Closed ${closePercent}%.`;
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            updateActiveTradeManagement();
            loadTrades();
            
            showToast(`TP1 recorded! ${closePercent}% closed @ ${exitPrice}. Now move SL to breakeven.`, 'success');
        }
        
        // Move stop loss to breakeven
        function moveToBE(tradeId) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) {
                showToast('Trade not found', 'error');
                return;
            }
            
            const trade = trades[index];
            
            // Move SL to entry (breakeven)
            const originalSL = trade.stop;
            trade.stop = trade.entry;
            trade.slMovedToBE = true;
            trade.slMovedToBEAt = new Date().toISOString();
            
            // Track SL history
            if (!trade.slHistory) trade.slHistory = [];
            trade.slHistory.push({
                from: originalSL,
                to: trade.entry,
                time: new Date().toISOString(),
                reason: 'MOVE_TO_BE'
            });
            
            trade.notes = (trade.notes || '') + `\n[${new Date().toLocaleString()}] SL moved to BE @ ${trade.entry}`;
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            updateActiveTradeManagement();
            loadTrades();
            
            showToast(`Stop loss moved to breakeven @ ${trade.entry}. Risk-free trade!`, 'success');
        }
        
        // Open trailing stop modal
        function openTrailModal(tradeId) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const trade = trades.find(t => t.id === tradeId);
            
            if (!trade) {
                showToast('Trade not found', 'error');
                return;
            }
            
            const volState = trade.volState || 'TREND';
            const trailRec = getTrailRecommendation(volState);
            
            const modalHtml = `
                <div class="trail-modal-overlay" id="trail-modal-overlay" onclick="closeTrailModal(event)">
                    <div class="trail-modal" onclick="event.stopPropagation()">
                        <h3>&#x1F4C8; Set Trailing Stop for ${trade.pair}</h3>
                        
                        <div class="vol-trail-recommendation">
                            <strong>Volatility: ${volState}</strong><br>
                            ${trailRec.recommendation}
                        </div>
                        
                        <div class="trail-option-card" onclick="selectTrailOption(this, 'structure')" data-option="structure">
                            <div class="trail-option-title">&#x1F4CD; Structure Trail</div>
                            <div class="trail-option-desc">Trail behind swing highs/lows (manual updates)</div>
                        </div>
                        
                        <div class="trail-option-card" onclick="selectTrailOption(this, 'atr')" data-option="atr">
                            <div class="trail-option-title">&#x1F4CA; ATR Trail (${trailRec.atrMultiple}x)</div>
                            <div class="trail-option-desc">Volatility-adjusted trail based on ${volState} state</div>
                            <input type="number" class="form-input mt-sm" id="trail-atr-input" value="${trailRec.atrMultiple}" step="0.5" min="0.5" max="3" placeholder="ATR Multiple">
                        </div>
                        
                        <div class="trail-option-card" onclick="selectTrailOption(this, 'fixed')" data-option="fixed">
                            <div class="trail-option-title">&#x1F4CD; Fixed Pips Trail</div>
                            <div class="trail-option-desc">Trail by fixed pip distance</div>
                            <input type="number" class="form-input mt-sm" id="trail-fixed-input" value="20" min="5" max="100" placeholder="Pips">
                        </div>
                        
                        <div class="flex gap-sm mt-md">
                            <button class="btn btn-primary" onclick="applyTrailStop('${tradeId}')">Apply Trail</button>
                            <button class="btn btn-secondary" onclick="closeTrailModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function selectTrailOption(el, option) {
            document.querySelectorAll('.trail-option-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            el.dataset.selected = 'true';
        }
        
        function closeTrailModal(event) {
            if (event && event.target.id !== 'trail-modal-overlay') return;
            const modal = document.getElementById('trail-modal-overlay');
            if (modal) modal.remove();
        }
        
        function applyTrailStop(tradeId) {
            const selectedOption = document.querySelector('.trail-option-card.selected');
            if (!selectedOption) {
                showToast('Please select a trail method', 'warning');
                return;
            }
            
            const option = selectedOption.dataset.option;
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) {
                showToast('Trade not found', 'error');
                return;
            }
            
            const trade = trades[index];
            trade.trailingActive = true;
            trade.trailMethod = option;
            
            if (option === 'atr') {
                trade.trailAtrMultiple = parseFloat(document.getElementById('trail-atr-input').value) || 1.5;
            } else if (option === 'fixed') {
                trade.trailFixedPips = parseInt(document.getElementById('trail-fixed-input').value) || 20;
            }
            
            if (!trade.trailingStopHistory) trade.trailingStopHistory = [];
            trade.trailingStopHistory.push({
                method: option,
                time: new Date().toISOString(),
                params: option === 'atr' ? trade.trailAtrMultiple : option === 'fixed' ? trade.trailFixedPips : 'structure'
            });
            
            trade.notes = (trade.notes || '') + `\n[${new Date().toLocaleString()}] Trail stop activated: ${option.toUpperCase()}`;
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            closeTrailModal();
            updateActiveTradeManagement();
            loadTrades();
            
            showToast(`Trailing stop activated: ${option.toUpperCase()}`, 'success');
        }
        
        // Acknowledge time warning for a trade
        function acknowledgeTimeWarning(tradeId) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) return;
            
            trades[index].timeWarningAcknowledged = true;
            trades[index].lastReviewedAt = new Date().toISOString();
            trades[index].notes = (trades[index].notes || '') + `\n[${new Date().toLocaleString()}] Time warning reviewed - trade held.`;
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            updateActiveTradeManagement();
            
            showToast('Trade reviewed and acknowledged', 'info');
        }
        
        // Refresh trade ages
        function refreshTradeAges() {
            updateActiveTradeManagement();
            showToast('Trade ages refreshed', 'info');
        }
        
        // Move all open trades to breakeven
        function moveAllToBE() {
            if (!confirm('Move ALL open trades to breakeven? This requires TP1 to be hit first for proper protocol.')) return;
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            let moved = 0;
            
            trades.forEach(trade => {
                if (trade.status === 'open' && trade.tp1Hit && !trade.slMovedToBE) {
                    trade.stop = trade.entry;
                    trade.slMovedToBE = true;
                    trade.slMovedToBEAt = new Date().toISOString();
                    moved++;
                }
            });
            
            if (moved > 0) {
                saveToStorage(STORAGE_KEYS.trades, trades);
                updateActiveTradeManagement();
                loadTrades();
                showToast(`${moved} trades moved to breakeven`, 'success');
            } else {
                showToast('No eligible trades (need TP1 hit first)', 'warning');
            }
        }
        
        // Close all open trades at market
        function closeAllAtMarket() {
            if (!confirm('WARNING: CLOSE ALL OPEN TRADES AT MARKET? This cannot be undone!')) return;
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const openTrades = trades.filter(t => t.status === 'open');
            
            if (openTrades.length === 0) {
                showToast('No open trades to close', 'info');
                return;
            }
            
            const exitPrice = prompt('Enter current market price (or leave blank for manual entry per trade):');
            
            openTrades.forEach(trade => {
                const idx = trades.findIndex(t => t.id === trade.id);
                if (idx !== -1) {
                    if (exitPrice) {
                        trades[idx].exit = parseFloat(exitPrice);
                    }
                    trades[idx].status = 'closed';
                    trades[idx].exitReason = 'CLOSE_ALL';
                    trades[idx].closedAt = new Date().toISOString();
                    trades[idx].rMultiple = calculateRMultiple(trades[idx]);
                }
            });
            
            saveToStorage(STORAGE_KEYS.trades, trades);
            updateActiveTradeManagement();
            loadTrades();
            updateDashboard();
            
            showToast(`${openTrades.length} trades closed`, 'success');
        }
        
        // Initialize Phase 2 on load
        function initPhase2ExitStrategy() {
            // Run on journal tab shown
            updateActiveTradeManagement();
            
            // Check Friday warning every minute
            setInterval(checkFridayWarning, 60000);
            
            // Initial Friday check
            if (!sessionStorage.getItem('fridayWarningDismissed')) {
                checkFridayWarning();
            }
        }
        
        // Hook into tab changes
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'journal') {
                updateActiveTradeManagement();
            }
        };
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initPhase2ExitStrategy, 500);
        });

        // ============================================
        // PHASE 3: TRADE GRADING SYSTEM
        // ============================================
        
        /**
         * Trade Grading Criteria:
         * - UTCC Score (0-100): Primary factor
         * - Entry Zone (HOT/OPTIMAL/ACCEPTABLE/EXTENDED)
         * - R:R Ratio
         * - MTF Alignment
         * - Volatility State
         * - Session-Pair Match
         * - News Safety
         * 
         * Grades:
         * A+ (90-100): Perfect setup, full position
         * A  (80-89):  Excellent setup, full position
         * B  (70-79):  Good setup, standard position
         * C  (60-69):  Acceptable, reduced position (50%)
         * D  (<60):    Skip trade
         */
        
        const GRADE_THRESHOLDS = {
            APLUS: { min: 90, label: 'A+', cssClass: 'grade-aplus', position: 'FULL (2%)', positionClass: 'rec-full' },
            A: { min: 80, label: 'A', cssClass: 'grade-a', position: 'FULL (1.5-2%)', positionClass: 'rec-full' },
            B: { min: 70, label: 'B', cssClass: 'grade-b', position: 'STANDARD (1.5%)', positionClass: 'rec-full' },
            C: { min: 60, label: 'C', cssClass: 'grade-c', position: 'REDUCED (1%)', positionClass: 'rec-reduced' },
            D: { min: 0, label: 'D', cssClass: 'grade-d', position: 'SKIP TRADE', positionClass: 'rec-skip' },
            DIS: { min: -1, label: 'DIS', cssClass: 'grade-dis', position: 'DISMISSED', positionClass: 'rec-skip' }
        };
        
        const ZONE_SCORES = {
            'HOT': 25,
            'OPTIMAL': 20,
            'ACCEPTABLE': 12,
            'EXTENDED': 5,
            '': 0
        };
        
        const VOL_STATE_SCORES = {
            'TREND': 15,
            'EXPLODE': 12,
            'QUIET': 8,
            'NORMAL': 10,
            'LOW': 0,
            '': 5
        };
        
        /**
         * Calculate trade grade based on all criteria
         */
        function calculateTradeGrade(criteria) {
            const {
                utccScore = 0,
                entryZone = '',
                rrRatio = 0,
                mtfAlignment = '0/3',
                volState = '',
                sessionPairMatch = 'NEUTRAL',
                newsClean = false
            } = criteria;
            
            let totalScore = 0;
            let breakdown = [];
            
            // 1. UTCC Score (max 35 points)
            // Score >= 90 = 35pts, 80-89 = 30pts, 70-79 = 20pts, <70 = 10pts
            let utccPoints = 0;
            if (utccScore >= 90) utccPoints = 35;
            else if (utccScore >= 80) utccPoints = 30;
            else if (utccScore >= 70) utccPoints = 20;
            else if (utccScore >= 60) utccPoints = 10;
            else utccPoints = 5;
            
            totalScore += utccPoints;
            breakdown.push({
                label: `Score: ${utccScore}`,
                points: utccPoints,
                status: utccScore >= 75 ? 'pass' : utccScore >= 60 ? 'warn' : 'fail'
            });
            
            // 2. Entry Zone (max 25 points)
            const zonePoints = ZONE_SCORES[entryZone.toUpperCase()] || 0;
            totalScore += zonePoints;
            breakdown.push({
                label: `Zone: ${entryZone || 'N/A'}`,
                points: zonePoints,
                status: zonePoints >= 20 ? 'pass' : zonePoints >= 12 ? 'warn' : 'fail'
            });
            
            // 3. R:R Ratio (max 20 points)
            // R:R >= 2.5 = 20pts, 2.0-2.5 = 18pts, 1.5-2.0 = 12pts, 1.0-1.5 = 5pts, <1.0 = 0pts
            let rrPoints = 0;
            if (rrRatio >= 2.5) rrPoints = 20;
            else if (rrRatio >= 2.0) rrPoints = 18;
            else if (rrRatio >= 1.5) rrPoints = 12;
            else if (rrRatio >= 1.0) rrPoints = 5;
            else rrPoints = 0;
            
            totalScore += rrPoints;
            breakdown.push({
                label: `R:R: ${rrRatio.toFixed(2)}`,
                points: rrPoints,
                status: rrRatio >= 1.5 ? 'pass' : rrRatio >= 1.0 ? 'warn' : 'fail'
            });
            
            // 4. Volatility State (max 15 points)
            const volPoints = VOL_STATE_SCORES[volState.toUpperCase()] || 5;
            totalScore += volPoints;
            breakdown.push({
                label: `Vol: ${volState || 'N/A'}`,
                points: volPoints,
                status: volPoints >= 12 ? 'pass' : volPoints >= 8 ? 'warn' : 'fail'
            });
            
            // 5. News Safety (5 points)
            const newsPoints = newsClean ? 5 : 0;
            totalScore += newsPoints;
            
            // Determine grade
            let grade;
            if (totalScore >= 90) grade = GRADE_THRESHOLDS.APLUS;
            else if (totalScore >= 80) grade = GRADE_THRESHOLDS.A;
            else if (totalScore >= 70) grade = GRADE_THRESHOLDS.B;
            else if (totalScore >= 60) grade = GRADE_THRESHOLDS.C;
            else grade = GRADE_THRESHOLDS.D;
            
            return {
                totalScore,
                grade,
                breakdown
            };
        }
        
        /**
         * Update grade display in validation panel
         */
        function updateTradeGradeDisplay() {
            const gradeDisplay = document.getElementById('trade-grade-display');
            const gradeBadge = document.getElementById('grade-badge');
            const gradeBreakdown = document.getElementById('grade-breakdown');
            const gradePositionRec = document.getElementById('grade-position-rec');
            const gradePositionValue = document.getElementById('grade-position-value');
            
            if (!gradeDisplay) return;
            
            // Collect current validation data
            const utccScore = parseInt(document.getElementById('val-score')?.value) || 0;
            const entryZone = document.getElementById('val-zone')?.value || '';
            const volState = document.getElementById('val-vol-state')?.value || '';
            
            // Get R:R from structure analysis
            const rrValueEl = document.querySelector('#structure-rr-value');
            let rrRatio = 0;
            if (rrValueEl) {
                const rrText = rrValueEl.textContent;
                const match = rrText.match(/([\d.]+)/);
                if (match) rrRatio = parseFloat(match[1]);
            }
            
            // Check news safety
            const newsCheck = document.getElementById('check-timing-news');
            const newsClean = newsCheck?.checked || false;
            
            // Only show grade if we have minimum data
            if (!utccScore || utccScore < 50) {
                gradeDisplay.style.display = 'none';
                return;
            }
            
            // Calculate grade
            const result = calculateTradeGrade({
                utccScore,
                entryZone,
                rrRatio,
                volState,
                newsClean
            });
            
            // Show grade display
            gradeDisplay.style.display = 'flex';
            
            // Update badge
            gradeBadge.textContent = result.grade.label;
            gradeBadge.className = `grade-badge ${result.grade.cssClass}`;
            
            // Update breakdown
            gradeBreakdown.innerHTML = result.breakdown.map(item => 
                `<span class="breakdown-item item-${item.status}">${item.label}</span>`
            ).join('');
            
            // Update position recommendation
            gradePositionValue.textContent = result.grade.position;
            gradePositionRec.className = `grade-position-rec ${result.grade.positionClass}`;
            
            // Store grade for trade logging
            window.currentTradeGrade = result;
        }
        
        /**
         * Get grade badge HTML for trade display
         */
        function getGradeBadge(grade, dismissReason) {
            if (!grade) return '<span class="grade-mini-badge grade-d">?</span>';
            if (grade === 'DIS') {
                const reason = dismissReason || 'Dismissed';
                return `<span class="grade-mini-badge grade-dis" title="${reason}">DIS</span>`;
            }
            
            const gradeInfo = Object.values(GRADE_THRESHOLDS).find(g => g.label === grade) || GRADE_THRESHOLDS.D;
            return `<span class="grade-mini-badge ${gradeInfo.cssClass}">${gradeInfo.label}</span>`;
        }
        
        /**
         * Hook grade calculation into validation updates
         */
        const originalUpdateValidationVerdict = typeof updateValidationVerdict === 'function' ? updateValidationVerdict : null;
        
        function updateValidationVerdictWithGrade() {
            // Call original if exists
            if (originalUpdateValidationVerdict) {
                originalUpdateValidationVerdict();
            }
            
            // Update grade display
            updateTradeGradeDisplay();
        }
        
        // Override validation updates to include grade
        document.addEventListener('DOMContentLoaded', () => {
            // Hook into input changes
            const validationInputs = [
                'val-score', 'val-zone', 'val-vol-state', 
                'check-timing-news', 'val-entry', 'val-stop', 'val-tp'
            ];
            
            validationInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', updateTradeGradeDisplay);
                    el.addEventListener('input', updateTradeGradeDisplay);
                }
            });
            
            // Initial calculation
            setTimeout(updateTradeGradeDisplay, 1000);
        });
        
        /**
         * Update executeTradeFromValidation to include grade
         */
        const originalExecuteTradeFromValidation = typeof executeTradeFromValidation === 'function' ? executeTradeFromValidation : null;
        
        if (originalExecuteTradeFromValidation) {
            executeTradeFromValidation = function() {
                // Store grade before executing
                if (window.currentTradeGrade) {
                    sessionStorage.setItem('lastTradeGrade', JSON.stringify(window.currentTradeGrade));
                }
                originalExecuteTradeFromValidation();
            };
        }

        // ============================================
        // PHASE 4: RE-ENTRY RULES SYSTEM
        // ============================================
        
        /**
         * Re-Entry Rules:
         * 1. 4-hour minimum wait after stop loss hit
         * 2. Fresh setup required (not same pattern)
         * 3. Higher score than the stopped trade
         * 4. Different session preferred
         */
        
        const REENTRY_WAIT_HOURS = 4;
        
        /**
         * Check if re-entry rules apply for a pair
         */
        function checkReentryRules(pair) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            
            // Find recent stopped trades on this pair
            const recentStops = trades.filter(t => {
                if (t.pair !== pair) return false;
                if (t.status !== 'closed') return false;
                if (!t.exitReason || !t.exitReason.includes('SL')) return false;
                
                // Check if within last 4 hours
                const closedAt = new Date(t.closedAt || t.date);
                const hoursSince = (Date.now() - closedAt.getTime()) / (1000 * 60 * 60);
                return hoursSince < REENTRY_WAIT_HOURS;
            });
            
            if (recentStops.length === 0) {
                return { blocked: false };
            }
            
            // Get the most recent stop
            const lastStop = recentStops.sort((a, b) => 
                new Date(b.closedAt || b.date) - new Date(a.closedAt || a.date)
            )[0];
            
            const closedAt = new Date(lastStop.closedAt || lastStop.date);
            const hoursSince = (Date.now() - closedAt.getTime()) / (1000 * 60 * 60);
            const hoursRemaining = REENTRY_WAIT_HOURS - hoursSince;
            
            return {
                blocked: true,
                lastStop,
                hoursSince,
                hoursRemaining,
                requiredScore: (lastStop.trendScore || 75) + 5, // Need 5 points higher
                lastSession: lastStop.session
            };
        }
        
        /**
         * Update re-entry rules display
         */
        function updateReentryRulesDisplay() {
            const pair = document.getElementById('val-pair')?.value;
            const card = document.getElementById('reentry-rules-card');
            const acceptedEl = document.getElementById('reentry-accepted');
            
            if (!pair || !card) {
                if (card) card.style.display = 'none';
                if (acceptedEl) acceptedEl.checked = true;
                return;
            }
            
            const result = checkReentryRules(pair);
            
            if (!result.blocked) {
                card.style.display = 'none';
                if (acceptedEl) acceptedEl.checked = true;
                updateValidationVerdict();
                return;
            }
            
            // Show re-entry block
            card.style.display = 'block';
            if (acceptedEl) acceptedEl.checked = false;
            
            // Update timer
            const timerEl = document.getElementById('reentry-timer');
            if (timerEl) {
                if (result.hoursRemaining > 0) {
                    const mins = Math.round(result.hoursRemaining * 60);
                    const hrs = Math.floor(mins / 60);
                    const remainMins = mins % 60;
                    timerEl.textContent = `Time remaining: ${hrs}h ${remainMins}m`;
                } else {
                    timerEl.textContent = 'Wait period complete - verify other requirements';
                    timerEl.style.color = 'var(--color-pass)';
                }
            }
            
            // Update score requirement
            const scoreReqEl = document.getElementById('reentry-score-req');
            if (scoreReqEl) {
                scoreReqEl.textContent = `Higher score than stopped trade (need: ${result.requiredScore}+)`;
            }
            
            // Check current values against requirements
            const currentScore = parseInt(document.getElementById('val-score')?.value) || 0;
            const currentSession = detectCurrentSession();
            
            // Update check marks
            updateReentryCheck('reentry-check-time', result.hoursRemaining <= 0);
            updateReentryCheck('reentry-check-score', currentScore >= result.requiredScore);
            updateReentryCheck('reentry-check-session', currentSession !== result.lastSession);
            // Fresh setup is manual confirmation via override
            
            updateValidationVerdict();
        }
        
        function updateReentryCheck(elementId, satisfied) {
            const el = document.getElementById(elementId);
            if (!el) return;
            
            if (satisfied) {
                el.textContent = '\u2611'; // Checked box
                el.className = 'reentry-check checked';
            } else {
                el.textContent = '\u2610'; // Empty box
                el.className = 'reentry-check unchecked';
            }
        }
        
        function detectCurrentSession() {
            const hour = new Date().getHours();
            if (hour >= 7 && hour < 17) return 'asian';
            if (hour >= 17 && hour < 22) return 'london';
            return 'ny';
        }
        
        function handleReentryOverride() {
            const overrideEl = document.getElementById('reentry-override');
            const acceptedEl = document.getElementById('reentry-accepted');
            const freshCheckEl = document.getElementById('reentry-check-fresh');
            
            if (overrideEl?.checked) {
                if (acceptedEl) acceptedEl.checked = true;
                if (freshCheckEl) {
                    freshCheckEl.textContent = '\u2611';
                    freshCheckEl.className = 'reentry-check checked';
                }
                showToast('Re-entry override accepted - trade with caution', 'warning');
            } else {
                if (acceptedEl) acceptedEl.checked = false;
                if (freshCheckEl) {
                    freshCheckEl.textContent = '\u2610';
                    freshCheckEl.className = 'reentry-check unchecked';
                }
            }
            
            updateValidationVerdict();
        }
        
        /**
         * Record stop loss for re-entry tracking
         */
        function recordStopLossHit(tradeId) {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const index = trades.findIndex(t => t.id === tradeId);
            
            if (index === -1) return;
            
            trades[index].exitReason = 'SL_HIT';
            trades[index].closedAt = new Date().toISOString();
            
            saveToStorage(STORAGE_KEYS.trades, trades);
        }
        
        // Hook into pair selection
        document.addEventListener('DOMContentLoaded', () => {
            const pairSelect = document.getElementById('val-pair');
            if (pairSelect) {
                pairSelect.addEventListener('change', updateReentryRulesDisplay);
            }
            
            const scoreInput = document.getElementById('val-score');
            if (scoreInput) {
                scoreInput.addEventListener('input', updateReentryRulesDisplay);
            }
            
            // Periodic timer update
            setInterval(() => {
                const card = document.getElementById('reentry-rules-card');
                if (card && card.style.display !== 'none') {
                    updateReentryRulesDisplay();
                }
            }, 60000); // Update every minute
        });

        function exportTrades() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const closedTrades = trades.filter(t => t.status === 'closed');
            
            if (closedTrades.length === 0) {
                showToast('No closed trades to export', 'warning');
                return;
            }
            
            // Create CSV
            const headers = ['Date', 'Pair', 'Direction', 'Alert', 'Entry', 'Exit', 'R-Multiple', 'PnL', 'Score', 'Zone', 'Session', 'Exit Reason'];
            const rows = closedTrades.map(t => [
                t.date,
                t.pair,
                t.direction,
                t.alertType,
                t.entry,
                t.exit,
                t.rMultiple?.toFixed(2) || '',
                t.pnl?.toFixed(2) || '',
                t.trendScore || '',
                t.entryZone || '',
                t.session || '',
                t.exitReason || ''
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadFile(csv, `trades_export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showToast('Trades exported', 'success');
        }

        function clearAllTrades() {
            if (!confirm(' This will DELETE ALL TRADES. This cannot be undone. Continue?')) return;
            if (!confirm('Are you ABSOLUTELY sure? Type "DELETE" in the next prompt to confirm.')) return;
            
            const confirmText = prompt('Type DELETE to confirm:');
            if (confirmText !== 'DELETE') {
                showToast('Deletion cancelled', 'info');
                return;
            }
            
            saveToStorage(STORAGE_KEYS.trades, []);
            loadTrades();
            updateDashboard();
            showToast('All trades deleted', 'info');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Add journal-specific styles
        const journalStyles = document.createElement('style');
        journalStyles.textContent = `
            .zone-badge {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.7rem;
                font-weight: 600;
            }
            .zone-hot {
                background: var(--zone-hot);
                color: white;
            }
            .zone-optimal {
                background: var(--zone-optimal);
                color: white;
            }
            .zone-acceptable {
                background: var(--zone-acceptable);
                color: #000;
            }
            .zone-extended {
                background: var(--zone-extended);
                color: white;
            }
            .badge-perfect {
                background: var(--color-perfect);
                color: white;
            }
        `;
        document.head.appendChild(journalStyles);

        // CHUNK 5 COMPLETE - Trade Journal CRUD

        // ============================================
        // CHUNK 6: PERFORMANCE ANALYTICS
        // ============================================

        function updatePerformanceStats() {
            const trades = loadFromStorage(STORAGE_KEYS.trades, []);
            const period = document.getElementById('perf-period')?.value || 'all';
            const filteredTrades = filterTradesByPeriod(trades.filter(t => t.status === 'closed'), period);
            
            calculateOverallStats(filteredTrades);
            calculateSessionStats(filteredTrades);
            calculateAlertTypeStats(filteredTrades);
            calculateGradeStats(filteredTrades);
            analyzeLossingTrades(filteredTrades);
            generateInsights(filteredTrades);
        }

        function filterTradesByPeriod(trades, period) {
            const now = new Date();
            
            switch(period) {
                case 'week':
                    const { start: weekStart } = getWeekRange();
                    return trades.filter(t => new Date(t.date) >= weekStart);
                    
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return trades.filter(t => new Date(t.date) >= monthStart);
                    
                case 'quarter':
                    const quarterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
                    return trades.filter(t => new Date(t.date) >= quarterStart);
                    
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    return trades.filter(t => new Date(t.date) >= yearStart);
                    
                default:
                    return trades;
            }
        }

        function calculateOverallStats(trades) {
            const totalTrades = trades.length;
            
            if (totalTrades === 0) {
                setEmptyOverallStats();
                return;
            }
            
            const winners = trades.filter(t => (t.rMultiple || 0) > 0);
            const losers = trades.filter(t => (t.rMultiple || 0) < 0);
            
            const winRate = (winners.length / totalTrades) * 100;
            
            const allR = trades.map(t => t.rMultiple || 0);
            const avgR = allR.reduce((a, b) => a + b, 0) / totalTrades;
            const totalR = allR.reduce((a, b) => a + b, 0);
            
            const avgWin = winners.length > 0 
                ? winners.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / winners.length 
                : 0;
            const avgLoss = losers.length > 0 
                ? Math.abs(losers.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / losers.length) 
                : 0;
            const expectancy = (winRate / 100 * avgWin) - ((1 - winRate / 100) * avgLoss);
            
            const grossProfit = winners.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
            const grossLoss = Math.abs(losers.reduce((sum, t) => sum + (t.rMultiple || 0), 0));
            const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : grossProfit > 0 ? 999 : 0;
            
            const largestWin = winners.length > 0 ? Math.max(...winners.map(t => t.rMultiple || 0)) : 0;
            const largestLoss = losers.length > 0 ? Math.min(...losers.map(t => t.rMultiple || 0)) : 0;
            
            const { maxWinStreak, maxLoseStreak } = calculateStreaks(trades);
            
            updateElement('perf-total-trades', totalTrades);
            updateElement('perf-win-rate', `${formatNumber(winRate, 1)}%`, winRate >= 50 ? 'text-pass' : 'text-fail');
            updateElement('perf-avg-r', `${formatNumber(avgR, 2)}R`, avgR >= 0 ? 'text-pass' : 'text-fail');
            updateElement('perf-expectancy', `${formatNumber(expectancy, 2)}R`, expectancy >= 0 ? 'text-pass' : 'text-fail');
            updateElement('perf-profit-factor', formatNumber(profitFactor, 2), profitFactor >= 1 ? 'text-pass' : 'text-fail');
            updateElement('perf-total-r', `${formatNumber(totalR, 2)}R`, totalR >= 0 ? 'text-pass' : 'text-fail');
            updateElement('perf-largest-win', `+${formatNumber(largestWin, 2)}R`, 'text-pass');
            updateElement('perf-largest-loss', `${formatNumber(largestLoss, 2)}R`, 'text-fail');
            updateElement('perf-avg-winner', `+${formatNumber(avgWin, 2)}R`, 'text-pass');
            updateElement('perf-avg-loser', `${formatNumber(-avgLoss, 2)}R`, 'text-fail');
            updateElement('perf-win-streak', maxWinStreak);
            updateElement('perf-lose-streak', maxLoseStreak);
        }

        function setEmptyOverallStats() {
            const ids = ['perf-total-trades', 'perf-win-rate', 'perf-avg-r', 'perf-expectancy',
                'perf-profit-factor', 'perf-total-r', 'perf-largest-win', 'perf-largest-loss',
                'perf-avg-winner', 'perf-avg-loser', 'perf-win-streak', 'perf-lose-streak'];
            ids.forEach(id => updateElement(id, '-'));
        }

        function updateElement(id, value, className = '') {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                if (className) el.className = 'stat-value ' + className;
            }
        }

        function calculateStreaks(trades) {
            let maxWinStreak = 0, maxLoseStreak = 0, currentWin = 0, currentLose = 0;
            const sorted = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            sorted.forEach(trade => {
                if ((trade.rMultiple || 0) > 0) {
                    currentWin++;
                    currentLose = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWin);
                } else if ((trade.rMultiple || 0) < 0) {
                    currentLose++;
                    currentWin = 0;
                    maxLoseStreak = Math.max(maxLoseStreak, currentLose);
                }
            });
            
            return { maxWinStreak, maxLoseStreak };
        }

        function calculateSessionStats(trades) {
            const sessions = ['asian', 'london', 'ny', 'overlap'];
            const tbody = document.getElementById('session-stats-body');
            if (!tbody) return;
            
            const rows = sessions.map(session => {
                const sessionTrades = trades.filter(t => t.session === session);
                const count = sessionTrades.length;
                if (count === 0) return `<tr><td>${session.toUpperCase()}</td><td>0</td><td>-</td><td>-</td><td>-</td></tr>`;
                
                const winners = sessionTrades.filter(t => (t.rMultiple || 0) > 0);
                const winRate = (winners.length / count) * 100;
                const avgR = sessionTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / count;
                const totalR = sessionTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                
                return `
                    <tr>
                        <td><strong>${session.toUpperCase()}</strong></td>
                        <td>${count}</td>
                        <td class="${winRate >= 50 ? 'text-pass' : 'text-fail'}">${formatNumber(winRate, 0)}%</td>
                        <td class="${avgR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(avgR, 2)}R</td>
                        <td class="${totalR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(totalR, 2)}R</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.join('');
        }

        function calculateAlertTypeStats(trades) {
            const alertTypes = ['TRADE_READY', 'STRONG_BULL', 'STRONG_BEAR', 'PERFECT_BULL', 'PERFECT_BEAR', 'MANUAL'];
            const tbody = document.getElementById('alert-stats-body');
            if (!tbody) return;
            
            const rows = alertTypes.map(alert => {
                const alertTrades = trades.filter(t => t.alertType === alert);
                const count = alertTrades.length;
                if (count === 0) return `<tr><td>${getAlertBadge(alert)}</td><td>0</td><td>-</td><td>-</td><td>-</td></tr>`;
                
                const winners = alertTrades.filter(t => (t.rMultiple || 0) > 0);
                const winRate = (winners.length / count) * 100;
                const avgR = alertTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / count;
                const totalR = alertTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                
                return `
                    <tr>
                        <td>${getAlertBadge(alert)}</td>
                        <td>${count}</td>
                        <td class="${winRate >= 50 ? 'text-pass' : 'text-fail'}">${formatNumber(winRate, 0)}%</td>
                        <td class="${avgR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(avgR, 2)}R</td>
                        <td class="${totalR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(totalR, 2)}R</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.join('');
        }

        function calculateGradeStats(trades) {
            const grades = ['A+', 'A', 'B', 'C', 'D', 'DIS', null];
            const gradeKeys = ['aplus', 'a', 'b', 'c', 'd', 'dis', 'none'];
            const tbody = document.getElementById('grade-stats-body');
            
            if (!tbody) return;
            
            let bestGrade = null;
            let bestAvgR = -999;
            let mostTradedGrade = null;
            let mostTradedCount = 0;
            const gradePerformances = [];
            
            const rows = grades.map((grade, idx) => {
                const key = gradeKeys[idx];
                const gradeTrades = grade === null 
                    ? trades.filter(t => !t.grade) 
                    : trades.filter(t => t.grade === grade);
                const count = gradeTrades.length;
                
                // Track most traded
                if (count > mostTradedCount && grade !== null) {
                    mostTradedCount = count;
                    mostTradedGrade = grade;
                }
                
                if (count === 0) {
                    return `
                        <tr>
                            <td>${getGradeBadge(grade)}</td>
                            <td>0</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                    `;
                }
                
                const winners = gradeTrades.filter(t => (t.rMultiple || 0) > 0);
                const losers = gradeTrades.filter(t => (t.rMultiple || 0) < 0);
                const winRate = (winners.length / count) * 100;
                const avgR = gradeTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / count;
                const totalR = gradeTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                
                const avgWin = winners.length > 0 
                    ? winners.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / winners.length 
                    : 0;
                const avgLoss = losers.length > 0 
                    ? Math.abs(losers.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / losers.length) 
                    : 0;
                const expectancy = (winRate / 100 * avgWin) - ((1 - winRate / 100) * avgLoss);
                
                const best = gradeTrades.length > 0 
                    ? Math.max(...gradeTrades.map(t => t.rMultiple || 0)) 
                    : 0;
                const worst = gradeTrades.length > 0 
                    ? Math.min(...gradeTrades.map(t => t.rMultiple || 0)) 
                    : 0;
                
                // Track best performer (by avg R, min 3 trades)
                if (count >= 3 && avgR > bestAvgR && grade !== null) {
                    bestAvgR = avgR;
                    bestGrade = grade;
                }
                
                // Track for correlation
                if (grade !== null && count >= 1) {
                    gradePerformances.push({ grade, avgR, count });
                }
                
                return `
                    <tr>
                        <td>${getGradeBadge(grade)}</td>
                        <td>${count}</td>
                        <td class="${winRate >= 50 ? 'text-pass' : 'text-fail'}">${formatNumber(winRate, 0)}%</td>
                        <td class="${avgR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(avgR, 2)}R</td>
                        <td class="${totalR >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(totalR, 2)}R</td>
                        <td class="${expectancy >= 0 ? 'text-pass' : 'text-fail'}">${formatNumber(expectancy, 2)}R</td>
                        <td class="text-pass">${best > 0 ? '+' : ''}${formatNumber(best, 2)}R</td>
                        <td class="text-fail">${formatNumber(worst, 2)}R</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = rows.join('');
            
            // Update summary stats
            updateElement('grade-best-performer', bestGrade || '--');
            updateElement('grade-most-traded', mostTradedGrade || '--');
            
            // Calculate grade-performance correlation
            const correlation = calculateGradeCorrelation(gradePerformances);
            const corrText = correlation === null ? '--' : 
                correlation > 0.5 ? 'Strong' :
                correlation > 0.2 ? 'Moderate' :
                correlation > -0.2 ? 'Weak' :
                correlation > -0.5 ? 'Inverse' : 'Strong Inverse';
            updateElement('grade-correlation', corrText);
        }
        
        function calculateGradeCorrelation(gradePerformances) {
            // Simple correlation: do higher grades = better performance?
            // A+ = 5, A = 4, B = 3, C = 2, D = 1
            if (gradePerformances.length < 3) return null;
            
            const gradeRanks = { 'A+': 5, 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
            
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0, n = 0;
            
            gradePerformances.forEach(gp => {
                const x = gradeRanks[gp.grade] || 0;
                const y = gp.avgR;
                const weight = Math.min(gp.count, 10); // Cap weight at 10
                
                for (let i = 0; i < weight; i++) {
                    sumX += x;
                    sumY += y;
                    sumXY += x * y;
                    sumX2 += x * x;
                    sumY2 += y * y;
                    n++;
                }
            });
            
            if (n < 3) return null;
            
            const numerator = (n * sumXY) - (sumX * sumY);
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            if (denominator === 0) return 0;
            return numerator / denominator;
        }

        function analyzeLossingTrades(trades) {
            const losers = trades.filter(t => (t.rMultiple || 0) < 0);
            const container = document.getElementById('losing-analysis');
            if (!container) return;
            
            if (losers.length === 0) {
                container.innerHTML = '<p class="text-muted">No losing trades to analyse.</p>';
                return;
            }
            
            // Analyse patterns
            const patterns = {
                lowScore: losers.filter(t => (t.trendScore || 0) < 80).length,
                badZone: losers.filter(t => ['ACCEPTABLE', 'EXTENDED'].includes(t.entryZone)).length,
                lowMtf: losers.filter(t => t.mtf !== '3/3').length,
                manual: losers.filter(t => t.alertType === 'MANUAL').length
            };
            
            const totalLosses = losers.length;
            const insights = [];
            
            if (patterns.lowScore > totalLosses * 0.3) {
                insights.push(` ${formatNumber(patterns.lowScore / totalLosses * 100, 0)}% of losses had trend score below 80`);
            }
            if (patterns.badZone > totalLosses * 0.3) {
                insights.push(` ${formatNumber(patterns.badZone / totalLosses * 100, 0)}% of losses were from ACCEPTABLE/EXTENDED zones`);
            }
            if (patterns.lowMtf > totalLosses * 0.3) {
                insights.push(` ${formatNumber(patterns.lowMtf / totalLosses * 100, 0)}% of losses didn't have full MTF alignment`);
            }
            if (patterns.manual > totalLosses * 0.4) {
                insights.push(` ${formatNumber(patterns.manual / totalLosses * 100, 0)}% of losses were MANUAL trades (not system alerts)`);
            }
            
            if (insights.length === 0) {
                insights.push(' No clear patterns detected in losing trades');
            }
            
            container.innerHTML = insights.map(i => `<p style="margin-bottom: 8px;">${i}</p>`).join('');
        }

        function generateInsights(trades) {
            const container = document.getElementById('ai-insights');
            if (!container) return;
            
            // If no trades passed, get closed trades from localStorage
            if (!trades) {
                const allTrades = JSON.parse(localStorage.getItem('forex_trades') || '[]');
                trades = allTrades.filter(t => t.status === 'closed');
            }
            
            if (!trades || trades.length < 5) {
                container.innerHTML = '<p class="text-muted">Need at least 5 closed trades to generate insights.</p>';
                return;
            }
            
            const insights = [];
            const winners = trades.filter(t => (t.rMultiple || 0) > 0);
            const winRate = (winners.length / trades.length) * 100;
            const avgR = trades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / trades.length;
            
            // Win rate insights
            if (winRate >= 60) {
                insights.push(' <strong>Excellent selectivity!</strong> Your win rate exceeds 60%. Keep being selective.');
            } else if (winRate < 45) {
                insights.push(' <strong>Win rate below 45%.</strong> Review your entry criteria. Are you waiting for all 5 conditions?');
            }
            
            // R-multiple insights
            if (avgR >= 0.5) {
                insights.push(' <strong>Strong average R.</strong> Your winners are properly sized against losers.');
            } else if (avgR < 0) {
                insights.push(' <strong>Negative expectancy.</strong> Review exit strategy - are you cutting winners too early?');
            }
            
            // Session insights
            const sessionPerf = {};
            ['asian', 'london', 'ny', 'overlap'].forEach(s => {
                const st = trades.filter(t => t.session === s);
                if (st.length >= 3) {
                    sessionPerf[s] = st.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / st.length;
                }
            });
            
            const bestSession = Object.entries(sessionPerf).sort((a, b) => b[1] - a[1])[0];
            const worstSession = Object.entries(sessionPerf).sort((a, b) => a[1] - b[1])[0];
            
            if (bestSession && bestSession[1] > 0.3) {
                insights.push(` <strong>${bestSession[0].toUpperCase()}</strong> is your best session (avg ${formatNumber(bestSession[1], 2)}R)`);
            }
            if (worstSession && worstSession[1] < -0.2) {
                insights.push(` Consider avoiding <strong>${worstSession[0].toUpperCase()}</strong> session (avg ${formatNumber(worstSession[1], 2)}R)`);
            }
            
            // Alert type insights
            const tradeReadyTrades = trades.filter(t => t.alertType === 'TRADE_READY');
            const manualTrades = trades.filter(t => t.alertType === 'MANUAL');
            
            if (tradeReadyTrades.length >= 3 && manualTrades.length >= 3) {
                const trAvg = tradeReadyTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / tradeReadyTrades.length;
                const manAvg = manualTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / manualTrades.length;
                
                if (trAvg > manAvg + 0.3) {
                    insights.push(' <strong>System alerts outperform manual trades.</strong> Trust the UTCC signals!');
                }
            }
            
            // Trade frequency
            if (trades.length > 10) {
                const weeklyAvg = trades.length / 4; // Rough estimate
                if (weeklyAvg > 10) {
                    insights.push(' <strong>High trade frequency.</strong> Target is 5-10/week. Quality over quantity!');
                }
            }
            
            if (insights.length === 0) {
                insights.push(' Keep trading consistently to generate more insights.');
            }
            
            container.innerHTML = insights.map(i => `<div class="insight-item">${i}</div>`).join('');
        }

        // Add performance-specific styles
        const perfStyles = document.createElement('style');
        perfStyles.textContent = `
            .insight-item {
                padding: var(--spacing-sm) var(--spacing-md);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
                margin-bottom: var(--spacing-sm);
                font-size: 0.9rem;
            }
            #losing-analysis p, #ai-insights .insight-item {
                border-left: 3px solid var(--border-accent);
                padding-left: var(--spacing-md);
            }
        `;
        document.head.appendChild(perfStyles);

        // ============================================
        // CLAUDE EXPORT FUNCTIONS
        // ============================================
        
        function generateClaudeExport() {
            const period = document.getElementById('export-period').value;
            const includeTrades = document.getElementById('export-trades').checked;
            const includeLessons = document.getElementById('export-lessons').checked;
            const includeSettings = document.getElementById('export-settings').checked;
            
            const allTrades = loadFromStorage(STORAGE_KEYS.trades, []);
            const settings = loadFromStorage(STORAGE_KEYS.settings, DEFAULT_SETTINGS);
            const scans = loadFromStorage(STORAGE_KEYS.scans, {});
            
            // Filter trades by period
            const now = new Date();
            let cutoffDate = null;
            let periodLabel = 'All Time';
            if (period === 'week') {
                cutoffDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
                periodLabel = 'Last 7 Days';
            } else if (period === 'month') {
                cutoffDate = new Date(now - 30 * 24 * 60 * 60 * 1000);
                periodLabel = 'Last 30 Days';
            } else if (period === 'quarter') {
                cutoffDate = new Date(now - 90 * 24 * 60 * 60 * 1000);
                periodLabel = 'Last 90 Days';
            }
            
            const trades = cutoffDate 
                ? allTrades.filter(t => new Date(t.date) >= cutoffDate)
                : allTrades;
            
            const closedTrades = trades.filter(t => t.status === 'closed');
            const openTrades = trades.filter(t => t.status === 'open');
            
            let report = [];
            
            // Header
            report.push('# FOREX TRADING REVIEW REQUEST');
            report.push('');
            report.push('I am requesting a coaching review of my forex trading performance. Please analyse the data below and provide:');
            report.push('1. Assessment of my trading performance and patterns');
            report.push('2. Identification of strengths and weaknesses');
            report.push('3. Specific actionable improvements for my trading');
            report.push('4. Suggestions for enhancing my UTCC system or Command Centre tool');
            report.push('5. Analysis of my setup notes vs outcomes - am I reading setups correctly?');
            report.push('');
            report.push('---');
            report.push('');
            
            // Account Overview
            report.push('## ACCOUNT OVERVIEW');
            report.push('');
            const drawdownPct = settings.peakBalance > 0 ? ((1 - settings.accountBalance / settings.peakBalance) * 100) : 0;
            report.push(`- **Export Date:** ${new Date().toLocaleDateString('en-AU')} ${new Date().toLocaleTimeString('en-AU')}`);
            report.push(`- **Period:** ${periodLabel}`);
            report.push(`- **Account Balance:** ${formatCurrency(settings.accountBalance, settings.currency)}`);
            report.push(`- **Peak Balance:** ${formatCurrency(settings.peakBalance, settings.currency)}`);
            report.push(`- **Default Risk:** ${settings.defaultRisk}%`);
            report.push(`- **Current Drawdown:** ${formatNumber(drawdownPct, 1)}%`);
            if (drawdownPct >= 5) {
                report.push(`- **Drawdown Status:** ${drawdownPct >= 15 ? 'EMERGENCY - Should stop trading' : drawdownPct >= 10 ? 'STOP - Max 0.5% risk' : 'CAUTION - Reduce position size'}`);
            }
            report.push('');
            
            // Performance Summary
            if (closedTrades.length > 0) {
                const winners = closedTrades.filter(t => (t.rMultiple || 0) > 0);
                const losers = closedTrades.filter(t => (t.rMultiple || 0) < 0);
                const breakeven = closedTrades.filter(t => (t.rMultiple || 0) === 0);
                const totalR = closedTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                const avgR = totalR / closedTrades.length;
                const winRate = (winners.length / closedTrades.length) * 100;
                const avgWin = winners.length > 0 ? winners.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / winners.length : 0;
                const avgLoss = losers.length > 0 ? Math.abs(losers.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / losers.length) : 0;
                const expectancy = (winRate/100 * avgWin) - ((100-winRate)/100 * avgLoss);
                const profitFactor = (avgLoss * losers.length) > 0 ? (avgWin * winners.length) / (avgLoss * losers.length) : 0;
                
                report.push('## PERFORMANCE SUMMARY');
                report.push('');
                report.push(`- **Total Trades:** ${closedTrades.length} closed, ${openTrades.length} open`);
                report.push(`- **Win/Loss/BE:** ${winners.length}W / ${losers.length}L / ${breakeven.length}BE`);
                report.push(`- **Win Rate:** ${formatNumber(winRate, 1)}%`);
                report.push(`- **Total R:** ${totalR >= 0 ? '+' : ''}${formatNumber(totalR, 2)}R`);
                report.push(`- **Average R per Trade:** ${avgR >= 0 ? '+' : ''}${formatNumber(avgR, 2)}R`);
                report.push(`- **Average Winner:** +${formatNumber(avgWin, 2)}R`);
                report.push(`- **Average Loser:** -${formatNumber(avgLoss, 2)}R`);
                report.push(`- **Expectancy:** ${expectancy >= 0 ? '+' : ''}${formatNumber(expectancy, 3)}R per trade`);
                report.push(`- **Profit Factor:** ${formatNumber(profitFactor, 2)}`);
                report.push('');
                
                // Performance by Session
                report.push('### Performance by Session');
                report.push('');
                const sessions = ['asian', 'london', 'ny', 'overlap'];
                const sessionLabels = { asian: 'Tokyo/Asian', london: 'London', ny: 'New York', overlap: 'London/NY Overlap' };
                sessions.forEach(session => {
                    const sessionTrades = closedTrades.filter(t => t.session === session);
                    if (sessionTrades.length > 0) {
                        const sessionWins = sessionTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const sessionR = sessionTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const sessionAvgR = sessionR / sessionTrades.length;
                        report.push(`- **${sessionLabels[session] || session}:** ${sessionTrades.length} trades, ${formatNumber((sessionWins/sessionTrades.length)*100, 0)}% WR, ${sessionR >= 0 ? '+' : ''}${formatNumber(sessionR, 2)}R total, ${sessionAvgR >= 0 ? '+' : ''}${formatNumber(sessionAvgR, 2)}R avg`);
                    }
                });
                const noSessionTrades = closedTrades.filter(t => !t.session);
                if (noSessionTrades.length > 0) {
                    report.push(`- **Unspecified Session:** ${noSessionTrades.length} trades`);
                }
                report.push('');
                
                // Performance by Grade
                report.push('### Performance by Trade Grade');
                report.push('');
                const grades = ['A+', 'A', 'B', 'C', 'D'];
                grades.forEach(grade => {
                    const gradeTrades = closedTrades.filter(t => t.grade === grade);
                    if (gradeTrades.length > 0) {
                        const gradeWins = gradeTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const gradeR = gradeTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const gradeAvgR = gradeR / gradeTrades.length;
                        report.push(`- **Grade ${grade}:** ${gradeTrades.length} trades, ${formatNumber((gradeWins/gradeTrades.length)*100, 0)}% WR, ${gradeR >= 0 ? '+' : ''}${formatNumber(gradeR, 2)}R total, ${gradeAvgR >= 0 ? '+' : ''}${formatNumber(gradeAvgR, 2)}R avg`);
                    }
                });
                const ungradedTrades = closedTrades.filter(t => !t.grade);
                if (ungradedTrades.length > 0) {
                    const ugWins = ungradedTrades.filter(t => (t.rMultiple || 0) > 0).length;
                    const ugR = ungradedTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                    report.push(`- **Ungraded:** ${ungradedTrades.length} trades, ${formatNumber((ugWins/ungradedTrades.length)*100, 0)}% WR, ${ugR >= 0 ? '+' : ''}${formatNumber(ugR, 2)}R total`);
                }
                report.push('');
                
                // Performance by Alert Type
                report.push('### Performance by Alert Type (System vs Manual)');
                report.push('');
                const alertTypes = ['TRADE_READY', 'STRONG', 'WATCH', 'MANUAL'];
                const alertLabels = { TRADE_READY: 'TRADE_READY (All 5 criteria)', STRONG: 'STRONG (4/5 criteria)', WATCH: 'WATCH (Developing)', MANUAL: 'MANUAL (Discretionary)' };
                alertTypes.forEach(alertType => {
                    const alertTrades = closedTrades.filter(t => t.alertType === alertType);
                    if (alertTrades.length > 0) {
                        const alertWins = alertTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const alertR = alertTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const alertAvgR = alertR / alertTrades.length;
                        report.push(`- **${alertLabels[alertType] || alertType}:** ${alertTrades.length} trades, ${formatNumber((alertWins/alertTrades.length)*100, 0)}% WR, ${alertR >= 0 ? '+' : ''}${formatNumber(alertR, 2)}R total, ${alertAvgR >= 0 ? '+' : ''}${formatNumber(alertAvgR, 2)}R avg`);
                    }
                });
                const noAlertTrades = closedTrades.filter(t => !t.alertType);
                if (noAlertTrades.length > 0) {
                    report.push(`- **No Alert Type Logged:** ${noAlertTrades.length} trades`);
                }
                report.push('');
                
                // Performance by Entry Zone
                report.push('### Performance by Entry Zone Quality');
                report.push('');
                const zones = ['hot', 'optimal', 'acceptable', 'extended'];
                const zoneLabels = { hot: 'HOT (Best)', optimal: 'OPTIMAL (Good)', acceptable: 'ACCEPTABLE (OK)', extended: 'EXTENDED (Poor)' };
                zones.forEach(zone => {
                    const zoneTrades = closedTrades.filter(t => t.entryZone === zone);
                    if (zoneTrades.length > 0) {
                        const zoneWins = zoneTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const zoneR = zoneTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const zoneAvgR = zoneR / zoneTrades.length;
                        report.push(`- **${zoneLabels[zone] || zone}:** ${zoneTrades.length} trades, ${formatNumber((zoneWins/zoneTrades.length)*100, 0)}% WR, ${zoneR >= 0 ? '+' : ''}${formatNumber(zoneR, 2)}R total, ${zoneAvgR >= 0 ? '+' : ''}${formatNumber(zoneAvgR, 2)}R avg`);
                    }
                });
                report.push('');
                
                // Performance by Volatility State
                report.push('### Performance by Volatility State');
                report.push('');
                const volStates = ['TREND', 'EXPLODE', 'QUIET', 'LOW'];
                volStates.forEach(vol => {
                    const volTrades = closedTrades.filter(t => t.volState === vol);
                    if (volTrades.length > 0) {
                        const volWins = volTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const volR = volTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const volAvgR = volR / volTrades.length;
                        report.push(`- **${vol}:** ${volTrades.length} trades, ${formatNumber((volWins/volTrades.length)*100, 0)}% WR, ${volR >= 0 ? '+' : ''}${formatNumber(volR, 2)}R total, ${volAvgR >= 0 ? '+' : ''}${formatNumber(volAvgR, 2)}R avg`);
                    }
                });
                report.push('');
                
                // Performance by Pair
                report.push('### Performance by Currency Pair');
                report.push('');
                const pairs = [...new Set(closedTrades.map(t => t.pair))].sort();
                pairs.forEach(pair => {
                    const pairTrades = closedTrades.filter(t => t.pair === pair);
                    const pairWins = pairTrades.filter(t => (t.rMultiple || 0) > 0).length;
                    const pairR = pairTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                    const pairAvgR = pairR / pairTrades.length;
                    report.push(`- **${pair}:** ${pairTrades.length} trades, ${formatNumber((pairWins/pairTrades.length)*100, 0)}% WR, ${pairR >= 0 ? '+' : ''}${formatNumber(pairR, 2)}R total, ${pairAvgR >= 0 ? '+' : ''}${formatNumber(pairAvgR, 2)}R avg`);
                });
                report.push('');
                
                // Performance by Direction
                report.push('### Performance by Direction');
                report.push('');
                ['long', 'short'].forEach(dir => {
                    const dirTrades = closedTrades.filter(t => t.direction === dir);
                    if (dirTrades.length > 0) {
                        const dirWins = dirTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const dirR = dirTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const dirAvgR = dirR / dirTrades.length;
                        report.push(`- **${dir.toUpperCase()}:** ${dirTrades.length} trades, ${formatNumber((dirWins/dirTrades.length)*100, 0)}% WR, ${dirR >= 0 ? '+' : ''}${formatNumber(dirR, 2)}R total, ${dirAvgR >= 0 ? '+' : ''}${formatNumber(dirAvgR, 2)}R avg`);
                    }
                });
                report.push('');
                
                // Performance by Day of Week
                report.push('### Performance by Day of Week');
                report.push('');
                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                for (let day = 0; day < 7; day++) {
                    const dayTrades = closedTrades.filter(t => new Date(t.date).getDay() === day);
                    if (dayTrades.length > 0) {
                        const dayWins = dayTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const dayR = dayTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        const dayAvgR = dayR / dayTrades.length;
                        report.push(`- **${dayNames[day]}:** ${dayTrades.length} trades, ${formatNumber((dayWins/dayTrades.length)*100, 0)}% WR, ${dayR >= 0 ? '+' : ''}${formatNumber(dayR, 2)}R total, ${dayAvgR >= 0 ? '+' : ''}${formatNumber(dayAvgR, 2)}R avg`);
                    }
                }
                report.push('');
                
                // Performance by Exit Reason
                report.push('### Performance by Exit Reason');
                report.push('');
                const exitReasons = [...new Set(closedTrades.map(t => t.exitReason).filter(Boolean))];
                if (exitReasons.length > 0) {
                    exitReasons.forEach(reason => {
                        const reasonTrades = closedTrades.filter(t => t.exitReason === reason);
                        const reasonWins = reasonTrades.filter(t => (t.rMultiple || 0) > 0).length;
                        const reasonR = reasonTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        report.push(`- **${reason}:** ${reasonTrades.length} trades, ${formatNumber((reasonWins/reasonTrades.length)*100, 0)}% WR, ${reasonR >= 0 ? '+' : ''}${formatNumber(reasonR, 2)}R total`);
                    });
                } else {
                    report.push('*No exit reasons logged*');
                }
                report.push('');
                
                // Streak Analysis
                let maxWinStreak = 0;
                let maxLoseStreak = 0;
                let tempWinStreak = 0;
                let tempLoseStreak = 0;
                let currentStreak = { type: null, count: 0 };
                
                const sortedTrades = [...closedTrades].sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedTrades.forEach(t => {
                    if ((t.rMultiple || 0) > 0) {
                        tempWinStreak++;
                        tempLoseStreak = 0;
                        maxWinStreak = Math.max(maxWinStreak, tempWinStreak);
                        currentStreak = { type: 'win', count: tempWinStreak };
                    } else if ((t.rMultiple || 0) < 0) {
                        tempLoseStreak++;
                        tempWinStreak = 0;
                        maxLoseStreak = Math.max(maxLoseStreak, tempLoseStreak);
                        currentStreak = { type: 'loss', count: tempLoseStreak };
                    }
                });
                
                report.push('### Streak Analysis');
                report.push('');
                report.push(`- **Max Win Streak:** ${maxWinStreak} trades`);
                report.push(`- **Max Lose Streak:** ${maxLoseStreak} trades`);
                report.push(`- **Current Streak:** ${currentStreak.count} ${currentStreak.type === 'win' ? 'wins' : currentStreak.type === 'loss' ? 'losses' : 'N/A'}`);
                report.push('');
                
                // Trend Score Analysis
                const tradesWithScore = closedTrades.filter(t => t.trendScore != null);
                if (tradesWithScore.length > 0) {
                    report.push('### Trend Score Analysis');
                    report.push('');
                    const avgScore = tradesWithScore.reduce((sum, t) => sum + t.trendScore, 0) / tradesWithScore.length;
                    const winnerScores = tradesWithScore.filter(t => (t.rMultiple || 0) > 0);
                    const loserScores = tradesWithScore.filter(t => (t.rMultiple || 0) < 0);
                    const avgWinnerScore = winnerScores.length > 0 ? winnerScores.reduce((sum, t) => sum + t.trendScore, 0) / winnerScores.length : 0;
                    const avgLoserScore = loserScores.length > 0 ? loserScores.reduce((sum, t) => sum + t.trendScore, 0) / loserScores.length : 0;
                    
                    report.push(`- **Average Trend Score (all trades):** ${formatNumber(avgScore, 0)}`);
                    report.push(`- **Average Trend Score (winners):** ${formatNumber(avgWinnerScore, 0)}`);
                    report.push(`- **Average Trend Score (losers):** ${formatNumber(avgLoserScore, 0)}`);
                    
                    // Score range breakdown
                    const highScore = tradesWithScore.filter(t => t.trendScore >= 85);
                    const midScore = tradesWithScore.filter(t => t.trendScore >= 75 && t.trendScore < 85);
                    const lowScore = tradesWithScore.filter(t => t.trendScore < 75);
                    
                    if (highScore.length > 0) {
                        const hsWins = highScore.filter(t => (t.rMultiple || 0) > 0).length;
                        const hsR = highScore.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        report.push(`- **Grade A+:** ${highScore.length} trades, ${formatNumber((hsWins/highScore.length)*100, 0)}% WR, ${hsR >= 0 ? '+' : ''}${formatNumber(hsR, 2)}R`);
                    }
                    if (midScore.length > 0) {
                        const msWins = midScore.filter(t => (t.rMultiple || 0) > 0).length;
                        const msR = midScore.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        report.push(`- **Score 75-84:** ${midScore.length} trades, ${formatNumber((msWins/midScore.length)*100, 0)}% WR, ${msR >= 0 ? '+' : ''}${formatNumber(msR, 2)}R`);
                    }
                    if (lowScore.length > 0) {
                        const lsWins = lowScore.filter(t => (t.rMultiple || 0) > 0).length;
                        const lsR = lowScore.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                        report.push(`- **Score <75:** ${lowScore.length} trades, ${formatNumber((lsWins/lowScore.length)*100, 0)}% WR, ${lsR >= 0 ? '+' : ''}${formatNumber(lsR, 2)}R`);
                    }
                    report.push('');
                }
                
            } else {
                report.push('## PERFORMANCE SUMMARY');
                report.push('');
                report.push('*No closed trades in this period.*');
                report.push('');
            }
            
            // Detailed Trade Log with Setup Notes
            if (includeTrades && closedTrades.length > 0) {
                report.push('## DETAILED TRADE LOG');
                report.push('');
                report.push('Each trade with full context for analysis:');
                report.push('');
                
                const sortedClosedTrades = [...closedTrades].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedClosedTrades.forEach((t, idx) => {
                    const rClass = (t.rMultiple || 0) >= 0 ? 'WIN' : 'LOSS';
                    report.push(`### Trade ${idx + 1}: ${t.pair} ${(t.direction || '').toUpperCase()} - ${rClass} (${t.rMultiple >= 0 ? '+' : ''}${formatNumber(t.rMultiple || 0, 2)}R)`);
                    report.push('');
                    report.push(`- **Date:** ${new Date(t.date).toLocaleDateString('en-AU')} ${new Date(t.date).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`);
                    report.push(`- **Pair:** ${t.pair}`);
                    report.push(`- **Direction:** ${(t.direction || 'Unknown').toUpperCase()}`);
                    report.push(`- **Alert Type:** ${t.alertType || 'Not logged'}`);
                    report.push(`- **Grade:** ${t.grade || 'Ungraded'}`);
                    report.push(`- **Session:** ${t.session ? t.session.charAt(0).toUpperCase() + t.session.slice(1) : 'Not logged'}`);
                    report.push(`- **Entry:** ${t.entry || '-'} | **Exit:** ${t.exit || '-'} | **SL:** ${t.stop || '-'} | **TP:** ${t.tp || '-'}`);
                    report.push(`- **Trend Score:** ${t.trendScore != null ? t.trendScore : 'Not logged'}`);
                    report.push(`- **Entry Zone:** ${t.entryZone ? t.entryZone.toUpperCase() : 'Not logged'}`);
                    report.push(`- **Volatility State:** ${t.volState || 'Not logged'}`);
                    report.push(`- **Exit Reason:** ${t.exitReason || 'Not logged'}`);
                    report.push(`- **Risk Amount:** ${t.riskAmount ? formatCurrency(t.riskAmount) : 'Not logged'}`);
                    report.push(`- **R-Multiple:** ${t.rMultiple != null ? (t.rMultiple >= 0 ? '+' : '') + formatNumber(t.rMultiple, 2) + 'R' : 'Not calculated'}`);
                    report.push(`- **P&L:** ${t.pnl != null ? formatCurrency(t.pnl) : 'Not calculated'}`);
                    
                    if (t.notes && t.notes.trim()) {
                        report.push('');
                        report.push('**Setup Notes (Pre-Trade Reasoning):**');
                        report.push(`> ${t.notes.replace(/\n/g, '\n> ')}`);
                    }
                    
                    if (t.lessons && t.lessons.trim()) {
                        report.push('');
                        report.push('**Lessons Learned (Post-Trade Reflection):**');
                        report.push(`> ${t.lessons.replace(/\n/g, '\n> ')}`);
                    }
                    
                    report.push('');
                    report.push('---');
                    report.push('');
                });
            }
            
            // Setup Notes Summary (for pattern recognition)
            if (includeLessons) {
                const tradesWithNotes = allTrades.filter(t => t.notes && t.notes.trim().length > 0);
                const tradesWithLessons = allTrades.filter(t => t.lessons && t.lessons.trim().length > 0);
                
                if (tradesWithNotes.length > 0) {
                    report.push('## SETUP NOTES SUMMARY');
                    report.push('');
                    report.push('Pre-trade reasoning and setup analysis. Look for patterns in how I assess setups:');
                    report.push('');
                    
                    // Group by outcome
                    const winningSetups = tradesWithNotes.filter(t => (t.rMultiple || 0) > 0);
                    const losingSetups = tradesWithNotes.filter(t => (t.rMultiple || 0) < 0);
                    
                    if (winningSetups.length > 0) {
                        report.push('### Winning Trade Setups');
                        report.push('');
                        winningSetups.slice(0, 15).forEach(t => {
                            report.push(`**${new Date(t.date).toLocaleDateString('en-AU')} ${t.pair} (+${formatNumber(t.rMultiple || 0, 2)}R):** ${t.notes.replace(/\n/g, ' ').substring(0, 200)}${t.notes.length > 200 ? '...' : ''}`);
                            report.push('');
                        });
                    }
                    
                    if (losingSetups.length > 0) {
                        report.push('### Losing Trade Setups');
                        report.push('');
                        losingSetups.slice(0, 15).forEach(t => {
                            report.push(`**${new Date(t.date).toLocaleDateString('en-AU')} ${t.pair} (${formatNumber(t.rMultiple || 0, 2)}R):** ${t.notes.replace(/\n/g, ' ').substring(0, 200)}${t.notes.length > 200 ? '...' : ''}`);
                            report.push('');
                        });
                    }
                }
                
                if (tradesWithLessons.length > 0) {
                    report.push('## LESSONS LEARNED SUMMARY');
                    report.push('');
                    report.push('Post-trade reflections. Look for recurring themes and whether I am learning from mistakes:');
                    report.push('');
                    
                    tradesWithLessons.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).forEach(t => {
                        const outcome = (t.rMultiple || 0) > 0 ? 'WIN' : (t.rMultiple || 0) < 0 ? 'LOSS' : 'BE';
                        report.push(`**${new Date(t.date).toLocaleDateString('en-AU')} ${t.pair} (${outcome}, ${t.rMultiple >= 0 ? '+' : ''}${formatNumber(t.rMultiple || 0, 2)}R):**`);
                        report.push(`> ${t.lessons.replace(/\n/g, '\n> ')}`);
                        report.push('');
                    });
                }
            }
            
            // Open Trades
            if (openTrades.length > 0) {
                report.push('## CURRENTLY OPEN TRADES');
                report.push('');
                openTrades.forEach(t => {
                    const age = getTradeAge(t.date);
                    report.push(`### ${t.pair} ${(t.direction || '').toUpperCase()}`);
                    report.push('');
                    report.push(`- **Entry:** ${t.entry} | **SL:** ${t.stop || 'NOT SET'} | **TP:** ${t.tp || 'NOT SET'}`);
                    report.push(`- **Age:** ${age.text}`);
                    report.push(`- **Grade:** ${t.grade || 'Ungraded'} | **Alert:** ${t.alertType || 'Not logged'}`);
                    report.push(`- **Trend Score:** ${t.trendScore || '-'} | **Vol State:** ${t.volState || '-'} | **Zone:** ${t.entryZone || '-'}`);
                    if (t.notes) report.push(`- **Setup Notes:** ${t.notes.replace(/\n/g, ' ')}`);
                    report.push('');
                });
            }
            
            // Daily Scans Summary (if available)
            const scanDates = Object.keys(scans).sort().reverse().slice(0, 7);
            if (scanDates.length > 0) {
                report.push('## RECENT DAILY SCANS');
                report.push('');
                report.push('Summary of recent market scanning activity:');
                report.push('');
                scanDates.forEach(date => {
                    const scan = scans[date];
                    if (scan && scan.pairs) {
                        const pairsScanned = Object.keys(scan.pairs).length;
                        const tradeReady = Object.values(scan.pairs).filter(p => p.alertType === 'TRADE_READY').length;
                        const strong = Object.values(scan.pairs).filter(p => p.alertType === 'STRONG').length;
                        report.push(`- **${date}:** ${pairsScanned} pairs scanned, ${tradeReady} TRADE_READY, ${strong} STRONG`);
                    }
                });
                report.push('');
            }
            
            // Settings & System Info
            if (includeSettings) {
                report.push('## MY TRADING SYSTEM CONFIGURATION');
                report.push('');
                report.push('### UTCC (Unified Trading Command Center) - 5 Criteria System');
                report.push('');
                report.push('All 5 criteria must pass before trade execution:');
                report.push('');
                report.push('1. **Trend Score:** >=80 required (0-100 scale based on EMA alignment across timeframes)');
                report.push('2. **MTF Alignment:** Higher timeframes must confirm direction');
                report.push('3. **Volatility State:** TREND or EXPLODE preferred; avoid LOW volatility');
                report.push('4. **Entry Zone:** HOT or OPTIMAL only; EXTENDED zones rejected');
                report.push('5. **News Safety:** 2-hour buffer around high-impact news');
                report.push('');
                report.push('### Alert Types & Meanings');
                report.push('');
                report.push('- **TRADE_READY:** All 5 criteria pass - highest confidence, full position');
                report.push('- **STRONG:** 4/5 criteria pass - needs manual validation of missing criterion');
                report.push('- **WATCH:** Developing setup - not ready, monitor only');
                report.push('- **MANUAL:** Discretionary entry without UTCC signal');
                report.push('');
                report.push('### Trade Grading System');
                report.push('');
                report.push('- **A+:** Perfect setup - all criteria optimal, high confluence, textbook entry');
                report.push('- **A:** Strong setup - all criteria pass, good confluence');
                report.push('- **B:** Acceptable setup - criteria pass but minor concerns');
                report.push('- **C:** Marginal setup - some criteria borderline, reduced conviction');
                report.push('- **D:** Poor setup - should not have traded, rules violated');
                report.push('');
                report.push('### Risk Management Rules');
                report.push('');
                report.push(`- **Standard Risk:** ${settings.defaultRisk}% per trade`);
                report.push('- **A+ Setups:** Can use up to 2% risk');
                report.push('- **B/C Setups:** Reduce to 1% risk or less');
                report.push('- **Drawdown Protocol:**');
                report.push('  - -5% from peak: Reduce position size by 50%');
                report.push('  - -10% from peak: Maximum 0.5% risk per trade');
                report.push('  - -15% from peak: Stop trading, full system review required');
                report.push('');
                report.push('### My Trading Schedule (AEST)');
                report.push('');
                report.push('- **Tokyo Session:** 9:00 AM - 5:00 PM AEST');
                report.push('- **London Session:** 5:00 PM - 2:00 AM AEST');
                report.push('- **New York Session:** 10:00 PM - 7:00 AM AEST');
                report.push('- **Best Windows:** Tokyo open (9-11 AM), London open (5-7 PM), London/NY overlap (10 PM - 12 AM)');
                report.push('');
                report.push('### Core & Rotation Pairs');
                report.push('');
                report.push(`- **Core Pairs (Always Watch):** ${CORE_PAIRS.join(', ')}`);
                report.push(`- **Rotation Pairs (Situational):** ${ROTATION_PAIRS.join(', ')}`);
                report.push('');
            }
            
            // Coaching Questions
            report.push('## QUESTIONS FOR COACHING REVIEW');
            report.push('');
            report.push('Please address these specific areas:');
            report.push('');
            report.push('1. **Pattern Analysis:** What patterns do you see in my winning vs losing trades? Any blind spots?');
            report.push('2. **Setup Quality:** Am I correctly identifying and grading setups based on my notes? Do my losses show setup misreads?');
            report.push('3. **Session/Pair Selection:** Should I avoid any sessions, pairs, or days based on my results?');
            report.push('4. **System Adherence:** Am I following my UTCC rules? Any signs of discipline breakdown or overtrading?');
            report.push('5. **Expectancy Improvement:** What specific changes would most improve my expectancy?');
            report.push('6. **Lessons Integration:** Am I learning from my mistakes? Are the same errors recurring?');
            report.push('7. **Tool Enhancement:** Any features to add to the Command Centre that would help me trade better?');
            report.push('8. **UTCC Refinement:** Any suggested adjustments to my 5-criteria system based on the results?');
            report.push('');
            report.push('---');
            report.push('');
            report.push('*Report generated by Forex Trading Command Centre v' + APP_VERSION + '*');
            
            // Display the report
            const textarea = document.getElementById('claude-export-text');
            const preview = document.getElementById('claude-export-preview');
            const copyBtn = document.getElementById('copy-export-btn');
            
            textarea.value = report.join('\n');
            preview.style.display = 'block';
            copyBtn.disabled = false;
            
            showNotification('Report generated! Review and copy to clipboard.', 'success');
        }
        
        function copyExportToClipboard() {
            const textarea = document.getElementById('claude-export-text');
            textarea.select();
            document.execCommand('copy');
            
            // Also try modern clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textarea.value);
            }
            
            showNotification('Report copied to clipboard! Paste into Claude.', 'success');
        }

        // CHUNK 6 COMPLETE - Performance Analytics

        // ============================================
        // CHUNK 7: SETTINGS, EXPORT/IMPORT, AUTO-SAVE
        // ============================================

        function exportAllData() {
            const data = {
                version: APP_VERSION,
                exportDate: new Date().toISOString(),
                trades: loadFromStorage(STORAGE_KEYS.trades, []),
                scans: loadFromStorage(STORAGE_KEYS.scans, {}),
                settings: loadFromStorage(STORAGE_KEYS.settings, DEFAULT_SETTINGS),
                goals: loadFromStorage(STORAGE_KEYS.goals, {}),
                theme: loadFromStorage(STORAGE_KEYS.theme, 'dark')
            };
            
            const json = JSON.stringify(data, null, 2);
            const filename = `ftcc_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            downloadFile(json, filename, 'application/json');
            
            // Update last backup date
            saveToStorage(STORAGE_KEYS.lastBackup, new Date().toISOString());
            updateSystemInfo();
            
            showToast('Data exported successfully', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.version || !data.exportDate) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Confirm import
                    if (!confirm(`Import backup from ${formatDate(data.exportDate)}? This will replace all current data.`)) {
                        return;
                    }
                    
                    // Import data
                    if (data.trades) saveToStorage(STORAGE_KEYS.trades, data.trades);
                    if (data.scans) saveToStorage(STORAGE_KEYS.scans, data.scans);
                    if (data.settings) saveToStorage(STORAGE_KEYS.settings, data.settings);
                    if (data.goals) saveToStorage(STORAGE_KEYS.goals, data.goals);
                    if (data.theme) {
                        saveToStorage(STORAGE_KEYS.theme, data.theme);
                        setTheme(data.theme);
                    }
                    
                    // Refresh all views
                    loadSettings();
                    loadTrades();
                    updateDashboard();
                    updateSystemInfo();
                    
                    showToast(`Imported ${data.trades?.length || 0} trades successfully`, 'success');
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Import failed: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }


        function clearAllData() {
            if (!confirm(' This will DELETE ALL DATA including trades, scans, and settings. Continue?')) return;
            
            const confirmText = prompt('Type "DELETE ALL" to confirm:');
            if (confirmText !== 'DELETE ALL') {
                showToast('Deletion cancelled', 'info');
                return;
            }
            
            // Clear all storage keys
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Reset to defaults
            saveToStorage(STORAGE_KEYS.settings, DEFAULT_SETTINGS);
            saveToStorage(STORAGE_KEYS.theme, 'dark');
            saveToStorage(STORAGE_KEYS.trades, []);
            saveToStorage(STORAGE_KEYS.scans, {});
            
            // Refresh
            setTheme('dark');
            loadSettings();
            loadTrades();
            updateDashboard();
            updateSystemInfo();
            
            showToast('All data cleared', 'info');
        }

        // ============================================
        // ACCORDION FUNCTIONS (Reference Guide)
        // ============================================

        function toggleAccordion(header) {
            const item = header.parentElement;
            const content = header.nextElementSibling;
            const isOpen = item.classList.contains('open');
            
            // Close all others
            document.querySelectorAll('.accordion-item.open').forEach(i => {
                if (i !== item) {
                    i.classList.remove('open');
                    i.querySelector('.accordion-content').style.maxHeight = null;
                }
            });
            
            // Toggle current
            if (isOpen) {
                item.classList.remove('open');
                content.style.maxHeight = null;
            } else {
                item.classList.add('open');
                content.style.maxHeight = content.scrollHeight + 'px';
            }
        }

        // Add accordion styles
        const accordionStyles = document.createElement('style');
        accordionStyles.textContent = `
            .accordion-item {
                border: 1px solid var(--border-primary);
                border-radius: var(--radius-md);
                margin-bottom: var(--spacing-sm);
                overflow: hidden;
            }
            .accordion-header {
                padding: var(--spacing-md);
                background: var(--bg-tertiary);
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 500;
                transition: background var(--transition-fast);
            }
            .accordion-header:hover {
                background: var(--bg-hover);
            }
            .accordion-header::after {
                content: '+';
                font-size: 1.2rem;
                transition: transform var(--transition-fast);
            }
            .accordion-item.open .accordion-header::after {
                content: '';
            }
            .accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                padding: 0 var(--spacing-md);
            }
            .accordion-item.open .accordion-content {
                padding: var(--spacing-md);
            }
            .accordion-content p {
                margin-bottom: var(--spacing-sm);
            }
            .accordion-content ul {
                margin: var(--spacing-sm) 0;
                padding-left: var(--spacing-lg);
            }
            .accordion-content li {
                margin-bottom: var(--spacing-xs);
            }
        `;
        document.head.appendChild(accordionStyles);

        // CHUNK 7 COMPLETE - Settings, Export/Import, Auto-save

        // ============================================
        // CHUNK 8: GUIDE TAB - GOALS, MILESTONES, CONFLUENCE
        // ============================================

        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const DEFAULT_MONTHLY_TARGETS = {
            trades: 30, // 5-10 per week  4 weeks
            winRate: 50,
            rTarget: 10 // Total R for month
        };

        function initGoalsTracker() {
            const grid = document.getElementById('monthly-goals-grid');
            if (!grid) return;
            
            const trades = loadFromStorage(STORAGE_KEYS.trades, []).filter(t => t.status === 'closed');
            const goals = loadFromStorage(STORAGE_KEYS.goals, {});
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            
            let html = '';
            
            MONTHS.forEach((month, index) => {
                const monthTrades = trades.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === currentYear && d.getMonth() === index;
                });
                
                const tradeCount = monthTrades.length;
                const winners = monthTrades.filter(t => (t.rMultiple || 0) > 0);
                const winRate = tradeCount > 0 ? (winners.length / tradeCount * 100) : 0;
                const totalR = monthTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
                
                const isPast = index < currentMonth;
                const isCurrent = index === currentMonth;
                const isFuture = index > currentMonth;
                
                let statusClass = 'month-future';
                let statusIcon = '';
                
                if (isPast || isCurrent) {
                    if (tradeCount >= 20 && winRate >= 50 && totalR >= 5) {
                        statusClass = 'month-success';
                        statusIcon = '';
                    } else if (tradeCount >= 10 && winRate >= 45) {
                        statusClass = 'month-partial';
                        statusIcon = '';
                    } else if (tradeCount > 0) {
                        statusClass = 'month-active';
                        statusIcon = '';
                    }
                }
                
                if (isCurrent) statusClass += ' month-current';
                
                html += `
                    <div class="month-card ${statusClass}">
                        <div class="month-header">
                            <span class="month-name">${month}</span>
                            <span class="month-status">${statusIcon}</span>
                        </div>
                        <div class="month-stats">
                            <div class="month-stat">
                                <span class="stat-num">${tradeCount}</span>
                                <span class="stat-lbl">trades</span>
                            </div>
                            <div class="month-stat">
                                <span class="stat-num ${winRate >= 50 ? 'text-pass' : winRate > 0 ? 'text-fail' : ''}">${tradeCount > 0 ? formatNumber(winRate, 0) + '%' : '-'}</span>
                                <span class="stat-lbl">win</span>
                            </div>
                            <div class="month-stat">
                                <span class="stat-num ${totalR >= 0 ? 'text-pass' : 'text-fail'}">${tradeCount > 0 ? formatNumber(totalR, 1) + 'R' : '-'}</span>
                                <span class="stat-lbl">total</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            // Update summary
            updateGoalsSummary(trades, currentYear);
            
            // Check milestones
            checkMilestones(trades);
        }

        function updateGoalsSummary(trades, year) {
            const yearTrades = trades.filter(t => new Date(t.date).getFullYear() === year);
            const currentMonth = new Date().getMonth();
            
            // Count months with activity
            const monthsWithTrades = new Set(yearTrades.map(t => new Date(t.date).getMonth())).size;
            const monthsComplete = Math.min(currentMonth + 1, 12);
            
            const totalTrades = yearTrades.length;
            const winners = yearTrades.filter(t => (t.rMultiple || 0) > 0);
            const avgWinRate = totalTrades > 0 ? (winners.length / totalTrades * 100) : 0;
            const totalR = yearTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0);
            
            updateElement('goals-months-complete', `${monthsWithTrades}/${monthsComplete}`);
            updateElement('goals-total-trades', totalTrades);
            updateElement('goals-avg-winrate', totalTrades > 0 ? formatNumber(avgWinRate, 0) + '%' : '-%');
            updateElement('goals-total-r', formatNumber(totalR, 1) + 'R', totalR >= 0 ? 'text-pass' : 'text-fail');
        }

        function checkMilestones(trades) {
            const milestones = {
                'first-trade': trades.length >= 1,
                'ten-trades': trades.length >= 10,
                'hundred-trades': trades.length >= 100,
                'fifty-winrate': false,
                'positive-month': false,
                'consistent-profits': false
            };
            
            // Check 50% win rate with 20+ trades
            if (trades.length >= 20) {
                const winners = trades.filter(t => (t.rMultiple || 0) > 0);
                milestones['fifty-winrate'] = (winners.length / trades.length) >= 0.5;
            }
            
            // Check for positive month
            const monthlyR = {};
            trades.forEach(t => {
                const monthKey = new Date(t.date).toISOString().slice(0, 7);
                monthlyR[monthKey] = (monthlyR[monthKey] || 0) + (t.rMultiple || 0);
            });
            
            const positiveMonths = Object.values(monthlyR).filter(r => r > 0);
            milestones['positive-month'] = positiveMonths.length >= 1;
            
            // Check for 3 consecutive profitable months
            const sortedMonths = Object.entries(monthlyR).sort((a, b) => a[0].localeCompare(b[0]));
            let consecutive = 0;
            let maxConsecutive = 0;
            sortedMonths.forEach(([month, r]) => {
                if (r > 0) {
                    consecutive++;
                    maxConsecutive = Math.max(maxConsecutive, consecutive);
                } else {
                    consecutive = 0;
                }
            });
            milestones['consistent-profits'] = maxConsecutive >= 3;
            
            // Update UI
            Object.entries(milestones).forEach(([key, achieved]) => {
                const el = document.getElementById(`ms-${key}`);
                if (el) {
                    el.textContent = achieved ? '' : '';
                    el.parentElement.classList.toggle('achieved', achieved);
                }
            });
        }

        function resetGoals() {
            if (!confirm('Reset all goal tracking data?')) return;
            saveToStorage(STORAGE_KEYS.goals, {});
            initGoalsTracker();
            showToast('Goals reset', 'info');
        }

        // Add guide-specific styles
        const guideStyles = document.createElement('style');
        guideStyles.textContent = `
            /* Step-by-Step Guide */
            .guide-steps {
                display: flex;
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            .guide-step {
                display: flex;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
                border-left: 3px solid var(--border-primary);
            }
            .guide-step.step-execute {
                border-left-color: var(--color-pass);
                background: rgba(34, 197, 94, 0.1);
            }
            .step-number {
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: var(--bg-primary);
                border-radius: 50%;
                font-weight: 700;
                flex-shrink: 0;
            }
            .step-execute .step-number {
                background: var(--color-pass);
                color: white;
            }
            .step-content h4 {
                margin-bottom: 4px;
                font-size: 1rem;
            }
            .step-content p {
                color: var(--text-secondary);
                font-size: 0.85rem;
                margin: 0;
            }
            
            /* Exit Rules */
            .exit-rule-box, .info-box {
                padding: var(--spacing-md);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
            }
            .exit-rule-box h4, .info-box h4 {
                margin-bottom: var(--spacing-sm);
                font-size: 0.95rem;
            }
            .exit-rule-box ul, .info-box ul {
                margin: 0;
                padding-left: var(--spacing-lg);
            }
            .exit-rule-box li, .info-box li {
                font-size: 0.85rem;
                margin-bottom: 4px;
                color: var(--text-secondary);
            }
            
            /* DO's and DON'Ts */
            .rules-box {
                padding: var(--spacing-md);
                border-radius: var(--radius-md);
            }
            .rules-do {
                background: rgba(34, 197, 94, 0.1);
                border: 1px solid var(--color-pass);
            }
            .rules-dont {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid var(--color-fail);
            }
            .rules-box h4 {
                margin-bottom: var(--spacing-sm);
            }
            .rules-box ul {
                margin: 0;
                padding-left: var(--spacing-lg);
            }
            .rules-box li {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }
            
            /* Monthly Goals Grid */
            .goals-grid {
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                gap: var(--spacing-sm);
            }
            @media (max-width: 900px) {
                .goals-grid { grid-template-columns: repeat(4, 1fr); }
            }
            @media (max-width: 600px) {
                .goals-grid { grid-template-columns: repeat(3, 1fr); }
            }
            .month-card {
                padding: var(--spacing-sm);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
                border: 2px solid transparent;
                text-align: center;
            }
            .month-card.month-current {
                border-color: var(--color-info);
            }
            .month-card.month-success {
                border-color: var(--color-pass);
                background: rgba(34, 197, 94, 0.1);
            }
            .month-card.month-partial {
                border-color: var(--color-warning);
            }
            .month-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: var(--spacing-xs);
            }
            .month-name {
                font-weight: 600;
                font-size: 0.85rem;
            }
            .month-stats {
                display: flex;
                justify-content: space-around;
                gap: 4px;
            }
            .month-stat {
                display: flex;
                flex-direction: column;
                font-size: 0.7rem;
            }
            .month-stat .stat-num {
                font-weight: 600;
                font-size: 0.9rem;
            }
            .month-stat .stat-lbl {
                color: var(--text-muted);
            }
            
            /* Milestones */
            .milestone-list {
                display: flex;
                flex-direction: column;
                gap: var(--spacing-xs);
            }
            .milestone {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                padding: var(--spacing-sm) var(--spacing-md);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
            }
            .milestone.achieved {
                background: rgba(34, 197, 94, 0.1);
            }
            .milestone-icon {
                font-size: 1.2rem;
            }
            .milestone-status {
                margin-left: auto;
            }
            
            /* Confluence */
            .confluence-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            @media (max-width: 600px) {
                .confluence-grid { grid-template-columns: 1fr; }
            }
            .confluence-item {
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-md);
                background: var(--bg-tertiary);
                border-radius: var(--radius-md);
                cursor: pointer;
                transition: all var(--transition-fast);
            }
            .confluence-item:hover {
                background: var(--bg-hover);
            }
            .confluence-item:has(input:checked) {
                background: rgba(34, 197, 94, 0.15);
                border: 1px solid var(--color-pass);
            }
            .confluence-item input {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }
            .confluence-label {
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }
            .confluence-icon {
                font-size: 1.1rem;
            }
            .confluence-strength {
                margin-top: var(--spacing-md);
            }
            .strength-bar {
                height: 12px;
                background: var(--bg-tertiary);
                border-radius: 6px;
                overflow: hidden;
            }
            .strength-fill {
                height: 100%;
                background: var(--color-fail);
                transition: all 0.3s ease;
                border-radius: 6px;
            }
            .strength-labels {
                display: flex;
                justify-content: space-between;
                font-size: 0.7rem;
                color: var(--text-muted);
                margin-top: 4px;
            }
        `;
        document.head.appendChild(guideStyles);

        // Initialize goals tracker on tab show
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initGoalsTracker, 500);
        });

        // CHUNK 8 COMPLETE - Guide Tab (Goals, Milestones, Confluence)

        // ============================================
        // CHUNK 9: NEWS IMPACT MANAGEMENT SYSTEM
        // ============================================

        // ============================================
        // LIVE ECONOMIC CALENDAR DATA
        // ============================================
        
        // Live calendar data loaded from JSON file
        let LIVE_CALENDAR_DATA = {
            last_updated: null,
            events: []
        };
        
        // Calendar JSON file path - adjust to your Unraid path
        const CALENDAR_JSON_PATH = './calendar.json';
        
        // Load economic calendar from JSON file
        async function loadEconomicCalendar() {
            try {
                const response = await fetch(CALENDAR_JSON_PATH + '?t=' + Date.now());
                if (!response.ok) {
                    console.warn('Calendar file not found. Using fallback mode.');
                    return false;
                }
                
                const data = await response.json();
                LIVE_CALENDAR_DATA = {
                    last_updated: data.last_updated,
                    events: data.events || []
                };
                
                console.log(`Loaded ${LIVE_CALENDAR_DATA.events.length} calendar events`);
                updateCalendarStatusIndicator(true);
                return true;
            } catch (error) {
                console.warn('Failed to load calendar:', error);
                updateCalendarStatusIndicator(false);
                return false;
            }
        }
        
        // Update calendar status indicator
        function updateCalendarStatusIndicator(isLoaded) {
            const indicator = document.getElementById('calendar-status-indicator');
            if (indicator) {
                if (isLoaded && LIVE_CALENDAR_DATA.events.length > 0) {
                    indicator.className = 'status-dot online';
                    indicator.title = `Calendar: Loaded (${LIVE_CALENDAR_DATA.events.length} events)`;
                } else {
                    indicator.className = 'status-dot offline';
                    indicator.title = 'Calendar: Offline';
                }
            }
        }
        
        // Get upcoming events for a specific currency within X hours
        function getUpcomingEventsForCurrency(currency, hoursAhead = 4) {
            if (!LIVE_CALENDAR_DATA.events || LIVE_CALENDAR_DATA.events.length === 0) {
                return [];
            }
            
            const now = new Date();
            const cutoff = new Date(now.getTime() + (hoursAhead * 60 * 60 * 1000));
            
            return LIVE_CALENDAR_DATA.events.filter(event => {
                if (event.currency !== currency) return false;
                if (!event.datetime_utc) return false;
                
                const eventTime = new Date(event.datetime_utc);
                return eventTime > now && eventTime <= cutoff;
            }).sort((a, b) => new Date(a.datetime_utc) - new Date(b.datetime_utc));
        }
        
        // Get all high impact events for a currency pair within X hours
        function getHighImpactEventsForPair(pair, hoursAhead = 4) {
            if (!pair || pair.length < 6) return [];
            
            const baseCurrency = pair.substring(0, 3);
            const quoteCurrency = pair.substring(3, 6);
            
            const baseEvents = getUpcomingEventsForCurrency(baseCurrency, hoursAhead)
                .filter(e => e.impact === 'High');
            const quoteEvents = getUpcomingEventsForCurrency(quoteCurrency, hoursAhead)
                .filter(e => e.impact === 'High');
            
            return [...baseEvents, ...quoteEvents].sort((a, b) => 
                new Date(a.datetime_utc) - new Date(b.datetime_utc)
            );
        }
        
        // Calculate minutes until an event
        function getMinutesUntilEvent(event) {
            if (!event.datetime_utc) return null;
            const now = new Date();
            const eventTime = new Date(event.datetime_utc);
            return Math.round((eventTime - now) / (1000 * 60));
        }
        
        // Format time until event for display
        function formatTimeUntil(minutes) {
            if (minutes === null) return 'Time TBD';
            if (minutes < 0) return 'Released';
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
        }
        
        // Check if it's safe to trade based on news
        function isNewsSafeToTrade(pair, minBufferMinutes = 30) {
            const highImpactEvents = getHighImpactEventsForPair(pair, 2);
            
            if (highImpactEvents.length === 0) {
                return { safe: true, reason: 'No high impact news within 2 hours' };
            }
            
            const nearestEvent = highImpactEvents[0];
            const minutesUntil = getMinutesUntilEvent(nearestEvent);
            
            if (minutesUntil !== null && minutesUntil < minBufferMinutes) {
                return { 
                    safe: false, 
                    reason: `${nearestEvent.title} (${nearestEvent.currency}) in ${formatTimeUntil(minutesUntil)}`,
                    event: nearestEvent
                };
            }
            
            return { 
                safe: true, 
                reason: `Next high impact: ${nearestEvent.title} in ${formatTimeUntil(minutesUntil)}`,
                event: nearestEvent
            };
        }
        
        // ============================================
        // END LIVE ECONOMIC CALENDAR
        // ============================================

        // News Impact Database - Comprehensive reference for major economic events
        const NEWS_IMPACT_DATABASE = {
            USD: [
                {
                    name: 'Non-Farm Payrolls (NFP)',
                    impact: 'high',
                    description: 'Monthly employment change excluding agriculture. Most market-moving US data.',
                    beatBias: 'USD bullish - stronger economy supports rate hikes',
                    missBias: 'USD bearish - weak employment suggests economic slowdown',
                    typicalMove: '50-150 pips',
                    bufferHours: 4
                },
                {
                    name: 'CPI (Consumer Price Index)',
                    impact: 'high',
                    description: 'Main inflation measure. Directly influences Fed rate decisions.',
                    beatBias: 'USD bullish - higher inflation = more hawkish Fed',
                    missBias: 'USD bearish - lower inflation = dovish Fed expectations',
                    typicalMove: '50-100 pips',
                    bufferHours: 4
                },
                {
                    name: 'FOMC Rate Decision',
                    impact: 'high',
                    description: 'Federal Reserve interest rate announcement and statement.',
                    beatBias: 'USD bullish - hawkish surprise or rate hike',
                    missBias: 'USD bearish - dovish surprise or rate cut',
                    typicalMove: '100-200 pips',
                    bufferHours: 6
                },
                {
                    name: 'GDP (Gross Domestic Product)',
                    impact: 'high',
                    description: 'Economic growth measure. Quarterly release.',
                    beatBias: 'USD bullish - stronger growth supports currency',
                    missBias: 'USD bearish - weaker growth concerns',
                    typicalMove: '30-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'Unemployment Claims',
                    impact: 'medium',
                    description: 'Weekly jobless claims. Lower is better for USD.',
                    beatBias: 'USD bearish - higher claims = weaker economy',
                    missBias: 'USD bullish - lower claims = stronger employment',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Retail Sales',
                    impact: 'medium',
                    description: 'Consumer spending measure. Key economic indicator.',
                    beatBias: 'USD bullish - strong consumer spending',
                    missBias: 'USD bearish - weak consumer spending',
                    typicalMove: '25-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'ISM Manufacturing PMI',
                    impact: 'medium',
                    description: 'Manufacturing sector health. Above 50 = expansion.',
                    beatBias: 'USD bullish - manufacturing expansion',
                    missBias: 'USD bearish - manufacturing contraction',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'ISM Services PMI',
                    impact: 'medium',
                    description: 'Services sector health. Larger part of US economy.',
                    beatBias: 'USD bullish - services expansion',
                    missBias: 'USD bearish - services contraction',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Core PCE Price Index',
                    impact: 'high',
                    description: 'Fed preferred inflation measure. Excludes food/energy.',
                    beatBias: 'USD bullish - higher inflation = hawkish Fed',
                    missBias: 'USD bearish - lower inflation = dovish Fed',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'ADP Employment',
                    impact: 'medium',
                    description: 'Private sector employment. NFP preview (2 days before).',
                    beatBias: 'USD bullish - strong private hiring',
                    missBias: 'USD bearish - weak private hiring',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Fed Chair Speech',
                    impact: 'high',
                    description: 'Powell or Fed officials speaking. Watch for policy hints.',
                    beatBias: 'USD bullish - hawkish tone on rates/inflation',
                    missBias: 'USD bearish - dovish tone, concern about growth',
                    typicalMove: '30-100 pips',
                    bufferHours: 4
                }
            ],
            EUR: [
                {
                    name: 'ECB Rate Decision',
                    impact: 'high',
                    description: 'European Central Bank interest rate announcement.',
                    beatBias: 'EUR bullish - hawkish surprise or rate hike',
                    missBias: 'EUR bearish - dovish surprise or rate cut',
                    typicalMove: '80-150 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (Eurozone)',
                    impact: 'high',
                    description: 'Eurozone inflation. Key for ECB policy.',
                    beatBias: 'EUR bullish - higher inflation = hawkish ECB',
                    missBias: 'EUR bearish - lower inflation = dovish ECB',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'German CPI',
                    impact: 'medium',
                    description: 'Germany inflation. Leads Eurozone CPI.',
                    beatBias: 'EUR bullish - German inflation rising',
                    missBias: 'EUR bearish - German inflation falling',
                    typicalMove: '25-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'German ZEW Economic Sentiment',
                    impact: 'medium',
                    description: 'Investor confidence in Germany.',
                    beatBias: 'EUR bullish - improved sentiment',
                    missBias: 'EUR bearish - deteriorating sentiment',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'GDP (Eurozone)',
                    impact: 'high',
                    description: 'Eurozone economic growth.',
                    beatBias: 'EUR bullish - stronger growth',
                    missBias: 'EUR bearish - weaker growth or recession',
                    typicalMove: '30-60 pips',
                    bufferHours: 4
                },
                {
                    name: 'PMI (Manufacturing/Services)',
                    impact: 'medium',
                    description: 'Business activity indicators.',
                    beatBias: 'EUR bullish - economic expansion',
                    missBias: 'EUR bearish - economic contraction',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'ECB President Speech',
                    impact: 'high',
                    description: 'Lagarde or ECB officials speaking.',
                    beatBias: 'EUR bullish - hawkish policy signals',
                    missBias: 'EUR bearish - dovish policy signals',
                    typicalMove: '30-80 pips',
                    bufferHours: 4
                }
            ],
            GBP: [
                {
                    name: 'BoE Rate Decision',
                    impact: 'high',
                    description: 'Bank of England interest rate announcement.',
                    beatBias: 'GBP bullish - hawkish surprise or rate hike',
                    missBias: 'GBP bearish - dovish surprise or rate cut',
                    typicalMove: '80-150 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (UK)',
                    impact: 'high',
                    description: 'UK inflation measure.',
                    beatBias: 'GBP bullish - higher inflation = hawkish BoE',
                    missBias: 'GBP bearish - lower inflation = dovish BoE',
                    typicalMove: '50-100 pips',
                    bufferHours: 4
                },
                {
                    name: 'GDP (UK)',
                    impact: 'high',
                    description: 'UK economic growth.',
                    beatBias: 'GBP bullish - stronger growth',
                    missBias: 'GBP bearish - weaker growth',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'Employment/Unemployment',
                    impact: 'medium',
                    description: 'UK labor market data.',
                    beatBias: 'GBP bullish - strong employment',
                    missBias: 'GBP bearish - weak employment',
                    typicalMove: '30-60 pips',
                    bufferHours: 2
                },
                {
                    name: 'Retail Sales (UK)',
                    impact: 'medium',
                    description: 'UK consumer spending.',
                    beatBias: 'GBP bullish - strong consumer',
                    missBias: 'GBP bearish - weak consumer',
                    typicalMove: '25-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'PMI (Manufacturing/Services)',
                    impact: 'medium',
                    description: 'UK business activity.',
                    beatBias: 'GBP bullish - expansion',
                    missBias: 'GBP bearish - contraction',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'BoE Governor Speech',
                    impact: 'high',
                    description: 'Bailey or BoE officials speaking.',
                    beatBias: 'GBP bullish - hawkish tone',
                    missBias: 'GBP bearish - dovish tone',
                    typicalMove: '30-70 pips',
                    bufferHours: 4
                }
            ],
            JPY: [
                {
                    name: 'BoJ Rate Decision',
                    impact: 'high',
                    description: 'Bank of Japan rate and policy announcement.',
                    beatBias: 'JPY bullish - policy normalisation, rate hike',
                    missBias: 'JPY bearish - continued ultra-loose policy',
                    typicalMove: '100-200 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (Japan)',
                    impact: 'high',
                    description: 'Japanese inflation. BoJ watching closely.',
                    beatBias: 'JPY bullish - inflation supports policy shift',
                    missBias: 'JPY bearish - low inflation = no policy change',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'GDP (Japan)',
                    impact: 'medium',
                    description: 'Japanese economic growth.',
                    beatBias: 'JPY bullish - stronger growth',
                    missBias: 'JPY bearish - weaker growth',
                    typicalMove: '25-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'Tankan Survey',
                    impact: 'medium',
                    description: 'Business confidence survey. Quarterly.',
                    beatBias: 'JPY bullish - improved confidence',
                    missBias: 'JPY bearish - deteriorating confidence',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Trade Balance',
                    impact: 'medium',
                    description: 'Japan exports vs imports.',
                    beatBias: 'JPY bullish - trade surplus',
                    missBias: 'JPY bearish - trade deficit widening',
                    typicalMove: '15-30 pips',
                    bufferHours: 2
                },
                {
                    name: 'BoJ Governor Speech',
                    impact: 'high',
                    description: 'Ueda or BoJ officials speaking.',
                    beatBias: 'JPY bullish - hints at policy normalisation',
                    missBias: 'JPY bearish - commitment to loose policy',
                    typicalMove: '40-100 pips',
                    bufferHours: 4
                }
            ],
            AUD: [
                {
                    name: 'RBA Rate Decision',
                    impact: 'high',
                    description: 'Reserve Bank of Australia rate announcement.',
                    beatBias: 'AUD bullish - hawkish surprise or rate hike',
                    missBias: 'AUD bearish - dovish surprise or rate cut',
                    typicalMove: '60-120 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (Australia)',
                    impact: 'high',
                    description: 'Australian inflation. Quarterly release.',
                    beatBias: 'AUD bullish - higher inflation = hawkish RBA',
                    missBias: 'AUD bearish - lower inflation = dovish RBA',
                    typicalMove: '50-100 pips',
                    bufferHours: 4
                },
                {
                    name: 'Employment Change',
                    impact: 'high',
                    description: 'Australian job market. Key RBA consideration.',
                    beatBias: 'AUD bullish - strong job growth',
                    missBias: 'AUD bearish - weak job growth',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'GDP (Australia)',
                    impact: 'high',
                    description: 'Australian economic growth. Quarterly.',
                    beatBias: 'AUD bullish - stronger growth',
                    missBias: 'AUD bearish - weaker growth',
                    typicalMove: '30-60 pips',
                    bufferHours: 4
                },
                {
                    name: 'Retail Sales',
                    impact: 'medium',
                    description: 'Australian consumer spending.',
                    beatBias: 'AUD bullish - strong consumer',
                    missBias: 'AUD bearish - weak consumer',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Trade Balance',
                    impact: 'medium',
                    description: 'Australia exports vs imports.',
                    beatBias: 'AUD bullish - trade surplus',
                    missBias: 'AUD bearish - trade deficit',
                    typicalMove: '15-30 pips',
                    bufferHours: 2
                },
                {
                    name: 'RBA Governor Speech',
                    impact: 'high',
                    description: 'Bullock or RBA officials speaking.',
                    beatBias: 'AUD bullish - hawkish policy signals',
                    missBias: 'AUD bearish - dovish policy signals',
                    typicalMove: '30-70 pips',
                    bufferHours: 4
                },
                {
                    name: 'China PMI/GDP',
                    impact: 'high',
                    description: 'China data heavily impacts AUD (trade partner).',
                    beatBias: 'AUD bullish - strong China = Aus exports',
                    missBias: 'AUD bearish - weak China = less demand',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                }
            ],
            NZD: [
                {
                    name: 'RBNZ Rate Decision',
                    impact: 'high',
                    description: 'Reserve Bank of NZ rate announcement.',
                    beatBias: 'NZD bullish - hawkish surprise or rate hike',
                    missBias: 'NZD bearish - dovish surprise or rate cut',
                    typicalMove: '60-120 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (New Zealand)',
                    impact: 'high',
                    description: 'NZ inflation. Quarterly release.',
                    beatBias: 'NZD bullish - higher inflation = hawkish RBNZ',
                    missBias: 'NZD bearish - lower inflation = dovish RBNZ',
                    typicalMove: '50-90 pips',
                    bufferHours: 4
                },
                {
                    name: 'GDP (New Zealand)',
                    impact: 'high',
                    description: 'NZ economic growth.',
                    beatBias: 'NZD bullish - stronger growth',
                    missBias: 'NZD bearish - weaker growth',
                    typicalMove: '30-60 pips',
                    bufferHours: 4
                },
                {
                    name: 'Employment/Unemployment',
                    impact: 'medium',
                    description: 'NZ labor market data.',
                    beatBias: 'NZD bullish - strong employment',
                    missBias: 'NZD bearish - weak employment',
                    typicalMove: '30-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'Trade Balance',
                    impact: 'medium',
                    description: 'NZ exports vs imports.',
                    beatBias: 'NZD bullish - trade surplus',
                    missBias: 'NZD bearish - trade deficit',
                    typicalMove: '15-30 pips',
                    bufferHours: 2
                },
                {
                    name: 'GDT Price Index',
                    impact: 'medium',
                    description: 'Global Dairy Trade prices. Key NZ export.',
                    beatBias: 'NZD bullish - higher dairy prices',
                    missBias: 'NZD bearish - lower dairy prices',
                    typicalMove: '15-30 pips',
                    bufferHours: 2
                }
            ],
            CAD: [
                {
                    name: 'BoC Rate Decision',
                    impact: 'high',
                    description: 'Bank of Canada rate announcement.',
                    beatBias: 'CAD bullish - hawkish surprise or rate hike',
                    missBias: 'CAD bearish - dovish surprise or rate cut',
                    typicalMove: '60-120 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (Canada)',
                    impact: 'high',
                    description: 'Canadian inflation.',
                    beatBias: 'CAD bullish - higher inflation = hawkish BoC',
                    missBias: 'CAD bearish - lower inflation = dovish BoC',
                    typicalMove: '40-80 pips',
                    bufferHours: 4
                },
                {
                    name: 'GDP (Canada)',
                    impact: 'high',
                    description: 'Canadian economic growth.',
                    beatBias: 'CAD bullish - stronger growth',
                    missBias: 'CAD bearish - weaker growth',
                    typicalMove: '30-60 pips',
                    bufferHours: 4
                },
                {
                    name: 'Employment Change',
                    impact: 'high',
                    description: 'Canadian job market. Often same day as US NFP.',
                    beatBias: 'CAD bullish - strong job growth',
                    missBias: 'CAD bearish - weak job growth',
                    typicalMove: '40-70 pips',
                    bufferHours: 4
                },
                {
                    name: 'Retail Sales',
                    impact: 'medium',
                    description: 'Canadian consumer spending.',
                    beatBias: 'CAD bullish - strong consumer',
                    missBias: 'CAD bearish - weak consumer',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'Trade Balance',
                    impact: 'medium',
                    description: 'Canada exports vs imports.',
                    beatBias: 'CAD bullish - trade surplus',
                    missBias: 'CAD bearish - trade deficit',
                    typicalMove: '15-30 pips',
                    bufferHours: 2
                },
                {
                    name: 'Oil Inventories',
                    impact: 'medium',
                    description: 'US crude inventories. CAD correlated with oil.',
                    beatBias: 'CAD bearish - higher inventories = lower oil',
                    missBias: 'CAD bullish - lower inventories = higher oil',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                }
            ],
            CHF: [
                {
                    name: 'SNB Rate Decision',
                    impact: 'high',
                    description: 'Swiss National Bank rate announcement.',
                    beatBias: 'CHF bullish - hawkish surprise or rate hike',
                    missBias: 'CHF bearish - dovish surprise or rate cut',
                    typicalMove: '60-120 pips',
                    bufferHours: 6
                },
                {
                    name: 'CPI (Switzerland)',
                    impact: 'medium',
                    description: 'Swiss inflation.',
                    beatBias: 'CHF bullish - higher inflation',
                    missBias: 'CHF bearish - lower inflation',
                    typicalMove: '25-50 pips',
                    bufferHours: 2
                },
                {
                    name: 'GDP (Switzerland)',
                    impact: 'medium',
                    description: 'Swiss economic growth.',
                    beatBias: 'CHF bullish - stronger growth',
                    missBias: 'CHF bearish - weaker growth',
                    typicalMove: '20-40 pips',
                    bufferHours: 2
                },
                {
                    name: 'KOF Economic Barometer',
                    impact: 'low',
                    description: 'Swiss leading indicator.',
                    beatBias: 'CHF bullish - improved outlook',
                    missBias: 'CHF bearish - deteriorating outlook',
                    typicalMove: '10-25 pips',
                    bufferHours: 1
                },
                {
                    name: 'SNB Chairman Speech',
                    impact: 'high',
                    description: 'Jordan or SNB officials speaking.',
                    beatBias: 'CHF bullish - less intervention signals',
                    missBias: 'CHF bearish - intervention threats',
                    typicalMove: '30-70 pips',
                    bufferHours: 4
                }
            ]
        };

        // Current state for news filtering
        let currentNewsFilter = { currency: 'all', search: '' };

        // ============================================
        // NEWS REFERENCE TAB FUNCTIONS
        // ============================================

        function renderNewsEvents() {
            const container = document.getElementById('news-events-list');
            if (!container) return;

            let eventsToShow = [];
            
            // Collect events based on filter
            if (currentNewsFilter.currency === 'all') {
                for (const currency in NEWS_IMPACT_DATABASE) {
                    NEWS_IMPACT_DATABASE[currency].forEach(event => {
                        eventsToShow.push({ ...event, currency });
                    });
                }
            } else {
                const currencyEvents = NEWS_IMPACT_DATABASE[currentNewsFilter.currency] || [];
                eventsToShow = currencyEvents.map(event => ({ ...event, currency: currentNewsFilter.currency }));
            }

            // Apply search filter
            if (currentNewsFilter.search) {
                const searchTerm = currentNewsFilter.search.toLowerCase();
                eventsToShow = eventsToShow.filter(event => 
                    event.name.toLowerCase().includes(searchTerm) ||
                    event.description.toLowerCase().includes(searchTerm)
                );
            }

            // Sort by impact (high first)
            const impactOrder = { high: 0, medium: 1, low: 2 };
            eventsToShow.sort((a, b) => impactOrder[a.impact] - impactOrder[b.impact]);

            // Render
            if (eventsToShow.length === 0) {
                container.innerHTML = '<div class="text-muted" style="text-align: center; padding: 20px;">No events found matching your criteria</div>';
                return;
            }

            container.innerHTML = eventsToShow.map(event => `
                <div class="news-event-card impact-${event.impact}">
                    <div class="news-event-header">
                        <div>
                            <span class="news-event-name">${event.name}</span>
                            <span class="badge badge-info" style="margin-left: 8px; font-size: 0.7rem;">${event.currency}</span>
                        </div>
                        <span class="news-impact-badge ${event.impact}">${event.impact}</span>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">
                        ${event.description}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">
                        <strong>Typical Move:</strong> ${event.typicalMove} | <strong>Buffer:</strong> ${event.bufferHours}h before entry
                    </div>
                    <div class="news-bias-row">
                        <div class="news-bias-box bullish">
                            <span class="news-bias-label">If Beats Forecast:</span>
                            ${event.beatBias}
                        </div>
                        <div class="news-bias-box bearish">
                            <span class="news-bias-label">If Misses Forecast:</span>
                            ${event.missBias}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleNewsReference() {
            const content = document.getElementById('news-reference-content');
            const btn = document.getElementById('news-ref-toggle-btn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide All';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show All';
            }
        }

        function filterNewsByCurrency(currency) {
            currentNewsFilter.currency = currency;
            
            // Update tab active state
            document.querySelectorAll('.news-currency-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.currency === currency) {
                    tab.classList.add('active');
                }
            });
            
            renderNewsEvents();
        }

        function filterNewsEvents() {
            const searchInput = document.getElementById('news-search-input');
            currentNewsFilter.search = searchInput ? searchInput.value : '';
            renderNewsEvents();
        }

        // ============================================
        // QUICK BIAS LOOKUP FUNCTIONS
        // ============================================

        function toggleQuickBiasPanel() {
            const panel = document.getElementById('quick-bias-panel');
            if (panel) {
                panel.classList.toggle('collapsed');
            }
        }

        function updateQuickBiasEvents() {
            const currencySelect = document.getElementById('quick-bias-currency');
            const eventSelect = document.getElementById('quick-bias-event');
            
            if (!currencySelect || !eventSelect) return;
            
            const currency = currencySelect.value;
            eventSelect.innerHTML = '<option value="">Select event...</option>';
            
            if (currency && NEWS_IMPACT_DATABASE[currency]) {
                NEWS_IMPACT_DATABASE[currency].forEach(event => {
                    const option = document.createElement('option');
                    option.value = event.name;
                    option.textContent = `${event.name} (${event.impact})`;
                    eventSelect.appendChild(option);
                });
            }
            
            // Clear result
            const resultDiv = document.getElementById('quick-bias-result');
            if (resultDiv) {
                resultDiv.className = 'quick-bias-result empty';
                resultDiv.innerHTML = 'Select currency and event to see bias';
            }
        }

        function showQuickBiasResult() {
            const currencySelect = document.getElementById('quick-bias-currency');
            const eventSelect = document.getElementById('quick-bias-event');
            const resultDiv = document.getElementById('quick-bias-result');
            
            if (!currencySelect || !eventSelect || !resultDiv) return;
            
            const currency = currencySelect.value;
            const eventName = eventSelect.value;
            
            if (!currency || !eventName) {
                resultDiv.className = 'quick-bias-result empty';
                resultDiv.innerHTML = 'Select currency and event to see bias';
                return;
            }
            
            const events = NEWS_IMPACT_DATABASE[currency] || [];
            const event = events.find(e => e.name === eventName);
            
            if (!event) {
                resultDiv.className = 'quick-bias-result empty';
                resultDiv.innerHTML = 'Event not found';
                return;
            }
            
            resultDiv.className = 'quick-bias-result';
            resultDiv.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <strong style="font-size: 1rem;">${event.name}</strong>
                    <span class="news-impact-badge ${event.impact}" style="margin-left: 8px;">${event.impact}</span>
                </div>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                    ${event.description}
                </div>
                <div class="news-bias-row">
                    <div class="news-bias-box bullish">
                        <span class="news-bias-label">BEATS Forecast:</span>
                        ${event.beatBias}
                    </div>
                    <div class="news-bias-box bearish">
                        <span class="news-bias-label">MISSES Forecast:</span>
                        ${event.missBias}
                    </div>
                </div>
                <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-muted);">
                    <strong>Typical Move:</strong> ${event.typicalMove} | 
                    <strong>Entry Buffer:</strong> Avoid entering ${event.bufferHours}h before release
                </div>
            `;
        }

        // ============================================
        // NEWS BUFFER CHECK FOR PRE-TRADE
        // ============================================

        function checkNewsBuffer() {
            // Check news buffer using live calendar data
            const pairSelect = document.getElementById('val-pair');
            if (!pairSelect) return;
            
            const pair = pairSelect.value;
            if (!pair) return;
            
            // Extract currencies from pair
            const baseCurrency = pair.substring(0, 3);
            const quoteCurrency = pair.substring(3, 6);
            
            // Check live calendar first, fall back to reference data
            if (LIVE_CALENDAR_DATA.events && LIVE_CALENDAR_DATA.events.length > 0) {
                updateNewsBufferWarningLive(pair, baseCurrency, quoteCurrency);
            } else {
                updateNewsBufferWarning(baseCurrency, quoteCurrency);
            }
        }
        
        // Live calendar version of news buffer warning
        function updateNewsBufferWarningLive(pair, baseCurrency, quoteCurrency) {
            const warningDiv = document.getElementById('news-buffer-warning');
            const titleText = document.getElementById('news-buffer-title-text');
            const contentDiv = document.getElementById('news-buffer-content');
            const recDiv = document.getElementById('news-buffer-recommendation');
            
            if (!warningDiv) return;
            
            // Get upcoming events for both currencies (next 4 hours)
            const baseEventsHigh = getUpcomingEventsForCurrency(baseCurrency, 4).filter(e => e.impact === 'High');
            const quoteEventsHigh = getUpcomingEventsForCurrency(quoteCurrency, 4).filter(e => e.impact === 'High');
            const baseEventsMed = getUpcomingEventsForCurrency(baseCurrency, 2).filter(e => e.impact === 'Medium');
            const quoteEventsMed = getUpcomingEventsForCurrency(quoteCurrency, 2).filter(e => e.impact === 'Medium');
            
            const allHighImpact = [...baseEventsHigh, ...quoteEventsHigh];
            const allMediumImpact = [...baseEventsMed, ...quoteEventsMed];
            
            // No upcoming news
            if (allHighImpact.length === 0 && allMediumImpact.length === 0) {
                warningDiv.classList.remove('active', 'caution');
                warningDiv.classList.add('active');
                titleText.textContent = 'News Clear';
                titleText.style.color = 'var(--color-pass)';
                contentDiv.innerHTML = '<div style="color: var(--color-pass);">No high impact news within 4 hours for ' + pair + '</div>';
                recDiv.innerHTML = '<strong style="color: var(--color-pass);">Safe to trade based on news calendar</strong>';
                return;
            }
            
            // Has upcoming high impact news
            warningDiv.classList.add('active');
            titleText.style.color = '';
            
            if (allHighImpact.length > 0) {
                const nearestHigh = allHighImpact[0];
                const minutesUntil = getMinutesUntilEvent(nearestHigh);
                
                // Critical - within 30 minutes
                if (minutesUntil !== null && minutesUntil < 30) {
                    warningDiv.classList.add('caution');
                    titleText.textContent = 'HIGH IMPACT NEWS IMMINENT';
                    titleText.style.color = 'var(--color-fail)';
                } else if (minutesUntil !== null && minutesUntil < 120) {
                    warningDiv.classList.add('caution');
                    titleText.textContent = 'High Impact News Approaching';
                    titleText.style.color = 'var(--color-warning)';
                } else {
                    warningDiv.classList.remove('caution');
                    titleText.textContent = 'Upcoming News for ' + pair;
                }
            } else {
                warningDiv.classList.remove('caution');
                titleText.textContent = 'Medium Impact News for ' + pair;
            }
            
            // Build content
            let contentHTML = '';
            
            if (allHighImpact.length > 0) {
                contentHTML += '<div style="margin-bottom: 8px;"><strong style="color: var(--color-fail);">High Impact:</strong></div>';
                contentHTML += '<ul style="margin: 0 0 8px 0; padding-left: 20px; font-size: 0.85rem;">';
                allHighImpact.slice(0, 4).forEach(event => {
                    const mins = getMinutesUntilEvent(event);
                    const timeStr = formatTimeUntil(mins);
                    const isUrgent = mins !== null && mins < 60;
                    contentHTML += '<li style="' + (isUrgent ? 'color: var(--color-fail);' : '') + '">';
                    contentHTML += event.currency + ': ' + event.title;
                    contentHTML += ' - <strong>' + timeStr + '</strong>';
                    if (event.forecast) contentHTML += ' (F: ' + event.forecast + ')';
                    contentHTML += '</li>';
                });
                contentHTML += '</ul>';
            }
            
            if (allMediumImpact.length > 0) {
                contentHTML += '<div style="margin-bottom: 4px;"><strong style="color: var(--color-warning);">Medium Impact:</strong></div>';
                contentHTML += '<ul style="margin: 0; padding-left: 20px; font-size: 0.8rem; color: var(--text-secondary);">';
                allMediumImpact.slice(0, 3).forEach(event => {
                    const mins = getMinutesUntilEvent(event);
                    contentHTML += '<li>' + event.currency + ': ' + event.title + ' - ' + formatTimeUntil(mins) + '</li>';
                });
                contentHTML += '</ul>';
            }
            
            contentDiv.innerHTML = contentHTML;
            
            // Recommendation based on nearest high impact
            if (allHighImpact.length > 0) {
                const nearestHigh = allHighImpact[0];
                const mins = getMinutesUntilEvent(nearestHigh);
                
                if (mins !== null && mins < 30) {
                    recDiv.innerHTML = '<strong style="color: var(--color-fail);">DO NOT ENTER - News in ' + mins + ' minutes</strong>';
                } else if (mins !== null && mins < 120) {
                    recDiv.innerHTML = '<strong style="color: var(--color-warning);">CAUTION - Consider waiting or reduce to 1% risk</strong>';
                } else {
                    recDiv.innerHTML = '<strong>Monitor - High impact news in ' + formatTimeUntil(mins) + '</strong>';
                }
            } else {
                recDiv.innerHTML = '<strong>Low risk - Only medium impact news upcoming</strong>';
            }
        }

        function manualNewsBufferCheck() {
            const pairSelect = document.getElementById('val-pair');
            if (!pairSelect || !pairSelect.value) {
                alert('Please select a currency pair first');
                return;
            }
            
            const pair = pairSelect.value;
            const baseCurrency = pair.substring(0, 3);
            const quoteCurrency = pair.substring(3, 6);
            
            let message = `News Events for ${pair}\n`;
            message += '='.repeat(35) + '\n\n';
            
            // LIVE EVENTS SECTION (from calendar.json)
            if (LIVE_CALENDAR_DATA.events && LIVE_CALENDAR_DATA.events.length > 0) {
                const baseEventsLive = getUpcomingEventsForCurrency(baseCurrency, 24);
                const quoteEventsLive = getUpcomingEventsForCurrency(quoteCurrency, 24);
                const allLiveEvents = [...baseEventsLive, ...quoteEventsLive];
                
                if (allLiveEvents.length > 0) {
                    message += 'UPCOMING SCHEDULED EVENTS (Next 24h)\n';
                    message += '='.repeat(35) + '\n';
                    
                    allLiveEvents.slice(0, 8).forEach(e => {
                        const mins = getMinutesUntilEvent(e);
                        const timeStr = formatTimeUntil(mins);
                        const impact = e.impact === 'High' ? '[HIGH]' : e.impact === 'Medium' ? '[MED]' : '[LOW]';
                        message += `${impact} ${e.currency}: ${e.title}\n`;
                        message += `   Time: ${timeStr}`;
                        if (e.forecast) message += ` | F: ${e.forecast}`;
                        if (e.previous) message += ` | P: ${e.previous}`;
                        message += '\n';
                    });
                } else {
                    message += 'OK - No scheduled events in next 24h\n';
                }
            } else {
                message += 'WARNING: Live calendar not loaded\n';
            }
            
            message += '\n' + '='.repeat(35) + '\n';
            message += 'REFERENCE: Key Events to Watch\n';
            message += '='.repeat(35) + '\n\n';
            
            // REFERENCE SECTION (from NEWS_IMPACT_DATABASE)
            const baseEvents = (NEWS_IMPACT_DATABASE[baseCurrency] || []).filter(e => e.impact === 'high');
            const quoteEvents = (NEWS_IMPACT_DATABASE[quoteCurrency] || []).filter(e => e.impact === 'high');
            
            if (baseEvents.length > 0) {
                message += `${baseCurrency} High Impact Events:\n`;
                baseEvents.forEach(e => {
                    message += `  * ${e.name} (${e.bufferHours}h buffer)\n`;
                });
                message += '\n';
            }
            
            if (quoteEvents.length > 0) {
                message += `${quoteCurrency} High Impact Events:\n`;
                quoteEvents.forEach(e => {
                    message += `  * ${e.name} (${e.bufferHours}h buffer)\n`;
                });
            }
            
            message += '\n' + '='.repeat(35) + '\n';
            message += 'Rule: High impact = 4h buffer, Medium = 2h buffer';
            
            alert(message);
        }

        function updateNewsBufferWarning(baseCurrency, quoteCurrency) {
            const warningDiv = document.getElementById('news-buffer-warning');
            const titleText = document.getElementById('news-buffer-title-text');
            const contentDiv = document.getElementById('news-buffer-content');
            const recDiv = document.getElementById('news-buffer-recommendation');
            
            if (!warningDiv) return;
            
            // Get high impact events for both currencies
            const baseEvents = (NEWS_IMPACT_DATABASE[baseCurrency] || []).filter(e => e.impact === 'high');
            const quoteEvents = (NEWS_IMPACT_DATABASE[quoteCurrency] || []).filter(e => e.impact === 'high');
            
            const allHighImpact = [...baseEvents.map(e => ({...e, currency: baseCurrency})), 
                                   ...quoteEvents.map(e => ({...e, currency: quoteCurrency}))];
            
            if (allHighImpact.length === 0) {
                warningDiv.classList.remove('active');
                return;
            }
            
            // Show educational warning (in production, would check actual calendar times)
            warningDiv.classList.add('active');
            warningDiv.classList.remove('caution');
            
            titleText.textContent = `News Events for ${baseCurrency}/${quoteCurrency}`;
            
            contentDiv.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>High Impact Events to Check:</strong>
                </div>
                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">
                    ${allHighImpact.slice(0, 5).map(e => `
                        <li>${e.currency}: ${e.name} - <span style="color: var(--color-warning);">${e.bufferHours}h buffer required</span></li>
                    `).join('')}
                </ul>
            `;
            
            recDiv.innerHTML = `
                <strong>Pre-Trade Rules:</strong>
                <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 0.8rem;">
                    <li>High impact within 4h: <span style="color: var(--color-fail);">DO NOT ENTER</span></li>
                    <li>Medium impact within 2h: <span style="color: var(--color-warning);">Reduce to 1% risk</span></li>
                    <li>Already in trade: Consider moving to BE or taking partials</li>
                </ul>
            `;
        }

        // ============================================
        // POSITION NEWS WARNINGS (DASHBOARD)
        // ============================================

        function checkOpenPositionNews() {
            // This checks open positions against upcoming news
            // Called when dashboard loads or active trades change
            
            const trades = JSON.parse(localStorage.getItem(STORAGE_KEYS.trades) || '[]');
            const openTrades = trades.filter(t => t.status === 'open');
            
            if (openTrades.length === 0) {
                const container = document.getElementById('position-news-warnings-container');
                if (container) container.innerHTML = '';
                return;
            }
            
            // Get affected currencies from open positions
            const affectedCurrencies = new Set();
            openTrades.forEach(trade => {
                if (trade.pair) {
                    affectedCurrencies.add(trade.pair.substring(0, 3));
                    affectedCurrencies.add(trade.pair.substring(3, 6));
                }
            });
            
            // Build warning content (educational - in production would check live calendar)
            const container = document.getElementById('position-news-warnings-container');
            if (!container) return;
            
            // Show a general reminder about checking news for open positions
            const currencies = Array.from(affectedCurrencies);
            let highImpactEvents = [];
            
            currencies.forEach(curr => {
                const events = (NEWS_IMPACT_DATABASE[curr] || []).filter(e => e.impact === 'high');
                events.forEach(e => {
                    highImpactEvents.push({ ...e, currency: curr });
                });
            });
            
            if (highImpactEvents.length > 0) {
                container.innerHTML = `
                    <div class="position-news-warning">
                        <div class="position-news-header">
                            <span class="icon">&#x1F4F0;</span>
                            <span>Open Position News Reminder</span>
                        </div>
                        <div class="position-news-details">
                            You have ${openTrades.length} open position(s) in currencies with major news events. 
                            Check your TradingView Economic Calendar for scheduled times.
                        </div>
                        <div style="font-size: 0.8rem; margin-bottom: 8px;">
                            <strong>Currencies Exposed:</strong> ${currencies.join(', ')}
                        </div>
                        <div class="position-news-action">
                            <button class="action-btn" onclick="showTab('reference'); filterNewsByCurrency('${currencies[0]}');">
                                View ${currencies[0]} Events
                            </button>
                            ${currencies[1] ? `<button class="action-btn" onclick="showTab('reference'); filterNewsByCurrency('${currencies[1]}');">View ${currencies[1]} Events</button>` : ''}
                        </div>
                        <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-muted);">
                            <strong>If high-impact news approaching:</strong> Move stop to BE if in profit, or take partials
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        // ============================================
        // INITIALISATION
        // ============================================

        // Initialise news system when DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            // Render news reference on reference tab
            setTimeout(() => {
                renderNewsEvents();
                checkOpenPositionNews();
                
                // Hook into showTab for news updates (after showTab is defined)
                if (typeof window.showTab === 'function') {
                    const _originalShowTab = window.showTab;
                    window.showTab = function(tabName) {
                        _originalShowTab(tabName);
                        if (tabName === 'dashboard') {
                            checkOpenPositionNews();
                        }
                        if (tabName === 'reference') {
                            renderNewsEvents();
                        }
                    };
                }
            }, 700);
        });

        // CHUNK 9 COMPLETE - News Impact Management System
    </script>
    
    <!-- Tooltip Positioning Script -->
    <script>
        // Position fixed tooltips near the trigger element
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('mouseover', (e) => {
                const tooltip = e.target.closest('.regime-tooltip');
                if (!tooltip) return;
                
                const content = tooltip.querySelector('.regime-tooltip-content');
                if (!content) return;
                
                const rect = tooltip.getBoundingClientRect();
                const contentWidth = 300;
                const contentHeight = content.offsetHeight || 150;
                
                // Position above the trigger, centered
                let left = rect.left + (rect.width / 2) - (contentWidth / 2);
                let top = rect.top - contentHeight - 10;
                
                // Keep within viewport
                if (left < 10) left = 10;
                if (left + contentWidth > window.innerWidth - 10) {
                    left = window.innerWidth - contentWidth - 10;
                }
                if (top < 10) {
                    // Show below if no room above
                    top = rect.bottom + 10;
                }
                
                content.style.left = left + 'px';
                content.style.top = top + 'px';
            });
        });
    </script>

    <!-- Armed Panel Module -->
    <script>
        (function() {
            // Configuration
            const STATE_URL = 'https://api.pineros.club/state';
            const REFRESH_INTERVAL = 30000; // 30 seconds
            
            // Elements
            const countEl = document.getElementById('armed-count');
            const listEl = document.getElementById('armed-list');
            const refreshEl = document.getElementById('armed-refresh');
            
            if (!countEl || !listEl || !refreshEl) {
                console.warn('Armed Panel: Elements not found');
                return;
            }

            // Score colour helper
            function scoreColour(score) {
                if (score >= 85) return 'var(--color-pass)';
                if (score >= 75) return 'var(--color-info)';
                if (score >= 65) return 'var(--color-warning)';
                return 'var(--text-muted)';
            }

            // Permission CSS class
            function permClass(perm) {
                if (!perm) return 'permission-legacy';
                var p = perm.toUpperCase();
                if (p === 'FULL') return 'permission-full';
                if (p === 'CONDITIONAL') return 'permission-conditional';
                return 'permission-legacy';
            }

            // Permission display class
            function permDisplayClass(perm) {
                if (!perm) return '';
                var p = perm.toUpperCase();
                if (p === 'FULL') return 'full';
                if (p === 'CONDITIONAL') return 'conditional';
                if (p === 'STAND_DOWN') return 'stand-down';
                return '';
            }

            // Build a pair row (used for both armed and candidates)
            function buildRow(p, emoji) {
                var permCls = permClass(p.permission);
                var permDisp = permDisplayClass(p.permission);
                var permLabel = p.permission || '\u2014';
                if (permLabel === 'CONDITIONAL') permLabel = 'COND';

                return '<div class="armed-pair-row ' + permCls + '">' +
                    '<span class="armed-emoji">' + emoji + '</span>' +
                    '<span class="armed-pair-name">' + (p.pair || '') + '</span>' +
                    '<span class="armed-primary">' + (p.primary || '\u2014') + '</span>' +
                    '<span class="armed-permission ' + permDisp + '">' + permLabel + '</span>' +
                    '<span class="armed-maxrisk">' + (p.maxRisk || '\u2014') + '</span>' +
                    '<span class="armed-score" style="color:' + scoreColour(p.score || 0) + '">' + (p.score || '\u2014') + '</span>' +
                    '<span class="armed-age">' + (p.age || '') + '</span>' +
                '</div>';
            }

            // Column headers row
            function buildColHeaders() {
                return '<div class="armed-col-headers">' +
                    '<span></span>' +
                    '<span>Pair</span>' +
                    '<span>Regime</span>' +
                    '<span>Perm</span>' +
                    '<span>Risk</span>' +
                    '<span>Sc</span>' +
                    '<span style="text-align:right">Age</span>' +
                '</div>';
            }
            
            // Fetch and render state
            async function fetchArmedState() {
                try {
                    const response = await fetch(STATE_URL, { 
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    const data = await response.json();
                    renderArmedState(data);
                } catch (e) {
                    renderArmedError(e.message);
                }
            }
            
            function renderArmedState(data) {
                var armedCount = data.count || 0;
                var candidateCount = data.candidateCount || 0;
                var totalCount = armedCount + candidateCount;

                // Update count badge (shows armed count only)
                countEl.textContent = armedCount;
                countEl.className = 'armed-panel-count' + (armedCount === 0 ? ' zero' : '');
                
                // Update refresh time
                refreshEl.textContent = formatTime(new Date());
                
                // Build HTML
                var html = '';

                // --- ARMED INSTRUMENTS section ---
                html += '<div class="armed-section-header">' +
                    'Armed Instruments ' +
                    '<span class="armed-section-count' + (armedCount > 0 ? ' armed' : '') + '">' + armedCount + '</span>' +
                '</div>';

                if (armedCount > 0) {
                    html += buildColHeaders();
                    var pairs = data.pairs || [];
                    for (var i = 0; i < pairs.length; i++) {
                        // Green circle for armed: &#x1F7E2;
                        html += buildRow(pairs[i], '&#x1F7E2;');
                    }
                } else {
                    html += '<div class="armed-empty">No instruments armed</div>';
                }

                // --- WATCHLIST section (candidates) ---
                var candidates = data.candidates || [];
                if (candidates.length > 0) {
                    html += '<div class="armed-section-header">' +
                        'Watchlist ' +
                        '<span class="armed-section-count candidate">' + candidateCount + '</span>' +
                    '</div>';
                    html += buildColHeaders();
                    for (var j = 0; j < candidates.length; j++) {
                        // Yellow circle for candidate: &#x1F7E1;
                        html += buildRow(candidates[j], '&#x1F7E1;');
                    }
                }

                listEl.innerHTML = html;
            }
            
            function renderArmedError(msg) {
                listEl.innerHTML = '<div class="armed-error">Cannot connect: ' + msg + '</div>';
                refreshEl.textContent = 'Error';
            }
            
            function formatTime(date) {
                return date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Initial fetch
            fetchArmedState();
            
            // Auto-refresh
            setInterval(fetchArmedState, REFRESH_INTERVAL);
            
            // Expose manual refresh globally
            window.refreshArmedPanel = fetchArmedState;
        })();
    </script>

    <!-- Regime Check Module -->
    <script src="js/regime-module.js"></script>
    
    <!-- Playbook Module -->
    <script src="js/playbook-module.js"></script>
	
	<!-- Circuit Breaker System -->
	<script src="js/circuit-breaker-module.js"></script>
	<script src="js/circuit-breaker-integration.js"></script>
	<script src="js/circuit-breaker-ui.js"></script>
	
	<!-- Broker Integration -->
	<script src="js/broker-manager.js"></script>
	<script src="js/broker-oanda.js"></script>
	<script src="js/broker-ui.js"></script>
	<script src="js/broker-dashboard.js"></script>
	
	<!-- UTCS Phase 1-4: Alert Queue & Trade Capture -->
	<script src="js/alert-queue.js"></script>
	<script src="js/trade-capture.js"></script>
	<script src="js/execute-integration.js"></script>
	<script src="js/journal-autofill.js"></script>
	
	<!-- Server Storage -->
	<script src="js/server-storage.js"></script>
	
	<!-- Trade Journal -->
	<script src="js/trade-journal.js"></script>
	

    <!-- Session Board & Gold Nugget Guide -->
    <script src="js/session-board.js"></script>
    <script src="js/trading-guide.js"></script>
    
</body>
</html>
