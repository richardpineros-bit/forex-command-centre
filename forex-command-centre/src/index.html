<!DOCTYPE html>
<!-- Forex Command Centre v3.5.0 - CSS Modularised -->
<!-- CSS Extraction: 8,535 inline CSS lines extracted to 8 modular CSS files -->
<!-- Phase 5: Armed Instruments TTL/FOMO + Quick Access Bar (COMPLETE) -->
<!-- Phase 6: Comprehensive Tooltips + DOM Enrichment (COMPLETE) -->
<!-- UTCS Integration: Phase 1-4 + Phase 5-6 (TTL/FOMO Gate + Comprehensive Tooltips) -->
<!-- UTCS Integration: Phase 1-4 (Alert Queue, Trade Capture, Quick Journal, Oanda History) -->
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Command Centre</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- UTCS Phase 1-4 Styles -->
    <link rel="stylesheet" href="css/alert-queue-ui.css">
    <link rel="stylesheet" href="css/trade-capture-ui.css">
    
    <!-- Modularised CSS (Phase 1 extraction) -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/regime.css">
    <link rel="stylesheet" href="css/pre-trade.css">
    <link rel="stylesheet" href="css/journal.css">
    <link rel="stylesheet" href="css/modals.css">
</head>
<body>
    <!-- ============================================
         APP HEADER
         ============================================ -->
    <header class="app-header">
        <div class="app-header-content">
            <div class="app-title">
                <h1>&#x1F4CA; Forex Command Centre</h1>
                <span>Pre-Trade</span>
            </div>
            
            <nav class="tab-nav">
                <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
                <button class="tab-btn" onclick="showTab('daily-context')">Briefing</button>

                <button class="tab-btn" onclick="showTab('playbook')">Game Plan</button>
                <button class="tab-btn" onclick="showTab('validation')">Pre-Trade</button>
                <button class="tab-btn" onclick="showTab('journal')">Journal</button>
                <button class="tab-btn" onclick="showTab('performance')">Performance</button>
                
                <button class="tab-btn" onclick="showTab('reference')">Reference</button>
                <button class="tab-btn" onclick="showTab('settings')">Settings</button>
            </nav>
            

            <!-- Gold Nugget Guide Button -->
            <div class="header-quick-actions" style="display: flex; gap: 8px; margin-left: auto;">
                <button class="btn-gold-nugget" onclick="TradingGuide.show()" title="UTCC Trading Reference">
                    &#x1F4D6; Guide
                </button>
            </div>
            
            <div class="theme-toggle">
                <span id="broker-global-status" class="status-dot disconnected" title="Broker: Disconnected" onclick="showTab('settings')"></span>
                <span id="calendar-status-indicator" class="status-dot offline" title="Calendar: Offline"></span>
                <button class="theme-toggle-btn active" onclick="setTheme('dark')" title="Dark Mode">&#x1F319;</button>
                <button class="theme-toggle-btn" onclick="setTheme('light')" title="Light Mode">&#x2600;</button>
            </div>
        </div>
    </header>

    <!-- ============================================
         MAIN CONTENT
         ============================================ -->
    <main class="container">
        
        <!-- ==========================================
             TAB 1: DASHBOARD
             ========================================== -->
        
        <!-- ============================================
             REGIME CHECK TAB
             ============================================ -->

        <!-- v3.0.0: Workflow Stepper (Phase 2) -->
        <div class="dc-stepper-wrapper" id="dc-stepper-wrapper">
            <div id="dc-stepper-container"></div>
        </div>

        <!-- v4.0.0: Briefing Tab -->
        <section id="tab-daily-context" class="tab-content">
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CB; Daily Briefing</h2>
                    <span class="regime-badge-info">Start here every day</span>
                </div>
                <div id="dc-form-container">
                    <!-- Rendered by daily-context.js -->
                </div>
            </div>
        </section>

        <section id="tab-dashboard" class="tab-content active">

            <!-- v3.0.0: Stand-Down Banner (Phase 1) -->
            <div id="dc-standdown-container" style="display:none;"></div>

            <!-- v3.0.0: Daily Context Briefing Card (Phase 1) -->
            <div id="dc-briefing-container"></div>

            <!-- v3.1.0: Active Playbook Briefing Card (Phase 3) -->
            <div id="dc-playbook-briefing-container"></div>



            
            <!-- v2.11.0: Discipline Dashboard (replaces Account Overview) -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Discipline Dashboard</h2>
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div id="drawdown-status" class="drawdown-indicator normal">
                            <span class="drawdown-dot"></span>
                            <span>NORMAL</span>
                        </div>
                        <span class="badge" id="dash-open-positions-badge" style="font-size:0.7rem;">0 Open</span>
                    </div>
                </div>
                
                <!-- Discipline Hero -->
                <div class="discipline-hero">
                    <div class="discipline-score-ring score-none" id="discipline-ring">
                        <div class="discipline-score-value" id="discipline-pct">--</div>
                    </div>
                    <div class="discipline-score-label">Rules Adherence</div>
                    <div class="discipline-subtitle" id="discipline-subtitle">No graded trades yet</div>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="discipline-process-score">--</div>
                        <div class="stat-label">Process Score (avg)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="discipline-perfect-count">0</div>
                        <div class="stat-label">Perfect Trades (9/9)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="discipline-streak">0</div>
                        <div class="stat-label">Discipline Streak</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="discipline-total-graded">0</div>
                        <div class="stat-label">Graded Trades</div>
                    </div>
                </div>
                
                <!-- Collapsible P&L (hidden by default) -->
                <div class="pnl-reveal-section">
                    <div class="pnl-reveal-toggle" onclick="togglePnlReveal()">
                        <span id="pnl-reveal-arrow">&#x25B6;</span>
                        <span>Account Data (P&amp;L)</span>
                    </div>
                    <div class="pnl-hidden-data" id="pnl-hidden-data">
                        <div class="grid grid-4">
                            <div class="stat-box">
                                <div class="stat-value" id="dash-balance">$2,000</div>
                                <div class="stat-label">Balance (AUD)</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="dash-peak">$2,000</div>
                                <div class="stat-label">Peak Balance</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="dash-drawdown">0.0%</div>
                                <div class="stat-label">Drawdown</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="dash-open-positions">0</div>
                                <div class="stat-label">Open Positions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick News Bias Lookup Panel -->
            <div class="quick-bias-panel" id="quick-bias-panel">
                <div class="quick-bias-header" onclick="toggleQuickBiasPanel()">
                    <div class="quick-bias-title">
                        <span>&#x1F4F0;</span>
                        <span>Quick News Bias Lookup</span>
                    </div>
                    <span class="quick-bias-toggle">&#x25BC;</span>
                </div>
                <div class="quick-bias-content">
                    <div class="quick-bias-selector">
                        <div class="form-group">
                            <label class="form-label">Currency</label>
                            <select class="form-select" id="quick-bias-currency" onchange="updateQuickBiasEvents()">
                                <option value="">Select currency...</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="GBP">GBP</option>
                                <option value="JPY">JPY</option>
                                <option value="AUD">AUD</option>
                                <option value="NZD">NZD</option>
                                <option value="CAD">CAD</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Event Type</label>
                            <select class="form-select" id="quick-bias-event" onchange="showQuickBiasResult()">
                                <option value="">Select event...</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-bias-result empty" id="quick-bias-result">
                        Select currency and event to see bias
                    </div>
                </div>
            </div>
            
            <!-- Position News Warning Panel (shown when open positions have upcoming news) -->
            <div id="position-news-warnings-container">
                <!-- Populated dynamically by JS when there are open positions with upcoming news -->
            </div>
            
            <!-- Active Trades Widget -->
            <div class="card mb-lg" id="active-trades-widget">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Active Trades</h2>
                    <div class="flex gap-sm align-center">
                        <span class="badge badge-info" id="widget-open-count">0 Open</span>
                        <button class="btn btn-secondary btn-sm" onclick="showTab('journal')">Manage &#x2192;</button>
                    </div>
                </div>
                
                <div id="active-trades-widget-content">
                    <div class="no-trades-widget" id="no-active-trades-widget">
                        <span style="font-size: 2rem; opacity: 0.5;">&#x1F52D;</span>
                        <span class="text-muted">No active trades</span>
                    </div>
                    
                    <div class="active-trades-grid" id="active-trades-grid" style="display: none;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Quick Trade Summary -->
                <div class="trade-summary-bar" id="trade-summary-bar" style="display: none;">
                    <div class="summary-item">
                        <span class="summary-label">Total Exposure:</span>
                        <span class="summary-value" id="widget-total-risk">0%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Active Risk:</span>
                        <span class="summary-value" id="widget-active-risk">--</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Oldest Trade:</span>
                        <span class="summary-value" id="widget-oldest-trade">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Armed Instruments Panel -->
            <div class="card mb-lg" id="armed-panel">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Armed Instruments</h2>
                    <div class="flex gap-sm align-center">
                        <button id="btn-clear-expired" onclick="clearExpiredArmed()" title="Remove expired instruments from server" style="display:none; font-size:0.7rem; padding:3px 8px; border-radius:var(--radius-sm); border:1px solid var(--color-fail); background:rgba(239,68,68,0.1); color:var(--color-fail); cursor:pointer; font-family:var(--font-heading); font-weight:600;">Clear Expired</button>
                        <span class="armed-panel-count zero" id="armed-count">0</span>
                        <span class="armed-refresh-time" id="armed-refresh">--</span>
                    </div>
                </div>
                <div class="armed-panel-list" id="armed-list">
                    <div class="armed-empty">Connecting to state server...</div>
                </div>
            </div>
            
            <!-- Drawdown Protocol Box -->
            <div class="card mb-lg" id="drawdown-protocol-box">
                <div class="card-header">
                    <h2 class="card-title">Drawdown Protocol</h2>
                </div>
                <div class="grid grid-4">
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-normal);">
                        <div class="stat-value" style="font-size: 1rem;">0% to -5%</div>
                        <div class="stat-label">NORMAL</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1.5-2% risk</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-caution);">
                        <div class="stat-value" style="font-size: 1rem;">-5% to -10%</div>
                        <div class="stat-label">CAUTION</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1% risk, review</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-stop);">
                        <div class="stat-value" style="font-size: 1rem;">-10% to -15%</div>
                        <div class="stat-label">STOP</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1-week break</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--drawdown-emergency);">
                        <div class="stat-value" style="font-size: 1rem;">-15%+</div>
                        <div class="stat-label">EMERGENCY</div>
                        <div class="text-muted" style="font-size: 0.7rem; margin-top: 4px;">1-month stop</div>
                    </div>
                </div>
            </div>
            
            <!-- Weekly Performance -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Weekly Discipline</h2>
                    <span class="text-muted" id="week-date-range">This Week</span>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="week-trades">0</div>
                        <div class="stat-label">Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-winrate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-avg-r">0.0R</div>
                        <div class="stat-label">Avg R-Multiple</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-adherence">--</div>
                        <div class="stat-label">Rules Adherence</div>
                    </div>
                </div>
                
                <div class="grid grid-2 mt-md">
                    <div class="stat-box">
                        <div class="stat-value" id="week-expectancy">0.0R</div>
                        <div class="stat-label">Expectancy</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="week-target">0 / 5-10</div>
                        <div class="stat-label">Target Progress</div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                
                <div class="flex gap-md" style="flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showTab('validation')">
                        OK - Validate Setup
                    </button>
                    <button class="btn btn-primary" onclick="showTab('journal')">
                        &#x1F4CB; Log Trade
                    </button>
                </div>
            </div>
            
        </section>

        <!-- PLACEHOLDER: Other tabs will be added in subsequent chunks -->
        
        <!-- ==========================================
             PLAYBOOK TAB - Behavioural Architecture
             ========================================== -->
        <section id="tab-playbook" class="tab-content">
            <div class="card playbook-module-card">
                <div class="playbook-module-header">
                    <h2 class="playbook-module-title">&#x1F3AF; Playbook Selection</h2>
                    <button class="btn btn-secondary btn-sm" onclick="PlaybookModule.handleResetSelection()">&#x1F503; Reset</button>
                </div>
                
                <div id="playbook-selection-container">
                    <!-- Rendered by PlaybookModule.renderPlaybookSelection() -->
                    <p class="text-muted" style="padding: var(--spacing-md);">Loading playbook options...</p>
                </div>
            </div>
        </section>

        <section id="tab-validation" class="tab-content">
            
            <!-- UTCC v2.5 Institutional Pre-Trade Checklist -->
            
            <!-- Pre-Trade Gate Banner (shown when playbook not selected) -->
            <div id="pretrade-gate-banner" class="pretrade-gate-banner" style="display: none;">
                <span class="gate-icon">&#x1F6D1;</span>
                <div class="gate-content">
                    <div class="gate-title">CHOOSE YOUR PLAN FIRST</div>
                    <p class="gate-message">Go to Game Plan and lock in your plan before running the Pre-Trade checklist.</p>
                </div>
                <button class="btn btn-primary" onclick="showTab('playbook')">Go to Game Plan</button>
            </div>
            
            <!-- Leakage Warning Container -->
            <div id="leakage-warnings-container" style="display: none;"></div>
            
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Pre-Trade Checklist</h2>
                    <button class="btn btn-secondary btn-sm" onclick="resetInstitutionalChecklist()">&#x1F503; Reset</button>
                </div>
                
                <p class="text-muted mb-md" style="padding: 0 var(--spacing-md); font-size: 0.85rem;">
                    7 checks before every trade. 6 must-pass + 1 position-sizing guide. If UTCC is Armed, the system has already confirmed score, timeframes, and volatility.
                </p>
                
                <!-- Basic Setup Info -->
                <div class="grid grid-3" style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <div class="form-group">
                        <label class="form-label">Pair</label>
                        <select class="form-select" id="val-pair" onchange="checkCooldown(); updateInstitutionalChecklist(); checkCorrelation(); updateSessionPairRating();">
                            <option value="">Select Pair</option>
                            <optgroup label="Core Pairs">
                                <option value="AUDUSD">AUDUSD</option>
                                <option value="USDJPY">USDJPY</option>
                                <option value="EURUSD">EURUSD</option>
                                <option value="GBPUSD">GBPUSD</option>
                                <option value="EURJPY">EURJPY</option>
                                <option value="GBPJPY">GBPJPY</option>
                            </optgroup>
                            <optgroup label="AUD Crosses">
                                <option value="AUDCAD">AUDCAD</option>
                                <option value="AUDCHF">AUDCHF</option>
                                <option value="AUDJPY">AUDJPY</option>
                                <option value="AUDNZD">AUDNZD</option>
                            </optgroup>
                            <optgroup label="EUR Crosses">
                                <option value="EURAUD">EURAUD</option>
                                <option value="EURCAD">EURCAD</option>
                                <option value="EURGBP">EURGBP</option>
                                <option value="EURNZD">EURNZD</option>
                            </optgroup>
                            <optgroup label="GBP Crosses">
                                <option value="GBPAUD">GBPAUD</option>
                                <option value="GBPCAD">GBPCAD</option>
                                <option value="GBPCHF">GBPCHF</option>
                                <option value="GBPNZD">GBPNZD</option>
                            </optgroup>
                            <optgroup label="JPY Crosses">
                                <option value="CADJPY">CADJPY</option>
                                <option value="CHFJPY">CHFJPY</option>
                                <option value="NZDJPY">NZDJPY</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="NZDCAD">NZDCAD</option>
                                <option value="NZDCHF">NZDCHF</option>
                                <option value="NZDUSD">NZDUSD</option>
                                <option value="USDCAD">USDCAD</option>
                                <option value="USDCHF">USDCHF</option>
                                <option value="CADCHF">CADCHF</option>
                                <option value="EURCHF">EURCHF</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direction</label>
                        <select class="form-select" id="val-direction" onchange="updateInstitutionalChecklist(); updateRSIMatrix();">
                            <option value="">Select</option>
                            <option value="long">LONG</option>
                            <option value="short">SHORT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Session-Pair Rating</label>
                        <div class="session-pair-rating" id="session-pair-rating"></div>
                    </div>
                </div>
                
                <!-- Unified Pre-Trade Checklist (7 Checks) -->
                <div class="inst-checklist">
                    <div class="inst-checklist-header">
                        <span class="inst-checklist-title">&#x1F3DB; 7 Checks Before You Trade</span>
                        <span class="inst-checklist-badge hard">6 MUST-PASS + 1 SIZING</span>
                    </div>
                    
                    <!-- Check 1: UTCC Armed State -->
                    <div class="inst-check-item" id="inst-check-1">
                        <span class="inst-check-number">1</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Is UTCC Armed?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">This is your permission gate. UTCC must show ARMED on the 4H chart. When Armed, the system has already confirmed trend score, timeframe alignment, and volatility. &#x2191; = bullish bias, &#x2193; = bearish bias.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Check your 4H chart &mdash; UTCC panel should show &#x2191; ARMED or &#x2193; ARMED</div>
                            <div class="inst-check-input">
                                <select class="form-select" id="check-utcc-armed" onchange="updateInstitutionalChecklist()" style="width: auto; min-width: 160px;">
                                    <option value="">Select Status</option>
                                    <option value="armed_long">&#x2191; ARMED</option>
                                    <option value="armed_short">&#x2193; ARMED</option>
                                    <option value="disarmed" data-tooltip="disarmed">DISARMED</option>
                                </select>
                                <span class="inst-check-status status-pending" id="check-1-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 2: 1H EMAs Stacked -->
                    <div class="inst-check-item" id="inst-check-2">
                        <span class="inst-check-number">2</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Are the 1H Moving Averages Lined Up?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">The 1H chart gives you timing. The fast, mid, and slow moving averages must be stacked in the same direction as the 4H trend. This confirms the lower timeframe agrees with the bigger picture.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">On the 1H chart: EMAs stacked in order (fast &gt; mid &gt; slow for longs, reversed for shorts)</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-ema-stacked" onchange="updateInstitutionalChecklist()">
                                    <span>Confirmed on 1H chart</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-2-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 3: Price Reaction at EMA -->
                    <div class="inst-check-item" id="inst-check-3">
                        <span class="inst-check-number">3</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Did Price React at the Moving Average?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">Price must DO something at the EMA ribbon &mdash; either hold there (acceptance) or bounce sharply away (rejection). Just touching the ribbon and drifting through it means nothing. You need a visible reaction.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Price shows a clear reaction at the EMA ribbon &mdash; holding there or bouncing away. Just touching is not enough.</div>
                            <div class="inst-check-input">
                                <select class="form-select" id="check-ema-reaction" onchange="updateInstitutionalChecklist()" style="width: auto; min-width: 180px;">
                                    <option value="">What did price do?</option>
                                    <option value="acceptance">Holding at the level (acceptance)</option>
                                    <option value="rejection">Bounced away sharply (rejection)</option>
                                    <option value="touch_only">Just touched it, no reaction</option>
                                    <option value="none">Hasn't reached it yet</option>
                                </select>
                                <span class="inst-check-status status-pending" id="check-3-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 4: Price Failed the Other Way -->
                    <div class="inst-check-item" id="inst-check-4">
                        <span class="inst-check-number">4</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Did Price Try the Other Way and Fail?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">You trade the failure, not a prediction. For longs: price tried to break lower and couldn't &mdash; buyers stepped in. For shorts: price tried to push higher and failed &mdash; sellers won. This is your confirmation that the other side lost.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Price attempted the opposite direction and failed. You are trading the reaction, not predicting.</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-failed-opposite" onchange="updateInstitutionalChecklist()">
                                    <span id="failed-opposite-label">Price failed to break lower (for long) / higher (for short)</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-4-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 5: Not Chasing the Alert -->
                    <div class="inst-check-item" id="inst-check-5">
                        <span class="inst-check-number">5</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Are You Chasing?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">If the alert just fired on the current candle, you are chasing. Let it breathe. Wait for at least the next candle close before entering. Urgency is the enemy of discipline.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">The alert fired on a previous candle, not the current one. You are not rushing in.</div>
                            <div class="inst-check-input">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="check-alert-lag" onchange="updateInstitutionalChecklist()">
                                    <span>Alert fired on previous candle (not chasing)</span>
                                </label>
                                <span class="inst-check-status status-pending" id="check-5-status">PENDING</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 6: RSI Position Sizing (SOFT) -->
                    <div class="inst-check-item" id="inst-check-6">
                        <span class="inst-check-number">6</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Is Momentum On Your Side?
                                <span class="inst-checklist-badge soft">SIZING</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">RSI tells you if momentum supports your direction. It doesn't block you from trading &mdash; it adjusts your position size. Ideal RSI = full size. Wrong-way RSI = smaller size or no entry.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">Check the RSI table below &mdash; this adjusts your position size, not whether you can trade</div>
                            <div class="inst-check-input">
                                <input type="number" class="form-input" id="check-rsi-value" placeholder="RSI value" min="0" max="100" style="width: 100px;" oninput="updateInstitutionalChecklist(); updateRSIMatrix();">
                                <span class="inst-check-status status-pending" id="check-6-status">PENDING</span>
                            </div>
                            
                            <!-- RSI Matrix -->
                            <div class="rsi-matrix" id="rsi-matrix">
                                <div class="rsi-matrix-title">RSI Position Size Matrix</div>
                                <div class="rsi-matrix-grid">
                                    <div class="rsi-matrix-cell header">Direction</div>
                                    <div class="rsi-matrix-cell header">RSI Level</div>
                                    <div class="rsi-matrix-cell header">Position Size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-ideal-dir">SHORT</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-short-ideal">&gt; 70 OVERBOUGHT</div>
                                    <div class="rsi-matrix-cell ideal">Full size (ideal)</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-acc-dir">SHORT</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-short-acc">50-70 PULLBACK</div>
                                    <div class="rsi-matrix-cell ideal">Full size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-mom-dir">SHORT</div>
                                    <div class="rsi-matrix-cell acceptable" id="rsi-short-mom">30-50 MOMENTUM</div>
                                    <div class="rsi-matrix-cell acceptable">75% size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-short-no-dir">SHORT</div>
                                    <div class="rsi-matrix-cell neutral" id="rsi-short-no">&lt; 30 OVERSOLD</div>
                                    <div class="rsi-matrix-cell neutral">No entry</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-ideal-dir">LONG</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-long-ideal">&lt; 30 OVERSOLD</div>
                                    <div class="rsi-matrix-cell ideal">Full size (ideal)</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-acc-dir">LONG</div>
                                    <div class="rsi-matrix-cell ideal" id="rsi-long-acc">30-50 PULLBACK</div>
                                    <div class="rsi-matrix-cell ideal">Full size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-mom-dir">LONG</div>
                                    <div class="rsi-matrix-cell acceptable" id="rsi-long-mom">50-70 MOMENTUM</div>
                                    <div class="rsi-matrix-cell acceptable">75% size</div>
                                    
                                    <div class="rsi-matrix-cell" id="rsi-long-no-dir">LONG</div>
                                    <div class="rsi-matrix-cell neutral" id="rsi-long-no">&gt; 70 OVERBOUGHT</div>
                                    <div class="rsi-matrix-cell neutral">No entry</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check 7: 48h Cooling Period -->
                    <div class="inst-check-item" id="inst-check-7">
                        <span class="inst-check-number">7</span>
                        <div class="inst-check-content">
                            <div class="inst-check-label">
                                Have You Lost on This Pair Recently?
                                <span class="inst-checklist-badge hard">MUST PASS</span>
                                <span class="inst-check-tooltip">?
                                    <span class="tooltip-content">48-hour cooling period after a loss on the same pair. This prevents revenge trading &mdash; the urge to immediately "win it back." Auto-checked from your trade journal.</span>
                                </span>
                            </div>
                            <div class="inst-check-criteria">No losing trade on this pair in the last 48 hours (auto-detected from your journal)</div>
                            <div class="inst-check-input">
                                <span class="inst-check-status status-pending" id="check-7-status">Select pair first</span>
                            </div>
                            <div id="cooldown-warning-container"></div>
                        </div>
                    </div>
                    
                    <!-- Auto-Detected System Checks -->
                    <div class="inst-check-auto-section">
                        <div class="inst-checklist-header" style="border-top: 1px solid var(--border-primary); margin-top: var(--spacing-sm); padding-top: var(--spacing-sm);">
                            <span class="inst-checklist-title" style="font-size: 0.85rem;">&#x1F916; Auto-Detected</span>
                        </div>
                        
                        <!-- Auto Check: Regime Match -->
                        <div class="inst-check-item inst-check-auto" id="inst-check-auto-regime">
                            <span class="inst-check-number" style="font-size: 0.7rem;">A</span>
                            <div class="inst-check-content">
                                <div class="inst-check-label" style="font-size: 0.85rem;">
                                    Does the Market Agree With Your Briefing?
                                    <span class="inst-check-tooltip">?
                                        <span class="tooltip-content">Compares what you declared in your Briefing (regime) with what UTCC is actually seeing. If they disagree, your read may be wrong.</span>
                                    </span>
                                </div>
                                <div class="inst-check-input">
                                    <span class="inst-check-status status-pending" id="check-auto-regime-status">Waiting for data</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto Check: Correlation -->
                        <div class="inst-check-item inst-check-auto" id="inst-check-auto-correlation">
                            <span class="inst-check-number" style="font-size: 0.7rem;">B</span>
                            <div class="inst-check-content">
                                <div class="inst-check-label" style="font-size: 0.85rem;">
                                    Are You Doubling Up on Correlated Pairs?
                                    <span class="inst-check-tooltip">?
                                        <span class="tooltip-content">Checks if you already have an open trade on a pair that shares a currency with this one. Two trades on correlated pairs = double the risk exposure.</span>
                                    </span>
                                </div>
                                <div class="inst-check-input">
                                    <span class="inst-check-status status-pending" id="check-auto-correlation-status">Select pair first</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Unified Verdict Panel -->
                <div class="entry-verdict-panel verdict-pending" id="entry-verdict-panel" style="margin: var(--spacing-md);">
                    <div class="entry-verdict-icon" id="entry-verdict-icon">&#x23F3;</div>
                    <div class="entry-verdict-status" id="entry-verdict-status">COMPLETE THE CHECKS</div>
                    <div class="entry-verdict-reason" id="entry-verdict-reason">Fill in all 7 checks above to see if you can trade</div>
                    <div class="entry-verdict-checklist" id="entry-verdict-checklist">
                        <span class="verdict-check" id="vc-1">&#x23F3; Armed</span>
                        <span class="verdict-check" id="vc-2">&#x23F3; EMAs</span>
                        <span class="verdict-check" id="vc-3">&#x23F3; Reaction</span>
                        <span class="verdict-check" id="vc-4">&#x23F3; Failed</span>
                        <span class="verdict-check" id="vc-5">&#x23F3; Lag</span>
                        <span class="verdict-check" id="vc-6">&#x23F3; RSI</span>
                        <span class="verdict-check" id="vc-7">&#x23F3; 48h</span>
                    </div>
                </div>
                
                <!-- SANITY CHECK WARNINGS -->
                <div class="sanity-warnings" style="margin: var(--spacing-lg) var(--spacing-md);">
                    <div class="sanity-warning" style="padding: var(--spacing-md); background: rgba(234, 179, 8, 0.1); border: 1px solid var(--color-warning); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                        <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">&#x26A0;</span>
                            <div>
                                <strong style="color: var(--color-warning);">Your Logs Don't Override the System</strong>
                                <p style="font-size: 0.85rem; margin: 4px 0 0 0; color: var(--text-secondary);">
                                    If UTCC disarms, the market wins the argument.<br>
                                    <em>"It downgraded because X"</em> is useful information.<br>
                                    <em>"I overrode it because Y"</em> is <strong>you breaking your own rules</strong>.<br>
                                    <span style="color: var(--color-fail);">Disarm = No trade. Full stop.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sanity-warning" style="padding: var(--spacing-md); background: rgba(59, 130, 246, 0.1); border: 1px solid var(--color-info); border-radius: var(--radius-md);">
                        <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                            <span style="font-size: 1.2rem;">&#x23F1;</span>
                            <div>
                                <strong style="color: var(--color-info);">The System Will Feel Late &mdash; That's Normal</strong>
                                <p style="font-size: 0.85rem; margin: 4px 0 0 0; color: var(--text-secondary);">
                                    After quiet periods, the first re-arm will feel obvious and late.<br>
                                    If you think <em>"This is obvious, why didn't UTCC arm sooner?"</em> &mdash; that's your ego trying to predict instead of react.<br>
                                    <span style="color: var(--color-pass);">Let price prove it first. Late is correct.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ATR Volatility Guidance (Display Only) -->
                <div class="atr-guidance-panel">
                    <div class="atr-guidance-header">
                        <span>&#x1F4CA;</span>
                        <span>ATR Volatility Check (Position Sizing Guide)</span>
                    </div>
                    <div class="atr-guidance-content">
                        <div class="atr-tier compressed" id="atr-tier-compressed">
                            <span class="atr-tier-range">&lt; 30%</span>
                            <span class="atr-tier-label" style="color: var(--color-pass);">COMPRESSED</span>
                            <span class="atr-tier-action">Ideal entry. Volatility expansion likely. Full position size.</span>
                        </div>
                        <div class="atr-tier normal" id="atr-tier-normal">
                            <span class="atr-tier-range">30-60%</span>
                            <span class="atr-tier-label" style="color: var(--color-info);">NORMAL</span>
                            <span class="atr-tier-action">Good entry. Proceed with full size.</span>
                        </div>
                        <div class="atr-tier elevated" id="atr-tier-elevated">
                            <span class="atr-tier-range">60-80%</span>
                            <span class="atr-tier-label" style="color: var(--color-warning);">ELEVATED</span>
                            <span class="atr-tier-action">Caution. Move underway. Reduce position size by 50%.</span>
                        </div>
                        <div class="atr-tier exhausted" id="atr-tier-exhausted">
                            <span class="atr-tier-range">&gt; 80%</span>
                            <span class="atr-tier-label" style="color: var(--color-fail);">EXHAUSTED</span>
                            <span class="atr-tier-action">Pass. You are late. Wait for pullback or next setup.</span>
                        </div>
                        <div class="atr-current-value">
                            <span class="atr-current-label">Current ATR Percentile:</span>
                            <input type="number" class="form-input" id="val-atr-pct" placeholder="e.g. 45" min="0" max="100" style="width: 80px;" oninput="updateATRGuidance()">
                            <span class="atr-current-number" id="atr-current-tier">--</span>
                        </div>
                    </div>
                </div>
                
                <!-- RSI Neutral Override Section (hidden by default) -->
                <div class="override-section" id="rsi-override-section" style="display: none; margin: 0 var(--spacing-md) var(--spacing-md);">
                    <label>
                        <input type="checkbox" id="rsi-override-confirm" onchange="updateInstitutionalChecklist()">
                        <span>I know RSI is neutral (45-55). I'm going ahead anyway with reduced conviction and smaller size.</span>
                    </label>
                </div>

            
            <!-- v2.12.1: Gate Divider -->
            <div class="pretrade-gate-divider" id="pretrade-gate-divider">
                <span class="gate-status-pill gate-locked" id="gate-status-pill">
                    <span id="gate-icon">&#x1F512;</span>
                    <span id="gate-text">Pass the checklist above to unlock</span>
                </span>
            </div>
            
            <!-- Structure Analysis Section -->
            <div class="card mb-lg pretrade-gated" id="structure-analysis">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CB; Where Are You Getting In?</h2>
                    <button class="btn btn-secondary btn-sm" onclick="toggleStructureEducation()">&#x2139; What Are Levels?</button>
                </div>
                
                <!-- Structure Education (hidden by default) -->
                <div id="structure-education" class="structure-education" style="display: none;">
                    <div class="education-header">
                        <h3>Understanding Price Structure</h3>
                        <button class="btn btn-sm" onclick="toggleStructureEducation()">&#x2715; Close</button>
                    </div>
                    
                    <div class="education-content">
                        <div class="education-section">
                            <h4>What is Structure?</h4>
                            <p>Structure refers to <strong>price levels where the market has previously reacted</strong>. These are not random lines - they're areas where buyers and sellers have fought battles before.</p>
                        </div>
                        
                        <div class="education-section">
                            <h4>For STOP LOSS - Look For:</h4>
                            <ul>
                                <li><strong>Swing Lows (for LONGS):</strong> Recent candle wicks that poked down and rejected - the lowest point before price moved up</li>
                                <li><strong>Swing Highs (for SHORTS):</strong> Recent candle wicks that poked up and rejected - the highest point before price moved down</li>
                                <li><strong>EMA Confluence:</strong> Areas where multiple EMAs cluster together (8/21/50)</li>
                                <li><strong>Round Numbers:</strong> Psychological levels like 1.1600, 0.7900, 150.00</li>
                                <li><strong>Previous Day High/Low:</strong> Key daily levels that often act as support/resistance</li>
                            </ul>
                        </div>
                        
                        <div class="education-section">
                            <h4>For TAKE PROFIT - Look For:</h4>
                            <ul>
                                <li><strong>Next Swing High/Low:</strong> The opposite of your SL structure - where price previously reversed</li>
                                <li><strong>S/R Zones on Chart:</strong> Horizontal levels where price has bounced multiple times</li>
                                <li><strong>EMA Resistance (for LONGS):</strong> Higher timeframe EMAs that might slow price down</li>
                                <li><strong>Fib Extensions:</strong> 1.272 or 1.618 extensions from recent swings</li>
                                <li><strong>Previous Week High/Low:</strong> Significant weekly levels</li>
                            </ul>
                        </div>
                        
                        <div class="education-section warning-box">
                            <h4>WARNING: Common Mistakes</h4>
                            <ul>
                                <li><strong>Placing SL exactly ON the level</strong> - Add 5-10 pip buffer BEYOND the structure</li>
                                <li><strong>Using arbitrary pip targets</strong> - 50 pips means nothing if there's resistance at 35 pips</li>
                                <li><strong>Ignoring obstacles</strong> - If there's a major S/R between entry and TP, that's your real TP</li>
                                <li><strong>Forcing trades</strong> - If structure gives you 1:0.8 R:R, skip the trade</li>
                            </ul>
                        </div>
                        
                        <div class="education-section">
                            <h4>Quick Structure Checklist</h4>
                            <ol>
                                <li>Zoom out to 4H/Daily - identify major S/R levels</li>
                                <li>Mark the nearest swing high AND swing low</li>
                                <li>Note where EMAs cluster</li>
                                <li>Check for round numbers nearby</li>
                                <li>Identify first obstacle in trade direction</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <!-- Step 1: Stop Loss Structure -->
                <div class="structure-step" id="structure-step-1">
                    <div class="structure-step-header">
                        <span class="structure-step-number">1</span>
                        <span class="structure-step-title">Identify Stop Loss Level</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="structure-checklist">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="sl-swing-identified" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've identified the nearest swing high/low</span>
                            </label>
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="sl-buffer-added" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've added buffer beyond the level (not sitting ON it)</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-2 mt-sm">
                            <div class="form-group">
                                <label class="form-label">Structure Level</label>
                                <input type="number" class="form-input" id="val-sl-structure" step="0.00001" placeholder="e.g. 1.15900" oninput="calculateStructureLevels(); updateEntryDecisionPanel();">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Actual Stop Loss (with buffer)</label>
                                <input type="number" class="form-input" id="val-stop" step="0.00001" placeholder="e.g. 1.15850" oninput="calculateStructureLevels()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Entry Price -->
                <div class="structure-step" id="structure-step-2">
                    <div class="structure-step-header">
                        <span class="structure-step-number">2</span>
                        <span class="structure-step-title">Entry Price</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="form-group">
                            <label class="form-label">Entry Price</label>
                            <input type="number" class="form-input" id="val-entry" step="0.00001" placeholder="Current price or limit level" oninput="calculateStructureLevels(); updateEntryDecisionPanel(); calculateATRStop();">
                        </div>
                        <p class="text-muted" style="font-size: 0.75rem; margin-top: 4px;">
                            Entry type selection coming in next update (Market/Limit/Scale-in)
                        </p>
                    </div>
                </div>
                
                <!-- Step 3: Take Profit Structure -->
                <div class="structure-step" id="structure-step-3">
                    <div class="structure-step-header">
                        <span class="structure-step-number">3</span>
                        <span class="structure-step-title">Identify Take Profit Levels</span>
                    </div>
                    <div class="structure-step-content">
                        <div class="structure-checklist">
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="tp-structure-identified" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">I've identified the first S/R level in my direction (TP1)</span>
                            </label>
                            <label class="checkbox-wrapper">
                                <input type="checkbox" id="tp-path-clear" onchange="updateStructureAnalysis()">
                                <span class="checkbox-label">No major obstacles between entry and TP1</span>
                            </label>
                        </div>
                        
                        <div class="grid grid-2 mt-sm">
                            <div class="form-group">
                                <label class="form-label">TP1 (First Target)</label>
                                <input type="number" class="form-input" id="val-tp1" step="0.00001" placeholder="First S/R level" oninput="calculateStructureLevels(); syncTPtoExitPlan();">
                            </div>
                            <div class="form-group">
                                <label class="form-label">TP2 (Extended Target)</label>
                                <input type="number" class="form-input" id="val-tp2" step="0.00001" placeholder="Optional second target" oninput="calculateStructureLevels(); syncTPtoExitPlan();">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- R:R Analysis -->
                <div class="rr-analysis-box">
                    <h4>Risk:Reward Analysis</h4>
                    <div class="grid grid-4">
                        <div class="rr-stat">
                            <div class="rr-stat-label">Risk (pips)</div>
                            <div class="rr-stat-value" id="calc-risk-pips">--</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">Reward to TP1</div>
                            <div class="rr-stat-value" id="calc-reward-pips">--</div>
                        </div>
                        <div class="rr-stat highlight">
                            <div class="rr-stat-label">R:R to TP1</div>
                            <div class="rr-stat-value" id="calc-rr-tp1">--</div>
                        </div>
                        <div class="rr-stat">
                            <div class="rr-stat-label">R:R to TP2</div>
                            <div class="rr-stat-value" id="calc-rr-tp2">--</div>
                        </div>
                    </div>
                    
                    <div class="rr-verdict" id="rr-verdict">
                        <span class="rr-verdict-icon">&#x23F3;</span>
                        <span class="rr-verdict-text">Enter levels to calculate R:R</span>
                    </div>
                </div>
                
                <!-- Step 4: R:R Confirmation -->
                <div class="structure-step" id="structure-step-4">
                    <div class="structure-step-header">
                        <span class="structure-step-number">4</span>
                        <span class="structure-step-title">R:R Acceptable?</span>
                    </div>
                    <div class="structure-step-content">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="rr-acceptable" onchange="updateStructureAnalysis()">
                            <span class="checkbox-label">R:R is at least 1:1.5 to first target - this trade is worth taking</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Entry Strategy Section -->
            <div class="card mb-lg pretrade-gated" id="entry-strategy-card">
                <div class="card-header">
                    <h2 class="card-title">&#x26A1; How Will You Enter?</h2>
                </div>
                
                <!-- Entry Decision Panel - NEW -->
                <div style="padding: var(--spacing-md);">
                    <div class="entry-decision-panel" id="entry-decision-panel">
                        <div class="decision-header">
                            <span>&#x1F3AF;</span>
                            <span>Entry Decision Engine</span>
                        </div>
                        <div class="decision-context">
                            <div class="context-item">
                                <span class="context-label">Distance to S/R:</span>
                                <span class="context-value" id="distance-to-structure">-- pips</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Volatility:</span>
                                <span class="context-value" id="decision-volatility">--</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Session:</span>
                                <span class="context-value" id="decision-session">--</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Setup Grade:</span>
                                <span class="context-value" id="decision-grade">--</span>
                            </div>
                        </div>
                        <div class="decision-recommendation" id="entry-recommendation">
                            <div class="rec-type">RECOMMENDED: <strong id="rec-entry-type">--</strong></div>
                            <div class="rec-reason" id="rec-reason">Complete structure analysis first</div>
                        </div>
                        <div class="decision-warning" id="entry-decision-warning" style="display: none;">
                            <span>WARNING:</span>
                            <span id="entry-warning-text">Your selection differs from recommendation</span>
                        </div>
                    </div>
                </div>
                
                <!-- Kill Zone Indicator - NEW -->
                <div style="padding: 0 var(--spacing-md);">
                    <div class="kill-zone-indicator" id="kill-zone-indicator" style="display: none;">
                        <div class="kz-icon">&#x1F3AF;</div>
                        <div class="kz-content">
                            <div class="kz-name" id="kz-name">London Open</div>
                            <div class="kz-desc" id="kz-desc">High volatility breakout zone</div>
                            <div class="kz-pairs" id="kz-pairs">Optimal: EURUSD, GBPUSD</div>
                        </div>
                        <div class="kz-timer" id="kz-timer">-- min</div>
                    </div>
                </div>
                
                <!-- Entry Type Selection -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">Entry Type</label>
                    <div class="entry-type-selector">
                        <button type="button" class="entry-type-btn active" data-type="market" id="btn-market" onclick="selectEntryType('market')">
                            <span class="entry-icon">&#x1F3AF;</span>
                            <span class="entry-label">Market</span>
                        </button>
                        <button type="button" class="entry-type-btn" data-type="limit" id="btn-limit" onclick="selectEntryType('limit')">
                            <span class="entry-icon">&#x1F4CD;</span>
                            <span class="entry-label">Limit</span>
                        </button>
                        <button type="button" class="entry-type-btn" data-type="scale" id="btn-scale" onclick="selectEntryType('scale')">
                            <span class="entry-icon">&#x1F4CA;</span>
                            <span class="entry-label">Scale-In</span>
                        </button>
                    </div>
                    
                    <!-- Limit Order Details (hidden by default) -->
                    <div id="limit-order-details" class="entry-details">
                        <div class="limit-order-details">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--accent-tertiary);">&#x1F4CD; Limit Order Setup</h4>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                <div class="form-group">
                                    <label class="form-label">Limit Price</label>
                                    <input type="number" id="limit-entry-price" class="form-input" step="0.00001" placeholder="1.08500" oninput="updateLimitOrderCalcs()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Distance from Current (pips)</label>
                                    <input type="text" id="limit-distance" class="form-input" readonly placeholder="--">
                                </div>
                            </div>
                            <!-- Limit Validation - NEW -->
                            <div class="limit-validation" id="limit-validation" style="display: none;">
                                <span id="limit-val-icon">OK -</span>
                                <span id="limit-val-text">Limit at structure level</span>
                            </div>
                            <button type="button" class="btn-use-structure" onclick="useStructureForLimit()">
                                &#x1F4CD; Use Structure Level
                            </button>
                            <div class="time-warning" id="limit-expiry-note" style="margin-top: var(--spacing-sm);">
                                <span>Time: </span>
                                <span>Limit orders: max 24h expiry. Cancel if setup invalidates.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scale-In Details (hidden by default) -->
                    <div id="scale-in-details" class="entry-details">
                        <div class="scale-in-details">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--accent-tertiary);">&#x1F4CA; Scale-In Protocol (A+ Setups Only)</h4>
                            
                            <!-- Scale-In Grade Check - NEW -->
                            <div class="scale-grade-check" id="scale-grade-check">
                                <span id="scale-grade-icon">&#x23F3;</span>
                                <span id="scale-grade-text">Enter UTCC score to verify eligibility</span>
                            </div>
                            
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: var(--spacing-md);">
                                Entry 1: First structure test (50%) &#x2192; Entry 2: Deeper structure OR confirmation (50%)
                            </p>
                            <div class="scale-level">
                                <span class="scale-level-number">1</span>
                                <input type="number" id="scale-price-1" class="form-input" step="0.00001" placeholder="First structure level" oninput="updateScaleCalcs()">
                                <input type="number" id="scale-percent-1" class="form-input scale-percent" value="50" min="10" max="90" oninput="updateScaleCalcs()">
                                <span style="font-size: 0.8rem;">%</span>
                            </div>
                            <div class="scale-level">
                                <span class="scale-level-number">2</span>
                                <input type="number" id="scale-price-2" class="form-input" step="0.00001" placeholder="Deeper structure level" oninput="updateScaleCalcs()">
                                <input type="number" id="scale-percent-2" class="form-input scale-percent" value="50" min="10" max="90" oninput="updateScaleCalcs()">
                                <span style="font-size: 0.8rem;">%</span>
                            </div>
                            <div id="scale-validation" style="margin-top: var(--spacing-sm); font-size: 0.8rem;"></div>
                            
                            <!-- Scale Calculations - NEW -->
                            <div class="scale-calculations" id="scale-calculations" style="display: none;">
                                <div class="scale-calc-row">
                                    <span class="label">Average Entry:</span>
                                    <span class="value" id="scale-avg-entry">--</span>
                                </div>
                                <div class="scale-calc-row">
                                    <span class="label">Combined R:R:</span>
                                    <span class="value" id="scale-combined-rr">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Session Timing -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Session Timing (AEST)</label>
                    <div class="session-timing">
                        <div class="session-box" id="session-tokyo">
                            <div class="session-name">&#x1F1EF;&#x1F1F5; Tokyo</div>
                            <div class="session-time">09:00 - 18:00</div>
                            <div class="session-status" id="tokyo-status">--</div>
                        </div>
                        <div class="session-box" id="session-london">
                            <div class="session-name">&#x1F1EC;&#x1F1E7; London</div>
                            <div class="session-time">17:00 - 02:00</div>
                            <div class="session-status" id="london-status">--</div>
                        </div>
                        <div class="session-box" id="session-newyork">
                            <div class="session-name">&#x1F1FA;&#x1F1F8; New York</div>
                            <div class="session-time">22:00 - 07:00</div>
                            <div class="session-status" id="newyork-status">--</div>
                        </div>
                    </div>
                    <div id="session-warning" class="time-warning" style="display: none;">
                        <span>WARNING:</span>
                        <span id="session-warning-text">Low liquidity period - consider waiting for session open</span>
                    </div>
                </div>
                
                <!-- Entry Timing Considerations -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Timing Considerations</label>
                    <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="timing-not-news" onchange="updateEntryConfirmation(); checkNewsBuffer();">
                            <span class="checkbox-label">Not entering within 30min of major news</span>
                        </label>
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="timing-session-appropriate" onchange="updateEntryConfirmation()">
                            <span class="checkbox-label">Session liquidity appropriate for this pair</span>
                        </label>
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="timing-not-friday-close" onchange="updateEntryConfirmation()">
                            <span class="checkbox-label">Not entering within 4hrs of Friday close</span>
                        </label>
                    </div>
                    
                    <!-- Enhanced News Buffer Warning -->
                    <div class="news-buffer-warning" id="news-buffer-warning">
                        <div class="news-buffer-title">
                            <span>WARNING:</span>
                            <span id="news-buffer-title-text">High Impact News Warning</span>
                        </div>
                        <div class="news-buffer-content" id="news-buffer-content">
                            <!-- Populated by JS -->
                        </div>
                        <div class="news-buffer-recommendation" id="news-buffer-recommendation">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- News Buffer Check Button -->
                    <div style="margin-top: var(--spacing-sm);">
                        <button class="btn btn-secondary btn-sm" onclick="manualNewsBufferCheck()">
                            &#x1F4C5; Check News for Selected Pair
                        </button>
                        <a href="https://www.forexfactory.com/calendar" target="_blank" class="btn btn-secondary btn-sm" style="margin-left: var(--spacing-sm); text-decoration: none;">
                            &#x1F4C6; Full Calendar
                        </a>
                    </div>
                </div>
                
                <!-- Entry Confirmation Summary -->
                <div class="entry-confirmation" style="padding: var(--spacing-md);">
                    <div id="entry-strategy-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem;">
                        <span id="entry-strategy-icon">&#x23F3;</span>
                        <span id="entry-strategy-text">Complete entry strategy setup</span>
                    </div>
                </div>
            </div>
            
            <!-- Stop Loss Strategy Section -->
            <div class="card mb-lg pretrade-gated" id="sl-strategy-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F6D1; Where Is Your Stop?</h2>
                </div>
                
                <!-- ATR-Based Calculator -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">ATR-Based Stop Loss Calculator</label>
                    <div class="atr-calculator">
                        <div class="atr-input-group">
                            <label class="form-label" style="font-size: 0.75rem;">Current ATR (from UTCC)</label>
                            <input type="number" id="sl-atr-value" class="form-input" step="0.0001" placeholder="0.0085" oninput="calculateATRStop()">
                        </div>
                        <div class="atr-input-group">
                            <label class="form-label" style="font-size: 0.75rem;">ATR Multiplier</label>
                            <input type="number" id="sl-atr-multiplier" class="form-input" step="0.1" value="1.5" min="0.5" max="3" oninput="calculateATRStop()">
                        </div>
                        <div class="atr-result">
                            <div class="atr-result-value" id="atr-sl-pips">--</div>
                            <div class="atr-result-label">Suggested SL (pips)</div>
                        </div>
                        <div class="atr-result">
                            <div class="atr-result-value" id="atr-sl-price">--</div>
                            <div class="atr-result-label">SL Price Level</div>
                        </div>
                    </div>
                </div>
                
                <!-- Volatility State Guide -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Volatility State (from UTCC)</label>
                    <div class="volatility-guide">
                        <div class="volatility-option" data-vol="quiet" onclick="selectVolatility('quiet')">
                            <div class="vol-name">&#x1F634; QUIET</div>
                            <div class="vol-multiplier">0.75 - 1x ATR</div>
                        </div>
                        <div class="volatility-option selected" data-vol="trend" onclick="selectVolatility('trend')">
                            <div class="vol-name">&#x1F4C8; TREND</div>
                            <div class="vol-multiplier">1 - 1.5x ATR</div>
                        </div>
                        <div class="volatility-option" data-vol="explode" onclick="selectVolatility('explode')">
                            <div class="vol-name">&#x1F4A5; EXPLODE</div>
                            <div class="vol-multiplier">1.5 - 2x ATR</div>
                        </div>
                    </div>
                    <div id="volatility-advice" style="font-size: 0.8rem; color: var(--text-muted); padding: var(--spacing-sm); background: var(--bg-tertiary); border-radius: var(--radius-sm);">
                        &#x1F4CA; TREND conditions: Standard stop distance. Use 1-1.5x ATR for balanced risk.
                    </div>
                </div>
                
                <!-- SL Confirmation -->
                <div style="padding: var(--spacing-md); border-top: 1px solid var(--border-primary);">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="sl-strategy-confirmed" onchange="updateSLStrategyStatus()">
                        <span class="checkbox-label">Stop loss is placed beyond structure with appropriate buffer for volatility</span>
                    </label>
                    <div id="sl-strategy-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem; margin-top: var(--spacing-sm);">
                        <span id="sl-strategy-icon">&#x23F3;</span>
                        <span id="sl-strategy-text">Configure stop loss strategy</span>
                    </div>
                </div>
            </div>
            
            <!-- Exit Management Section -->
            <div class="card mb-lg pretrade-gated" id="exit-management-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Exit Management Plan</h2>
                </div>
                
                <!-- TP Levels with Partials -->
                <div style="padding: var(--spacing-md);">
                    <label class="form-label">Take Profit Levels & Partials</label>
                    <div class="tp-levels-grid">
                        <div class="tp-level-box tp1">
                            <div class="tp-level-header">
                                <span class="tp-level-title">TP1 - First Target</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="exit-tp1-percent" class="form-input tp-percent-input" value="50" min="25" max="75" oninput="updateExitPartials()">
                                    <span style="font-size: 0.8rem;">%</span>
                                </div>
                            </div>
                            <input type="number" id="exit-tp1-price" class="form-input" step="0.00001" placeholder="From Structure Analysis" oninput="updateExitPlan()">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                Close half position, move SL to breakeven
                            </div>
                        </div>
                        <div class="tp-level-box tp2">
                            <div class="tp-level-header">
                                <span class="tp-level-title">TP2 - Final Target</span>
                                <div style="display: flex; align-items: center; gap: 4px;">
                                    <input type="number" id="exit-tp2-percent" class="form-input tp-percent-input" value="50" min="25" max="75" readonly>
                                    <span style="font-size: 0.8rem;">%</span>
                                </div>
                            </div>
                            <input type="number" id="exit-tp2-price" class="form-input" step="0.00001" placeholder="From Structure Analysis" oninput="updateExitPlan()">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                                Let runner ride with trailing stop
                            </div>
                        </div>
                    </div>
                    <div id="partials-validation" style="font-size: 0.8rem; text-align: center;"></div>
                </div>
                
                <!-- Trail Stop Configuration -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Trailing Stop Strategy (after TP1)</label>
                    <div class="trail-stop-config">
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-breakeven" value="breakeven" checked onchange="updateTrailMethod()">
                            <label for="trail-breakeven">Move to Breakeven only</label>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-structure" value="structure" onchange="updateTrailMethod()">
                            <label for="trail-structure">Trail behind structure (swing points)</label>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-atr" value="atr" onchange="updateTrailMethod()">
                            <label for="trail-atr">ATR-based trail</label>
                            <input type="number" id="trail-atr-multiple" class="form-input" value="1.5" step="0.5" min="1" max="3" disabled>
                            <span style="font-size: 0.75rem;">x ATR</span>
                        </div>
                        <div class="trail-option">
                            <input type="radio" name="trail-method" id="trail-fixed" value="fixed" onchange="updateTrailMethod()">
                            <label for="trail-fixed">Fixed pips trail</label>
                            <input type="number" id="trail-fixed-pips" class="form-input" value="20" min="5" max="100" disabled>
                            <span style="font-size: 0.75rem;">pips</span>
                        </div>
                    </div>
                </div>
                
                <!-- Time Stop -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Time-Based Exit Rule</label>
                    <div class="time-stop-config">
                        <span>If no progress after</span>
                        <input type="number" id="time-stop-hours" class="form-input" style="width: 70px;" value="24" min="4" max="72">
                        <span>hours, review and consider closing</span>
                    </div>
                </div>
                
                <!-- Exit Rules Acknowledgment -->
                <div style="padding: 0 var(--spacing-md) var(--spacing-md);">
                    <label class="form-label">Exit Rules</label>
                    <div class="exit-rules-box">
                        <div class="exit-rule">
                            <span class="exit-rule-icon">1.</span>
                            <span>At TP1: Close partial, move SL to breakeven</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">2.</span>
                            <span>Opposite UTCC signal = immediate exit (don't wait for SL)</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">3.</span>
                            <span>Time stop triggered = reassess, don't hold dead trades</span>
                        </div>
                        <div class="exit-rule">
                            <span class="exit-rule-icon">4.</span>
                            <span>Never move SL against position (only to reduce risk)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Exit Plan Confirmation -->
                <div style="padding: var(--spacing-md); border-top: 1px solid var(--border-primary);">
                    <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                        <input type="checkbox" id="exit-plan-acknowledged" onchange="updateExitPlanStatus()">
                        <span class="checkbox-label">I have a clear exit plan with defined TP levels and trail strategy</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="exit-opposite-signal" onchange="updateExitPlanStatus()">
                        <span class="checkbox-label">Exit on opposite UTCC direction signal (trend reversal)</span>
                    </label>
                    <div id="exit-plan-summary" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 0.9rem; margin-top: var(--spacing-sm);">
                        <span id="exit-plan-icon">&#x23F3;</span>
                        <span id="exit-plan-text">Configure exit management plan</span>
                    </div>
                </div>
            </div>
            
            <!-- Correlation Check -->
            <div class="card mb-lg pretrade-gated" id="correlation-check-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F517; Correlation Check</h2>
                </div>
                
                <div id="correlation-status" class="correlation-status">
                    <div class="correlation-status-icon">&#x23F3;</div>
                    <div class="correlation-status-text">Select a pair to check correlation</div>
                </div>
                
                <!-- Correlation Block Warning (shows when correlated) -->
                <div id="correlation-block" style="display: none; padding: var(--spacing-md); background: rgba(239, 68, 68, 0.15); border: 2px solid var(--color-fail); border-radius: var(--radius-md); margin: var(--spacing-md);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <span style="font-size: 1.5rem;">&#x1F6AB;</span>
                        <strong style="color: var(--color-fail); font-size: 1.1rem;">TRADE BLOCKED - Correlated Exposure</strong>
                    </div>
                    <p id="correlation-block-reason" style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                        You have open positions in correlated pairs.
                    </p>
                    
                    <!-- Override Option -->
                    <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-sm);">
                        <label class="checkbox-wrapper" style="margin-bottom: var(--spacing-sm);">
                            <input type="checkbox" id="correlation-override" onchange="handleCorrelationOverride()">
                            <span class="checkbox-label"><strong>Override block</strong> - I understand and accept doubled currency exposure</span>
                        </label>
                        <div id="correlation-override-warning" style="display: none; font-size: 0.8rem; color: var(--color-warning); margin-top: var(--spacing-sm);">
                            WARNING: <strong>Half position size required!</strong> Reduce your position to 50% of normal to manage correlation risk.
                        </div>
                    </div>
                </div>
                
                <div class="correlation-groups-collapse" style="padding: var(--spacing-md);">
                    <button class="btn btn-sm btn-secondary" onclick="toggleCorrelationGroups()">Show Correlation Groups</button>
                    <div id="correlation-groups-content" style="display: none;">
                        <div class="correlation-groups mt-sm">
                            <div class="correlation-group"><strong>AUD:</strong> AUDUSD, AUDJPY, AUDNZD, AUDCAD, AUDCHF, EURAUD, GBPAUD</div>
                            <div class="correlation-group"><strong>EUR:</strong> EURUSD, EURJPY, EURGBP, EURAUD, EURCAD, EURNZD, EURCHF</div>
                            <div class="correlation-group"><strong>GBP:</strong> GBPUSD, GBPJPY, EURGBP, GBPAUD, GBPCAD, GBPCHF, GBPNZD</div>
                            <div class="correlation-group"><strong>JPY:</strong> USDJPY, EURJPY, GBPJPY, AUDJPY, NZDJPY, CADJPY, CHFJPY</div>
                            <div class="correlation-group"><strong>NZD:</strong> NZDUSD, NZDJPY, AUDNZD, NZDCAD, NZDCHF, EURNZD, GBPNZD</div>
                            <div class="correlation-group"><strong>CAD:</strong> USDCAD, CADJPY, AUDCAD, EURCAD, GBPCAD, NZDCAD, CADCHF</div>
                            <div class="correlation-group"><strong>CHF:</strong> USDCHF, CHFJPY, AUDCHF, EURCHF, GBPCHF, NZDCHF, CADCHF</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden checkbox for validation (auto-checked when clear or override accepted) -->
                <input type="checkbox" id="correlation-accepted" style="display: none;" onchange="updateValidationVerdict()">
            </div>
            
            <!-- Phase 4: Re-Entry Rules Check -->
            <div class="card mb-lg pretrade-gated" id="reentry-rules-card" style="display: none;">
                <div class="card-header" style="background: rgba(239, 68, 68, 0.1);">
                    <h2 class="card-title" style="color: var(--color-fail);">RE-ENTRY BLOCK</h2>
                </div>
                
                <div class="reentry-block-content" style="padding: var(--spacing-md);">
                    <div class="reentry-warning-box" style="background: rgba(239, 68, 68, 0.1); border: 2px solid var(--color-fail); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 1.5rem;">&#x1F6D1;</span>
                            <strong style="color: var(--color-fail); font-size: 1.1rem;">WAIT PERIOD ACTIVE</strong>
                        </div>
                        <p id="reentry-reason" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                            Recent stop loss hit on this pair. Re-entry rules apply.
                        </p>
                        <div id="reentry-timer" style="font-family: var(--font-heading); font-size: 1.2rem; color: var(--color-warning);">
                            Time remaining: --
                        </div>
                    </div>
                    
                    <div class="reentry-rules-list" style="background: var(--bg-tertiary); border-radius: var(--radius-md); padding: var(--spacing-md);">
                        <h4 style="margin-bottom: var(--spacing-sm);">Re-Entry Requirements:</h4>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-time">&#x2610;</span>
                            <span>4-hour minimum wait after stop loss</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-fresh">&#x2610;</span>
                            <span>Fresh setup (not same pattern)</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-score">&#x2610;</span>
                            <span id="reentry-score-req">Higher score than stopped trade (need: --)</span>
                        </div>
                        <div class="reentry-rule" style="display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-xs) 0;">
                            <span class="reentry-check" id="reentry-check-session">&#x2610;</span>
                            <span>Different session preferred</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: var(--spacing-md);">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="reentry-override" onchange="handleReentryOverride()">
                            <span class="checkbox-label"><strong>Override re-entry block</strong> - I confirm all re-entry requirements are met</span>
                        </label>
                    </div>
                </div>
                
                <input type="checkbox" id="reentry-accepted" style="display: none;" onchange="updateValidationVerdict()">
            </div>
            
            <!-- Final Confirmation -->
            <div class="card mb-lg pretrade-gated">
                <div class="card-header">
                    <h2 class="card-title">OK - Final Confirmation</h2>
                </div>
                
                <div class="final-checks">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="final-structure-supports" onchange="updateStructureAnalysis()">
                        <span class="checkbox-label"><strong>Structure supports this trade</strong> - I'm entering because the levels make sense, not because I want to be in a trade</span>
                    </label>
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="final-risk-sized" onchange="updateStructureAnalysis()">
                        <span class="checkbox-label"><strong>Position is properly sized</strong> - Risk is within my drawdown-adjusted limit</span>
                    </label>
                </div>
            </div>
            
            <!-- Validation Verdict -->
            <div class="card pretrade-gated">
                <div class="verdict-box" id="validation-verdict">
                    <div class="verdict-label">Trade Status</div>
                    <div class="verdict-status" id="verdict-status">INCOMPLETE</div>
                    <div class="text-muted mt-sm" style="font-size: 0.8rem;" id="verdict-reason">Complete structure analysis and confirmations</div>
                    
                    <!-- Phase 3: Trade Grade Display -->
                    <div class="trade-grade-display" id="trade-grade-display" style="display: none;">
                        <div class="grade-badge-container">
                            <div class="grade-badge" id="grade-badge">--</div>
                            <div class="grade-label-text">Setup Grade</div>
                        </div>
                        <div class="grade-details">
                            <div class="grade-breakdown" id="grade-breakdown"></div>
                        </div>
                        <div class="grade-position-rec" id="grade-position-rec">
                            <span class="rec-label">Recommended Position:</span>
                            <span class="rec-value" id="grade-position-value">--</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-lg mt-lg" style="width: 100%;" id="execute-trade-btn" disabled onclick="executeTradeFromValidation()">
                    EXECUTE TRADE
                </button>
            </div>
            
        </section>
        
        <section id="tab-journal" class="tab-content">
            
            <!-- v2.10.0: Edit Mode Banner (Bug Fix #6) -->
            <div id="edit-mode-banner" style="display:none; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(59,130,246,0.05)); border: 2px solid var(--color-info); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); position: relative;">
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.4rem; background: var(--color-info); color: #fff; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&#x270E;</span>
                        <div>
                            <div style="font-weight: 700; color: var(--color-info); font-size: 1rem;">EDITING TRADE</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);" id="edit-mode-detail">--</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="cancelEditMode()" style="white-space: nowrap;">&#x2715; Cancel Edit</button>
                </div>
            </div>
            
            <!-- Institutional Trade Journal -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4D3; Institutional Trade Journal</h2>
                    <button class="btn btn-secondary btn-sm" onclick="clearTradeForm()">&#x1F4CD; Clear Form</button>
                </div>
                
                <!-- SECTION A: Trade Metadata -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">A</span>
                        <span class="journal-section-title">Trade Metadata</span>
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-input" id="trade-datetime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Instrument</label>
                            <select class="form-select" id="trade-pair">
                                <option value="">Select Instrument</option>
                                <optgroup label="--- FOREX ---"></optgroup>
                                <optgroup label="Core Pairs">
                                    <option value="AUDUSD">AUDUSD</option>
                                    <option value="USDJPY">USDJPY</option>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                    <option value="EURJPY">EURJPY</option>
                                    <option value="GBPJPY">GBPJPY</option>
                                </optgroup>
                                <optgroup label="AUD Crosses">
                                    <option value="AUDCAD">AUDCAD</option>
                                    <option value="AUDCHF">AUDCHF</option>
                                    <option value="AUDJPY">AUDJPY</option>
                                    <option value="AUDNZD">AUDNZD</option>
                                </optgroup>
                                <optgroup label="EUR Crosses">
                                    <option value="EURAUD">EURAUD</option>
                                    <option value="EURCAD">EURCAD</option>
                                    <option value="EURGBP">EURGBP</option>
                                    <option value="EURNZD">EURNZD</option>
                                </optgroup>
                                <optgroup label="GBP Crosses">
                                    <option value="GBPAUD">GBPAUD</option>
                                    <option value="GBPCAD">GBPCAD</option>
                                    <option value="GBPCHF">GBPCHF</option>
                                    <option value="GBPNZD">GBPNZD</option>
                                </optgroup>
                                <optgroup label="JPY Crosses">
                                    <option value="CADJPY">CADJPY</option>
                                    <option value="CHFJPY">CHFJPY</option>
                                    <option value="NZDJPY">NZDJPY</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="NZDCAD">NZDCAD</option>
                                    <option value="NZDCHF">NZDCHF</option>
                                    <option value="NZDUSD">NZDUSD</option>
                                    <option value="USDCAD">USDCAD</option>
                                    <option value="USDCHF">USDCHF</option>
                                    <option value="CADCHF">CADCHF</option>
                                    <option value="EURCHF">EURCHF</option>
                                </optgroup>
                                <optgroup label="--- METALS ---"></optgroup>
                                <optgroup label="Precious Metals">
                                    <option value="XAUUSD">XAUUSD (Gold)</option>
                                    <option value="XAGUSD">XAGUSD (Silver)</option>
                                </optgroup>
                                <optgroup label="--- INDICES ---"></optgroup>
                                <optgroup label="US Indices">
                                    <option value="US30USD">US30USD (Dow)</option>
                                    <option value="SPX500USD">SPX500USD (S&P)</option>
                                    <option value="NAS100USD">NAS100USD (Nasdaq)</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Session
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which session are you trading?</strong><br><br>
                                        <strong>Tokyo (9am&ndash;5pm AEST):</strong> Your primary Asian session. JPY/AUD pairs most active. Moderate volatility.<br><br>
                                        <strong>London (5pm&ndash;10pm AEST):</strong> Your primary European session. EUR/GBP/CHF pairs most active. Highest liquidity.<br><br>
                                        <strong>New York:</strong> Prep only &mdash; outside your availability window. Mark levels, do not execute.<br><br>
                                        <strong>Overlap:</strong> Prep only &mdash; volatile, unpredictable. Observation and level marking.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-session">
                                <option value="">Select</option>
                                <option value="tokyo">Tokyo</option>
                                <option value="london">London</option>
                                <option value="newyork">New York</option>
                                <option value="overlap">London/NY Overlap</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trade Type
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which playbook are you executing?</strong> You must name this BEFORE seeing the alert.<br><br>
                                        <strong>Continuation:</strong> Trend in place; EMA ribbon pullback; enter on rejection/acceptance. Best in Expansion regime.<br><br>
                                        <strong>Pullback:</strong> Deep retracement to slow EMA or key swing level; wait for reclaim. Best in Expansion.<br><br>
                                        <strong>Range Expansion:</strong> Breakout from compression/range; requires confirmation (retest). Only in Contraction regime after proof.<br><br>
                                        <strong>Mean Reversion:</strong> Fade at defined range extremes only. Balanced regime only. Reduced size.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-type">
                                <option value="">Select</option>
                                <option value="continuation">Continuation</option>
                                <option value="pullback">Pullback</option>
                                <option value="range-expansion">Range Expansion</option>
                                <option value="mean-reversion">Mean Reversion</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">Direction</label>
                            <select class="form-select" id="trade-direction">
                                <option value="">Select</option>
                                <option value="long">LONG</option>
                                <option value="short">SHORT</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Alert Status
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>What was the UTCC alert state when you took this trade?</strong><br><br>
                                        <strong>READY:</strong> All 5 criteria met. Highest confidence. Full position.<br><br>
                                        <strong>STRONG:</strong> 4/5 criteria met. Good setup but one criterion missing. Reduced position.<br><br>
                                        <strong>WATCH:</strong> Developing setup. Criteria forming but not yet met. No execution.<br><br>
                                        <strong>MANUAL:</strong> Discretionary entry without UTCC confirmation. Should be rare.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-alert-type">
                                <option value="">Select</option>
                                <option value="TRADE_READY">READY (All 5 criteria)</option>
                                <option value="STRONG">STRONG (4/5 criteria)</option>
                                <option value="WATCH">WATCH (Developing)</option>
                                <option value="MANUAL">MANUAL (Discretionary)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Permission TF
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which timeframe granted permission?</strong><br><br>
                                        <strong>4H:</strong> Primary permission timeframe. Gives directional bias. Standard for swing entries.<br><br>
                                        <strong>1H:</strong> Secondary. Used when 4H is already aligned and 1H provides the ARMED signal.<br><br>
                                        <strong>Daily:</strong> Context timeframe only. Rarely the direct permission source; confirms higher structure.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-permission-tf">
                                <option value="">Select</option>
                                <option value="4H">4H</option>
                                <option value="1H">1H</option>
                                <option value="Daily">Daily</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Execution TF
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Which timeframe are you entering on?</strong><br><br>
                                        <strong>1H:</strong> Standard execution timeframe. Best for swing entries with clear structure.<br><br>
                                        <strong>15m:</strong> Tight entry refinement. Use when 1H structure is confirmed and you want a tighter stop.<br><br>
                                        <strong>5m:</strong> Scalp precision. Rarely used; only for very tight risk entries. Higher noise.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-execution-tf">
                                <option value="">Select</option>
                                <option value="1H">1H</option>
                                <option value="15m">15m</option>
                                <option value="5m">5m</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION B: Permission Log (AUTO-POPULATED from Pre-Trade) -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">B</span>
                        <span class="journal-section-title">Permission Log</span>
                        <span class="journal-section-badge" style="background: var(--color-info); color: #fff;">Auto</span>
                    </div>
                    
                    <div id="permission-log-readonly" class="permission-log-grid" style="opacity: 0.85;">
                        <div class="permission-log-row">
                            <span class="permission-log-label">Market Regime</span>
                            <span class="permission-log-value" id="perm-display-regime">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Structure Quality</span>
                            <span class="permission-log-value" id="perm-display-structure">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Volatility Context</span>
                            <span class="permission-log-value" id="perm-display-vol">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Session Window</span>
                            <span class="permission-log-value" id="perm-display-session">--</span>
                        </div>
                        <div class="permission-log-row highlight">
                            <span class="permission-log-label">Permission State</span>
                            <span class="permission-log-value" id="perm-display-state">--</span>
                        </div>
                        <div class="permission-log-row">
                            <span class="permission-log-label">Reason</span>
                            <span class="permission-log-value" id="perm-display-reason" style="font-size:0.75rem;">--</span>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; text-align: center;">
                        &#x2139; Auto-populated from Pre-Trade validation. Edit in Pre-Trade tab.
                    </div>

                    <!-- Hidden fields to preserve data in collectTradeFormData -->
                    <input type="hidden" id="trade-market-regime" value="">
                    <input type="hidden" id="trade-structure-quality" value="">
                    <input type="hidden" id="trade-vol-context" value="">
                    <input type="hidden" id="trade-session-window" value="">
                    <input type="hidden" id="trade-permission-state" value="">
                    <input type="hidden" id="trade-permission-reason" value="">
                    <input type="hidden" id="trade-permission-evidence" value="">
                </div>
                
                                <!-- SECTION C: Execution Quality -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">C</span>
                        <span class="journal-section-title">Execution Quality</span>
                    </div>
                    
                    <div class="execution-checklist">
                        <label class="execution-check">
                            <input type="checkbox" id="exec-type-declared">
                            <span>Trade type declared pre-entry
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You named your playbook (Continuation, Pullback, etc.) <strong>before</strong> seeing the chart or alert. If you decided the type after the alert, uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-single-trigger">
                            <span>Single execution trigger used
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You used exactly <strong>one</strong> trigger to enter (e.g. BOS, rejection candle, reclaim). No freestyle entries or combining multiple conflicting triggers.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-planned-price">
                            <span>Entry at planned price
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Your actual entry was at or near the price you planned. If you chased or entered impulsively at a worse price, uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-stop-invalidation">
                            <span>Stop placed at invalidation
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Your stop is at the level where your <strong>trade thesis is wrong</strong> &mdash; not an arbitrary ATR distance. The stop should make structural sense.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="execution-check">
                            <input type="checkbox" id="exec-spread-ok">
                            <span>Spread acceptable
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        Spread was within normal range for this pair and session. If spread was abnormally wide (news, dead zone, illiquid hours), uncheck this.
                                    </span>
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="form-group mt-md">
                        <label class="form-label">Entry Trigger Description</label>
                        <input type="text" class="form-input" id="trade-entry-trigger" placeholder="e.g. 1H BOS in direction of 4H, rejection at key level...">
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">Entry Price</label>
                            <input type="number" class="form-input" id="trade-entry" step="0.00001" placeholder="1.23456">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stop Loss</label>
                            <input type="number" class="form-input" id="trade-stop" step="0.00001" placeholder="1.23000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Take Profit</label>
                            <input type="number" class="form-input" id="trade-tp" step="0.00001" placeholder="1.24000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Exit Price</label>
                            <input type="number" class="form-input" id="trade-exit" step="0.00001" placeholder="Leave blank if open">
                        </div>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Position Size (Units)</label>
                            <input type="number" class="form-input" id="trade-units" placeholder="e.g. 15000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risk Amount (AUD)</label>
                            <input type="number" class="form-input" id="trade-risk-amount" step="0.01" placeholder="e.g. 30.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Risk %
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Position risk as percentage of account.</strong> Must match your permission state and drawdown level.<br><br>
                                        <strong>0.25%:</strong> Override trades only. Maximum risk when trading against a block.<br><br>
                                        <strong>0.5%:</strong> Conditional permission or drawdown caution (-3% to -5%). Reduced conviction.<br><br>
                                        <strong>1%:</strong> Conservative normal. Use during early system adoption or minor drawdown.<br><br>
                                        <strong>1.5%:</strong> Standard risk. FULL permission + clean structure + entry window.<br><br>
                                        <strong>2%:</strong> Maximum allowed. Only with FULL permission, HOT zone, perfect conditions. Absolute ceiling &mdash; never exceed.
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-risk-pct">
                                <option value="0.25">0.25% (Override)</option>
                                <option value="0.5">0.5%</option>
                                <option value="1">1%</option>
                                <option value="1.5" selected>1.5%</option>
                                <option value="2">2%</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION D: Management Discipline -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">D</span>
                        <span class="journal-section-title">Management Discipline</span>
                    </div>
                    
                    <div class="management-checklist">
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-no-early-stop">
                            <span>No early stop movement
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You did <strong>not</strong> widen your stop after entry. Stops only move to breakeven or tighter &mdash; never further from entry. Widening is a discipline failure.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-partial-rules">
                            <span>Partial rules followed
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You followed your partial take-profit rules: close 50% at TP1 (1R), move stop to breakeven, let remainder run. No improvising.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-exit-rules">
                            <span>Exit rules respected
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        You exited because <strong>the reason changed</strong> (structure break, opposite signal, news, time stop) &mdash; not because of fear or hope. Emotional exits = uncheck.
                                    </span>
                                </span>
                            </span>
                        </label>
                        <label class="management-check">
                            <input type="checkbox" id="mgmt-no-revenge">
                            <span>No revenge management
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        After a loss, you did <strong>not</strong> re-enter the same pair, increase size, or lower your standards to &ldquo;make it back&rdquo;. 48h cooldown respected.
                                    </span>
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Exit Reason
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Why did this trade close?</strong><br><br>
                                        <strong>TP Hit:</strong> Price reached your take-profit level. System worked.<br>
                                        <strong>SL Hit:</strong> Price reached invalidation. Accept -1R as cost of business.<br>
                                        <strong>Manual Win/Loss:</strong> You closed before TP/SL. Must have a structural reason.<br>
                                        <strong>Breakeven:</strong> Neutral &mdash; does NOT reset loss streaks or failure counters.<br>
                                        <strong>News Event:</strong> Closed to avoid high-impact news. Defensive; valid.<br>
                                        <strong>Time Stop:</strong> Trade went nowhere within time limit (24&ndash;48h for 1H, 3&ndash;5 days for 4H).
                                    </span>
                                </span>
                            </label>
                            <select class="form-select" id="trade-exit-reason">
                                <option value="">Select (if closed)</option>
                                <option value="TP_HIT">TP Hit</option>
                                <option value="SL_HIT">SL Hit</option>
                                <option value="MANUAL_WIN">Manual Close - Win</option>
                                <option value="MANUAL_LOSS">Manual Close - Loss</option>
                                <option value="BREAKEVEN">Breakeven</option>
                                <option value="PARTIAL">Partial Close</option>
                                <option value="NEWS">News Event</option>
                                <option value="TIME_STOP">Time Stop</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Trade Status</label>
                            <select class="form-select" id="trade-status">
                                <option value="open">Open</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Slippage (pips)</label>
                            <input type="number" class="form-input" id="trade-slippage" step="0.1" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <!-- SECTION E: Outcome Metrics -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">E</span>
                        <span class="journal-section-title">Outcome Metrics</span>
                        <span class="journal-section-badge secondary">Secondary</span>
                    </div>
                    
                    <div class="grid grid-4">
                        <div class="form-group">
                            <label class="form-label">R-Multiple</label>
                            <input type="number" class="form-input" id="trade-r-display" step="0.01" readonly placeholder="Auto-calculated">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MAE (pips)
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Max Adverse Excursion:</strong> How many pips did price go AGAINST you before the trade ended?<br><br>
                                        If this is often close to your stop loss, your stops might be too tight.
                                    </span>
                                </span>
                            </label>
                            <input type="number" class="form-input" id="trade-mae" step="0.1" placeholder="e.g. 15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MFE (pips)
                                <span class="regime-tooltip">&#x2139;
                                    <span class="regime-tooltip-content">
                                        <strong>Max Favourable Excursion:</strong> How many pips did price go IN YOUR FAVOUR before the trade ended?<br><br>
                                        If this is much bigger than your actual profit, you might be exiting too early.
                                    </span>
                                </span>
                            </label>
                            <input type="number" class="form-input" id="trade-mfe" step="0.1" placeholder="e.g. 45">
                        </div>
                        <div class="form-group">
                            <label class="form-label">UTCC Score</label>
                            <input type="number" class="form-input" id="trade-trend-score" min="0" max="100" placeholder="0-100">
                        </div>
                    </div>
                </div>
                
                <!-- SECTION F: Post-Trade Review -->
                <div class="journal-section">
                    <div class="journal-section-header">
                        <span class="journal-section-letter">F</span>
                        <span class="journal-section-title">Post-Trade Review</span>
                        <span class="journal-section-badge edge">Edge-Focused</span>
                    </div>
                    
                    <div class="review-question">
                        <p class="review-question-text">Did I lose money because the model failed, or because I failed the model?</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Trade Classification</label>
                        <select class="form-select" id="trade-classification">
                            <option value="">Select classification</option>
                            <option value="model-win">Model Win - System worked as designed</option>
                            <option value="model-loss">Model Loss - Valid setup, market moved against</option>
                            <option value="execution-error">Execution Error - Good setup, poor execution</option>
                            <option value="permission-violation">Permission Violation - Should not have traded</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Setup Notes</label>
                        <textarea class="form-textarea" id="trade-notes" placeholder="Why did you take this trade? What was the setup rationale?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lessons / Edge Refinement</label>
                        <textarea class="form-textarea" id="trade-lessons" placeholder="What did you learn? How does this refine your edge?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Screenshot Link</label>
                        <input type="url" class="form-input" id="trade-screenshot" placeholder="https://...">
                    </div>
                </div>
                
                <!-- Hidden fields for backwards compatibility -->
                <!-- alert type moved to Section A dropdown -->
                <input type="hidden" id="trade-entry-zone" value="">
                <input type="hidden" id="trade-vol-state" value="">
                <input type="hidden" id="trade-mtf" value="">
                <input type="hidden" id="trade-grade" value="">
                
                <button class="btn btn-primary btn-lg mt-md" style="width: 100%;" onclick="saveTrade()">
                    &#x1F4BE; Save Trade
                </button>
            </div>
            
            <!-- Friday Close Warning Banner -->
            <div class="friday-warning-banner" id="friday-warning-banner" style="display: none;">
                <div class="friday-warning-content">
                    <span class="friday-warning-icon">WARNING:</span>
                    <div class="friday-warning-text">
                        <strong>FRIDAY CLOSE WARNING</strong>
                        <span>Review all open positions before weekend. Holding over weekend = increased gap risk.</span>
                    </div>
                    <div class="friday-warning-actions">
                        <button class="btn btn-warning btn-sm" onclick="reviewAllOpenTrades()">Review All</button>
                        <button class="btn btn-secondary btn-sm" onclick="dismissFridayWarning()">Dismiss</button>
                    </div>
                </div>
            </div>
            
            <!-- Active Trade Management Panel -->
            <div class="card mb-lg" id="active-trade-management">
                <div class="card-header">
                    <h2 class="card-title">&#x1F3AF; Active Trade Management</h2>
                    <div class="flex gap-sm align-center">
                        <span class="badge badge-info" id="open-positions-count">0 Open</span>
                        <button class="btn btn-secondary btn-sm" onclick="refreshTradeAges()">&#x1F504; Refresh</button>
                    </div>
                </div>
                
                <!-- Exit Protocol Status Summary -->
                <div class="exit-protocol-summary" id="exit-protocol-summary">
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-awaiting-tp1">0</span>
                        <span class="protocol-stat-label">Awaiting TP1</span>
                    </div>
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-at-breakeven">0</span>
                        <span class="protocol-stat-label">At Breakeven</span>
                    </div>
                    <div class="protocol-stat">
                        <span class="protocol-stat-value" id="trades-trailing">0</span>
                        <span class="protocol-stat-label">Trailing</span>
                    </div>
                    <div class="protocol-stat protocol-stat-warning" id="trades-needing-review-stat">
                        <span class="protocol-stat-value" id="trades-needing-review">0</span>
                        <span class="protocol-stat-label">Need Review</span>
                    </div>
                </div>
                
                <!-- Active Trades List -->
                <div class="active-trades-list" id="active-trades-list">
                    <div class="no-trades-message" id="no-active-trades">
                        <span class="no-trades-icon">&#x1F4CD;</span>
                        <span>No active trades</span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions-bar" id="quick-actions-bar" style="display: none;">
                    <span class="quick-actions-label">Quick Actions:</span>
                    <button class="btn btn-secondary btn-sm" onclick="moveAllToBE()">Move All to BE</button>
                    <button class="btn btn-warning btn-sm" onclick="closeAllAtMarket()">Close All @ Market</button>
                </div>
            </div>
            
            <!-- v2.12.0: No-Trade Journal (Market Review) -->
            <div class="card mb-lg" id="no-trade-journal-card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F6E1; Market Review (No-Trade Log)</h2>
                    <span class="badge" id="no-trade-count-badge" style="font-size:0.7rem;">0 reviews</span>
                </div>
                
                <!-- Quick Entry Form -->
                <div style="border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); background: var(--bg-elevated);">
                    <div style="font-weight:600; font-size:0.85rem; margin-bottom: var(--spacing-sm); color: var(--color-pass);">&#x2714; Log a Discipline Pass</div>
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label class="form-label">Session</label>
                            <select class="form-select" id="nt-session">
                                <option value="tokyo">Tokyo</option>
                                <option value="london">London</option>
                                <option value="new_york">New York</option>
                                <option value="pre_market">Pre-Market Scan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Reason No Trade</label>
                            <select class="form-select" id="nt-reason">
                                <option value="no_setup">No Valid Setup</option>
                                <option value="failed_utcc">Failed UTCC Criteria</option>
                                <option value="wrong_session">Wrong Session Window</option>
                                <option value="atr_exhausted">ATR Exhausted</option>
                                <option value="correlation_block">Correlation Block</option>
                                <option value="news_risk">High-Impact News Risk</option>
                                <option value="drawdown_limit">Drawdown Limit Active</option>
                                <option value="discipline_pass">Discipline Pass (tempted but passed)</option>
                                <option value="weekend_close">Weekend/Session Close</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pairs Reviewed</label>
                            <input type="text" class="form-input" id="nt-pairs" placeholder="e.g. AUDUSD, USDJPY, EURUSD">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <input type="text" class="form-input" id="nt-notes" placeholder="What did you observe? Any temptations resisted?">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="saveNoTrade()">&#x1F6E1; Log Review</button>
                </div>
                
                <!-- Recent No-Trade Log -->
                <div id="no-trade-log">
                    <div class="no-trade-log-header">
                        <span style="font-size:0.8rem; font-weight:600;">Recent Reviews</span>
                        <span class="count-badge" id="no-trade-week-count">This week: 0</span>
                    </div>
                    <div id="no-trade-log-entries">
                        <div style="text-align:center; padding: var(--spacing-md); color: var(--text-muted); font-size: 0.8rem;">No reviews logged yet. Passing on bad setups is discipline.</div>
                    </div>
                </div>
            </div>
            
            <!-- Trade History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Trade History</h2>
                    <div class="flex gap-sm">
                        <button class="btn btn-sm" style="background:#6b7280;color:#fff;" onclick="bulkDismissTrades()" id="bulk-dismiss-btn" title="Dismiss all ungraded trades as test/legacy">&#x1F5D1; Dismiss Ungraded</button>
                        <button class="btn btn-secondary btn-sm" onclick="exportTrades()">&#x1F4E4; Export CSV</button>
                        <button class="btn btn-danger btn-sm" onclick="clearAllTrades()">&#x1F5D1; Clear All</button>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex gap-md mb-md" style="flex-wrap: wrap;">
                    <select class="form-select" id="filter-pair" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Instruments</option>
                        <optgroup label="Forex - Core">
                            <option value="AUDUSD">AUDUSD</option>
                            <option value="USDJPY">USDJPY</option>
                            <option value="EURUSD">EURUSD</option>
                            <option value="GBPUSD">GBPUSD</option>
                            <option value="EURJPY">EURJPY</option>
                            <option value="GBPJPY">GBPJPY</option>
                        </optgroup>
                        <optgroup label="Forex - Crosses">
                            <option value="AUDCAD">AUDCAD</option>
                            <option value="AUDCHF">AUDCHF</option>
                            <option value="AUDJPY">AUDJPY</option>
                            <option value="AUDNZD">AUDNZD</option>
                            <option value="EURAUD">EURAUD</option>
                            <option value="EURCAD">EURCAD</option>
                            <option value="EURGBP">EURGBP</option>
                            <option value="EURNZD">EURNZD</option>
                            <option value="GBPAUD">GBPAUD</option>
                            <option value="GBPCAD">GBPCAD</option>
                            <option value="GBPCHF">GBPCHF</option>
                            <option value="GBPNZD">GBPNZD</option>
                            <option value="CADJPY">CADJPY</option>
                            <option value="CHFJPY">CHFJPY</option>
                            <option value="NZDJPY">NZDJPY</option>
                            <option value="NZDCAD">NZDCAD</option>
                            <option value="NZDCHF">NZDCHF</option>
                            <option value="NZDUSD">NZDUSD</option>
                            <option value="USDCAD">USDCAD</option>
                            <option value="USDCHF">USDCHF</option>
                            <option value="CADCHF">CADCHF</option>
                            <option value="EURCHF">EURCHF</option>
                        </optgroup>
                        <optgroup label="Metals">
                            <option value="XAUUSD">XAUUSD</option>
                            <option value="XAGUSD">XAGUSD</option>
                            <option value="XPTUSD">XPTUSD</option>
                            <option value="XCUUSD">XCUUSD</option>
                        </optgroup>
                        <optgroup label="Energy">
                            <option value="WTICOUSD">WTICOUSD</option>
                            <option value="BCOUSD">BCOUSD</option>
                            <option value="NATGASUSD">NATGASUSD</option>
                        </optgroup>
                        <optgroup label="Indices - US">
                            <option value="US30USD">US30USD</option>
                            <option value="SPX500USD">SPX500USD</option>
                            <option value="NAS100USD">NAS100USD</option>
                            <option value="US2000USD">US2000USD</option>
                        </optgroup>
                        <optgroup label="Indices - Europe">
                            <option value="DE30EUR">DE30EUR</option>
                            <option value="UK100GBP">UK100GBP</option>
                            <option value="FR40EUR">FR40EUR</option>
                            <option value="EU50EUR">EU50EUR</option>
                        </optgroup>
                        <optgroup label="Indices - Asia">
                            <option value="JP225USD">JP225USD</option>
                            <option value="JP225YJPY">JP225YJPY</option>
                            <option value="HK33HKD">HK33HKD</option>
                            <option value="CN50USD">CN50USD</option>
                            <option value="AU200AUD">AU200AUD</option>
                        </optgroup>
                        <optgroup label="Bonds">
                            <option value="USB02YUSD">USB02YUSD</option>
                            <option value="USB05YUSD">USB05YUSD</option>
                            <option value="USB10YUSD">USB10YUSD</option>
                            <option value="USB30YUSD">USB30YUSD</option>
                            <option value="UK10YBGBP">UK10YBGBP</option>
                            <option value="DE10YBEUR">DE10YBEUR</option>
                        </optgroup>
                        <optgroup label="Crypto">
                            <option value="BTCUSD">BTCUSD</option>
                            <option value="MBTCUSD">MBTCUSD</option>
                            <option value="ETHUSD">ETHUSD</option>
                            <option value="LTCUSD">LTCUSD</option>
                            <option value="BCHUSD">BCHUSD</option>
                        </optgroup>
                    </select>
                    <select class="form-select" id="filter-alert" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Alerts</option>
                        <option value="TRADE_READY">B+</option>
                        <option value="STRONG_BULL">A BULL</option>
                        <option value="STRONG_BEAR">A BEAR</option>
                        <option value="PERFECT_BULL">A+ BULL</option>
                        <option value="PERFECT_BEAR">A+ BEAR</option>
                        <option value="MANUAL">MANUAL</option>
                    </select>
                    <select class="form-select" id="filter-grade" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Grades</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="DIS">Dismissed</option>
                        <option value="none">No Grade</option>
                    </select>
                    <select class="form-select" id="filter-result" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Results</option>
                        <option value="win">Winners</option>
                        <option value="loss">Losers</option>
                        <option value="breakeven">Breakeven</option>
                    </select>
                    <select class="form-select" id="filter-source" style="width: auto;" onchange="filterTrades()">
                        <option value="">All Sources</option>
                        <option value="auto">Auto-Captured</option>
                        <option value="manual">Manual Entry</option>
                    </select>
                </div>
                
                <div class="table-wrapper">
                    <table class="table" id="trade-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Pair</th>
                                <th>Dir</th>
                                <th>Source</th>
                                <th>Alert</th>
                                <th>Grade</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>R-Multiple</th>
                                <th>Score</th>
                                <th>Zone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trade-history-body">
                            <tr>
                                <td colspan="12" class="text-center text-muted">No trades recorded yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination placeholder -->
                <div class="flex justify-between items-center mt-md">
                    <span class="text-muted" id="trade-count">0 trades</span>
                    <div class="flex gap-sm">
                        <button class="btn btn-secondary btn-sm" id="prev-page" disabled> Prev</button>
                        <button class="btn btn-secondary btn-sm" id="next-page" disabled>Next &#x2192;</button>
                    </div>
                </div>
            </div>
            
        </section>
        
        <section id="tab-performance" class="tab-content">
            
            <!-- Overall Stats -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Overall Performance</h2>
                    <select class="form-select" id="perf-period" style="width: auto;" onchange="updatePerformanceStats()">
                        <option value="all">All Time</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
                
                <div class="grid grid-4">
                    <div class="stat-box">
                        <div class="stat-value" id="perf-total-trades">0</div>
                        <div class="stat-label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-win-rate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-avg-r">0.0R</div>
                        <div class="stat-label">Avg R-Multiple</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-expectancy">0.0R</div>
                        <div class="stat-label">Expectancy</div>
                    </div>
                </div>
                
                <div class="grid grid-4 mt-md">
                    <div class="stat-box">
                        <div class="stat-value" id="perf-profit-factor">0.0</div>
                        <div class="stat-label">Profit Factor</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value positive" id="perf-largest-win">0R</div>
                        <div class="stat-label">Largest Win</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value negative" id="perf-largest-loss">0R</div>
                        <div class="stat-label">Largest Loss</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="perf-avg-winner">0R</div>
                        <div class="stat-label">Avg Winner</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance by Session -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Session</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Session</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Best</th>
                                <th>Worst</th>
                            </tr>
                        </thead>
                        <tbody id="session-stats-body">
                            <tr>
                                <td><span class="badge badge-info">Asian</span></td>
                                <td id="sess-asian-trades">0</td>
                                <td id="sess-asian-wr">0%</td>
                                <td id="sess-asian-avg">0R</td>
                                <td id="sess-asian-total">0R</td>
                                <td id="sess-asian-best" class="text-pass">0R</td>
                                <td id="sess-asian-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-warning">London</span></td>
                                <td id="sess-london-trades">0</td>
                                <td id="sess-london-wr">0%</td>
                                <td id="sess-london-avg">0R</td>
                                <td id="sess-london-total">0R</td>
                                <td id="sess-london-best" class="text-pass">0R</td>
                                <td id="sess-london-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-pass">NY</span></td>
                                <td id="sess-ny-trades">0</td>
                                <td id="sess-ny-wr">0%</td>
                                <td id="sess-ny-avg">0R</td>
                                <td id="sess-ny-total">0R</td>
                                <td id="sess-ny-best" class="text-pass">0R</td>
                                <td id="sess-ny-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-perfect">Overlap</span></td>
                                <td id="sess-overlap-trades">0</td>
                                <td id="sess-overlap-wr">0%</td>
                                <td id="sess-overlap-avg">0R</td>
                                <td id="sess-overlap-total">0R</td>
                                <td id="sess-overlap-best" class="text-pass">0R</td>
                                <td id="sess-overlap-worst" class="text-fail">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Performance by Alert Type -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Alert Type</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Alert Type</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Expectancy</th>
                            </tr>
                        </thead>
                        <tbody id="alert-stats-body">
                            <tr>
                                <td><span class="badge badge-trade-ready">B+</span></td>
                                <td id="alert-tr-trades">0</td>
                                <td id="alert-tr-wr">0%</td>
                                <td id="alert-tr-avg">0R</td>
                                <td id="alert-tr-total">0R</td>
                                <td id="alert-tr-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-strong">A</span></td>
                                <td id="alert-strong-trades">0</td>
                                <td id="alert-strong-wr">0%</td>
                                <td id="alert-strong-avg">0R</td>
                                <td id="alert-strong-total">0R</td>
                                <td id="alert-strong-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-perfect-alert">A+</span></td>
                                <td id="alert-perfect-trades">0</td>
                                <td id="alert-perfect-wr">0%</td>
                                <td id="alert-perfect-avg">0R</td>
                                <td id="alert-perfect-total">0R</td>
                                <td id="alert-perfect-exp">0R</td>
                            </tr>
                            <tr>
                                <td><span class="badge badge-watch">MANUAL</span></td>
                                <td id="alert-manual-trades">0</td>
                                <td id="alert-manual-wr">0%</td>
                                <td id="alert-manual-avg">0R</td>
                                <td id="alert-manual-total">0R</td>
                                <td id="alert-manual-exp">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Performance by Grade -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Performance by Grade</h2>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Grade</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Avg R</th>
                                <th>Total R</th>
                                <th>Expectancy</th>
                                <th>Best</th>
                                <th>Worst</th>
                            </tr>
                        </thead>
                        <tbody id="grade-stats-body">
                            <tr>
                                <td><span class="grade-mini-badge grade-aplus">A+</span></td>
                                <td id="grade-aplus-trades">0</td>
                                <td id="grade-aplus-wr">0%</td>
                                <td id="grade-aplus-avg">0R</td>
                                <td id="grade-aplus-total">0R</td>
                                <td id="grade-aplus-exp">0R</td>
                                <td id="grade-aplus-best" class="text-pass">0R</td>
                                <td id="grade-aplus-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-a">A</span></td>
                                <td id="grade-a-trades">0</td>
                                <td id="grade-a-wr">0%</td>
                                <td id="grade-a-avg">0R</td>
                                <td id="grade-a-total">0R</td>
                                <td id="grade-a-exp">0R</td>
                                <td id="grade-a-best" class="text-pass">0R</td>
                                <td id="grade-a-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-b">B</span></td>
                                <td id="grade-b-trades">0</td>
                                <td id="grade-b-wr">0%</td>
                                <td id="grade-b-avg">0R</td>
                                <td id="grade-b-total">0R</td>
                                <td id="grade-b-exp">0R</td>
                                <td id="grade-b-best" class="text-pass">0R</td>
                                <td id="grade-b-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-c">C</span></td>
                                <td id="grade-c-trades">0</td>
                                <td id="grade-c-wr">0%</td>
                                <td id="grade-c-avg">0R</td>
                                <td id="grade-c-total">0R</td>
                                <td id="grade-c-exp">0R</td>
                                <td id="grade-c-best" class="text-pass">0R</td>
                                <td id="grade-c-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-d">D</span></td>
                                <td id="grade-d-trades">0</td>
                                <td id="grade-d-wr">0%</td>
                                <td id="grade-d-avg">0R</td>
                                <td id="grade-d-total">0R</td>
                                <td id="grade-d-exp">0R</td>
                                <td id="grade-d-best" class="text-pass">0R</td>
                                <td id="grade-d-worst" class="text-fail">0R</td>
                            </tr>
                            <tr>
                                <td><span class="grade-mini-badge grade-d">?</span></td>
                                <td id="grade-none-trades">0</td>
                                <td id="grade-none-wr">0%</td>
                                <td id="grade-none-avg">0R</td>
                                <td id="grade-none-total">0R</td>
                                <td id="grade-none-exp">0R</td>
                                <td id="grade-none-best" class="text-pass">0R</td>
                                <td id="grade-none-worst" class="text-fail">0R</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Grade Performance Summary -->
                <div class="grid grid-3 mt-md">
                    <div class="stat-box" style="border-left: 3px solid var(--color-perfect);">
                        <div class="stat-value" id="grade-best-performer">--</div>
                        <div class="stat-label">Best Performing Grade</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--color-warning);">
                        <div class="stat-value" id="grade-most-traded">--</div>
                        <div class="stat-label">Most Traded Grade</div>
                    </div>
                    <div class="stat-box" style="border-left: 3px solid var(--color-info);">
                        <div class="stat-value" id="grade-correlation">--</div>
                        <div class="stat-label">Grade-Performance Correlation</div>
                    </div>
                </div>
            </div>
            
            <!-- Losing Trade Analysis -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Losing Trade Analysis</h2>
                </div>
                
                <div class="grid grid-3">
                    <div class="stat-box">
                        <div class="stat-value" id="loss-count">0</div>
                        <div class="stat-label">Total Losses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="loss-avg">0R</div>
                        <div class="stat-label">Avg Loss Size</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="loss-streak">0</div>
                        <div class="stat-label">Max Losing Streak</div>
                    </div>
                </div>
                
                <div class="mt-md">
                    <h4 style="font-size: 0.85rem; margin-bottom: 8px;">Common Loss Patterns</h4>
                    <div id="loss-patterns" class="text-muted" style="font-size: 0.85rem;">
                        No losing trades to analyse yet.
                    </div>
                </div>
            </div>
            
            <!-- AI Insights -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4CA; AI Insights</h2>
                    <button class="btn btn-secondary btn-sm" onclick="generateInsights()">&#x1F503; Refresh</button>
                </div>
                
                <div id="ai-insights" class="text-secondary" style="font-size: 0.9rem; line-height: 1.7;">
                    <p>Not enough trade data for insights. Complete at least 10 trades to generate personalised analysis.</p>
                </div>
            </div>
            
            <!-- Export for Claude Review -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4E4; Export for Claude Review</h2>
                </div>
                
                <p class="text-secondary mb-md">Generate a comprehensive report of your trading performance, lessons learned, and system usage. Copy and paste into Claude for coaching, analysis, and suggestions for improving the Command Centre and UTCC system.</p>
                
                <div class="flex gap-md mb-md">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Export Period</label>
                        <select class="form-select" id="export-period">
                            <option value="week">Last 7 Days</option>
                            <option value="month" selected>Last 30 Days</option>
                            <option value="quarter">Last 90 Days</option>
                            <option value="all">All Time</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Include</label>
                        <div class="flex gap-sm" style="flex-wrap: wrap;">
                            <label class="checkbox-label"><input type="checkbox" id="export-trades" checked> Trades</label>
                            <label class="checkbox-label"><input type="checkbox" id="export-lessons" checked> Lessons</label>
                            <label class="checkbox-label"><input type="checkbox" id="export-settings" checked> Settings</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-sm">
                    <button class="btn btn-primary" onclick="generateClaudeExport()">&#x1F4CB; Generate Report</button>
                    <button class="btn btn-secondary" onclick="copyExportToClipboard()" id="copy-export-btn" disabled>&#x1F4CB; Copy to Clipboard</button>
                </div>
                
                <div id="claude-export-preview" class="mt-md" style="display: none;">
                    <label class="form-label">Preview (scroll to review, then copy)</label>
                    <textarea id="claude-export-text" class="form-input" style="height: 400px; font-family: var(--font-heading); font-size: 0.8rem; line-height: 1.5;" readonly></textarea>
                </div>
            </div>
            
        </section>
        
        <section id="tab-reference" class="tab-content">
            <div id="reference-tab-content"></div>
        </section>
        
        <section id="tab-settings" class="tab-content">
            
            <!-- Theme Settings -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Appearance</h2>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <div class="flex gap-md">
                        <button class="btn btn-secondary" id="theme-dark-btn" onclick="setTheme('dark')">&#x1F319; Dark</button>
                        <button class="btn btn-secondary" id="theme-light-btn" onclick="setTheme('light')">&#x2600; Light</button>
                    </div>
                </div>
            </div>
            
            <!-- Account Settings -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Account Settings</h2>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Account Balance (AUD)</label>
                        <input type="number" class="form-input" id="settings-balance" value="2000" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peak Balance (AUD)</label>
                        <input type="number" class="form-input" id="settings-peak" value="2000" step="0.01">
                        <span class="text-muted" style="font-size: 0.75rem;">For drawdown calculation</span>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">Default Risk %</label>
                        <select class="form-select" id="settings-risk">
                            <option value="0.5">0.5%</option>
                            <option value="1">1%</option>
                            <option value="1.5" selected>1.5%</option>
                            <option value="2">2%</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select class="form-select" id="settings-currency">
                            <option value="AUD" selected>AUD</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-primary mt-md" onclick="saveSettings()">&#x1F4BE; Save Settings</button>
            </div>
            
            <!-- Broker Connection (rendered by broker-ui.js) -->
            <div id="broker-status-panel" class="mb-lg"></div>
            
            <!-- Server Storage -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">&#x1F4BE; Server Storage</h2>
                    <div id="server-storage-status">
                        <span class="badge">Local Only</span>
                    </div>
                </div>
                
                <p class="text-muted mb-md" style="font-size: 0.85rem;">
                    Sync your data to the server for backup and cross-device access.
                </p>
                
                <div class="grid grid-2 mb-md">
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Last Save:</strong> <span id="server-last-save">Never</span></p>
                        <p style="font-size: 0.85rem;"><strong>Last Load:</strong> <span id="server-last-load">Never</span></p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Server:</strong> <span id="server-url">forex.pineros.club</span></p>
                        <p style="font-size: 0.85rem;"><strong>Status:</strong> <span id="server-status">Unknown</span></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-sm">
                        <input type="checkbox" id="server-auto-save" checked>
                        Auto-save every 60 seconds
                    </label>
                </div>
                
                <div class="flex gap-md">
                    <button class="btn btn-primary" onclick="serverStorageSave()">&#x1F4BE; Save to Server</button>
                    <button class="btn btn-secondary" onclick="serverStorageLoad()">&#x1F4E5; Load from Server</button>
                </div>
                
                <div id="server-storage-message" class="mt-md" style="display: none;"></div>
            </div>
            
            <!-- Data Management -->
            <div class="card mb-lg">
                <div class="card-header">
                    <h2 class="card-title">Data Management</h2>
                </div>
                
                <div class="flex gap-md" style="flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportAllData()">&#x1F4E4; Export All Data (JSON)</button>
                    <label class="btn btn-secondary" style="cursor: pointer;">
                        &#x1F525; Import Data
                        <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
                    </label>
                </div>
                
                <div class="mt-lg" style="padding: 16px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid var(--color-fail);">
                    <h4 style="color: var(--color-fail); margin-bottom: 8px;">WARNING: Danger Zone</h4>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">This action cannot be undone. All trades, scans, and settings will be permanently deleted.</p>
                    <button class="btn btn-danger" onclick="clearAllData()">&#x1F5D1; Clear All Data</button>
                </div>
            </div>
            
            <!-- System Info -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Information</h2>
                </div>
                
                <div class="grid grid-2">
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Version:</strong> 2.6.0</p>
                        <p style="font-size: 0.85rem;"><strong>Indicator:</strong> UTCC v2.5</p>
                        <p style="font-size: 0.85rem;"><strong>Broker:</strong> Oanda</p>
                    </div>
                    <div>
                        <p style="font-size: 0.85rem;"><strong>Storage Used:</strong> <span id="storage-used">0 KB</span></p>
                        <p style="font-size: 0.85rem;"><strong>Trades Logged:</strong> <span id="trades-logged">0</span></p>
                        <p style="font-size: 0.85rem;"><strong>Last Backup:</strong> <span id="last-backup">Never</span></p>
                    </div>
                </div>
            </div>
            
        </section>
        
        <!-- ==========================================
             TAB: TRADE GUIDE (NEW)
             ========================================== -->
        
    </main>

    <!-- ============================================
         FLOATING ACTION BUTTONS
         ============================================ -->
    <a href="https://www.forexfactory.com/calendar" target="_blank" class="fab-calendar" title="Forex Factory Calendar">
        &#x1F4C5;
    </a>
    <button class="fab" id="fab-armed" onclick="scrollToArmedPanel()" title="Armed Instruments">
        &#x1F3AF;
        <span class="fab-trade-count zero" id="fab-armed-count">0</span>
    </button>

    <!-- ============================================
         JAVASCRIPT - FOREX TRADING COMMAND CENTRE
         ============================================ -->

    <!-- Phase 3: Core JS modules (extracted from inline block) -->
    <script src="js/core-state.js"></script>
    <script src="js/core-ui.js"></script>
    <script src="js/dashboard-drawdown.js"></script>
    <script src="js/active-trades.js"></script>
    <script src="js/daily-scan.js"></script>
    <script src="js/pre-trade.js"></script>
    <script src="js/asset-class.js"></script>
    <script src="js/stop-loss-exit.js"></script>
    <script src="js/institutional-checklist.js"></script>
    <script src="js/journal-crud.js"></script>
    <script src="js/performance-analytics.js"></script>
    <script src="js/settings-accordion.js"></script>
    <script src="js/guide-tab.js"></script>
    <script src="js/news-impact.js"></script>

    
    <!-- Tooltip Positioning Script -->
    <script src="js/tooltip-positioning.js"></script>

    <!-- Armed Panel Module -->
    <script src="js/armed-panel.js"></script>

    <!-- Regime Check Module -->
    <!-- v3.0.0: Daily Context Module (Phase 1) -->
    <script src="js/daily-context.js"></script>

    <script src="js/regime-module.js"></script>
    
    <!-- Playbook Module -->
    <script src="js/playbook-module.js"></script>
	
	<!-- Circuit Breaker System -->
	<script src="js/circuit-breaker-module.js"></script>
	<script src="js/circuit-breaker-integration.js"></script>
	<script src="js/circuit-breaker-ui.js"></script>
	
	<!-- Broker Integration -->
	<script src="js/broker-manager.js"></script>
	<script src="js/broker-oanda.js"></script>
	<script src="js/broker-ui.js"></script>
	<script src="js/broker-dashboard.js"></script>
	
	<!-- UTCS Phase 1-4: Alert Queue & Trade Capture -->
	<script src="js/alert-queue.js"></script>
	<script src="js/trade-capture.js"></script>
	<script src="js/execute-integration.js"></script>
	<script src="js/journal-autofill.js"></script>
	
	<!-- Server Storage -->
	<script src="js/server-storage.js"></script>
	
	<!-- Trade Journal -->
	<script src="js/trade-journal.js"></script>
	

    <!-- Session Board removed (v3.4.1)  functionality replaced by Daily Context -->
    <!-- Reference Tab -->
    <script src="js/reference-tab.js"></script>

    <!-- Gold Nugget Guide -->
    <script src="js/trading-guide.js"></script>
    

    <!-- v3.0.0: Daily Context Init -->


    <!-- === PHASE 5: QUICK ACCESS BAR === -->
    <div id="quick-access-bar" class="hidden">
        <div style="display:flex; gap:var(--spacing-xs); padding:var(--spacing-xs); overflow-x:auto; width:100%;" id="quick-access-items">
            <!-- Populated by JavaScript -->
        </div>
    </div>


    <!-- === PHASE 5: QUICK ACCESS BAR POPULATION & INTERACTION === -->
    <script src="js/quick-access-bar.js"></script>


    <!-- INITIALIZATION === -->
    <script src="js/tooltip-definitions.js"></script>

</body>
</html>
